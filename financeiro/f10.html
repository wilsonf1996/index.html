<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Financeiro ‚Ä¢ Apple-level (Realtime DB)</title>
  <meta name="theme-color" content="#0b0d12" />
  <style>
    :root{
      --bg0:#07080b; --bg1:#0b0d12;
      --cardA: rgba(255,255,255,.065);
      --cardB: rgba(255,255,255,.03);
      --text:#e9eefc; --muted:#9aa6c3; --line:rgba(255,255,255,.08);
      --good:#2dd4bf; --bad:#fb7185; --warn:#fbbf24; --brand:#60a5fa;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r:18px; --r2:26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text", "Segoe UI", Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(96,165,250,.22), transparent 60%),
        radial-gradient(1000px 700px at 90% 0%, rgba(45,212,191,.14), transparent 55%),
        radial-gradient(900px 600px at 80% 110%, rgba(251,113,133,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 45%, #07090f 100%);
      overflow-x:hidden;
    }
    .safe{padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    .wrap{max-width:1240px; margin:0 auto; padding:22px 18px 92px;}
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 18px;
      margin:-22px -18px 18px;
      backdrop-filter: blur(16px);
      background: linear-gradient(180deg, rgba(7,8,11,.86), rgba(7,8,11,.42));
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:240px;}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background:
        radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(20px 20px at 70% 30%, rgba(255,255,255,.15), transparent 60%),
        linear-gradient(135deg, rgba(96,165,250,.95), rgba(45,212,191,.75));
      box-shadow: 0 12px 34px rgba(96,165,250,.2);
      border: 1px solid rgba(255,255,255,.12);
    }
    .brand h1{font-size:14px; margin:0; letter-spacing:.2px; line-height:1.1;}
    .brand p{margin:0; font-size:12px; color:var(--muted); line-height:1.2;}
    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .pill{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      border-radius:999px; padding:8px 10px;
      box-shadow: 0 6px 24px rgba(0,0,0,.25) inset;
    }
    .pill span{font-size:12px; color:var(--muted); max-width:260px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .btn{
      appearance:none; border:none; cursor:pointer;
      border-radius:12px; padding:10px 12px;
      color:var(--text);
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      transition: transform .08s ease, background .15s ease, border-color .15s ease, filter .15s ease;
      font-size:13px;
      display:inline-flex; align-items:center; gap:9px;
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.09); border-color:rgba(255,255,255,.14)}
    .btn:active{transform:scale(.985)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(45,212,191,.72));
      border-color: rgba(255,255,255,.18);
      color:#071017;
      font-weight:650;
    }
    .btn.danger{background:rgba(251,113,133,.14); border-color:rgba(251,113,133,.28)}
    .btn.ghost{background:transparent}
    .grid{display:grid; grid-template-columns:1.28fr .72fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} .brand{min-width:unset} }

    .card{
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border:1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .title{display:flex; flex-direction:column; gap:4px;}
    .title h2{margin:0; font-size:14px; letter-spacing:.2px}
    .title p{margin:0; font-size:12px; color:var(--muted)}
    .card .bd{padding:14px 16px 16px;}

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width:980px){ .kpis{grid-template-columns: repeat(2, 1fr);} }

    .kpi{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius: var(--r);
      padding:12px;
      display:flex; flex-direction:column; gap:6px;
      min-height:76px;
    }
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-size:18px; font-weight:750; letter-spacing:.2px}
    .kpi .sub{font-size:11px; color:var(--muted)}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .muted{color:var(--muted)}

    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; justify-content:space-between;
      margin:12px 0 0;
    }
    .filters{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;}
    .field{display:flex; flex-direction:column; gap:6px; min-width:160px;}
    .field label{font-size:11px; color:var(--muted)}
    input, select, textarea{
      width:100%;
      background: rgba(0,0,0,.22);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding:10px 10px;
      color: var(--text);
      outline:none;
      font-family: var(--sans);
      font-size: 13px;
    }
    textarea{min-height:84px; resize: vertical;}
    input::placeholder, textarea::placeholder{color:rgba(154,166,195,.7)}
    input:focus, select:focus, textarea:focus{border-color: rgba(96,165,250,.5); box-shadow: 0 0 0 4px rgba(96,165,250,.12);}

    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width:680px){ .split{grid-template-columns:1fr;} }

    .divider{height:1px; background:var(--line); margin:12px 0;}
    .hint{font-size:12px; color:var(--muted); line-height:1.4}
    .footer-note{margin-top:12px; font-size:11px; color:rgba(154,166,195,.8);}
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: rgba(233,238,252,.9);
    }

    canvas{width:100%; height:220px; border-radius: 18px; border:1px solid var(--line); background: rgba(0,0,0,.18)}

    .list{display:flex; flex-direction:column; gap:10px;}
    .tx{
      display:grid;
      grid-template-columns: 1.25fr .55fr .55fr .65fr;
      gap:10px;
      align-items:center;
      padding:12px;
      border-radius: var(--r);
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      cursor:pointer;
    }
    .tx:hover{border-color:rgba(255,255,255,.14); background: rgba(0,0,0,.22)}
    .tx:active{transform:scale(.995)}
    @media (max-width:820px){ .tx{grid-template-columns: 1fr; gap:8px;} }

    .tx .main{display:flex; flex-direction:column; gap:3px;}
    .tx .main .name{font-size:13px; font-weight:700}
    .tx .main .meta{font-size:11px; color:var(--muted); display:flex; flex-wrap:wrap; gap:8px}
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
    }
    .amount{
      text-align:right;
      font-family: var(--mono);
      font-size: 13px;
      font-weight:800;
    }
    .right{display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: 18px;
      z-index:999;
      background: rgba(15,18,26,.88);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding:10px 14px;
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      max-width:min(920px, calc(100% - 22px));
      display:none;
      font-size:13px;
      color: var(--text);
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .toast.show{display:flex}

    .skeleton{
      background: linear-gradient(90deg, rgba(255,255,255,.04), rgba(255,255,255,.09), rgba(255,255,255,.04));
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite;
      border-radius: 12px;
      height: 44px;
      border: 1px solid var(--line);
    }
    @keyframes shimmer{0%{background-position:0% 0}100%{background-position:200% 0}}

    .modal{
      position:fixed; inset:0; display:none; place-items:center; z-index:1000;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      padding: 18px;
    }
    .modal.show{display:grid}
    .modal .panel{
      width:min(900px, 100%);
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .phd{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .panel .phd .ttl{display:flex; flex-direction:column; gap:3px}
    .panel .phd h3{margin:0; font-size:14px}
    .panel .phd p{margin:0; font-size:12px; color:var(--muted)}
    .panel .pbd{padding:14px 16px 16px}

    .danger-note{
      border:1px solid rgba(251,113,133,.28);
      background: rgba(251,113,133,.10);
      border-radius: 14px;
      padding:10px 12px;
      font-size:12px;
      color: rgba(233,238,252,.92);
      line-height:1.35;
    }
    .ok-note{
      border:1px solid rgba(45,212,191,.25);
      background: rgba(45,212,191,.09);
      border-radius: 14px;
      padding:10px 12px;
      font-size:12px;
      color: rgba(233,238,252,.92);
      line-height:1.35;
    }
  </style>

  <!-- Firebase compat (mant√©m a linha do seu app, mas completo) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>

<body class="safe">
  <div class="wrap">
    <header class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Financeiro</h1>
          <p id="subtitle">Realtime Database ‚Ä¢ Apple-level UI ‚Ä¢ Dados por usu√°rio</p>
        </div>
      </div>

      <div class="actions">
        <div class="pill" title="Usu√°rio atual">
          <span id="userPill">Conectando‚Ä¶</span>
        </div>

        <button class="btn ghost" id="btnImport" title="Importar seus dados antigos (/expenses)">
          ‚§í Importar antigo
        </button>

        <button class="btn ghost" id="btnExport" title="Exportar CSV (Ctrl+E)">
          ‚§ì Exportar
        </button>

        <button class="btn" id="btnRecurring" title="Gerar recorr√™ncias do m√™s atual">
          üîÅ Recorr√™ncias
        </button>

        <button class="btn" id="btnSettings" title="Configura√ß√µes / Or√ßamentos (Ctrl+,)">
          ‚öôÔ∏è Ajustes
        </button>

        <button class="btn primary" id="btnNew" title="Novo lan√ßamento (N)">
          Ôºã Lan√ßamento
        </button>

        <button class="btn" id="btnGoogle" title="Entrar com Google">
          üîê Google
        </button>

        <button class="btn danger" id="btnSignOut" title="Sair" style="display:none;">
          ‚éã Sair
        </button>
      </div>
    </header>

    <main class="grid">
      <!-- LEFT -->
      <section class="card" aria-label="Dashboard">
        <div class="hd">
          <div class="title">
            <h2>Resumo do per√≠odo</h2>
            <p>Saldo, receitas, despesas, pend√™ncias e or√ßamento</p>
          </div>
          <div class="right" style="align-items:flex-end;">
            <div class="field" style="min-width:170px;">
              <label for="period">Per√≠odo</label>
              <select id="period">
                <option value="thisMonth">Este m√™s</option>
                <option value="lastMonth">M√™s passado</option>
                <option value="thisYear">Este ano</option>
                <option value="custom">Personalizado</option>
              </select>
            </div>
            <div class="field" id="customRange" style="min-width:290px; display:none;">
              <label>Intervalo</label>
              <div class="split">
                <input id="dateFrom" type="date" />
                <input id="dateTo" type="date" />
              </div>
            </div>
          </div>
        </div>

        <div class="bd">
          <div class="kpis">
            <div class="kpi">
              <div class="label">Saldo</div>
              <div class="value" id="kpiBalance">‚Äî</div>
              <div class="sub" id="kpiBalanceSub">Receitas ‚àí Despesas (pagas)</div>
            </div>
            <div class="kpi">
              <div class="label">Receitas</div>
              <div class="value good" id="kpiIncome">‚Äî</div>
              <div class="sub">No per√≠odo</div>
            </div>
            <div class="kpi">
              <div class="label">Despesas</div>
              <div class="value bad" id="kpiExpense">‚Äî</div>
              <div class="sub">No per√≠odo</div>
            </div>
            <div class="kpi">
              <div class="label">Or√ßamento</div>
              <div class="value" id="kpiBudget">‚Äî</div>
              <div class="sub" id="kpiBudgetSub">Gasto / Limite (m√™s)</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="toolbar">
            <div class="filters">
              <div class="field">
                <label for="fType">Tipo</label>
                <select id="fType">
                  <option value="all">Tudo</option>
                  <option value="expense">Despesas</option>
                  <option value="income">Receitas</option>
                </select>
              </div>
              <div class="field">
                <label for="fStatus">Status</label>
                <select id="fStatus">
                  <option value="all">Todos</option>
                  <option value="paid">Pago/Recebido</option>
                  <option value="pending">Pendente</option>
                </select>
              </div>
              <div class="field">
                <label for="fAccount">Conta</label>
                <select id="fAccount"></select>
              </div>
              <div class="field">
                <label for="fCategory">Categoria</label>
                <select id="fCategory"></select>
              </div>
              <div class="field" style="min-width:240px;">
                <label for="fSearch">Buscar</label>
                <input id="fSearch" placeholder="Ex: mercado, aluguel, cliente‚Ä¶" />
              </div>
            </div>

            <div class="right">
              <button class="btn" id="btnDemo" title="Criar dados de exemplo (somente voc√™)">
                ‚ú® Demo
              </button>
              <button class="btn" id="btnRefresh" title="Atualizar (R)">
                ‚ü≥ Atualizar
              </button>
            </div>
          </div>

          <div style="margin-top:12px;">
            <canvas id="chart"></canvas>
            <div class="footer-note">
              Atalhos: <span class="kbd">N</span> novo ‚Ä¢ <span class="kbd">Ctrl+E</span> exportar ‚Ä¢ <span class="kbd">R</span> atualizar ‚Ä¢ <span class="kbd">Ctrl+,</span> ajustes
            </div>
          </div>

          <div class="divider"></div>

          <div class="title" style="margin-bottom:10px;">
            <h2 style="margin:0; font-size:13px;">Lan√ßamentos</h2>
            <p style="margin:0; font-size:12px; color:var(--muted)">Clique em um item para editar.</p>
          </div>

          <div class="list" id="txList">
            <div class="skeleton"></div>
            <div class="skeleton"></div>
            <div class="skeleton"></div>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card" aria-label="Info e a√ß√µes">
        <div class="hd">
          <div class="title">
            <h2>Gest√£o de verdade</h2>
            <p>Controle, previsibilidade e clareza</p>
          </div>
        </div>
        <div class="bd">
          <div class="ok-note">
            ‚úÖ Seus dados ficam em: <b>/users/{uid}/transactions</b> e <b>/users/{uid}/settings</b><br>
            ‚úÖ Login an√¥nimo autom√°tico (sem voc√™ fazer nada).<br>
            ‚úÖ Se quiser, entre com Google para ter a mesma conta em outros dispositivos.
          </div>

          <div class="divider"></div>

          <div class="kpi">
            <div class="label">Modelo recomendado</div>
            <div class="sub">
              ‚Ä¢ Poucas categorias (8‚Äì14) <br>
              ‚Ä¢ Or√ßamento por categoria <br>
              ‚Ä¢ Recorr√™ncias para fixos (aluguel, internet, academia)
            </div>
          </div>

          <div class="divider"></div>

          <div class="title">
            <h2 style="margin:0; font-size:13px;">Seguran√ßa</h2>
            <p style="margin:0; font-size:12px; color:var(--muted)">Depois eu te passo as regras ideais do RTDB</p>
          </div>

          <div class="danger-note" style="margin-top:10px;">
            ‚ö†Ô∏è Se o seu Realtime Database estiver com regras abertas (test mode), qualquer pessoa pode ler/escrever.<br>
            Depois que estiver tudo ok, eu te mando as regras para: <b>cada usu√°rio s√≥ ver seus dados</b>.
          </div>

          <div class="divider"></div>

          <button class="btn ghost" id="btnHome">‚Ü© Voltar p√°gina principal</button>
          <button class="btn ghost" id="btnPrint">üñ®Ô∏è Gerar PDF/Imprimir</button>
        </div>
      </aside>
    </main>
  </div>

  <!-- MODAL: TRANSACTION -->
  <div class="modal" id="txModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="txTitle">
      <div class="phd">
        <div class="ttl">
          <h3 id="txTitle">Novo lan√ßamento</h3>
          <p id="txSub">Receita ou despesa com categoria, conta e detalhes</p>
        </div>
        <div class="right">
          <button class="btn ghost" id="btnCloseTx">‚úï Fechar</button>
          <button class="btn danger" id="btnDeleteTx" style="display:none;">üóëÔ∏è Excluir</button>
          <button class="btn primary" id="btnSaveTx">‚úî Salvar</button>
        </div>
      </div>
      <div class="pbd">
        <div class="split">
          <div class="field">
            <label for="txType">Tipo</label>
            <select id="txType">
              <option value="expense">Despesa</option>
              <option value="income">Receita</option>
            </select>
          </div>
          <div class="field">
            <label for="txStatus">Status</label>
            <select id="txStatus">
              <option value="paid">Pago / Recebido</option>
              <option value="pending">Pendente</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="split">
          <div class="field">
            <label for="txDate">Data</label>
            <input id="txDate" type="date" />
          </div>
          <div class="field">
            <label for="txTime">Hora</label>
            <input id="txTime" type="time" />
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="txName">Descri√ß√£o</label>
            <input id="txName" placeholder="Ex: Mercado, Aluguel, Cliente X‚Ä¶" maxlength="80"/>
          </div>
          <div class="field">
            <label for="txAmount">Valor</label>
            <input id="txAmount" inputmode="decimal" placeholder="Ex: 123,45" />
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="txAccount">Conta</label>
            <select id="txAccount"></select>
          </div>
          <div class="field">
            <label for="txCategory">Categoria</label>
            <select id="txCategory"></select>
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="txTags">Tags (v√≠rgula)</label>
            <input id="txTags" placeholder="Ex: fixo, obra, viagem" />
          </div>
          <div class="field">
            <label for="txAttachment">Anexo (link)</label>
            <input id="txAttachment" placeholder="Ex: recibo no Drive" />
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="txRecurring">Recorr√™ncia</label>
            <select id="txRecurring">
              <option value="none">N√£o recorrente</option>
              <option value="monthly">Mensal</option>
              <option value="weekly">Semanal</option>
            </select>
          </div>
          <div class="field">
            <label for="txRecurringDay">Dia fixo (mensal)</label>
            <input id="txRecurringDay" type="number" min="1" max="31" placeholder="Ex: 5" />
          </div>
        </div>

        <div class="field" style="margin-top:10px;">
          <label for="txNote">Observa√ß√µes</label>
          <textarea id="txNote" placeholder="Detalhes adicionais‚Ä¶" maxlength="800"></textarea>
        </div>

        <div class="footer-note" id="txFoot"></div>
      </div>
    </div>
  </div>

  <!-- MODAL: SETTINGS -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="stTitle">
      <div class="phd">
        <div class="ttl">
          <h3 id="stTitle">Ajustes ‚Ä¢ Or√ßamentos</h3>
          <p>Contas, categorias, moeda e budgets</p>
        </div>
        <div class="right">
          <button class="btn ghost" id="btnCloseSettings">‚úï Fechar</button>
          <button class="btn primary" id="btnSaveSettings">‚úî Salvar</button>
        </div>
      </div>
      <div class="pbd">
        <div class="split">
          <div class="field">
            <label for="stCurrency">Moeda</label>
            <select id="stCurrency">
              <option value="BRL">BRL (R$)</option>
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (‚Ç¨)</option>
            </select>
          </div>
          <div class="kpi">
            <div class="label">Dica</div>
            <div class="sub">Mant√©m poucas categorias e budgets bem claros. Isso vira ‚Äúgest√£o real‚Äù.</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="title">
          <h2 style="margin:0; font-size:13px;">Contas</h2>
          <p style="margin:0; font-size:12px; color:var(--muted)">Uma por linha</p>
        </div>
        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="stAccounts">Lista</label>
            <textarea id="stAccounts" placeholder="Banco&#10;Carteira&#10;Cart√£o"></textarea>
          </div>
          <div class="kpi">
            <div class="label">Sugest√£o</div>
            <div class="sub">Banco / Carteira / Cart√£o / Investimentos j√° resolve 95% dos casos.</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="title">
          <h2 style="margin:0; font-size:13px;">Categorias</h2>
          <p style="margin:0; font-size:12px; color:var(--muted)">Uma por linha</p>
        </div>
        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="stCategories">Lista</label>
            <textarea id="stCategories" placeholder="Moradia&#10;Alimenta√ß√£o&#10;Transporte&#10;Lazer&#10;Sa√∫de"></textarea>
          </div>
          <div class="kpi">
            <div class="label">Regra</div>
            <div class="sub">Se voc√™ n√£o consegue ‚Äúmemorizar‚Äù, est√° com categorias demais.</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="title">
          <h2 style="margin:0; font-size:13px;">Or√ßamento por categoria (mensal)</h2>
          <p style="margin:0; font-size:12px; color:var(--muted)">Formato: Categoria=valor</p>
        </div>
        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="stBudgets">Budgets</label>
            <textarea id="stBudgets" placeholder="Moradia=2500&#10;Alimenta√ß√£o=1200&#10;Transporte=600&#10;Lazer=400"></textarea>
          </div>
          <div class="kpi">
            <div class="label">Como calcula</div>
            <div class="sub">Somente <b>despesas</b> pagas do m√™s, somadas por categoria vs limite.</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="hint">
          Salvo em: <span class="kbd">/users/{uid}/settings</span>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: RECURRING -->
  <div class="modal" id="recModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="recTitle">
      <div class="phd">
        <div class="ttl">
          <h3 id="recTitle">Recorr√™ncias</h3>
          <p>Gere automaticamente fixos do m√™s (sem duplicar)</p>
        </div>
        <div class="right">
          <button class="btn ghost" id="btnCloseRec">‚úï Fechar</button>
          <button class="btn primary" id="btnGenerateRec">‚úî Gerar m√™s</button>
        </div>
      </div>
      <div class="pbd">
        <div class="ok-note">
          Como usar: marque um lan√ßamento como <b>Mensal</b> e coloque o <b>dia fixo</b> (ex: 5).
          Depois clique em <b>Gerar m√™s</b> para criar os itens automaticamente como <b>pendentes</b> (ou pagos, se voc√™ escolher).
        </div>
        <div class="divider"></div>
        <div class="field">
          <label for="recMode">Gerar como</label>
          <select id="recMode">
            <option value="pending">Pendente</option>
            <option value="paid">Pago/Recebido</option>
          </select>
        </div>
        <div class="footer-note" id="recInfo"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <div class="msg" id="toastMsg">‚Äî</div>
    <button class="btn ghost" id="toastClose">OK</button>
  </div>

  <script>
    /************************************************************
     * 1) FirebaseConfig (o MESMO do seu app)
     ************************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyAIp-rFuZZsBCNVJ3pSge4TE-XUuwYygrI",
      authDomain: "agenda-6accc.firebaseapp.com",
      databaseURL: "https://agenda-6accc-default-rtdb.firebaseio.com",
      projectId: "agenda-6accc",
      storageBucket: "agenda-6accc.appspot.com",
      messagingSenderId: "794262176773",
      appId: "1:794262176773:web:c4e3837b29f635d5dc086c",
      measurementId: "G-CVBQ54PERH"
    };

    /************************************************************
     * 2) Init Firebase (compat)
     ************************************************************/
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    /************************************************************
     * 3) State + Helpers
     ************************************************************/
    const $ = (id) => document.getElementById(id);

    const state = {
      uid: null,
      email: null,
      settings: null,
      tx: [],
      period: "thisMonth",
      range: { from: null, to: null },
      filters: { type:"all", status:"all", account:"all", category:"all", search:"" },
      editingId: null,
      listeners: [],
    };

    const defaults = {
      currency: "BRL",
      accounts: ["Banco","Carteira","Cart√£o","Investimentos"],
      categories: ["Moradia","Alimenta√ß√£o","Transporte","Lazer","Sa√∫de","Educa√ß√£o","Impostos","Outros"],
      budgets: { "Moradia": 2500, "Alimenta√ß√£o": 1200, "Transporte": 600, "Lazer": 400 }
    };

    function toast(msg){
      $("toastMsg").textContent = msg;
      $("toast").classList.add("show");
    }
    $("toastClose").addEventListener("click", ()=> $("toast").classList.remove("show"));

    function nowISODate(){
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }
    function nowISOTime(){
      const d = new Date();
      return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }

    function startOfMonth(d=new Date()){ return new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0,0); }
    function endOfMonth(d=new Date()){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); }
    function startOfYear(d=new Date()){ return new Date(d.getFullYear(), 0, 1, 0,0,0,0); }
    function endOfYear(d=new Date()){ return new Date(d.getFullYear(), 11, 31, 23,59,59,999); }

    function clampRange(){
      const now = new Date();
      if(state.period === "thisMonth"){
        state.range.from = startOfMonth(now);
        state.range.to = endOfMonth(now);
      } else if(state.period === "lastMonth"){
        const prev = new Date(now.getFullYear(), now.getMonth()-1, 15);
        state.range.from = startOfMonth(prev);
        state.range.to = endOfMonth(prev);
      } else if(state.period === "thisYear"){
        state.range.from = startOfYear(now);
        state.range.to = endOfYear(now);
      } else {
        const f = $("dateFrom").value ? new Date($("dateFrom").value + "T00:00:00") : startOfMonth(now);
        const t = $("dateTo").value ? new Date($("dateTo").value + "T23:59:59") : endOfMonth(now);
        state.range.from = f;
        state.range.to = t;
      }
    }

    function fmtMoney(v){
      const cur = (state.settings?.currency || defaults.currency);
      try{
        return new Intl.NumberFormat("pt-BR", { style:"currency", currency: cur }).format(v || 0);
      }catch{
        return `R$ ${(v||0).toFixed(2)}`;
      }
    }

    function toNumberCurrency(str){
      if(typeof str !== "string") return Number(str||0);
      const s = str.trim().replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,"");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }

    function safeText(s){
      return String(s ?? "").replace(/[<>]/g,"").trim();
    }

    function txPath(){ return `/users/${state.uid}/transactions`; }
    function settingsPath(){ return `/users/${state.uid}/settings`; }
    function legacyPath(){ return `/expenses`; }

    function parseBudgets(text){
      const out = {};
      (text || "").split("\n").map(l=>l.trim()).filter(Boolean).forEach(line=>{
        const [k,v] = line.split("=");
        const key = (k||"").trim();
        if(!key) return;
        out[key] = toNumberCurrency((v||"").trim());
      });
      return out;
    }
    function budgetsToText(obj){
      const keys = Object.keys(obj||{}).sort((a,b)=>a.localeCompare(b));
      return keys.map(k=>`${k}=${Number(obj[k]||0)}`).join("\n");
    }

    /************************************************************
     * 4) UI: Select options
     ************************************************************/
    function setSelectOptions(select, items, includeAll=true, allLabel="Todas"){
      select.innerHTML = "";
      if(includeAll){
        const opt = document.createElement("option");
        opt.value = "all";
        opt.textContent = allLabel;
        select.appendChild(opt);
      }
      (items||[]).forEach(v=>{
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v;
        select.appendChild(o);
      });
    }

    function syncFiltersUI(){
      const s = state.settings || defaults;
      setSelectOptions($("fAccount"), s.accounts, true, "Todas");
      setSelectOptions($("fCategory"), s.categories, true, "Todas");
      $("fAccount").value = state.filters.account;
      $("fCategory").value = state.filters.category;
    }

    function syncTxFormSelects(){
      const s = state.settings || defaults;
      $("txAccount").innerHTML = "";
      s.accounts.forEach(a=>{
        const o=document.createElement("option"); o.value=a; o.textContent=a; $("txAccount").appendChild(o);
      });
      $("txCategory").innerHTML = "";
      s.categories.forEach(c=>{
        const o=document.createElement("option"); o.value=c; o.textContent=c; $("txCategory").appendChild(o);
      });
    }

    /************************************************************
     * 5) Chart (clean)
     ************************************************************/
    function drawChart(txList){
      const canvas = $("chart");
      const ctx = canvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const W = rect.width;
      const H = 220;

      canvas.width = Math.floor(W * dpr);
      canvas.height = Math.floor(H * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);

      ctx.clearRect(0,0,W,H);

      // grid
      ctx.lineWidth = 1;
      ctx.strokeStyle = "rgba(255,255,255,.07)";
      for(let i=0;i<=4;i++){
        const y = 18 + i*((H-36)/4);
        ctx.beginPath(); ctx.moveTo(12,y); ctx.lineTo(W-12,y); ctx.stroke();
      }

      // aggregate by day
      const map = new Map();
      for(const t of txList){
        const d = new Date(t.ts);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
        if(!map.has(key)) map.set(key,{inc:0, exp:0});
        const o = map.get(key);
        if(t.type === "income") o.inc += (t.amount||0);
        else o.exp += (t.amount||0);
      }
      const keys = Array.from(map.keys()).sort();
      if(keys.length === 0){
        ctx.fillStyle="rgba(154,166,195,.75)";
        ctx.font="12px " + getComputedStyle(document.body).fontFamily;
        ctx.fillText("Sem dados no per√≠odo para gerar gr√°fico.", 16, 34);
        return;
      }

      // cumulative
      let cum = 0;
      const series = keys.map(k=>{
        const o = map.get(k);
        cum += (o.inc - o.exp);
        return {k, cum, inc:o.inc, exp:o.exp};
      });

      const maxAbs = Math.max(...series.map(s=>Math.abs(s.cum)), 1);
      const pad = 18;
      const x0 = 12, x1 = W-12;
      const y0 = pad, y1 = H-pad;

      const toX = (i)=> x0 + ( (x1-x0) * (i/(series.length-1 || 1)) );
      const toY = (v)=> (y0 + (y1-y0) * (0.5 - (v/(2*maxAbs))) );

      // line (saldo acumulado)
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(96,165,250,.85)";
      ctx.beginPath();
      series.forEach((s,i)=>{
        const x = toX(i), y = toY(s.cum);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      // points
      ctx.fillStyle = "rgba(255,255,255,.85)";
      series.forEach((s,i)=>{
        const x=toX(i), y=toY(s.cum);
        ctx.beginPath(); ctx.arc(x,y,2.4,0,Math.PI*2); ctx.fill();
      });

      // label (√∫ltimo saldo)
      const last = series[series.length-1];
      ctx.fillStyle = "rgba(233,238,252,.92)";
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText(`Saldo acumulado: ${fmtMoney(last.cum)}`, 16, H-14);
    }

    /************************************************************
     * 6) Rendering
     ************************************************************/
    function inRange(ts){
      return ts >= state.range.from.getTime() && ts <= state.range.to.getTime();
    }

    function applyFilters(list){
      const f = state.filters;
      return list.filter(t=>{
        if(!inRange(t.ts)) return false;
        if(f.type !== "all" && t.type !== f.type) return false;
        if(f.status !== "all" && (t.status||"paid") !== f.status) return false;
        if(f.account !== "all" && (t.account||"") !== f.account) return false;
        if(f.category !== "all" && (t.category||"") !== f.category) return false;
        if(f.search.trim()){
          const q = f.search.trim().toLowerCase();
          const bag = `${t.name||""} ${t.note||""} ${(t.tags||[]).join(" ")} ${(t.category||"")} ${(t.account||"")}`.toLowerCase();
          if(!bag.includes(q)) return false;
        }
        return true;
      }).sort((a,b)=>b.ts-a.ts);
    }

    function computeKPIs(filtered){
      let income=0, expense=0, pending=0;
      for(const t of filtered){
        const st = (t.status||"paid");
        if(st === "pending"){ pending += (t.type==="expense" ? (t.amount||0) : 0); }
        if(st !== "paid") continue; // KPIs principais usam pagos (mais realista)
        if(t.type === "income") income += (t.amount||0);
        else expense += (t.amount||0);
      }
      const balance = income - expense;

      // budget: sempre do m√™s atual (independente do filtro), despesas pagas do m√™s
      const s = state.settings || defaults;
      const budgets = s.budgets || {};
      const now = new Date();
      const mFrom = startOfMonth(now).getTime();
      const mTo = endOfMonth(now).getTime();
      let spentThisMonth = 0;
      for(const t of state.tx){
        if(t.type !== "expense") continue;
        if((t.status||"paid") !== "paid") continue;
        if(t.ts < mFrom || t.ts > mTo) continue;
        spentThisMonth += (t.amount||0);
      }
      const limit = Object.values(budgets).reduce((a,b)=>a+(Number(b)||0),0);

      $("kpiIncome").textContent = fmtMoney(income);
      $("kpiExpense").textContent = fmtMoney(expense);
      $("kpiBalance").textContent = fmtMoney(balance);
      $("kpiBalance").className = "value " + (balance>=0 ? "good":"bad");
      $("kpiBudget").textContent = `${fmtMoney(spentThisMonth)} / ${fmtMoney(limit)}`;
      $("kpiBudgetSub").textContent = limit>0 ? `Uso: ${Math.min(999, Math.round((spentThisMonth/limit)*100))}% (m√™s atual)` : "Defina budgets nos Ajustes";

      return {income, expense, balance, pending, spentThisMonth, limit};
    }

    function renderList(){
      clampRange();
      const filtered = applyFilters(state.tx);
      computeKPIs(filtered);
      drawChart(filtered);

      const el = $("txList");
      el.innerHTML = "";
      if(filtered.length === 0){
        const div = document.createElement("div");
        div.className = "hint";
        div.innerHTML = "Sem lan√ßamentos neste filtro. Clique em <b>Ôºã Lan√ßamento</b> para come√ßar.";
        el.appendChild(div);
        return;
      }

      filtered.slice(0, 250).forEach(t=>{
        const row = document.createElement("div");
        row.className = "tx";
        row.onclick = ()=> openTxModal(t);

        const d = new Date(t.ts);
        const dt = d.toLocaleString("pt-BR");

        const main = document.createElement("div");
        main.className = "main";
        const name = document.createElement("div");
        name.className = "name";
        name.textContent = t.name || "(sem descri√ß√£o)";

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `
          <span class="badge">${dt}</span>
          <span class="badge">${t.type === "income" ? "Receita" : "Despesa"}</span>
          <span class="badge">${(t.status||"paid")==="paid" ? "Pago" : "Pendente"}</span>
          ${t.account ? `<span class="badge">${t.account}</span>` : ""}
          ${t.category ? `<span class="badge">${t.category}</span>` : ""}
        `;
        main.appendChild(name);
        main.appendChild(meta);

        const amount = document.createElement("div");
        amount.className = "amount " + (t.type==="income" ? "good":"bad");
        amount.textContent = (t.type==="income" ? "+" : "-") + " " + fmtMoney(t.amount||0);

        const small = document.createElement("div");
        small.className = "hint";
        small.style.marginTop = "2px";
        const tags = (t.tags||[]).slice(0,5).join(", ");
        small.textContent = (t.note ? t.note.slice(0,80) : "") + (tags ? `  ‚Ä¢  Tags: ${tags}` : "");

        const col2 = document.createElement("div");
        col2.innerHTML = `<div class="hint">ID: <span class="kbd">${t.id.slice(0,8)}</span></div>`;

        const actions = document.createElement("div");
        actions.className = "right";
        actions.innerHTML = `
          <button class="btn ghost" data-act="toggle">${(t.status||"paid")==="paid" ? "‚è≥ Pendente" : "‚úÖ Pagar"}</button>
          <button class="btn danger" data-act="del">üóëÔ∏è</button>
        `;
        actions.querySelector('[data-act="toggle"]').onclick = (e)=>{ e.stopPropagation(); toggleStatus(t); };
        actions.querySelector('[data-act="del"]').onclick = (e)=>{ e.stopPropagation(); deleteTx(t); };

        const wrap = document.createElement("div");
        wrap.style.display="contents";
        row.appendChild(main);
        row.appendChild(col2);
        row.appendChild(small);
        row.appendChild(actions);

        // Melhor layout em desktop: reorganiza
        if(window.matchMedia("(min-width: 821px)").matches){
          row.innerHTML = "";
          row.appendChild(main);
          row.appendChild(document.createElement("div"));
          row.appendChild(amount);
          row.appendChild(actions);

          // adiciona linha 2 via meta embaixo da main (j√° tem)
          // e nota pequena na coluna vazia
          row.children[1].appendChild(small);
          row.children[1].appendChild(document.createElement("div")).className="footer-note";
          row.children[1].lastChild.innerHTML = `Conta: <span class="kbd">${t.account||"‚Äî"}</span> ‚Ä¢ Cat: <span class="kbd">${t.category||"‚Äî"}</span>`;
        }

        el.appendChild(row);
      });
    }

    /************************************************************
     * 7) Settings: load/save
     ************************************************************/
    async function ensureSettings(){
      const ref = db.ref(settingsPath());
      const snap = await ref.get();
      if(!snap.exists()){
        await ref.set(defaults);
        state.settings = {...defaults};
      } else {
        const v = snap.val();
        state.settings = {
          currency: v.currency || defaults.currency,
          accounts: Array.isArray(v.accounts) && v.accounts.length ? v.accounts : defaults.accounts,
          categories: Array.isArray(v.categories) && v.categories.length ? v.categories : defaults.categories,
          budgets: v.budgets && typeof v.budgets === "object" ? v.budgets : defaults.budgets,
          recMeta: v.recMeta && typeof v.recMeta === "object" ? v.recMeta : {}
        };
      }

      // Sync UI
      $("stCurrency").value = state.settings.currency;
      $("stAccounts").value = (state.settings.accounts||[]).join("\n");
      $("stCategories").value = (state.settings.categories||[]).join("\n");
      $("stBudgets").value = budgetsToText(state.settings.budgets||{});
      syncFiltersUI();
      syncTxFormSelects();
    }

    async function saveSettings(){
      const currency = $("stCurrency").value || "BRL";
      const accounts = $("stAccounts").value.split("\n").map(s=>s.trim()).filter(Boolean);
      const categories = $("stCategories").value.split("\n").map(s=>s.trim()).filter(Boolean);
      const budgets = parseBudgets($("stBudgets").value);

      const next = {
        currency,
        accounts: accounts.length ? accounts : defaults.accounts,
        categories: categories.length ? categories : defaults.categories,
        budgets,
        recMeta: state.settings?.recMeta || {}
      };

      await db.ref(settingsPath()).set(next);
      state.settings = next;
      syncFiltersUI();
      syncTxFormSelects();
      toast("Ajustes salvos.");
      closeModal("settingsModal");
      renderList();
    }

    /************************************************************
     * 8) Transactions: CRUD
     ************************************************************/
    function txFromForm(){
      const type = $("txType").value;
      const status = $("txStatus").value;
      const date = $("txDate").value || nowISODate();
      const time = $("txTime").value || "12:00";
      const ts = new Date(`${date}T${time}:00`).getTime();

      const name = safeText($("txName").value);
      const amount = toNumberCurrency($("txAmount").value);
      const account = $("txAccount").value || "";
      const category = $("txCategory").value || "";
      const tags = $("txTags").value.split(",").map(s=>s.trim()).filter(Boolean).slice(0,12);
      const attachment = safeText($("txAttachment").value);
      const note = safeText($("txNote").value);

      const recurring = $("txRecurring").value || "none";
      const recurringDay = Number($("txRecurringDay").value || 0);

      if(!name || !Number.isFinite(amount) || amount <= 0){
        throw new Error("Preencha descri√ß√£o e valor (>0).");
      }

      if(recurring === "monthly" && (recurringDay < 1 || recurringDay > 31)){
        throw new Error("Para mensal, informe um dia fixo (1‚Äì31).");
      }

      return {
        type, status,
        ts,
        name, amount,
        account, category,
        tags,
        attachment,
        note,
        recurring,
        recurringDay: recurring === "monthly" ? recurringDay : 0,
        updatedAt: Date.now(),
      };
    }

    async function createTx(data){
      const ref = db.ref(txPath()).push();
      const id = ref.key;
      await ref.set({
        id,
        ...data,
        createdAt: Date.now()
      });
      toast("Lan√ßamento criado.");
    }

    async function updateTx(id, data){
      await db.ref(`${txPath()}/${id}`).update(data);
      toast("Lan√ßamento atualizado.");
    }

    async function deleteTx(t){
      const ok = confirm("Excluir este lan√ßamento?");
      if(!ok) return;
      await db.ref(`${txPath()}/${t.id}`).remove();
      toast("Exclu√≠do.");
    }

    async function toggleStatus(t){
      const next = (t.status||"paid")==="paid" ? "pending" : "paid";
      await db.ref(`${txPath()}/${t.id}/status`).set(next);
      toast(next==="paid" ? "Marcado como pago." : "Marcado como pendente.");
    }

    function openTxModal(t=null){
      state.editingId = t ? t.id : null;

      syncTxFormSelects();

      $("txTitle").textContent = t ? "Editar lan√ßamento" : "Novo lan√ßamento";
      $("btnDeleteTx").style.display = t ? "inline-flex" : "none";

      const d = t ? new Date(t.ts) : new Date();
      $("txDate").value = t ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}` : nowISODate();
      $("txTime").value = t ? `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}` : nowISOTime();

      $("txType").value = t?.type || "expense";
      $("txStatus").value = t?.status || "paid";
      $("txName").value = t?.name || "";
      $("txAmount").value = t?.amount != null ? String(t.amount).replace(".",",") : "";
      $("txAccount").value = t?.account || (state.settings?.accounts?.[0] || "");
      $("txCategory").value = t?.category || (state.settings?.categories?.[0] || "");
      $("txTags").value = (t?.tags || []).join(", ");
      $("txAttachment").value = t?.attachment || "";
      $("txNote").value = t?.note || "";
      $("txRecurring").value = t?.recurring || "none";
      $("txRecurringDay").value = t?.recurringDay || "";

      $("txFoot").textContent = t ? `ID: ${t.id}` : "Dica: use recorr√™ncia mensal para contas fixas.";
      openModal("txModal");
    }

    async function saveTx(){
      try{
        const data = txFromForm();
        if(state.editingId){
          await updateTx(state.editingId, data);
        } else {
          await createTx(data);
        }
        closeModal("txModal");
      }catch(err){
        alert(err.message || "Erro ao salvar.");
      }
    }

    /************************************************************
     * 9) Recorr√™ncias
     ************************************************************/
    function openRecModal(){
      const count = state.tx.filter(t=>t.recurring && t.recurring !== "none").length;
      $("recInfo").textContent = `Modelos recorrentes encontrados: ${count}.`;
      openModal("recModal");
    }

    function ymKey(d=new Date()){
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    }

    async function generateRecurrencesForCurrentMonth(mode){
      const models = state.tx.filter(t=>t.recurring && t.recurring !== "none");
      if(models.length === 0){
        toast("Nenhuma recorr√™ncia definida. Marque algum lan√ßamento como Mensal/Semanal.");
        return;
      }

      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth(); // 0..11
      const monthKey = ymKey(now);

      // meta para n√£o duplicar (por modelo + m√™s)
      const recMeta = state.settings?.recMeta || {};
      let created = 0;

      for(const model of models){
        const metaKey = `${model.id}:${monthKey}`;
        if(recMeta[metaKey]) continue; // j√° gerado

        if(model.recurring === "monthly"){
          const day = Math.min(Math.max(Number(model.recurringDay||1),1),31);
          const dt = new Date(y, m, day, 9, 0, 0, 0);
          // se o m√™s n√£o tem esse dia (ex: 31 em fevereiro), JS ajusta ‚Äî vamos corrigir: usar √∫ltimo dia do m√™s
          if(dt.getMonth() !== m){
            const last = endOfMonth(new Date(y,m,1));
            dt.setTime(last.getTime());
          }

          const data = {
            type: model.type,
            status: mode,
            ts: dt.getTime(),
            name: model.name,
            amount: model.amount,
            account: model.account || "",
            category: model.category || "",
            tags: (model.tags||[]),
            attachment: model.attachment || "",
            note: (model.note ? model.note + "  ‚Ä¢ (gerado por recorr√™ncia)" : "(gerado por recorr√™ncia)"),
            recurring: "none",
            recurringDay: 0,
            updatedAt: Date.now(),
          };

          await createTx(data);
          created++;
          recMeta[metaKey] = true;
        }

        // weekly (simples): gera 4 ocorr√™ncias na primeira semana do m√™s a partir do dia do modelo
        if(model.recurring === "weekly"){
          const base = new Date(model.ts);
          const weekday = base.getDay(); // 0..6
          const first = new Date(y, m, 1, 9, 0, 0, 0);
          // achar o primeiro weekday do m√™s
          const delta = (weekday - first.getDay() + 7) % 7;
          const firstOcc = new Date(first.getTime() + delta*86400000);
          for(let k=0;k<5;k++){
            const occ = new Date(firstOcc.getTime() + k*7*86400000);
            if(occ.getMonth() !== m) break;

            const metaKeyW = `${model.id}:${monthKey}:w${k}`;
            if(recMeta[metaKeyW]) continue;

            const data = {
              type: model.type,
              status: mode,
              ts: occ.getTime(),
              name: model.name,
              amount: model.amount,
              account: model.account || "",
              category: model.category || "",
              tags: (model.tags||[]),
              attachment: model.attachment || "",
              note: (model.note ? model.note + "  ‚Ä¢ (gerado por recorr√™ncia)" : "(gerado por recorr√™ncia)"),
              recurring: "none",
              recurringDay: 0,
              updatedAt: Date.now(),
            };
            await createTx(data);
            created++;
            recMeta[metaKeyW] = true;
          }
        }
      }

      // salva meta
      state.settings.recMeta = recMeta;
      await db.ref(settingsPath()).set(state.settings);

      toast(created ? `Recorr√™ncias geradas: ${created}` : "Nada a gerar (j√° estava gerado).");
      closeModal("recModal");
    }

    /************************************************************
     * 10) Export CSV
     ************************************************************/
    function exportCSV(){
      const filtered = applyFilters(state.tx);
      const rows = [["data_hora","tipo","status","valor","descricao","conta","categoria","tags","anexo","obs","id"]];
      filtered.forEach(t=>{
        const d = new Date(t.ts).toLocaleString("pt-BR");
        rows.push([
          d,
          t.type,
          t.status||"paid",
          String(t.amount||0).replace(".",","),
          (t.name||"").replaceAll('"','""'),
          t.account||"",
          t.category||"",
          (t.tags||[]).join("|"),
          t.attachment||"",
          (t.note||"").replaceAll('"','""'),
          t.id
        ]);
      });

      const csv = rows.map(r => r.map(v=> `"${String(v ?? "")}"`).join(";")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `financeiro_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      toast("CSV exportado.");
    }

    /************************************************************
     * 11) Demo + Import legado
     ************************************************************/
    async function seedDemo(){
      const ok = confirm("Criar dados de exemplo para voc√™?");
      if(!ok) return;

      const s = state.settings || defaults;
      const base = new Date();
      const items = [
        {type:"income", status:"paid", name:"Sal√°rio", amount:9000, category:"Outros", account:"Banco", tags:["fixo"], note:"Entrada mensal", recurring:"monthly", recurringDay:5},
        {type:"expense", status:"paid", name:"Aluguel", amount:2500, category:"Moradia", account:"Banco", tags:["fixo"], note:"", recurring:"monthly", recurringDay:3},
        {type:"expense", status:"paid", name:"Mercado", amount:420, category:"Alimenta√ß√£o", account:"Cart√£o", tags:["vari√°vel"], note:"", recurring:"none"},
        {type:"expense", status:"pending", name:"Internet", amount:120, category:"Moradia", account:"Banco", tags:["fixo"], note:"Vence dia 10", recurring:"monthly", recurringDay:10},
        {type:"expense", status:"paid", name:"Gasolina", amount:230, category:"Transporte", account:"Cart√£o", tags:["carro"], note:"", recurring:"none"},
      ];

      for(let i=0;i<items.length;i++){
        const dt = new Date(base.getTime() - i*3*86400000);
        const data = {
          ...items[i],
          account: items[i].account || s.accounts[0],
          category: items[i].category || s.categories[0],
          ts: dt.getTime(),
          attachment:"",
          tags: items[i].tags||[],
          updatedAt: Date.now()
        };
        await createTx(data);
      }
      toast("Demo criada.");
    }

    async function importLegacy(){
      const ok = confirm("Importar dados do seu app antigo em /expenses? (n√£o apaga nada)");
      if(!ok) return;

      const snap = await db.ref(legacyPath()).get();
      if(!snap.exists()){
        alert("Nenhum dado encontrado em /expenses.");
        return;
      }

      const val = snap.val();
      let arr = [];
      if(Array.isArray(val)) arr = val;
      else if(typeof val === "object") arr = Object.values(val);

      if(!arr.length){
        alert("N√£o h√° itens para importar.");
        return;
      }

      let imported = 0;
      for(const e of arr){
        const dt = e.dateTime ? new Date(e.dateTime) : new Date();
        const ts = dt.getTime();
        const type = e.type === "income" ? "income" : "expense";
        const amount = Number(e.amount||0);
        const name = safeText(e.description || "Importado");
        const data = {
          type,
          status: "paid",
          ts,
          name,
          amount: Number.isFinite(amount) ? amount : 0,
          account: "Banco",
          category: type==="income" ? "Outros" : "Outros",
          tags: ["importado"],
          attachment: "",
          note: "Importado do app antigo (/expenses).",
          recurring: "none",
          recurringDay: 0,
          updatedAt: Date.now(),
        };
        await createTx(data);
        imported++;
      }

      toast(`Importa√ß√£o conclu√≠da: ${imported} itens.`);
    }

    /************************************************************
     * 12) DB Listener
     ************************************************************/
    function clearListeners(){
      state.listeners.forEach(fn=>fn && fn());
      state.listeners = [];
    }

    function listenTransactions(){
      clearListeners();
      const ref = db.ref(txPath());
      const cb = ref.on("value", (snap)=>{
        const v = snap.val() || {};
        const list = Object.values(v);
        // normaliza
        state.tx = list.filter(x=>x && x.id).map(x=>({
          id: x.id,
          type: x.type || "expense",
          status: x.status || "paid",
          ts: Number(x.ts || x.createdAt || Date.now()),
          name: x.name || "",
          amount: Number(x.amount || 0),
          account: x.account || "",
          category: x.category || "",
          tags: Array.isArray(x.tags) ? x.tags : [],
          attachment: x.attachment || "",
          note: x.note || "",
          recurring: x.recurring || "none",
          recurringDay: Number(x.recurringDay || 0),
          createdAt: Number(x.createdAt || 0),
          updatedAt: Number(x.updatedAt || 0),
        }));
        renderList();
      });
      state.listeners.push(()=>ref.off("value", cb));
    }

    /************************************************************
     * 13) Modals
     ************************************************************/
    function openModal(id){ $(id).classList.add("show"); }
    function closeModal(id){ $(id).classList.remove("show"); }

    /************************************************************
     * 14) Wire UI
     ************************************************************/
    $("btnNew").addEventListener("click", ()=> openTxModal(null));
    $("btnCloseTx").addEventListener("click", ()=> closeModal("txModal"));
    $("btnSaveTx").addEventListener("click", saveTx);
    $("btnDeleteTx").addEventListener("click", async ()=>{
      const id = state.editingId;
      if(!id) return;
      const t = state.tx.find(x=>x.id===id);
      if(t) await deleteTx(t);
      closeModal("txModal");
    });

    $("btnSettings").addEventListener("click", ()=> openModal("settingsModal"));
    $("btnCloseSettings").addEventListener("click", ()=> closeModal("settingsModal"));
    $("btnSaveSettings").addEventListener("click", saveSettings);

    $("btnRecurring").addEventListener("click", openRecModal);
    $("btnCloseRec").addEventListener("click", ()=> closeModal("recModal"));
    $("btnGenerateRec").addEventListener("click", async ()=>{
      const mode = $("recMode").value || "pending";
      await generateRecurrencesForCurrentMonth(mode);
    });

    $("btnExport").addEventListener("click", exportCSV);
    $("btnDemo").addEventListener("click", seedDemo);
    $("btnRefresh").addEventListener("click", ()=>{ renderList(); toast("Atualizado."); });
    $("btnImport").addEventListener("click", importLegacy);

    $("btnHome").addEventListener("click", ()=>{
      window.location.href = "https://wilsonf1996.github.io/index.html/";
    });
    $("btnPrint").addEventListener("click", ()=> window.print());

    $("period").addEventListener("change", ()=>{
      state.period = $("period").value;
      $("customRange").style.display = (state.period==="custom") ? "block" : "none";
      renderList();
    });
    $("dateFrom").addEventListener("change", renderList);
    $("dateTo").addEventListener("change", renderList);

    $("fType").addEventListener("change", ()=>{ state.filters.type=$("fType").value; renderList(); });
    $("fStatus").addEventListener("change", ()=>{ state.filters.status=$("fStatus").value; renderList(); });
    $("fAccount").addEventListener("change", ()=>{ state.filters.account=$("fAccount").value; renderList(); });
    $("fCategory").addEventListener("change", ()=>{ state.filters.category=$("fCategory").value; renderList(); });
    $("fSearch").addEventListener("input", ()=>{
      state.filters.search = $("fSearch").value;
      renderList();
    });

    window.addEventListener("resize", ()=> renderList());

    // Atalhos
    document.addEventListener("keydown", (e)=>{
      const k = e.key.toLowerCase();
      if(k==="n" && !e.ctrlKey && !e.metaKey){ openTxModal(null); }
      if(k==="r" && !e.ctrlKey && !e.metaKey){ renderList(); toast("Atualizado."); }
      if((e.ctrlKey||e.metaKey) && k==="e"){ e.preventDefault(); exportCSV(); }
      if((e.ctrlKey||e.metaKey) && k===","){ e.preventDefault(); openModal("settingsModal"); }
      if(k==="escape"){
        closeModal("txModal"); closeModal("settingsModal"); closeModal("recModal");
      }
    });

    /************************************************************
     * 15) Auth (an√¥nimo autom√°tico + op√ß√£o Google)
     ************************************************************/
    async function ensureAuth(){
      // Se j√° estiver logado, ok
      return new Promise((resolve)=>{
        auth.onAuthStateChanged(async (user)=>{
          if(user){
            state.uid = user.uid;
            state.email = user.email || null;
            $("btnSignOut").style.display = "inline-flex";
            $("userPill").textContent = state.email ? `Google: ${state.email}` : `An√¥nimo: ${state.uid.slice(0,8)}‚Ä¶`;
            resolve(user);
          } else {
            // login an√¥nimo autom√°tico (zero fric√ß√£o)
            try{
              const cred = await auth.signInAnonymously();
              resolve(cred.user);
            }catch(err){
              alert("Falha no login an√¥nimo: " + (err.message||err));
            }
          }
        });
      });
    }

    $("btnGoogle").addEventListener("click", async ()=>{
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
        toast("Logado com Google.");
      }catch(err){
        alert("Erro Google: " + (err.message||err));
      }
    });

    $("btnSignOut").addEventListener("click", async ()=>{
      const ok = confirm("Sair?");
      if(!ok) return;
      await auth.signOut();
      location.reload();
    });

    /************************************************************
     * 16) Boot
     ************************************************************/
    async function boot(){
      $("period").value = state.period;
      $("customRange").style.display = "none";
      $("dateFrom").value = nowISODate();
      $("dateTo").value = nowISODate();

      $("fType").value = "all";
      $("fStatus").value = "all";
      $("fSearch").value = "";

      await ensureAuth();
      await ensureSettings();
      listenTransactions();
      toast("Pronto. App financeiro Apple-level conectado.");
    }

    boot();
  </script>
</body>
</html>
