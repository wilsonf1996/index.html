<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Gest√£o Financeira Pessoal</title>
  <meta name="theme-color" content="#0b0d12" />
  <style>
    :root{
      --bg0:#07080b; --bg1:#0b0d12;
      --cardA: rgba(255,255,255,.09);
      --cardB: rgba(255,255,255,.03);
      --text:#eaf0ff; --muted:#9aa6c3; --line:rgba(255,255,255,.10);
      --good:#2dd4bf; --bad:#fb7185; --warn:#fbbf24; --brand:#60a5fa;
      --shadow: 0 20px 90px rgba(0,0,0,.58);
      --r:18px; --r2:26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text","Segoe UI", Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% -10%, rgba(96,165,250,.22), transparent 60%),
        radial-gradient(1000px 800px at 95% 10%, rgba(45,212,191,.14), transparent 55%),
        radial-gradient(900px 700px at 80% 115%, rgba(251,113,133,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 45%, #07090f 100%);
      overflow-x:hidden;
    }
    .safe{padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    .wrap{max-width:1280px; margin:0 auto; padding:22px 16px 88px;}
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 16px;
      margin:-22px -16px 14px;
      backdrop-filter: blur(18px);
      background: linear-gradient(180deg, rgba(7,8,11,.90), rgba(7,8,11,.35));
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background:
        radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(20px 20px at 70% 30%, rgba(255,255,255,.15), transparent 60%),
        linear-gradient(135deg, rgba(96,165,250,.95), rgba(45,212,191,.75));
      border:1px solid rgba(255,255,255,.15);
      box-shadow: 0 16px 48px rgba(96,165,250,.18);
    }
    .brand h1{margin:0; font-size:14px; letter-spacing:.2px; line-height:1.1}
    .brand p{margin:0; font-size:12px; color:var(--muted); line-height:1.2}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center}

    .btn{
      appearance:none; border:none; cursor:pointer;
      border-radius:12px; padding:10px 12px;
      color:var(--text);
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      font-size:13px;
      display:inline-flex; align-items:center; gap:9px;
      user-select:none;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }
    .btn:hover{background:rgba(255,255,255,.09); border-color:rgba(255,255,255,.14)}
    .btn:active{transform:scale(.985)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(45,212,191,.72));
      border-color: rgba(255,255,255,.18);
      color:#071017;
      font-weight:850;
    }
    .btn.danger{background:rgba(251,113,133,.14); border-color:rgba(251,113,133,.28)}
    .btn.ghost{background:transparent; box-shadow:none}
    .pill{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      border-radius:999px; padding:8px 10px;
      box-shadow: 0 6px 24px rgba(0,0,0,.25) inset;
    }
    .pill span{font-size:12px; color:var(--muted); max-width:320px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

    .grid{display:grid; grid-template-columns:1.32fr .68fr; gap:12px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .card{
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border:1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .title{display:flex; flex-direction:column; gap:4px;}
    .title h2{margin:0; font-size:14px; letter-spacing:.2px}
    .title p{margin:0; font-size:12px; color:var(--muted)}
    .card .bd{padding:14px 16px 16px;}

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      border-radius: 999px;
      padding:6px;
    }
    .tab{
      cursor:pointer;
      padding:9px 12px;
      border-radius: 999px;
      font-size:12px;
      border:1px solid transparent;
      color: rgba(233,240,255,.90);
      background: transparent;
      transition: background .15s ease, border-color .15s ease;
      user-select:none;
      display:flex; align-items:center; gap:8px;
    }
    .tab.active{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.12);
    }

    .kpis{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;}
    @media (max-width:980px){ .kpis{grid-template-columns: repeat(2, 1fr);} }
    .kpi{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius: var(--r);
      padding:12px;
      display:flex; flex-direction:column; gap:6px;
      min-height:78px;
    }
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-size:18px; font-weight:900; letter-spacing:.2px}
    .kpi .sub{font-size:11px; color:var(--muted)}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}

    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; justify-content:space-between;
      margin:12px 0 0;
    }
    .filters{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;}
    .field{display:flex; flex-direction:column; gap:6px; min-width:160px;}
    .field label{font-size:11px; color:var(--muted)}
    input, select, textarea{
      width:100%;
      background: rgba(0,0,0,.22);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding:10px 10px;
      color: var(--text);
      outline:none;
      font-family: var(--sans);
      font-size: 13px;
    }
    textarea{min-height:92px; resize: vertical;}
    input::placeholder, textarea::placeholder{color:rgba(154,166,195,.72)}
    input:focus, select:focus, textarea:focus{border-color: rgba(96,165,250,.55); box-shadow: 0 0 0 4px rgba(96,165,250,.12);}

    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width:680px){ .split{grid-template-columns:1fr;} }

    .divider{height:1px; background:var(--line); margin:12px 0;}

    .canvasBox{
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    canvas{width:100%; height:230px; display:block}
    .miniCanvas{height:210px;}
    .hint{font-size:12px; color:var(--muted); line-height:1.45}
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: rgba(233,238,252,.9);
    }

    .list{display:flex; flex-direction:column; gap:10px;}
    .tx{
      display:grid;
      grid-template-columns: 1.1fr .7fr .6fr .85fr;
      gap:10px;
      align-items:center;
      padding:12px;
      border-radius: var(--r);
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      cursor:pointer;
    }
    .tx:hover{border-color:rgba(255,255,255,.14); background: rgba(0,0,0,.22)}
    .tx:active{transform:scale(.995)}
    @media (max-width:820px){ .tx{grid-template-columns: 1fr; gap:8px;} }

    .tx .main{display:flex; flex-direction:column; gap:3px;}
    .tx .main .name{font-size:13px; font-weight:900}
    .tx .main .meta{font-size:11px; color:var(--muted); display:flex; flex-wrap:wrap; gap:8px}
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
    }
    .amount{
      text-align:right;
      font-family: var(--mono);
      font-size: 13px;
      font-weight:950;
    }
    .right{display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: 16px;
      z-index:999;
      background: rgba(15,18,26,.88);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding:10px 14px;
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      max-width:min(920px, calc(100% - 22px));
      display:none;
      font-size:13px;
      color: var(--text);
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .toast.show{display:flex}

    .modal{
      position:fixed; inset:0; display:none; place-items:center; z-index:1000;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      padding: 16px;
    }
    .modal.show{display:grid}
    .panel{
      width:min(980px, 100%);
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .phd{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .panel .phd .ttl{display:flex; flex-direction:column; gap:3px}
    .panel .phd h3{margin:0; font-size:14px}
    .panel .phd p{margin:0; font-size:12px; color:var(--muted)}
    .panel .pbd{padding:14px 16px 16px}

    .goal{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease;
    }
    .goal:hover{background: rgba(0,0,0,.22); border-color: rgba(255,255,255,.14)}
    .goalTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .goalName{font-weight:950; font-size:13px;}
    .goalMeta{font-size:11px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap; margin-top:4px;}
    .bar{
      height:10px; border-radius:999px; overflow:hidden;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.08);
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(96,165,250,.95), rgba(45,212,191,.72));
      border-radius:999px;
    }

    .noteBox{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding:10px 12px;
      font-size:12px;
      color: rgba(233,238,252,.92);
      line-height:1.35;
    }

    .budgetRow{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .budgetTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .budgetName{font-weight:950; font-size:13px;}
    .budgetMeta{font-size:11px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap;}
    .budgetBar{
      height:10px;
      border-radius:999px;
      overflow:hidden;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.08);
    }
    .budgetFill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(45,212,191,.9), rgba(96,165,250,.9));
    }

    .chartsGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:10px;
    }
    @media (max-width:980px){ .chartsGrid{grid-template-columns:1fr;} }
    .chartsRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width:820px){ .chartsRow{grid-template-columns:1fr;} }

    /* bottom nav for mobile */
    .bottomNav{
      position:fixed; left:0; right:0; bottom:0; z-index:60;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      backdrop-filter: blur(18px);
      background: linear-gradient(180deg, rgba(7,8,11,.15), rgba(7,8,11,.78));
      border-top: 1px solid var(--line);
      display:none;
    }
    .bottomNav .tabs{width:100%; justify-content:space-between;}
    @media (max-width:980px){
      .bottomNav{display:block;}
      .desktopTabs{display:none;}
      .wrap{padding-bottom:120px;}
    }
  </style>

  <!-- Firebase compat: SEM auth (sem login) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>

<body class="safe">
  <div class="wrap">
    <header class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Gest√£o Financeira Pessoal</h1>
          <p>Apple/Microsoft-level ‚Ä¢ Dashboard ‚Ä¢ Or√ßamento ‚Ä¢ Recorr√™ncias ‚Ä¢ Metas ‚Ä¢ Firebase</p>
        </div>
      </div>

      <div class="actions">
        <div class="pill" title="Banco de dados em uso">
          <span id="dbInfo">Conectando no Firebase‚Ä¶</span>
        </div>

        <div class="desktopTabs">
          <div class="tabs" id="tabsTop">
            <div class="tab active" data-tab="dash">üìä Dashboard</div>
            <div class="tab" data-tab="tx">üßæ Lan√ßamentos</div>
            <div class="tab" data-tab="goals">üéØ Metas</div>
            <div class="tab" data-tab="settings">‚öôÔ∏è Ajustes</div>
          </div>
        </div>

        <button class="btn ghost" id="btnExport" title="Exportar CSV">‚§ì CSV</button>
        <button class="btn ghost" id="btnPrint" title="Gerar PDF (imprimir)">üñ®Ô∏è PDF</button>
        <button class="btn primary" id="btnNew">Ôºã Lan√ßamento</button>
      </div>
    </header>

    <main class="grid">
      <!-- LEFT: Main content -->
      <section class="card" aria-label="Conte√∫do">
        <div class="hd">
          <div class="title">
            <h2 id="pageTitle">Dashboard</h2>
            <p id="pageSub">Resumo do per√≠odo + gr√°ficos + or√ßamento</p>
          </div>

          <div class="right">
            <div class="field" style="min-width:220px;">
              <label for="period">Per√≠odo</label>
              <select id="period">
                <option value="thisMonth">Este m√™s</option>
                <option value="lastMonth">M√™s passado</option>
                <option value="thisYear">Este ano</option>
                <option value="yearCompare">Ano (comparativo)</option>
                <option value="custom">Personalizado</option>
              </select>
            </div>
            <div class="field" id="customRange" style="min-width:280px; display:none;">
              <label>Intervalo</label>
              <div class="split">
                <input id="dateFrom" type="date" />
                <input id="dateTo" type="date" />
              </div>
            </div>
          </div>
        </div>

        <div class="bd">
          <!-- DASH -->
          <div id="viewDash">
            <div class="kpis">
              <div class="kpi">
                <div class="label">Saldo</div>
                <div class="value" id="kpiBalance">‚Äî</div>
                <div class="sub">Receitas ‚àí Despesas (pagas)</div>
              </div>
              <div class="kpi">
                <div class="label">Receitas</div>
                <div class="value good" id="kpiIncome">‚Äî</div>
                <div class="sub">No per√≠odo</div>
              </div>
              <div class="kpi">
                <div class="label">Despesas</div>
                <div class="value bad" id="kpiExpense">‚Äî</div>
                <div class="sub">No per√≠odo</div>
              </div>
              <div class="kpi">
                <div class="label">Or√ßamento (m√™s)</div>
                <div class="value" id="kpiBudget">‚Äî</div>
                <div class="sub" id="kpiBudgetSub">Gasto / Limite</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="toolbar">
              <div class="filters">
                <div class="field">
                  <label for="fType">Tipo</label>
                  <select id="fType">
                    <option value="all">Tudo</option>
                    <option value="expense">Despesas</option>
                    <option value="income">Receitas</option>
                  </select>
                </div>
                <div class="field">
                  <label for="fStatus">Status</label>
                  <select id="fStatus">
                    <option value="all">Todos</option>
                    <option value="paid">Pago/Recebido</option>
                    <option value="pending">Pendente</option>
                  </select>
                </div>
                <div class="field">
                  <label for="fSource">Fonte</label>
                  <select id="fSource"></select>
                </div>
                <div class="field">
                  <label for="fCategory">Categoria</label>
                  <select id="fCategory"></select>
                </div>
                <div class="field" style="min-width:240px;">
                  <label for="fSearch">Buscar</label>
                  <input id="fSearch" placeholder="Ex: aluguel, mercado, empresa, sal√°rio‚Ä¶" />
                </div>
              </div>

              <div class="right">
                <button class="btn" id="btnDemo" title="Criar exemplos">‚ú® Demo</button>
                <button class="btn" id="btnRefresh" title="Atualizar">‚ü≥ Atualizar</button>
              </div>
            </div>

            <div class="chartsGrid" style="margin-top:12px;">
              <div>
                <div class="canvasBox">
                  <canvas id="chartBalance"></canvas>
                </div>
                <div class="hint" style="margin-top:8px;">
                  Gr√°fico: <b>saldo acumulado</b> no per√≠odo.
                  Atalho: <span class="kbd">N</span> novo ‚Ä¢ <span class="kbd">Ctrl+E</span> CSV ‚Ä¢ <span class="kbd">Esc</span> fechar
                </div>
              </div>
              <div>
                <div class="canvasBox">
                  <canvas id="chartFlow" class="miniCanvas"></canvas>
                </div>
                <div class="hint" style="margin-top:8px;">
                  <b>Receitas vs Despesas</b> (pagas) no per√≠odo.
                </div>
              </div>
            </div>

            <div class="chartsRow">
              <div>
                <div class="canvasBox">
                  <canvas id="chartDonut" class="miniCanvas"></canvas>
                </div>
                <div class="hint" style="margin-top:8px;">
                  <b>Categorias (Despesas pagas)</b> no per√≠odo.
                </div>
              </div>
              <div>
                <div class="canvasBox">
                  <canvas id="chartPareto" class="miniCanvas"></canvas>
                </div>
                <div class="hint" style="margin-top:8px;">
                  <b>Pareto</b>: Top categorias + % acumulado.
                </div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="title" style="margin-bottom:10px;">
              <h2 style="margin:0; font-size:13px;">Or√ßamento por categoria (m√™s atual)</h2>
              <p style="margin:0; font-size:12px; color:var(--muted)">Alertas autom√°ticos em 80% e 100%+</p>
            </div>
            <div class="list" id="budgetsList"></div>

            <div class="divider"></div>

            <div class="title" style="margin-bottom:10px;">
              <h2 style="margin:0; font-size:13px;">Lan√ßamentos (do per√≠odo)</h2>
              <p style="margin:0; font-size:12px; color:var(--muted)">Clique para editar.</p>
            </div>

            <div class="list" id="txList"></div>
          </div>

          <!-- TX -->
          <div id="viewTx" style="display:none;">
            <div class="noteBox">
              Aqui voc√™ v√™ todos os lan√ßamentos com filtros e a√ß√µes r√°pidas.
              Use <b>Fonte</b> para diferenciar: <b>Sal√°rio</b>, <b>Empresa</b>, <b>Freela</b> etc.
            </div>
            <div class="divider"></div>
            <div class="list" id="txListAll"></div>
          </div>

          <!-- GOALS -->
          <div id="viewGoals" style="display:none;">
            <div class="toolbar" style="margin-top:0;">
              <div class="title">
                <h2 style="margin:0; font-size:13px;">Metas</h2>
                <p style="margin:0; font-size:12px; color:var(--muted)">Progresso + v√≠nculo opcional por lan√ßamento</p>
              </div>
              <div class="right">
                <button class="btn primary" id="btnNewGoal">Ôºã Meta</button>
              </div>
            </div>
            <div class="divider"></div>
            <div class="noteBox" id="goalsSummary">Carregando metas‚Ä¶</div>
            <div class="divider"></div>
            <div class="list" id="goalsList"></div>
          </div>

          <!-- SETTINGS -->
          <div id="viewSettings" style="display:none;">
            <div class="noteBox">
              Ajustes reais do app: <b>fontes</b>, <b>categorias</b>, <b>contas</b>, <b>or√ßamentos</b> e <b>recorr√™ncias</b>.
              Isso deixa o app ‚Äúde verdade‚Äù, tipo iOS.
            </div>

            <div class="divider"></div>

            <div class="split">
              <div class="field">
                <label for="stCurrency">Moeda</label>
                <select id="stCurrency">
                  <option value="BRL">BRL (R$)</option>
                  <option value="USD">USD ($)</option>
                  <option value="EUR">EUR (‚Ç¨)</option>
                </select>
              </div>
              <div class="noteBox">
                <b>Fonte</b> = de onde veio/para onde foi o dinheiro.<br>
                Ex: <b>Sal√°rio</b>, <b>Empresa</b> (entrada/sa√≠da), Freela‚Ä¶
              </div>
            </div>

            <div class="divider"></div>

            <div class="split">
              <div class="field">
                <label for="stSources">Fontes (uma por linha)</label>
                <textarea id="stSources"></textarea>
              </div>
              <div class="field">
                <label for="stCategories">Categorias (uma por linha)</label>
                <textarea id="stCategories"></textarea>
              </div>
            </div>

            <div class="split" style="margin-top:10px;">
              <div class="field">
                <label for="stAccounts">Contas (uma por linha)</label>
                <textarea id="stAccounts"></textarea>
              </div>
              <div class="field">
                <label for="stBudgets">Or√ßamento mensal por categoria (Categoria=valor)</label>
                <textarea id="stBudgets"></textarea>
              </div>
            </div>

            <div class="divider"></div>

            <div class="title" style="margin-bottom:8px;">
              <h2 style="margin:0; font-size:13px;">Recorr√™ncias (Sal√°rio, Aluguel, Assinaturas, etc.)</h2>
              <p style="margin:0; font-size:12px; color:var(--muted)">Cria automaticamente os lan√ßamentos do m√™s, sem duplicar.</p>
            </div>

            <div class="split">
              <div class="field">
                <label for="stRecurring">Regras (1 por linha)</label>
                <textarea id="stRecurring" placeholder="Formato:
Nome|tipo(income/expense)|valor|dia(1-28)|Fonte|Categoria|Conta|status(paid/pending)|metaId(opcional)

Ex:
Sal√°rio|income|9000|5|Sal√°rio|Outros|Banco|paid|
Aluguel|expense|2500|2|Empresa|Moradia|Banco|paid|
Netflix|expense|55,90|10|Empresa|Lazer|Cart√£o|paid|
"></textarea>
              </div>
              <div class="noteBox">
                ‚Ä¢ Dia 1‚Äì28 para evitar m√™s curto<br>
                ‚Ä¢ ‚ÄúEmpresa‚Äù pode ser entrada e sa√≠da<br>
                ‚Ä¢ Anti-duplica√ß√£o: marca em <span class="kbd">/finance_recurring_generated</span><br><br>
                <b>Dica:</b> depois de configurar, clique em ‚ÄúGerar recorr√™ncias deste m√™s‚Äù.
              </div>
            </div>

            <div class="divider"></div>

            <div class="right">
              <button class="btn" id="btnGenRecurring">üß† Gerar recorr√™ncias deste m√™s</button>
              <button class="btn" id="btnMigrate" title="Converter formato antigo (array) para /expenses/{id}">
                üß© Migrar antigo
              </button>
              <button class="btn primary" id="btnSaveSettings">‚úî Salvar Ajustes</button>
            </div>

            <div class="hint" style="margin-top:10px;">
              Salvo em: <span class="kbd">/finance_settings</span>, <span class="kbd">/finance_recurring</span> e dados em <span class="kbd">/expenses</span>.
            </div>

            <div class="divider"></div>

            <div class="title" style="margin-bottom:8px;">
              <h2 style="margin:0; font-size:13px;">Vis√£o anual (comparativo)</h2>
              <p style="margin:0; font-size:12px; color:var(--muted)">V√° em Per√≠odo ‚Üí ‚ÄúAno (comparativo)‚Äù para ver 12 meses.</p>
            </div>

            <div class="canvasBox">
              <canvas id="chartYear" class="miniCanvas"></canvas>
            </div>
            <div class="hint" style="margin-top:8px;">
              Gr√°fico anual: receitas, despesas e saldo por m√™s (pagos).
            </div>

          </div>
        </div>
      </section>

      <!-- RIGHT: Side panel -->
      <aside class="card" aria-label="A√ß√µes r√°pidas">
        <div class="hd">
          <div class="title">
            <h2>Atalhos</h2>
            <p>R√°pido, limpo e ‚ÄúApple feel‚Äù</p>
          </div>
          <button class="btn ghost" id="btnHome">‚Ü© Principal</button>
        </div>

        <div class="bd">
          <div class="noteBox">
            ‚úÖ Sem login por enquanto<br>
            ‚úÖ Mant√©m seu banco (<b>/expenses</b>)<br>
            ‚úÖ ‚ÄúEmpresa‚Äù √© <b>Fonte</b> (entra e sai)<br>
            ‚úÖ Or√ßamento + gr√°ficos + recorr√™ncias + ano comparativo
          </div>

          <div class="divider"></div>

          <div class="title">
            <h2 style="margin:0; font-size:13px;">Metas em destaque</h2>
            <p style="margin:0; font-size:12px; color:var(--muted)">Clique para editar</p>
          </div>
          <div style="margin-top:10px;" class="list" id="goalsMini"></div>

          <div class="divider"></div>

          <div class="right">
            <button class="btn ghost" id="btnExport2">‚§ì CSV</button>
            <button class="btn ghost" id="btnPrint2">üñ®Ô∏è PDF</button>
          </div>

          <div class="divider"></div>

          <div class="hint">
            Atalhos: <span class="kbd">N</span> novo ‚Ä¢ <span class="kbd">Ctrl+E</span> CSV ‚Ä¢ <span class="kbd">Esc</span> fechar
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Mobile bottom nav -->
  <div class="bottomNav">
    <div class="tabs" id="tabsBottom">
      <div class="tab active" data-tab="dash">üìä</div>
      <div class="tab" data-tab="tx">üßæ</div>
      <div class="tab" data-tab="goals">üéØ</div>
      <div class="tab" data-tab="settings">‚öôÔ∏è</div>
    </div>
  </div>

  <!-- MODAL: Transaction -->
  <div class="modal" id="txModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="txTitle">
      <div class="phd">
        <div class="ttl">
          <h3 id="txTitle">Novo lan√ßamento</h3>
          <p>Receita/Despesa + Fonte (Sal√°rio/Empresa/etc)</p>
        </div>
        <div class="right">
          <button class="btn ghost" id="btnCloseTx">‚úï</button>
          <button class="btn danger" id="btnDeleteTx" style="display:none;">üóëÔ∏è</button>
          <button class="btn primary" id="btnSaveTx">Salvar</button>
        </div>
      </div>

      <div class="pbd">
        <div class="split">
          <div class="field">
            <label for="txType">Tipo</label>
            <select id="txType">
              <option value="expense">Despesa</option>
              <option value="income">Receita</option>
            </select>
          </div>
          <div class="field">
            <label for="txStatus">Status</label>
            <select id="txStatus">
              <option value="paid">Pago/Recebido</option>
              <option value="pending">Pendente</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="split">
          <div class="field">
            <label for="txDate">Data</label>
            <input id="txDate" type="date" />
          </div>
          <div class="field">
            <label for="txTime">Hora</label>
            <input id="txTime" type="time" />
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="txName">Descri√ß√£o</label>
            <input id="txName" placeholder="Ex: Mercado, Cliente X, Aluguel‚Ä¶" maxlength="80" />
          </div>
          <div class="field">
            <label for="txAmount">Valor</label>
            <input id="txAmount" inputmode="decimal" placeholder="Ex: 123,45" />
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="txSource">Fonte</label>
            <select id="txSource"></select>
          </div>
          <div class="field">
            <label for="txCategory">Categoria</label>
            <select id="txCategory"></select>
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="txAccount">Conta</label>
            <select id="txAccount"></select>
          </div>
          <div class="field">
            <label for="txGoalLink">Vincular √† meta (opcional)</label>
            <select id="txGoalLink"></select>
          </div>
        </div>

        <div class="field" style="margin-top:10px;">
          <label for="txNote">Observa√ß√µes (opcional)</label>
          <textarea id="txNote" placeholder="Detalhes, notas, etc‚Ä¶"></textarea>
        </div>

        <div class="hint" id="txFoot"></div>
      </div>
    </div>
  </div>

  <!-- MODAL: Goal -->
  <div class="modal" id="goalModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="goalTitle">
      <div class="phd">
        <div class="ttl">
          <h3 id="goalTitle">Meta</h3>
          <p>Crie/edite metas e registre aportes</p>
        </div>
        <div class="right">
          <button class="btn ghost" id="btnCloseGoal">‚úï</button>
          <button class="btn danger" id="btnDeleteGoal" style="display:none;">üóëÔ∏è</button>
          <button class="btn primary" id="btnSaveGoal">Salvar</button>
        </div>
      </div>

      <div class="pbd">
        <div class="split">
          <div class="field">
            <label for="gName">Nome</label>
            <input id="gName" placeholder="Ex: Reserva de emerg√™ncia" />
          </div>
          <div class="field">
            <label for="gTarget">Valor alvo</label>
            <input id="gTarget" inputmode="decimal" placeholder="Ex: 20000,00" />
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="gDue">Prazo (opcional)</label>
            <input id="gDue" type="date" />
          </div>
          <div class="field">
            <label for="gCurrent">Atual (auto ou manual)</label>
            <input id="gCurrent" inputmode="decimal" placeholder="Ex: 1500,00" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="hint" id="goalFoot"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <div class="msg" id="toastMsg">‚Äî</div>
    <button class="btn ghost" id="toastClose">OK</button>
  </div>

  <script>
    /************************************************************
     * FirebaseConfig (EXATAMENTE o mesmo que voc√™ enviou)
     ************************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyAIp-rFuZZsBCNVJ3pSge4TE-XUuwYygrI",
      authDomain: "agenda-6accc.firebaseapp.com",
      databaseURL: "https://agenda-6accc-default-rtdb.firebaseio.com",
      projectId: "agenda-6accc",
      storageBucket: "agenda-6accc.appspot.com",
      messagingSenderId: "794262176773",
      appId: "1:794262176773:web:c4e3837b29f635d5dc086c",
      measurementId: "G-CVBQ54PERH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const $ = (id)=>document.getElementById(id);

    const PATH = {
      expenses: "/expenses",                       // mant√©m o mesmo do seu app original
      settings: "/finance_settings",
      goals: "/finance_goals",
      recurring: "/finance_recurring",
      recurringGenerated: "/finance_recurring_generated"
    };

    const defaults = {
      currency: "BRL",
      sources: ["Sal√°rio","Empresa","Freela","Investimentos","Outros"],
      categories: ["Moradia","Alimenta√ß√£o","Transporte","Lazer","Sa√∫de","Educa√ß√£o","Impostos","Outros"],
      accounts: ["Banco","Carteira","Cart√£o","Investimentos"],
      budgets: { "Moradia": 2500, "Alimenta√ß√£o": 1200, "Transporte": 600, "Lazer": 400 }
    };

    const state = {
      settings: {...defaults},
      tx: [],
      goals: [],
      recurring: [],
      period: "thisMonth",
      range: {from:null, to:null},
      filters: { type:"all", status:"all", source:"all", category:"all", search:"" },
      editingTxId: null,
      editingGoalId: null,
      rawExpensesIsArray: false
    };

    function toast(msg){
      $("toastMsg").textContent = msg;
      $("toast").classList.add("show");
      setTimeout(()=> $("toast").classList.remove("show"), 2600);
    }
    $("toastClose").addEventListener("click", ()=> $("toast").classList.remove("show"));

    function openModal(id){ $(id).classList.add("show"); }
    function closeModal(id){ $(id).classList.remove("show"); }

    function nowISODate(){
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }
    function nowISOTime(){
      const d = new Date();
      return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }
    function startOfMonth(d=new Date()){ return new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0,0); }
    function endOfMonth(d=new Date()){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); }
    function startOfYear(d=new Date()){ return new Date(d.getFullYear(), 0, 1, 0,0,0,0); }
    function endOfYear(d=new Date()){ return new Date(d.getFullYear(), 11, 31, 23,59,59,999); }

    function clampRange(){
      const now = new Date();
      if(state.period==="thisMonth"){
        state.range.from = startOfMonth(now);
        state.range.to = endOfMonth(now);
      }else if(state.period==="lastMonth"){
        const prev = new Date(now.getFullYear(), now.getMonth()-1, 15);
        state.range.from = startOfMonth(prev);
        state.range.to = endOfMonth(prev);
      }else if(state.period==="thisYear"){
        state.range.from = startOfYear(now);
        state.range.to = endOfYear(now);
      }else if(state.period==="yearCompare"){
        state.range.from = startOfYear(now);
        state.range.to = endOfYear(now);
      }else{
        const f = $("dateFrom").value ? new Date($("dateFrom").value+"T00:00:00") : startOfMonth(now);
        const t = $("dateTo").value ? new Date($("dateTo").value+"T23:59:59") : endOfMonth(now);
        state.range.from = f;
        state.range.to = t;
      }
    }

    function fmtMoney(v){
      const cur = state.settings.currency || "BRL";
      try{
        return new Intl.NumberFormat("pt-BR",{style:"currency",currency:cur}).format(v||0);
      }catch{
        return `R$ ${(v||0).toFixed(2)}`;
      }
    }
    function toNumberCurrency(str){
      if(typeof str !== "string") return Number(str||0);
      const s = str.trim().replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,"");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function safeText(s){
      return String(s ?? "").replace(/[<>]/g,"").trim();
    }

    function setSelectOptions(select, items, includeAll=true, allLabel="Todas"){
      select.innerHTML="";
      if(includeAll){
        const o=document.createElement("option");
        o.value="all"; o.textContent=allLabel;
        select.appendChild(o);
      }
      (items||[]).forEach(v=>{
        const o=document.createElement("option");
        o.value=v; o.textContent=v;
        select.appendChild(o);
      });
    }

    function budgetsToText(obj){
      const keys = Object.keys(obj||{}).sort((a,b)=>a.localeCompare(b));
      return keys.map(k=>`${k}=${Number(obj[k]||0)}`).join("\n");
    }
    function parseBudgets(text){
      const out={};
      (text||"").split("\n").map(l=>l.trim()).filter(Boolean).forEach(line=>{
        const [k,v]=line.split("=");
        const key=(k||"").trim();
        if(!key) return;
        out[key]=toNumberCurrency((v||"").trim());
      });
      return out;
    }

    function recurringToText(list){
      return (list||[]).map(r=>{
        return [
          r.name||"",
          r.type||"expense",
          String(Number(r.amount||0)).replace(".",","),
          String(r.day||1),
          r.source||"",
          r.category||"",
          r.account||"",
          r.status||"paid",
          r.goalId||""
        ].join("|");
      }).join("\n");
    }

    function parseRecurring(text){
      const rows=(text||"").split("\n").map(l=>l.trim()).filter(Boolean);
      const out=[];
      for(const line of rows){
        const parts=line.split("|").map(x=>x.trim());
        if(parts.length<7) continue;
        const [name,type,amount,day,source,category,account,status,goalId] = parts;
        const t = (type==="income") ? "income" : "expense";
        const a = toNumberCurrency(amount);
        const d = Math.min(28, Math.max(1, parseInt(day||"1",10) || 1));
        out.push({
          id: "", // set when saving
          name: safeText(name||"Recorr√™ncia"),
          type: t,
          amount: Number.isFinite(a)?a:0,
          day: d,
          source: source||"",
          category: category||"",
          account: account||"",
          status: (status==="pending") ? "pending" : "paid",
          goalId: goalId||""
        });
      }
      return out;
    }

    function syncSelects(){
      setSelectOptions($("fSource"), state.settings.sources, true, "Todas");
      setSelectOptions($("fCategory"), state.settings.categories, true, "Todas");
      $("fSource").value = state.filters.source;
      $("fCategory").value = state.filters.category;

      // form tx
      $("txSource").innerHTML="";
      state.settings.sources.forEach(v=>{
        const o=document.createElement("option"); o.value=v; o.textContent=v; $("txSource").appendChild(o);
      });
      $("txCategory").innerHTML="";
      state.settings.categories.forEach(v=>{
        const o=document.createElement("option"); o.value=v; o.textContent=v; $("txCategory").appendChild(o);
      });
      $("txAccount").innerHTML="";
      state.settings.accounts.forEach(v=>{
        const o=document.createElement("option"); o.value=v; o.textContent=v; $("txAccount").appendChild(o);
      });

      // metas no select
      $("txGoalLink").innerHTML="";
      const none=document.createElement("option");
      none.value=""; none.textContent="Nenhuma";
      $("txGoalLink").appendChild(none);
      (state.goals||[]).forEach(g=>{
        const o=document.createElement("option"); o.value=g.id; o.textContent=g.name;
        $("txGoalLink").appendChild(o);
      });
    }

    /************************************************************
     * SETTINGS + GOALS + RECURRING
     ************************************************************/
    async function loadSettings(){
      const snap = await db.ref(PATH.settings).get().catch(()=>null);
      if(snap && snap.exists()){
        const v = snap.val();
        state.settings = {
          currency: v.currency || defaults.currency,
          sources: Array.isArray(v.sources) && v.sources.length ? v.sources : defaults.sources,
          categories: Array.isArray(v.categories) && v.categories.length ? v.categories : defaults.categories,
          accounts: Array.isArray(v.accounts) && v.accounts.length ? v.accounts : defaults.accounts,
          budgets: v.budgets && typeof v.budgets==="object" ? v.budgets : defaults.budgets
        };
      }else{
        await db.ref(PATH.settings).set(defaults);
        state.settings = {...defaults};
      }

      $("stCurrency").value = state.settings.currency;
      $("stSources").value = state.settings.sources.join("\n");
      $("stCategories").value = state.settings.categories.join("\n");
      $("stAccounts").value = state.settings.accounts.join("\n");
      $("stBudgets").value = budgetsToText(state.settings.budgets);

      syncSelects();
    }

    function listenRecurring(){
      db.ref(PATH.recurring).on("value",(snap)=>{
        const v = snap.val() || {};
        const list = Object.keys(v).map(id=>{
          const r=v[id]||{};
          return {
            id,
            name: r.name||"Recorr√™ncia",
            type: (r.type==="income")?"income":"expense",
            amount: Number(r.amount||0),
            day: Math.min(28, Math.max(1, parseInt(r.day||"1",10) || 1)),
            source: r.source||"",
            category: r.category||"",
            account: r.account||"",
            status: (r.status==="pending")?"pending":"paid",
            goalId: r.goalId||""
          };
        });
        state.recurring = list;
        $("stRecurring").value = recurringToText(list);
        renderYearChart(); // mant√©m atual
      });
    }

    async function saveSettings(){
      const next = {
        currency: $("stCurrency").value || "BRL",
        sources: $("stSources").value.split("\n").map(s=>s.trim()).filter(Boolean),
        categories: $("stCategories").value.split("\n").map(s=>s.trim()).filter(Boolean),
        accounts: $("stAccounts").value.split("\n").map(s=>s.trim()).filter(Boolean),
        budgets: parseBudgets($("stBudgets").value)
      };
      if(!next.sources.length) next.sources = defaults.sources.slice();
      if(!next.categories.length) next.categories = defaults.categories.slice();
      if(!next.accounts.length) next.accounts = defaults.accounts.slice();

      // Recorr√™ncias
      const rec = parseRecurring($("stRecurring").value);
      // sobrescreve /finance_recurring (com ids novos)
      const recObj = {};
      for(const r of rec){
        const ref = db.ref(PATH.recurring).push();
        const id = ref.key;
        recObj[id] = { id, ...r, createdAt: Date.now(), updatedAt: Date.now() };
      }

      await db.ref(PATH.settings).set(next);
      await db.ref(PATH.recurring).set(recObj);

      state.settings = next;

      if(state.filters.source!=="all" && !next.sources.includes(state.filters.source)) state.filters.source="all";
      if(state.filters.category!=="all" && !next.categories.includes(state.filters.category)) state.filters.category="all";

      syncSelects();
      renderAll();
      toast("Ajustes e recorr√™ncias salvos.");
    }

    function listenGoals(){
      db.ref(PATH.goals).on("value",(snap)=>{
        const v = snap.val() || {};
        const list = Object.values(v).filter(Boolean).map(g=>({
          id: g.id,
          name: g.name || "Meta",
          target: Number(g.target||0),
          current: Number(g.current||0),
          due: g.due || ""
        }));
        state.goals = list;
        syncSelects();
        renderGoals();
      });
    }

    /************************************************************
     * Leitura do /expenses mantendo compatibilidade
     ************************************************************/
    function normalizeExpenseItem(id, raw){
      const type = raw.type === "income" ? "income" : "expense";

      let ts = 0;
      if(raw.ts) ts = Number(raw.ts);
      else if(raw.dateTime) ts = new Date(raw.dateTime).getTime();
      else ts = Date.now();

      const name = raw.name || raw.description || "Sem descri√ß√£o";
      const amount = Number(raw.amount || 0);
      const status = raw.status || "paid";

      return {
        id,
        type,
        status,
        ts,
        name: safeText(name),
        amount: Number.isFinite(amount) ? amount : 0,
        source: raw.source || (type==="income" ? "Sal√°rio" : "Empresa"),
        category: raw.category || "Outros",
        account: raw.account || "Banco",
        note: raw.note || "",
        goalId: raw.goalId || "",
        recurringKey: raw.recurringKey || ""
      };
    }

    function listenExpenses(){
      db.ref(PATH.expenses).on("value",(snap)=>{
        const v = snap.val();

        state.rawExpensesIsArray = Array.isArray(v);

        let list = [];
        if(Array.isArray(v)){
          list = v.map((raw, idx)=> raw ? normalizeExpenseItem(String(idx), raw) : null).filter(Boolean);
        }else if(v && typeof v === "object"){
          list = Object.keys(v).map(id=> normalizeExpenseItem(id, v[id])).filter(Boolean);
        }else{
          list = [];
        }

        list.sort((a,b)=>b.ts-a.ts);
        state.tx = list;

        $("dbInfo").textContent = `DB: /expenses ‚Ä¢ itens: ${state.tx.length}` + (state.rawExpensesIsArray ? " ‚Ä¢ (formato antigo detectado)" : "");
        renderAll();
        renderYearChart();
      });
    }

    /************************************************************
     * CRUD Lan√ßamentos
     ************************************************************/
    function openTxModal(t=null){
      state.editingTxId = t ? t.id : null;
      $("txTitle").textContent = t ? "Editar lan√ßamento" : "Novo lan√ßamento";
      $("btnDeleteTx").style.display = t ? "inline-flex" : "none";

      const d = t ? new Date(t.ts) : new Date();
      $("txDate").value = t ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}` : nowISODate();
      $("txTime").value = t ? `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}` : nowISOTime();

      $("txType").value = t?.type || "expense";
      $("txStatus").value = t?.status || "paid";
      $("txName").value = t?.name || "";
      $("txAmount").value = t?.amount != null ? String(t.amount).replace(".",",") : "";
      $("txNote").value = t?.note || "";

      syncSelects();
      $("txSource").value = t?.source || (t?.type==="income" ? "Sal√°rio" : "Empresa");
      if(!state.settings.sources.includes($("txSource").value)) $("txSource").value = state.settings.sources[0] || "Empresa";

      $("txCategory").value = t?.category || "Outros";
      if(!state.settings.categories.includes($("txCategory").value)) $("txCategory").value = state.settings.categories[0] || "Outros";

      $("txAccount").value = t?.account || "Banco";
      if(!state.settings.accounts.includes($("txAccount").value)) $("txAccount").value = state.settings.accounts[0] || "Banco";

      $("txGoalLink").value = t?.goalId || "";

      $("txFoot").textContent = t ? `ID: ${t.id}` : "Dica: use Fonte=Empresa para entradas e sa√≠das do dia a dia.";
      openModal("txModal");
    }

    function txFromForm(){
      const type = $("txType").value;
      const status = $("txStatus").value;
      const date = $("txDate").value || nowISODate();
      const time = $("txTime").value || "12:00";
      const ts = new Date(`${date}T${time}:00`).getTime();

      const name = safeText($("txName").value);
      const amount = toNumberCurrency($("txAmount").value);
      const source = $("txSource").value || "";
      const category = $("txCategory").value || "";
      const account = $("txAccount").value || "";
      const note = safeText($("txNote").value);
      const goalId = $("txGoalLink").value || "";

      if(!name || !Number.isFinite(amount) || amount<=0) throw new Error("Preencha descri√ß√£o e valor (>0).");

      return { type, status, ts, name, amount, source, category, account, note, goalId };
    }

    async function saveTx(){
      try{
        const data = txFromForm();

        if(state.rawExpensesIsArray){
          const ok = confirm("Detectei o formato antigo (array) em /expenses.\nRecomendado migrar para o formato novo (/expenses/{id}).\n\nDeseja salvar mesmo assim (pode sobrescrever itens)?");
          if(!ok) return;

          const idx = state.editingTxId ? Number(state.editingTxId) : state.tx.length;
          const arr = (await db.ref(PATH.expenses).get()).val();
          const list = Array.isArray(arr) ? arr.slice() : [];
          const legacy = {
            dateTime: new Date(data.ts).toISOString().slice(0,16),
            description: data.name,
            amount: data.amount,
            type: data.type
          };
          list[idx] = legacy;
          await db.ref(PATH.expenses).set(list);
          toast("Salvo (formato antigo).");
          closeModal("txModal");
          return;
        }

        if(state.editingTxId){
          await db.ref(`${PATH.expenses}/${state.editingTxId}`).update({ ...data, updatedAt: Date.now() });
          toast("Lan√ßamento atualizado.");
        }else{
          const ref = db.ref(PATH.expenses).push();
          const id = ref.key;
          await ref.set({ id, ...data, createdAt: Date.now(), updatedAt: Date.now() });
          toast("Lan√ßamento criado.");
        }

        if(data.goalId) await recomputeGoalCurrent(data.goalId);

        closeModal("txModal");
      }catch(err){
        alert(err.message || "Erro ao salvar.");
      }
    }

    async function deleteTx(t){
      const ok = confirm("Excluir este lan√ßamento?");
      if(!ok) return;

      if(state.rawExpensesIsArray){
        const arr = (await db.ref(PATH.expenses).get()).val();
        const list = Array.isArray(arr) ? arr.slice() : [];
        list[Number(t.id)] = null;
        await db.ref(PATH.expenses).set(list);
        toast("Exclu√≠do (formato antigo).");
        return;
      }

      await db.ref(`${PATH.expenses}/${t.id}`).remove();
      toast("Exclu√≠do.");
      if(t.goalId) await recomputeGoalCurrent(t.goalId);
    }

    async function toggleStatus(t){
      const next = (t.status||"paid")==="paid" ? "pending" : "paid";

      if(state.rawExpensesIsArray){
        toast("No formato antigo n√£o h√° status. Migre para usar status.");
        return;
      }

      await db.ref(`${PATH.expenses}/${t.id}/status`).set(next);
      toast(next==="paid" ? "Marcado como pago." : "Marcado como pendente.");
      if(t.goalId) await recomputeGoalCurrent(t.goalId);
    }

    /************************************************************
     * Metas
     ************************************************************/
    function openGoalModal(g=null){
      state.editingGoalId = g ? g.id : null;
      $("goalTitle").textContent = g ? "Editar meta" : "Nova meta";
      $("btnDeleteGoal").style.display = g ? "inline-flex" : "none";

      $("gName").value = g?.name || "";
      $("gTarget").value = g?.target != null ? String(g.target).replace(".",",") : "";
      $("gCurrent").value = g?.current != null ? String(g.current).replace(".",",") : "0";
      $("gDue").value = g?.due || "";
      $("goalFoot").textContent = g ? `ID: ${g.id}` : "Dica: vincule lan√ßamentos √† meta para recalcular automaticamente.";
      openModal("goalModal");
    }

    async function saveGoal(){
      const name = safeText($("gName").value);
      const target = toNumberCurrency($("gTarget").value);
      const current = toNumberCurrency($("gCurrent").value);
      const due = $("gDue").value || "";

      if(!name) return alert("Informe o nome da meta.");
      if(!Number.isFinite(target) || target<=0) return alert("Informe o valor alvo (>0).");

      if(state.editingGoalId){
        await db.ref(`${PATH.goals}/${state.editingGoalId}`).update({
          name, target, current: Math.max(0,current), due, updatedAt: Date.now()
        });
        toast("Meta atualizada.");
      }else{
        const ref = db.ref(PATH.goals).push();
        const id = ref.key;
        await ref.set({ id, name, target, current: Math.max(0,current), due, createdAt: Date.now(), updatedAt: Date.now() });
        toast("Meta criada.");
      }
      closeModal("goalModal");
    }

    async function deleteGoal(g){
      const ok = confirm("Excluir esta meta?");
      if(!ok) return;
      await db.ref(`${PATH.goals}/${g.id}`).remove();
      toast("Meta exclu√≠da.");
      closeModal("goalModal");
    }

    async function recomputeGoalCurrent(goalId){
      const related = state.tx.filter(t=>t.goalId===goalId && (t.status||"paid")==="paid");
      const sum = related.reduce((s,t)=> s + Math.abs(Number(t.amount||0)), 0);
      await db.ref(`${PATH.goals}/${goalId}/current`).set(sum);
    }

    /************************************************************
     * Migrar formato antigo (array) -> novo (/expenses/{id})
     ************************************************************/
    async function migrateLegacy(){
      const snap = await db.ref(PATH.expenses).get().catch(()=>null);
      if(!snap || !snap.exists()){
        alert("N√£o h√° dados em /expenses.");
        return;
      }
      const v = snap.val();
      if(!Array.isArray(v)){
        alert("Seu /expenses j√° est√° no formato novo (por id).");
        return;
      }
      const arr = v.filter(Boolean);
      if(!arr.length){
        alert("Array antigo est√° vazio.");
        return;
      }
      const ok = confirm(`Vou migrar ${arr.length} itens do array antigo para o formato novo (/expenses/{id}).\n\nIsso vai substituir o n√≥ /expenses pelo formato novo.\n\nContinuar?`);
      if(!ok) return;

      const obj = {};
      arr.forEach((raw)=>{
        const ref = db.ref(PATH.expenses).push();
        const id = ref.key;
        const t = normalizeExpenseItem(id, raw);
        obj[id] = { id, ...t, createdAt: Date.now(), updatedAt: Date.now() };
        obj[id].description = t.name;
        obj[id].dateTime = new Date(t.ts).toISOString().slice(0,16);
      });

      await db.ref(PATH.expenses).set(obj);
      toast("Migra√ß√£o conclu√≠da. Agora voc√™ tem status/fonte/categoria/conta.");
    }

    /************************************************************
     * Recorr√™ncias: gerar m√™s (anti-duplica√ß√£o)
     ************************************************************/
    function ymKey(d=new Date()){
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    }

    async function generateRecurringForThisMonth(){
      if(state.rawExpensesIsArray){
        alert("Para recorr√™ncias com anti-duplica√ß√£o, migre o /expenses para o formato novo primeiro (Ajustes ‚Üí Migrar antigo).");
        return;
      }

      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth(); // 0-11
      const ym = ymKey(now);

      const rules = state.recurring || [];
      if(!rules.length){
        alert("Sem regras de recorr√™ncia. Cadastre em Ajustes e salve.");
        return;
      }

      let created = 0;
      for(const r of rules){
        const genPath = `${PATH.recurringGenerated}/${ym}/${r.id}`;
        const genSnap = await db.ref(genPath).get().catch(()=>null);
        if(genSnap && genSnap.exists()) continue; // j√° gerado

        const day = Math.min(28, Math.max(1, Number(r.day||1)));
        const dt = new Date(year, month, day, 12, 0, 0, 0);

        const ref = db.ref(PATH.expenses).push();
        const id = ref.key;

        const recurringKey = `rec_${ym}_${r.id}`;
        const data = {
          id,
          type: r.type,
          status: r.status || "paid",
          ts: dt.getTime(),
          name: r.name || "Recorr√™ncia",
          amount: Number(r.amount||0),
          source: r.source || (r.type==="income" ? "Sal√°rio" : "Empresa"),
          category: r.category || "Outros",
          account: r.account || "Banco",
          note: "Gerado automaticamente (recorr√™ncia)",
          goalId: r.goalId || "",
          recurringKey,
          createdAt: Date.now(),
          updatedAt: Date.now()
        };

        await ref.set(data);
        await db.ref(genPath).set({ createdAt: Date.now(), txId: id });
        created++;

        if(data.goalId) await recomputeGoalCurrent(data.goalId);
      }

      toast(created ? `Recorr√™ncias geradas: ${created}` : "Nada a gerar (j√° estava tudo criado).");
    }

    /************************************************************
     * Filtros + KPIs + Render + Gr√°ficos
     ************************************************************/
    function inRange(ts){
      return ts >= state.range.from.getTime() && ts <= state.range.to.getTime();
    }

    function applyFilters(list){
      const f = state.filters;
      return list.filter(t=>{
        if(!inRange(t.ts)) return false;
        if(f.type!=="all" && t.type!==f.type) return false;
        if(f.status!=="all" && (t.status||"paid")!==f.status) return false;
        if(f.source!=="all" && (t.source||"")!==f.source) return false;
        if(f.category!=="all" && (t.category||"")!==f.category) return false;
        if(f.search.trim()){
          const q=f.search.trim().toLowerCase();
          const bag=`${t.name||""} ${t.note||""} ${t.source||""} ${t.category||""} ${t.account||""}`.toLowerCase();
          if(!bag.includes(q)) return false;
        }
        return true;
      }).sort((a,b)=>b.ts-a.ts);
    }

    function computeKPIs(filtered){
      let income=0, expense=0;
      for(const t of filtered){
        if((t.status||"paid")!=="paid") continue;
        if(t.type==="income") income += (t.amount||0);
        else expense += (t.amount||0);
      }
      const balance = income - expense;

      // or√ßamento do m√™s atual (pago)
      const now = new Date();
      const mFrom = startOfMonth(now).getTime();
      const mTo = endOfMonth(now).getTime();
      let spentThisMonth = 0;
      for(const t of state.tx){
        if(t.type!=="expense") continue;
        if((t.status||"paid")!=="paid") continue;
        if(t.ts<mFrom || t.ts>mTo) continue;
        spentThisMonth += (t.amount||0);
      }
      const limit = Object.values(state.settings.budgets||{}).reduce((a,b)=>a+(Number(b)||0),0);

      $("kpiIncome").textContent = fmtMoney(income);
      $("kpiExpense").textContent = fmtMoney(expense);

      $("kpiBalance").textContent = fmtMoney(balance);
      $("kpiBalance").className = "value " + (balance>=0 ? "good":"bad");

      $("kpiBudget").textContent = `${fmtMoney(spentThisMonth)} / ${fmtMoney(limit)}`;
      $("kpiBudgetSub").textContent = limit>0 ? `Uso: ${Math.min(999, Math.round((spentThisMonth/limit)*100))}%` : "Defina budgets em Ajustes";
      return {income, expense, balance};
    }

    function setupCanvas(canvas, height){
      const ctx = canvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const W = rect.width;
      const H = height;
      canvas.width = Math.floor(W*dpr);
      canvas.height = Math.floor(H*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return {ctx, W, H};
    }

    function drawGrid(ctx,W,H){
      ctx.lineWidth=1;
      ctx.strokeStyle="rgba(255,255,255,.07)";
      const top=18, bottom=H-18;
      for(let i=0;i<=4;i++){
        const y = top + i*((bottom-top)/4);
        ctx.beginPath(); ctx.moveTo(12,y); ctx.lineTo(W-12,y); ctx.stroke();
      }
    }

    function drawBalanceChart(filtered){
      const canvas = $("chartBalance");
      const {ctx,W,H} = setupCanvas(canvas, 230);
      ctx.clearRect(0,0,W,H);
      drawGrid(ctx,W,H);

      // por dia: saldo acumulado (pagos)
      const map = new Map();
      for(const t of filtered){
        const d=new Date(t.ts);
        const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
        if(!map.has(key)) map.set(key,{inc:0,exp:0});
        const o=map.get(key);
        if((t.status||"paid")!=="paid") continue;
        if(t.type==="income") o.inc += (t.amount||0);
        else o.exp += (t.amount||0);
      }
      const keys = Array.from(map.keys()).sort();
      if(keys.length===0){
        ctx.fillStyle="rgba(154,166,195,.75)";
        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        ctx.fillText("Sem dados pagos no per√≠odo para gr√°fico.", 16, 34);
        return;
      }

      let cum=0;
      const series = keys.map(k=>{
        const o=map.get(k);
        cum += (o.inc - o.exp);
        return {k, cum};
      });

      const maxAbs = Math.max(...series.map(s=>Math.abs(s.cum)), 1);
      const pad=18;
      const x0=12, x1=W-12;
      const y0=pad, y1=H-pad;
      const toX=(i)=> x0 + ((x1-x0)*(i/(series.length-1 || 1)));
      const toY=(v)=> (y0 + (y1-y0)*(0.5 - (v/(2*maxAbs))));

      // glow line
      ctx.lineWidth=6;
      ctx.strokeStyle="rgba(96,165,250,.12)";
      ctx.beginPath();
      series.forEach((s,i)=>{
        const x=toX(i), y=toY(s.cum);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      ctx.lineWidth=2.25;
      ctx.strokeStyle="rgba(96,165,250,.92)";
      ctx.beginPath();
      series.forEach((s,i)=>{
        const x=toX(i), y=toY(s.cum);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      ctx.fillStyle="rgba(255,255,255,.9)";
      series.forEach((s,i)=>{
        const x=toX(i), y=toY(s.cum);
        ctx.beginPath(); ctx.arc(x,y,2.6,0,Math.PI*2); ctx.fill();
      });

      const last=series[series.length-1];
      ctx.fillStyle="rgba(233,240,255,.92)";
      ctx.font="12px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText(`Saldo acumulado: ${fmtMoney(last.cum)}`, 16, H-14);
    }

    function drawFlowChart(kpis){
      const canvas = $("chartFlow");
      const {ctx,W,H} = setupCanvas(canvas, 210);
      ctx.clearRect(0,0,W,H);
      drawGrid(ctx,W,H);

      const inc = kpis.income||0;
      const exp = kpis.expense||0;
      const max = Math.max(inc, exp, 1);

      const left=28, right=W-28;
      const top=18, bottom=H-30;
      const barW = Math.min(70, (right-left)/3);

      function bar(x, val, isIncome){
        const h = (bottom-top) * (val/max);
        const y = bottom - h;
        ctx.fillStyle = isIncome ? "rgba(45,212,191,.85)" : "rgba(251,113,133,.85)";
        ctx.strokeStyle = "rgba(255,255,255,.14)";
        ctx.lineWidth = 1;
        roundRect(ctx, x-barW/2, y, barW, h, 12, true, true);
        ctx.fillStyle="rgba(233,240,255,.92)";
        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        ctx.textAlign="center";
        ctx.fillText(isIncome?"Receitas":"Despesas", x, H-12);
      }

      bar(left + (right-left)*0.33, inc, true);
      bar(left + (right-left)*0.66, exp, false);

      ctx.textAlign="left";
      ctx.fillStyle="rgba(233,240,255,.92)";
      ctx.font="12px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText(`+ ${fmtMoney(inc)}   |   - ${fmtMoney(exp)}`, 16, 18);
    }

    function drawDonutChart(catTotals){
      const canvas = $("chartDonut");
      const {ctx,W,H} = setupCanvas(canvas, 210);
      ctx.clearRect(0,0,W,H);

      const entries = Object.entries(catTotals).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]).slice(0,8);
      const total = entries.reduce((s,[,v])=>s+v,0);

      // background ring
      const cx=W/2, cy=H/2;
      const r=Math.min(W,H)*0.34;
      const r2=r*0.65;

      ctx.lineWidth = r-r2;
      ctx.strokeStyle="rgba(255,255,255,.07)";
      ctx.beginPath();
      ctx.arc(cx,cy,(r+r2)/2,0,Math.PI*2);
      ctx.stroke();

      if(total<=0){
        ctx.fillStyle="rgba(154,166,195,.75)";
        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        ctx.fillText("Sem despesas pagas no per√≠odo.", 16, 34);
        return;
      }

      let a0 = -Math.PI/2;
      entries.forEach(([name,val],i)=>{
        const frac = val/total;
        const a1 = a0 + frac*Math.PI*2;
        // cor por HSL suave (n√£o fixo)
        const hue = (i*48 + 210) % 360;
        ctx.strokeStyle = `hsla(${hue}, 90%, 65%, .9)`;
        ctx.lineWidth = r-r2;
        ctx.beginPath();
        ctx.arc(cx,cy,(r+r2)/2,a0,a1);
        ctx.stroke();
        a0=a1;
      });

      // center text
      ctx.fillStyle="rgba(233,240,255,.95)";
      ctx.font="900 13px "+getComputedStyle(document.body).fontFamily;
      ctx.textAlign="center";
      ctx.fillText("Despesas", cx, cy-6);
      ctx.fillStyle="rgba(154,166,195,.9)";
      ctx.font="12px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText(fmtMoney(total), cx, cy+14);

      // mini legend
      ctx.textAlign="left";
      ctx.font="12px "+getComputedStyle(document.body).fontFamily;
      let y=18;
      entries.slice(0,4).forEach(([name,val],i)=>{
        const hue = (i*48 + 210) % 360;
        ctx.fillStyle = `hsla(${hue}, 90%, 65%, .95)`;
        ctx.fillRect(14,y-9,10,10);
        ctx.fillStyle="rgba(233,240,255,.9)";
        const pct = Math.round((val/total)*100);
        ctx.fillText(`${name} ‚Ä¢ ${pct}%`, 30, y);
        y+=16;
      });
    }

    function drawParetoChart(catTotals){
      const canvas = $("chartPareto");
      const {ctx,W,H} = setupCanvas(canvas, 210);
      ctx.clearRect(0,0,W,H);
      drawGrid(ctx,W,H);

      const entries = Object.entries(catTotals).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]).slice(0,6);
      const total = entries.reduce((s,[,v])=>s+v,0);

      if(total<=0){
        ctx.fillStyle="rgba(154,166,195,.75)";
        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        ctx.fillText("Sem despesas pagas no per√≠odo.", 16, 34);
        return;
      }

      const left=12, right=W-12;
      const top=20, bottom=H-26;
      const rowH = (bottom-top) / entries.length;

      let acc=0;
      entries.forEach(([name,val],i)=>{
        acc += val;
        const pct = acc/total; // acumulado
        const barW = (right-left) * (val/total);
        const y = top + i*rowH + 6;

        // bar
        ctx.fillStyle = "rgba(96,165,250,.85)";
        ctx.strokeStyle = "rgba(255,255,255,.12)";
        roundRect(ctx, left, y, barW, rowH-12, 10, true, true);

        // acumulado marker (linha)
        const xLine = left + (right-left) * pct;
        ctx.strokeStyle = "rgba(45,212,191,.85)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(xLine, y-4);
        ctx.lineTo(xLine, y+rowH-8);
        ctx.stroke();

        // labels
        ctx.fillStyle="rgba(233,240,255,.9)";
        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        ctx.textAlign="left";
        ctx.fillText(name, left+10, y + (rowH-12)/2 + 4);

        ctx.textAlign="right";
        const p = Math.round((val/total)*100);
        ctx.fillStyle="rgba(233,240,255,.86)";
        ctx.fillText(`${p}%`, right-6, y + (rowH-12)/2 + 4);
      });

      ctx.textAlign="left";
      ctx.fillStyle="rgba(233,240,255,.92)";
      ctx.font="12px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText("Top categorias (barra) + acumulado (linha)", 16, 18);
    }

    function roundRect(ctx, x, y, w, h, r, fill, stroke) {
      r = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }

    function getCategoryTotals(filtered){
      const out = {};
      for(const t of filtered){
        if(t.type!=="expense") continue;
        if((t.status||"paid")!=="paid") continue;
        const c = t.category || "Outros";
        out[c] = (out[c]||0) + (t.amount||0);
      }
      return out;
    }

    function renderBudgets(){
      const el = $("budgetsList");
      el.innerHTML = "";

      const now = new Date();
      const mFrom = startOfMonth(now).getTime();
      const mTo = endOfMonth(now).getTime();

      // gastos por categoria no m√™s atual (pagos)
      const spentByCat = {};
      for(const t of state.tx){
        if(t.type!=="expense") continue;
        if((t.status||"paid")!=="paid") continue;
        if(t.ts<mFrom || t.ts>mTo) continue;
        const c = t.category || "Outros";
        spentByCat[c] = (spentByCat[c]||0) + (t.amount||0);
      }

      const budgets = state.settings.budgets || {};
      const cats = Object.keys(budgets).sort((a,b)=>a.localeCompare(b));
      if(!cats.length){
        const d=document.createElement("div");
        d.className="hint";
        d.innerHTML="Sem or√ßamento definido. V√° em <b>Ajustes</b> e preencha ‚ÄúOr√ßamento mensal por categoria‚Äù.";
        el.appendChild(d);
        return;
      }

      cats.forEach(cat=>{
        const limit = Number(budgets[cat]||0);
        const spent = Number(spentByCat[cat]||0);
        const pct = limit>0 ? (spent/limit) : 0;
        const pct100 = Math.round(pct*100);

        let tag = "Ok";
        let tagClass = "good";
        if(pct>=1){ tag="Estourou"; tagClass="bad"; }
        else if(pct>=0.8){ tag="Aten√ß√£o"; tagClass="warn"; }

        const row=document.createElement("div");
        row.className="budgetRow";

        row.innerHTML = `
          <div class="budgetTop">
            <div>
              <div class="budgetName">${safeText(cat)}</div>
              <div class="budgetMeta">
                <span class="badge">Gasto: ${fmtMoney(spent)}</span>
                <span class="badge">Limite: ${fmtMoney(limit)}</span>
                <span class="badge ${tagClass}">${tag} ‚Ä¢ ${pct100}%</span>
              </div>
            </div>
            <div class="amount ${tagClass}">${fmtMoney(limit - spent)}</div>
          </div>
          <div class="budgetBar"><div class="budgetFill" style="width:${Math.max(0, Math.min(140, pct*100))}%;"></div></div>
          <div class="hint">${pct>=1 ? "Voc√™ ultrapassou o limite. Ajuste or√ßamento ou reduza gastos." : "Faltam " + fmtMoney(Math.max(0,limit-spent)) + " para o limite."}</div>
        `;

        // color bar based on status
        const fill = row.querySelector(".budgetFill");
        if(pct>=1) fill.style.background = "linear-gradient(90deg, rgba(251,113,133,.9), rgba(251,113,133,.75))";
        else if(pct>=0.8) fill.style.background = "linear-gradient(90deg, rgba(251,191,36,.9), rgba(96,165,250,.85))";
        else fill.style.background = "linear-gradient(90deg, rgba(45,212,191,.9), rgba(96,165,250,.85))";

        el.appendChild(row);
      });
    }

    function renderYearChart(){
      const canvas = $("chartYear");
      if(!canvas) return;
      const {ctx,W,H} = setupCanvas(canvas, 210);
      ctx.clearRect(0,0,W,H);
      drawGrid(ctx,W,H);

      const now = new Date();
      const year = now.getFullYear();
      const months = Array.from({length:12},(_,i)=>i);

      // soma por m√™s (pagos)
      const inc = new Array(12).fill(0);
      const exp = new Array(12).fill(0);

      for(const t of state.tx){
        const d=new Date(t.ts);
        if(d.getFullYear()!==year) continue;
        if((t.status||"paid")!=="paid") continue;
        const m=d.getMonth();
        if(t.type==="income") inc[m]+= (t.amount||0);
        else exp[m]+= (t.amount||0);
      }

      const max = Math.max(...inc, ...exp, 1);
      const left=12, right=W-12;
      const top=20, bottom=H-26;

      // bars per month (income + expense)
      const slot = (right-left)/12;
      const barW = Math.max(6, Math.min(12, slot*0.28));

      function yFor(val){
        return bottom - (bottom-top)*(val/max);
      }

      months.forEach(m=>{
        const x = left + slot*m + slot/2;
        // income bar
        ctx.fillStyle="rgba(45,212,191,.78)";
        ctx.strokeStyle="rgba(255,255,255,.12)";
        roundRect(ctx, x-barW-2, yFor(inc[m]), barW, bottom - yFor(inc[m]), 8, true, true);

        // expense bar
        ctx.fillStyle="rgba(251,113,133,.72)";
        roundRect(ctx, x+2, yFor(exp[m]), barW, bottom - yFor(exp[m]), 8, true, true);
      });

      // saldo line
      const saldo = months.map(m=>inc[m]-exp[m]);
      const maxAbs = Math.max(...saldo.map(v=>Math.abs(v)), 1);
      const toY=(v)=> (top + (bottom-top)*(0.5 - (v/(2*maxAbs))));
      ctx.lineWidth=2.2;
      ctx.strokeStyle="rgba(96,165,250,.9)";
      ctx.beginPath();
      months.forEach((m,i)=>{
        const x = left + slot*m + slot/2;
        const y = toY(saldo[i]);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      // labels
      ctx.fillStyle="rgba(233,240,255,.92)";
      ctx.font="12px "+getComputedStyle(document.body).fontFamily;
      ctx.textAlign="left";
      ctx.fillText(`Ano ${year} ‚Ä¢ Receitas (verde) / Despesas (rosa) ‚Ä¢ Saldo (linha)`, 16, 18);
      ctx.textAlign="right";
      const sumInc = inc.reduce((a,b)=>a+b,0);
      const sumExp = exp.reduce((a,b)=>a+b,0);
      ctx.fillText(`${fmtMoney(sumInc - sumExp)}`, right, 18);
    }

    function renderTxList(targetId, list){
      const el = $(targetId);
      el.innerHTML = "";
      if(list.length===0){
        const d=document.createElement("div");
        d.className="hint";
        d.innerHTML="Sem lan√ßamentos neste filtro. Clique em <b>Ôºã Lan√ßamento</b> para come√ßar.";
        el.appendChild(d);
        return;
      }

      list.slice(0, 300).forEach(t=>{
        const row=document.createElement("div");
        row.className="tx";
        row.onclick=()=>openTxModal(t);

        const dt=new Date(t.ts).toLocaleString("pt-BR");
        const main=document.createElement("div");
        main.className="main";
        main.innerHTML = `
          <div class="name">${safeText(t.name)}</div>
          <div class="meta">
            <span class="badge">${dt}</span>
            <span class="badge">${t.type==="income"?"Receita":"Despesa"}</span>
            <span class="badge">${(t.status||"paid")==="paid"?"Pago":"Pendente"}</span>
            <span class="badge">Fonte: ${safeText(t.source||"")}</span>
            <span class="badge">${safeText(t.category||"")}</span>
            ${t.recurringKey?`<span class="badge">üîÅ Recorr.</span>`:""}
            ${t.goalId?`<span class="badge">üéØ Meta</span>`:""}
          </div>
        `;

        const note=document.createElement("div");
        note.className="hint";
        note.textContent = (t.note||"").slice(0, 90);

        const amount=document.createElement("div");
        amount.className="amount "+(t.type==="income"?"good":"bad");
        amount.textContent = (t.type==="income"?"+":"-")+" "+fmtMoney(t.amount||0);

        const actions=document.createElement("div");
        actions.className="right";
        actions.innerHTML = `
          <button class="btn ghost" data-act="toggle">${(t.status||"paid")==="paid" ? "‚è≥ Pendente" : "‚úÖ Pagar"}</button>
          <button class="btn danger" data-act="del">üóëÔ∏è</button>
        `;
        actions.querySelector('[data-act="toggle"]').onclick=(e)=>{e.stopPropagation(); toggleStatus(t);};
        actions.querySelector('[data-act="del"]').onclick=(e)=>{e.stopPropagation(); deleteTx(t);};

        if(window.matchMedia("(min-width:821px)").matches){
          row.appendChild(main);
          row.appendChild(note);
          row.appendChild(amount);
          row.appendChild(actions);
        }else{
          row.appendChild(amount);
          row.appendChild(note);
          row.appendChild(actions);
        }

        el.appendChild(row);
      });
    }

    function renderGoals(){
      const list = (state.goals||[]).slice().sort((a,b)=> (a.due||"").localeCompare(b.due||""));
      const totalTarget = list.reduce((s,g)=>s+Number(g.target||0),0);
      const totalCurrent = list.reduce((s,g)=>s+Number(g.current||0),0);
      const pct = totalTarget>0 ? Math.round((totalCurrent/totalTarget)*100) : 0;

      $("goalsSummary").innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
          <div>
            <b>Metas:</b> ${list.length}<br>
            <span class="hint">Total: ${fmtMoney(totalCurrent)} / ${fmtMoney(totalTarget)} (${pct}%)</span>
          </div>
          <div class="kbd">üéØ</div>
        </div>
      `;

      const renderInto = (id, max=999)=>{
        const el=$(id);
        el.innerHTML="";
        if(list.length===0){
          const d=document.createElement("div");
          d.className="hint";
          d.innerHTML="Sem metas ainda. Clique em <b>Ôºã Meta</b> para criar.";
          el.appendChild(d);
          return;
        }
        list.slice(0,max).forEach(g=>{
          const target=Number(g.target||0);
          const current=Number(g.current||0);
          const pct = target>0 ? Math.max(0,Math.min(100,(current/target)*100)) : 0;
          const due = g.due ? new Date(g.due+"T00:00:00").toLocaleDateString("pt-BR") : "Sem prazo";

          const card=document.createElement("div");
          card.className="goal";
          card.onclick=()=>openGoalModal(g);
          card.innerHTML = `
            <div class="goalTop">
              <div>
                <div class="goalName">${safeText(g.name)}</div>
                <div class="goalMeta">
                  <span class="badge">Prazo: ${due}</span>
                </div>
              </div>
              <div class="amount">${fmtMoney(current)} / ${fmtMoney(target)}</div>
            </div>
            <div class="bar"><div class="fill" style="width:${pct}%;"></div></div>
            <div class="hint">${pct.toFixed(0)}% ‚Ä¢ Falta: <b>${fmtMoney(Math.max(0,target-current))}</b></div>
          `;
          el.appendChild(card);
        });
      };

      renderInto("goalsList", 999);
      renderInto("goalsMini", 3);
      syncSelects();
    }

    function renderAll(){
      clampRange();
      const filtered = applyFilters(state.tx);

      const kpis = computeKPIs(filtered);
      drawBalanceChart(filtered);
      drawFlowChart(kpis);

      const catTotals = getCategoryTotals(filtered);
      drawDonutChart(catTotals);
      drawParetoChart(catTotals);

      renderBudgets();
      renderTxList("txList", filtered);
      renderTxList("txListAll", filtered);
      renderGoals();

      if(state.period==="yearCompare"){
        renderYearChart();
      }
    }

    /************************************************************
     * CSV + Demo + Navega√ß√£o
     ************************************************************/
    function exportCSV(){
      clampRange();
      const filtered = applyFilters(state.tx);
      const rows=[["data_hora","tipo","status","fonte","categoria","conta","meta_id","recorrencia","valor","descricao","obs","id"]];
      filtered.forEach(t=>{
        rows.push([
          new Date(t.ts).toLocaleString("pt-BR"),
          t.type,
          t.status||"paid",
          t.source||"",
          t.category||"",
          t.account||"",
          t.goalId||"",
          t.recurringKey||"",
          String(t.amount||0).replace(".",","),
          (t.name||"").replaceAll('"','""'),
          (t.note||"").replaceAll('"','""'),
          t.id
        ]);
      });
      const csv = rows.map(r=>r.map(v=>`"${String(v??"")}"`).join(";")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;
      a.download=`financeiro_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      toast("CSV exportado.");
    }

    async function seedDemo(){
      const ok = confirm("Criar dados de exemplo (Sal√°rio + Empresa + metas + recorr√™ncias)?");
      if(!ok) return;

      if(state.rawExpensesIsArray){
        alert("Seu /expenses est√° no formato antigo (array). Migre primeiro (Ajustes ‚Üí Migrar antigo) para demo completa.");
        return;
      }

      // metas
      const g1 = db.ref(PATH.goals).push(); const id1=g1.key;
      await g1.set({ id:id1, name:"Reserva de emerg√™ncia", target:20000, current:0, due:"", createdAt:Date.now(), updatedAt:Date.now() });

      const g2 = db.ref(PATH.goals).push(); const id2=g2.key;
      await g2.set({ id:id2, name:"Viagem", target:6000, current:0, due:"", createdAt:Date.now(), updatedAt:Date.now() });

      // recorr√™ncias
      const r1 = db.ref(PATH.recurring).push(); const rid1=r1.key;
      await r1.set({ id: rid1, name:"Sal√°rio", type:"income", amount:9000, day:5, source:"Sal√°rio", category:"Outros", account:"Banco", status:"paid", goalId:"" });

      const r2 = db.ref(PATH.recurring).push(); const rid2=r2.key;
      await r2.set({ id: rid2, name:"Aluguel", type:"expense", amount:2500, day:2, source:"Empresa", category:"Moradia", account:"Banco", status:"paid", goalId:"" });

      const r3 = db.ref(PATH.recurring).push(); const rid3=r3.key;
      await r3.set({ id: rid3, name:"Netflix", type:"expense", amount:55.90, day:10, source:"Empresa", category:"Lazer", account:"Cart√£o", status:"paid", goalId:"" });

      // alguns lan√ßamentos
      const base = new Date();
      const items = [
        {type:"income",status:"paid",name:"Cliente (Empresa)",amount:3500,source:"Empresa",category:"Outros",account:"Banco",note:"Recebimento"},
        {type:"expense",status:"paid",name:"Mercado",amount:420,source:"Empresa",category:"Alimenta√ß√£o",account:"Cart√£o",note:""},
        {type:"expense",status:"pending",name:"Internet",amount:120,source:"Empresa",category:"Moradia",account:"Banco",note:"Vence dia 10"},
        {type:"expense",status:"paid",name:"Aporte Reserva",amount:600,source:"Sal√°rio",category:"Outros",account:"Banco",note:"Vinculado √† meta",goalId:id1},
        {type:"expense",status:"paid",name:"Aporte Viagem",amount:200,source:"Sal√°rio",category:"Lazer",account:"Banco",note:"Vinculado √† meta",goalId:id2},
      ];

      for(let i=0;i<items.length;i++){
        const dt = new Date(base.getTime() - i*3*86400000);
        const ref=db.ref(PATH.expenses).push();
        const id=ref.key;
        const data={ id, ...items[i], ts:dt.getTime(), createdAt:Date.now(), updatedAt:Date.now() };
        await ref.set(data);
      }

      await recomputeGoalCurrent(id1);
      await recomputeGoalCurrent(id2);

      toast("Demo criada. Agora gere recorr√™ncias do m√™s em Ajustes.");
    }

    function setTab(tab){
      document.querySelectorAll(".tab").forEach(t=>{
        t.classList.toggle("active", t.dataset.tab===tab);
      });

      const titles = {
        dash: ["Dashboard","Resumo do per√≠odo + gr√°ficos + or√ßamento"],
        tx: ["Lan√ßamentos","Lista completa (com a√ß√µes r√°pidas)"],
        goals: ["Metas","Progresso e edi√ß√£o de metas"],
        settings: ["Ajustes","Fontes, categorias, or√ßamento e recorr√™ncias"]
      };
      $("pageTitle").textContent = titles[tab][0];
      $("pageSub").textContent = titles[tab][1];

      $("viewDash").style.display = tab==="dash" ? "block" : "none";
      $("viewTx").style.display = tab==="tx" ? "block" : "none";
      $("viewGoals").style.display = tab==="goals" ? "block" : "none";
      $("viewSettings").style.display = tab==="settings" ? "block" : "none";

      renderAll();
    }

    /************************************************************
     * Wire UI
     ************************************************************/
    $("btnNew").addEventListener("click", ()=> openTxModal(null));
    $("btnCloseTx").addEventListener("click", ()=> closeModal("txModal"));
    $("btnSaveTx").addEventListener("click", saveTx);
    $("btnDeleteTx").addEventListener("click", async ()=>{
      const id=state.editingTxId;
      const t=state.tx.find(x=>x.id===id);
      if(t) await deleteTx(t);
      closeModal("txModal");
    });

    $("btnNewGoal").addEventListener("click", ()=> openGoalModal(null));
    $("btnCloseGoal").addEventListener("click", ()=> closeModal("goalModal"));
    $("btnSaveGoal").addEventListener("click", saveGoal);
    $("btnDeleteGoal").addEventListener("click", async ()=>{
      const g=state.goals.find(x=>x.id===state.editingGoalId);
      if(g) await deleteGoal(g);
    });

    $("btnSaveSettings").addEventListener("click", saveSettings);
    $("btnMigrate").addEventListener("click", migrateLegacy);
    $("btnGenRecurring").addEventListener("click", generateRecurringForThisMonth);

    $("btnExport").addEventListener("click", exportCSV);
    $("btnExport2").addEventListener("click", exportCSV);
    $("btnPrint").addEventListener("click", ()=> window.print());
    $("btnPrint2").addEventListener("click", ()=> window.print());
    $("btnRefresh").addEventListener("click", ()=>{ renderAll(); toast("Atualizado."); });
    $("btnDemo").addEventListener("click", seedDemo);

    $("btnHome").addEventListener("click", ()=>{
      window.location.href = "https://wilsonf1996.github.io/index.html/";
    });

    $("period").addEventListener("change", ()=>{
      state.period = $("period").value;
      $("customRange").style.display = (state.period==="custom") ? "block" : "none";
      renderAll();
    });
    $("dateFrom").addEventListener("change", renderAll);
    $("dateTo").addEventListener("change", renderAll);

    $("fType").addEventListener("change", ()=>{ state.filters.type=$("fType").value; renderAll(); });
    $("fStatus").addEventListener("change", ()=>{ state.filters.status=$("fStatus").value; renderAll(); });
    $("fSource").addEventListener("change", ()=>{ state.filters.source=$("fSource").value; renderAll(); });
    $("fCategory").addEventListener("change", ()=>{ state.filters.category=$("fCategory").value; renderAll(); });
    $("fSearch").addEventListener("input", ()=>{ state.filters.search=$("fSearch").value; renderAll(); });

    function bindTabs(containerId){
      const el = $(containerId);
      el.addEventListener("click",(e)=>{
        const t = e.target.closest(".tab");
        if(!t) return;
        setTab(t.dataset.tab);
      });
    }
    bindTabs("tabsTop");
    bindTabs("tabsBottom");

    document.addEventListener("keydown",(e)=>{
      const k=e.key.toLowerCase();
      if(k==="n" && !e.ctrlKey && !e.metaKey) openTxModal(null);
      if((e.ctrlKey||e.metaKey) && k==="e"){ e.preventDefault(); exportCSV(); }
      if(k==="escape"){
        closeModal("txModal");
        closeModal("goalModal");
      }
    });

    window.addEventListener("resize", ()=> renderAll());

    /************************************************************
     * Boot
     ************************************************************/
    async function boot(){
      $("period").value = state.period;
      $("dateFrom").value = nowISODate();
      $("dateTo").value = nowISODate();

      state.filters = {type:"all", status:"all", source:"all", category:"all", search:""};
      $("fType").value="all";
      $("fStatus").value="all";
      $("fSearch").value="";

      await loadSettings();
      listenGoals();
      listenRecurring();
      listenExpenses();

      clampRange();
      renderAll();
      toast("Pronto. Gest√£o financeira pessoal (Apple/Microsoft-level).");
    }

    boot();
  </script>
</body>
</html>
