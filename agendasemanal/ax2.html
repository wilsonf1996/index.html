<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Premium – Calendário Moderno Avançado</title>
    <!-- Materialize CSS para interface moderna -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- Fontes e Ícones -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <style>
    /* Variáveis de cor e temas */
    :root {
      --bg-color: #f1f3f4;
      --text-color: #202124;
      --header-bg: #4285f4;
      --header-text: #fff;
      --cell-border: #dadce0;
      --sidebar-bg: #fff;
      --event-bg: #34a853;
      --accent-color: #fbbc04;
      --time-label-bg-light: #f8f9fa;
    }
    .theme-dark {
      --bg-color: #202124;
      --text-color: #e8eaed;
      --header-bg: #202124;
      --header-text: #e8eaed;
      --cell-border: #5f6368;
      --sidebar-bg: #303134;
      --event-bg: #81c784;
      --accent-color: #fbbc04;
      /* No modo escuro, a coluna de horários terá fundo preto */
      --time-label-bg-dark: #000;
    }
    /* Reset e estilos básicos */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }
    /* Loading Spinner */
    #loading-spinner {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: none;
        z-index: 2000;
    }
    #loading-spinner .spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid var(--header-bg);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Transições suaves */
    .theme-transition {
      transition: background 0.5s, color 0.5s;
    }
    </style>
</head>
<body class="theme-transition">
    <!-- Loading Spinner -->
    <div id="loading-spinner"><div class="spinner"></div></div>

    <!-- Cabeçalho com Materialize -->
    <nav class="blue">
      <div class="nav-wrapper container">
        <a href="#" class="brand-logo">Agenda Premium</a>
        <ul id="nav-mobile" class="right hide-on-med-and-down">
          <li><a href="#" id="prev-btn"><i class="fa fa-chevron-left"></i></a></li>
          <li><a href="#" id="next-btn"><i class="fa fa-chevron-right"></i></a></li>
          <li><a href="#" id="toggle-theme">Tema</a></li>
          <li>
              <label>Cor: <input type="color" id="color-picker" value="#4285f4" style="border: none; background: none;"></label>
          </li>
          <li><a href="#" id="sync-btn">Sync</a></li>
          <li><a href="#" id="btn-logout">Sair</a></li>
        </ul>
      </div>
    </nav>

    <!-- Área do Calendário -->
    <div id="calendar-container" class="container">
        <div id="current-week-display" class="center-align"></div>
        <div id="calendar-header" class="row"></div>
        <div id="calendar-body" class="row"></div>
    </div>

    <!-- Modal de Autenticação -->
    <div id="auth-modal" class="modal">
      <div class="modal-content">
        <h4>Entrar / Registrar</h4>
        <div class="row">
            <div class="input-field col s12">
              <input id="auth-email" type="email">
              <label for="auth-email">Email</label>
            </div>
            <div class="input-field col s12">
              <input id="auth-password" type="password">
              <label for="auth-password">Senha</label>
            </div>
        </div>
        <a href="#" id="auth-login-btn" class="waves-effect waves-light btn">Entrar</a>
        <div class="divider"></div>
        <div class="row">
            <div class="input-field col s12">
              <input id="auth-username" type="text">
              <label for="auth-username">Nome de Usuário (opcional)</label>
            </div>
            <div class="input-field col s12">
              <input id="auth-register-password" type="password">
              <label for="auth-register-password">Senha (mínimo 6 caracteres)</label>
            </div>
            <div class="input-field col s12">
              <input id="auth-register-password-confirm" type="password">
              <label for="auth-register-password-confirm">Confirme a senha</label>
            </div>
            <p>
              <label>
                <input type="checkbox" id="auth-terms" />
                <span>Aceito os Termos e Política</span>
              </label>
            </p>
        </div>
        <a href="#" id="auth-register-btn" class="waves-effect waves-light btn">Registrar</a>
        <p><a href="#" id="auth-forgot-password">Esqueceu a senha?</a></p>
      </div>
    </div>

    <!-- Modal de Evento (Criação / Edição) -->
    <div id="event-modal" class="modal">
      <div class="modal-content">
        <h4 id="modal-title">Novo Evento</h4>
        <p id="event-info"></p>
        <div class="row">
          <div class="input-field col s12">
            <input id="event-title" type="text">
            <label for="event-title">Título do Evento</label>
          </div>
          <div class="input-field col s12">
            <textarea id="event-description" class="materialize-textarea"></textarea>
            <label for="event-description">Descrição</label>
          </div>
          <div class="input-field col s6">
            <input id="event-start" type="time">
            <label for="event-start">Início</label>
          </div>
          <div class="input-field col s6">
            <input id="event-end" type="time">
            <label for="event-end">Término</label>
          </div>
          <div class="input-field col s12">
            <select id="event-recurrence">
              <option value="none" selected>Nenhum</option>
              <option value="daily">Diário</option>
              <option value="weekly">Semanal</option>
              <option value="monthly">Mensal</option>
            </select>
            <label>Recorrência</label>
          </div>
        </div>
        <a href="#" id="save-event" class="waves-effect waves-light btn">Salvar</a>
        <a href="#" id="delete-event" class="waves-effect waves-light btn red" style="display:none;">Excluir</a>
        <a href="#" id="cancel-event" class="waves-effect waves-light btn grey">Cancelar</a>
      </div>
    </div>

    <!-- Toast Container (utilizado pelo Materialize) -->
    <div id="toast-container"></div>

    <!-- Scripts do Firebase e Materialize -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
    // Inicialização do Materialize
    document.addEventListener('DOMContentLoaded', function() {
      var elemsModal = document.querySelectorAll('.modal');
      M.Modal.init(elemsModal, {opacity: 0.7});
      var elemsSelect = document.querySelectorAll('select');
      M.FormSelect.init(elemsSelect);
    });

    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDxMWPu_CnXV-u4-vlDFd-IZ8fzlyKJHng",
      authDomain: "financeiro-5.firebaseapp.com",
      databaseURL: "https://financeiro-5-default-rtdb.firebaseio.com",
      projectId: "financeiro-5",
      storageBucket: "financeiro-5",
      messagingSenderId: "686639785223",
      appId: "1:686639785223:web:0314689c82c6dd1c2951a2",
      measurementId: "G-Q5REWML5DX"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    let currentUser = null;
    let currentDate = new Date();
    let currentView = "week";
    let allEvents = {};
    const diasSemana = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado", "Domingo"];

    // Offline storage – salva eventos feitos offline
    let offlineEvents = JSON.parse(localStorage.getItem("offlineEvents") || "[]");
    function syncOfflineEvents() {
      if (navigator.onLine && offlineEvents.length > 0 && currentUser) {
        offlineEvents.forEach(ev => {
          let refPath = "agendas/" + currentUser.uid + "/" + ev.date + "/dia";
          let cellRef = database.ref(refPath);
          cellRef.once('value').then(snapshot => {
            let events = snapshot.val() || [];
            events.push(ev.event);
            return cellRef.set(events);
          });
        });
        offlineEvents = [];
        localStorage.setItem("offlineEvents", JSON.stringify(offlineEvents));
        M.toast({html: 'Eventos offline sincronizados!'});
      }
    }
    window.addEventListener('online', syncOfflineEvents);

    // Funções para o spinner de carregamento
    function showSpinner() {
      document.getElementById("loading-spinner").style.display = "block";
    }
    function hideSpinner() {
      document.getElementById("loading-spinner").style.display = "none";
    }

    // Função de toast usando Materialize
    function showToast(message) {
      M.toast({html: message});
    }

    // Permite ao usuário escolher a cor do cabeçalho
    document.getElementById("color-picker").addEventListener("input", function(){
      let color = this.value;
      document.documentElement.style.setProperty("--header-bg", color);
    });

    // Toggle de tema (modo claro/escuro)
    function toggleTheme() {
      if(document.documentElement.classList.contains("theme-dark")){
        document.documentElement.classList.remove("theme-dark");
        localStorage.setItem("themeDark", "false");
      } else {
        document.documentElement.classList.add("theme-dark");
        localStorage.setItem("themeDark", "true");
      }
    }
    if(localStorage.getItem("themeDark") === "true"){
      document.documentElement.classList.add("theme-dark");
    }
    document.getElementById("toggle-theme").addEventListener("click", toggleTheme);

    // Funções de autenticação com feedback aprimorado
    function login() {
      const email = document.getElementById('auth-email').value.trim();
      const password = document.getElementById('auth-password').value.trim();
      if (!email) { showToast("Informe um email válido."); return; }
      auth.signInWithEmailAndPassword(email, password)
        .then(() => { 
          showToast("Login efetuado.");
          M.Modal.getInstance(document.getElementById('auth-modal')).close();
        })
        .catch(error => { showToast("Erro no login: " + error.message); });
    }
    function register() {
      const email = document.getElementById('auth-email').value.trim();
      const password = document.getElementById('auth-register-password').value.trim();
      const confirmPassword = document.getElementById('auth-register-password-confirm').value.trim();
      const username = document.getElementById('auth-username').value.trim();
      const termosAceitos = document.getElementById('auth-terms').checked;
      if (password !== confirmPassword) { showToast("Senhas não conferem."); return; }
      if (!termosAceitos) { showToast("Aceite os Termos."); return; }
      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          currentUser = userCredential.user;
          return database.ref("usuarios/" + currentUser.uid).set({
            email: email,
            username: username,
            criadoEm: new Date().toLocaleString()
          });
        })
        .then(() => { 
          showToast("Registro efetuado.");
          M.Modal.getInstance(document.getElementById('auth-modal')).close();
        })
        .catch(error => {
          if(error.code === "auth/email-already-in-use") {
            showToast("Email já está em uso.");
          } else if(error.code === "auth/weak-password") {
            showToast("Senha fraca, escolha uma senha mais forte.");
          } else {
            showToast("Erro no registro: " + error.message);
          }
        });
    }
    document.getElementById('auth-login-btn').addEventListener('click', login);
    document.getElementById('auth-register-btn').addEventListener('click', register);
    document.getElementById('auth-forgot-password').addEventListener('click', () => {
      const email = document.getElementById('auth-email').value.trim();
      if (email) {
        auth.sendPasswordResetEmail(email)
          .then(() => { showToast("Email de recuperação enviado."); })
          .catch(error => { showToast("Erro: " + error.message); });
      } else { showToast("Informe o email para recuperação."); }
    });
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById('btn-logout').textContent = user.email.split('@')[0];
        document.getElementById('auth-modal').style.display = 'none';
        loadEvents();
        renderCalendar();
      } else {
        currentUser = null;
        M.Modal.getInstance(document.getElementById('auth-modal')).open();
      }
    });

    // Função para obter eventos de uma data (suporta recorrência)
    function getEventsForDate(date) {
      const dateKey = date.toISOString().slice(0,10);
      return (allEvents[dateKey] && allEvents[dateKey]["dia"]) || [];
    }

    // Função de renderização do calendário (exemplo para a visualização semanal)
    function renderCalendar() {
      showSpinner();
      updateHeaderDisplay();
      if (currentView === "week") {
        renderWeekView();
      } else if (currentView === "month") {
        renderMonthView();
      } else if (currentView === "year") {
        renderYearView();
      }
      hideSpinner();
    }
    function updateHeaderDisplay() {
      if (currentView === "week") {
        let temp = new Date(currentDate);
        let day = temp.getDay();
        let diff = temp.getDate() - (day === 0 ? 6 : day - 1);
        let monday = new Date(temp.setDate(diff));
        let sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        document.getElementById('current-week-display').textContent =
          monday.toLocaleDateString() + " - " + sunday.toLocaleDateString();
      }
      // Atualizar para as visualizações "month" e "year" conforme necessário.
    }
    // Exemplo simplificado de renderWeekView com recorrência
    function renderWeekView() {
      let temp = new Date(currentDate);
      let day = temp.getDay();
      let diff = temp.getDate() - (day === 0 ? 6 : day - 1);
      let monday = new Date(temp.setDate(diff));
      const header = document.getElementById('calendar-header');
      header.innerHTML = "";
      let emptyCell = document.createElement('div');
      emptyCell.className = "time-slot";
      header.appendChild(emptyCell);
      for (let i = 0; i < 7; i++) {
        let dayCell = document.createElement('div');
        let dataDia = new Date(monday);
        dataDia.setDate(monday.getDate() + i);
        dayCell.innerHTML = `<strong>${diasSemana[i]}</strong><br>${dataDia.toLocaleDateString()}`;
        header.appendChild(dayCell);
      }
      const body = document.getElementById('calendar-body');
      body.innerHTML = "";
      for (let hour = 0; hour < 24; hour++) {
        let timeLabel = document.createElement('div');
        timeLabel.className = "time-label";
        timeLabel.textContent = hour + ":00";
        body.appendChild(timeLabel);
        for (let i = 0; i < 7; i++) {
          let cell = document.createElement('div');
          cell.className = "day-cell";
          let cellDate = new Date(monday);
          cellDate.setDate(monday.getDate() + i);
          cell.dataset.date = cellDate.toISOString().slice(0,10);
          cell.addEventListener('dblclick', function() {
            openEventModal(null, null, cellDate, hour);
          });
          body.appendChild(cell);
          let eventsForDay = getEventsForDate(cellDate);
          let eventsForHour = eventsForDay.filter(ev => {
            let [evHour] = ev.inicio.split(":");
            return parseInt(evHour) === hour;
          });
          // Processa também eventos recorrentes (lógica simplificada)
          let recurringEvents = [];
          eventsForDay.forEach(ev => {
            if(ev.recurrence && ev.recurrence !== "none") {
              if(ev.recurrence === "daily" ||
                 (ev.recurrence === "weekly" && cellDate.getDay() === new Date(ev.originalDate || cell.dataset.date).getDay()) ||
                 (ev.recurrence === "monthly" && cellDate.getDate() === new Date(ev.originalDate || cell.dataset.date).getDate())) {
                recurringEvents.push(ev);
              }
            }
          });
          eventsForHour = eventsForHour.concat(recurringEvents);
          if (eventsForHour.length > 0) {
            eventsForHour.forEach((event, index) => {
              let eventBlock = document.createElement('div');
              eventBlock.className = "event-block";
              eventBlock.textContent = event.titulo;
              eventBlock.addEventListener('click', function(e) {
                e.stopPropagation();
                openEventModal(index, event, cellDate, hour);
              });
              cell.appendChild(eventBlock);
            });
          }
        }
      }
    }
    // As funções renderMonthView e renderYearView seguiriam lógicas semelhantes

    // Modal de Evento – inclui seleção de recorrência
    function openEventModal(eventIndex = null, eventData = null, dateObj, hour) {
      let modalElem = document.getElementById('event-modal');
      let instance = M.Modal.getInstance(modalElem);
      instance.open();
      document.getElementById('modal-title').textContent = eventData ? "Editar Evento" : "Novo Evento";
      document.getElementById('event-info').textContent =
        dateObj.toLocaleDateString() + " | Sugestão: " + hour + ":00";
      document.getElementById('event-title').value = eventData ? eventData.titulo : "";
      document.getElementById('event-description').value = eventData ? eventData.descricao : "";
      document.getElementById('event-start').value = (eventData && eventData.inicio) ? eventData.inicio : String(hour).padStart(2, '0') + ":00";
      document.getElementById('event-end').value = (eventData && eventData.termino) ? eventData.termino : String((hour + 1) % 24).padStart(2, '0') + ":00";
      document.getElementById('event-recurrence').value = eventData ? eventData.recurrence : "none";
      M.FormSelect.init(document.querySelectorAll('select')); // Atualiza o select
      modalElem.dataset.date = dateObj.toISOString();
      modalElem.dataset.eventIndex = eventIndex;
      document.getElementById('delete-event').style.display = eventData ? 'inline-block' : 'none';
    }
    function closeEventModal() {
      let modalElem = document.getElementById('event-modal');
      let instance = M.Modal.getInstance(modalElem);
      instance.close();
      delete modalElem.dataset.eventIndex;
      delete modalElem.dataset.date;
    }
    document.getElementById('cancel-event').addEventListener('click', closeEventModal);

    // Salva o evento, com suporte a recorrência e modo offline
    function saveEvent() {
      let modalElem = document.getElementById('event-modal');
      let newEvent = {
        titulo: document.getElementById('event-title').value,
        descricao: document.getElementById('event-description').value,
        inicio: document.getElementById('event-start').value,
        termino: document.getElementById('event-end').value,
        recurrence: document.getElementById('event-recurrence').value,
        originalDate: modalElem.dataset.date
      };
      if (!newEvent.titulo || !newEvent.inicio || !newEvent.termino) {
        showToast("Preencha os campos obrigatórios.");
        return;
      }
      let dateKey = new Date(modalElem.dataset.date).toISOString().slice(0,10);
      if (!navigator.onLine) {
        // Salva offline
        offlineEvents.push({ date: dateKey, event: newEvent });
        localStorage.setItem("offlineEvents", JSON.stringify(offlineEvents));
        showToast("Evento salvo offline.");
        closeEventModal();
        renderCalendar();
        return;
      }
      let refPath = "agendas/" + currentUser.uid + "/" + dateKey + "/dia";
      let cellRef = database.ref(refPath);
      cellRef.once('value').then(snapshot => {
        let events = snapshot.val();
        if (!Array.isArray(events)) { events = []; }
        let evIndex = modalElem.dataset.eventIndex;
        if (evIndex !== null && evIndex !== "" && evIndex !== "null") {
          events[evIndex] = newEvent;
        } else {
          events.push(newEvent);
        }
        return cellRef.set(events);
      }).then(() => {
        showToast("Evento salvo.");
        closeEventModal();
      }).catch(error => {
        showToast("Erro ao salvar: " + error.message);
      });
    }
    document.getElementById('save-event').addEventListener('click', saveEvent);

    // Função para excluir evento (mantida similar à versão anterior)
    function deleteEvent() {
      let modalElem = document.getElementById('event-modal');
      let evIndex = modalElem.dataset.eventIndex;
      if (evIndex === null || evIndex === "" || evIndex === "null") {
        showToast("Nenhum evento para excluir.");
        return;
      }
      let dateKey = new Date(modalElem.dataset.date).toISOString().slice(0,10);
      let refPath = "agendas/" + currentUser.uid + "/" + dateKey + "/dia";
      let cellRef = database.ref(refPath);
      cellRef.once('value').then(snapshot => {
        let events = snapshot.val();
        if (!Array.isArray(events)) { events = []; }
        if (evIndex >= events.length) {
          showToast("Evento não encontrado.");
          return;
        }
        events.splice(evIndex, 1);
        return cellRef.set(events);
      }).then(() => {
        showToast("Evento excluído.");
        closeEventModal();
      }).catch(error => {
        showToast("Erro ao excluir: " + error.message);
      });
    }
    document.getElementById('delete-event').addEventListener('click', deleteEvent);

    // Suporte a gestos em dispositivos móveis
    let touchStartX = 0;
    let touchEndX = 0;
    const calendarContainer = document.getElementById('calendar-container');
    calendarContainer.addEventListener('touchstart', e => {
      touchStartX = e.changedTouches[0].screenX;
    });
    calendarContainer.addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      if (touchEndX < touchStartX - 50) {
        document.getElementById('next-btn').click();
      } else if (touchEndX > touchStartX + 50) {
        document.getElementById('prev-btn').click();
      }
    });

    // Navegação (botões prev, next, sync)
    document.getElementById('prev-btn').addEventListener('click', function() {
      if (currentView === "week") {
        currentDate.setDate(currentDate.getDate() - 7);
      } else if (currentView === "month") {
        currentDate.setMonth(currentDate.getMonth() - 1);
      } else if (currentView === "year") {
        currentDate.setFullYear(currentDate.getFullYear() - 1);
      }
      renderCalendar();
    });
    document.getElementById('next-btn').addEventListener('click', function() {
      if (currentView === "week") {
        currentDate.setDate(currentDate.getDate() + 7);
      } else if (currentView === "month") {
        currentDate.setMonth(currentDate.getMonth() + 1);
      } else if (currentView === "year") {
        currentDate.setFullYear(currentDate.getFullYear() + 1);
      }
      renderCalendar();
    });
    document.getElementById('sync-btn').addEventListener('click', function(){
      syncOfflineEvents();
      showToast("Calendário sincronizado.");
    });
    </script>
</body>
</html>
