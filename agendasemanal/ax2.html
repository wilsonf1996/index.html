<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agenda Premium – Calendário Moderno</title>
  <!-- Fontes e Ícones -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
  <style>
    /* Variáveis de cor e temas */
    :root {
      --bg-color: #f1f3f4;
      --text-color: #202124;
      --header-bg: #4285f4;
      --header-text: #fff;
      --cell-border: #dadce0;
      --sidebar-bg: #fff;
      --event-bg: #34a853;
      --accent-color: #fbbc04;
    }
    .theme-dark {
      --bg-color: #202124;
      --text-color: #e8eaed;
      --header-bg: #202124;
      --header-text: #e8eaed;
      --cell-border: #5f6368;
      --sidebar-bg: #303134;
      --event-bg: #81c784;
      --accent-color: #fbbc04;
    }
    /* Reset e estilos básicos */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }
    /* Spinner de carregamento */
    #spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 3000;
    }
    #spinner:after {
      content: "";
      width: 40px;
      height: 40px;
      border: 4px solid #ccc;
      border-top-color: var(--header-bg);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Cabeçalho */
    #header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background: var(--header-bg);
      color: var(--header-text);
      height: 60px;
    }
    #header .nav-buttons button,
    #header #toggle-theme,
    #header #view-selector button,
    #header #sync-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: var(--header-text);
      padding: 8px 12px;
      margin-right: 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #header .nav-buttons button:hover,
    #header #toggle-theme:hover,
    #header #view-selector button:hover,
    #header #sync-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    #current-week-display { font-size: 1.2em; font-weight: bold; }
    #user-info { font-size: 0.9em; }
    #view-selector { display: inline-block; }
    /* Sidebar */
    #sidebar {
      width: 250px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--cell-border);
      padding: 20px;
      height: calc(100vh - 60px);
      overflow-y: auto;
      position: fixed;
      top: 60px;
      left: 0;
    }
    #profile-section { text-align: center; margin-bottom: 20px; }
    #profile-section span {
      display: block;
      margin-top: 10px;
      font-weight: 500;
      font-size: 1.1em;
    }
    #sidebar nav ul { list-style: none; padding: 0; }
    #sidebar nav ul li {
      padding: 10px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.3s;
    }
    #sidebar nav ul li:hover { background: rgba(0,0,0,0.1); }
    /* Calendário */
    #calendar-container {
      margin-left: 250px;
      padding: 20px;
      min-height: calc(100vh - 60px);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    /* Visualizações: Semana */
    .calendar-header, .calendar-grid { display: grid; }
    .calendar-header.week {
      grid-template-columns: 60px repeat(7, 1fr);
      border-bottom: 1px solid var(--cell-border);
    }
    .calendar-header.week div {
      padding: 10px;
      text-align: center;
      font-weight: 500;
    }
    .calendar-header.week .time-slot { background: #f8f9fa; }
    .theme-dark .calendar-header.week .time-slot { background: #000; }
    .calendar-grid.week {
      grid-template-columns: 60px repeat(7, 1fr);
    }
    .calendar-grid.week .time-label {
      padding: 10px;
      text-align: right;
      border-top: 1px solid var(--cell-border);
      border-right: 1px solid var(--cell-border);
      background: #f8f9fa;
    }
    .theme-dark .calendar-grid.week .time-label {
      background: #000;
      color: #fff;
    }
    .calendar-grid.week .day-cell {
      position: relative;
      border-top: 1px solid var(--cell-border);
      border-right: 1px solid var(--cell-border);
      height: 60px;
      cursor: pointer;
      overflow: hidden;
    }
    .theme-dark .calendar-grid.week .day-cell { color: var(--text-color); }
    /* Visualização: Mês */
    .month-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    .month-grid .month-cell {
      border: 1px solid var(--cell-border);
      height: 100px;
      padding: 4px;
      position: relative;
      cursor: pointer;
    }
    .month-grid .month-cell div.day-number { font-weight: bold; }
    .month-grid .event-block {
      background: var(--event-bg);
      color: #fff;
      padding: 2px 4px;
      border-radius: 2px;
      font-size: 0.8em;
      margin-top: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    /* Visualização: Ano */
    .year-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .year-cell {
      border: 1px solid var(--cell-border);
      padding: 10px;
      min-height: 150px;
      cursor: pointer;
      text-align: center;
      position: relative;
    }
    .year-cell .month-name { font-weight: bold; margin-bottom: 5px; }
    .year-cell .year-events {
      font-size: 0.75em;
      max-height: 70px;
      overflow-y: auto;
      text-align: left;
      margin-top: 5px;
    }
    /* Bloco de Evento */
    .event-block {
      position: absolute;
      left: 2px;
      right: 2px;
      top: 2px;
      background: var(--event-bg);
      color: #fff;
      padding: 2px 4px;
      border-radius: 2px;
      font-size: 0.8em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      user-select: none;
    }
    /* Modal – para eventos e autenticação */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal-content {
      background: #fff;
      color: var(--text-color);
      padding: 20px;
      border-radius: 4px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    /* Inputs e botões */
    .modal-content input,\n    .modal-content textarea,\n    .modal-content select {\n      width: 100%;\n      padding: 8px;\n      margin: 8px 0;\n      border: 1px solid var(--cell-border);\n      border-radius: 4px;\n      background: #fff;\n      color: var(--text-color);\n    }\n    .theme-dark .modal-content input,\n    .theme-dark .modal-content textarea,\n    .theme-dark .modal-content select {\n      background: #616161;\n      color: var(--text-color);\n      border: 1px solid #757575;\n    }\n    .modal-content button {\n      padding: 8px 12px;\n      border: none;\n      border-radius: 4px;\n      cursor: pointer;\n      margin-right: 5px;\n    }\n    #event-info { font-size: 0.9em; margin-bottom: 10px; }\n    /* Toast */\n    #toast-container {\n      position: fixed;\n      bottom: 20px;\n      left: 50%;\n      transform: translateX(-50%);\n      z-index: 2000;\n    }\n    .toast {\n      background: #202124;\n      color: #fff;\n      padding: 10px 20px;\n      margin: 5px;\n      border-radius: 4px;\n    }\n    /* Responsividade */\n    @media (max-width: 768px) {\n      #sidebar { display: none; }\n      #calendar-container { margin-left: 0; padding: 10px; }\n      .calendar-header, .calendar-grid { font-size: 0.9em; }\n      .modal-content { padding: 15px; }\n    }\n  </style>\n</head>\n<body>\n  <!-- Spinner -->\n  <div id=\"spinner\"></div>\n\n  <!-- Cabeçalho -->\n  <header id=\"header\" role=\"banner\">\n    <div class=\"nav-buttons\">\n      <button id=\"prev-btn\" aria-label=\"Anterior\"><i class=\"fa fa-chevron-left\"></i></button>\n      <button id=\"next-btn\" aria-label=\"Próxima\"><i class=\"fa fa-chevron-right\"></i></button>\n    </div>\n    <div id=\"current-week-display\" aria-live=\"polite\">Data: ...</div>\n    <div id=\"view-selector\">\n      <button id=\"view-week\" aria-label=\"Visualizar Semana\">Semana</button>\n      <button id=\"view-month\" aria-label=\"Visualizar Mês\">Mês</button>\n      <button id=\"view-year\" aria-label=\"Visualizar Ano\">Ano</button>\n      <button id=\"toggle-theme\" aria-label=\"Alternar Tema\">Tema</button>\n      <button id=\"sync-btn\" aria-label=\"Sincronizar Calendário\">Sync</button>\n    </div>\n    <div id=\"user-info\"></div>\n  </header>\n\n  <!-- Sidebar com perfil e logout -->\n  <aside id=\"sidebar\" role=\"complementary\">\n    <div id=\"profile-section\">\n      <span id=\"profile-name\">Usuário</span>\n    </div>\n    <nav>\n      <ul>\n        <li id=\"btn-logout\">Sair</li>\n      </ul>\n    </nav>\n  </aside>\n\n  <!-- Calendário -->\n  <div id=\"calendar-container\">\n    <div id=\"calendar-header\"></div>\n    <div id=\"calendar-body\"></div>\n  </div>\n\n  <!-- Modal de Autenticação -->\n  <div id=\"auth-modal\" class=\"modal\" role=\"dialog\" aria-modal=\"true\">\n    <div class=\"modal-content\">\n      <h3>Entrar / Registrar</h3>\n      <input type=\"email\" id=\"auth-email\" placeholder=\"Email\">\n      <input type=\"password\" id=\"auth-password\" placeholder=\"Senha\">\n      <button id=\"auth-login-btn\">Entrar</button>\n      <hr>\n      <input type=\"text\" id=\"auth-username\" placeholder=\"Usuário (mínimo 3 caracteres)\">\n      <input type=\"password\" id=\"auth-register-password\" placeholder=\"Senha (mínimo 6 caracteres)\">\n      <input type=\"password\" id=\"auth-register-password-confirm\" placeholder=\"Confirme a senha\">\n      <label><input type=\"checkbox\" id=\"auth-terms\"> Aceito os Termos e Política</label>\n      <button id=\"auth-register-btn\">Registrar</button>\n      <p><a href=\"#\" id=\"auth-forgot-password\">Esqueceu a senha?</a></p>\n    </div>\n  </div>\n\n  <!-- Modal de Evento -->\n  <div id=\"event-modal\" class=\"modal\" role=\"dialog\" aria-modal=\"true\">\n    <div class=\"modal-content\">\n      <h3 id=\"modal-title\">Novo Evento</h3>\n      <p id=\"event-info\"></p>\n      <input type=\"text\" id=\"event-title\" placeholder=\"Título do Evento\">\n      <textarea id=\"event-description\" placeholder=\"Descrição\"></textarea>\n      <label>Início: <input type=\"time\" id=\"event-start\"></label>\n      <label>Término: <input type=\"time\" id=\"event-end\"></label>\n      <label>Recorrência: \n        <select id=\"event-recurrencia\">\n          <option value=\"none\" selected>Nenhum</option>\n          <option value=\"diario\">Diário</option>\n          <option value=\"semanal\">Semanal</option>\n          <option value=\"mensal\">Mensal</option>\n        </select>\n      </label>\n      <div style=\"margin-top:10px;\">\n        <button id=\"save-event\">Salvar</button>\n        <button id=\"delete-event\" style=\"display: none;\">Excluir</button>\n        <button id=\"cancel-event\">Cancelar</button>\n      </div>\n    </div>\n  </div>\n\n  <!-- Toast Container -->\n  <div id=\"toast-container\" aria-live=\"assertive\"></div>\n\n  <!-- Firebase SDKs -->\n  <script src=\"https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js\"></script>\n  <script src=\"https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js\"></script>\n  <script src=\"https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js\"></script>\n  <script>\n    document.addEventListener(\"DOMContentLoaded\", function() {\n      \"use strict\";\n      /***************************************\n       * CONFIGURAÇÃO DO FIREBASE – Substitua pelos seus dados\n       ***************************************/\n      const firebaseConfig = {\n        apiKey: \"AIzaSyDxMWPu_CnXV-u4-vlDFd-IZ8fzlyKJHng\",\n        authDomain: \"financeiro-5.firebaseapp.com\",\n        databaseURL: \"https://financeiro-5-default-rtdb.firebaseio.com\",\n        projectId: \"financeiro-5\",\n        storageBucket: \"financeiro-5\",\n        messagingSenderId: \"686639785223\",\n        appId: \"1:686639785223:web:0314689c82c6dd1c2951a2\",\n        measurementId: \"G-Q5REWML5DX\"\n      };\n      firebase.initializeApp(firebaseConfig);\n      const auth = firebase.auth();\n      const database = firebase.database();\n\n      /***************************************\n       * VARIÁVEIS GLOBAIS\n       ***************************************/\n      let currentUser = null;\n      let currentDate = new Date();\n      let currentView = \"week\"; // week, month ou year\n      let allEvents = {};\n      let eventsListener = null;\n      let checkForUpcomingEventsInterval = null;\n      const diasSemana = [\"Segunda\", \"Terça\", \"Quarta\", \"Quinta\", \"Sexta\", \"Sábado\", \"Domingo\"];\n      let offlineEvents = JSON.parse(localStorage.getItem(\"offlineEvents\") || \"[]\");\n\n      function syncOfflineEvents() {\n        if (navigator.onLine && offlineEvents.length > 0 && currentUser) {\n          offlineEvents.forEach(offlineEv => {\n            const refPath = \"agendas/\" + currentUser.uid + \"/\" + offlineEv.date + \"/dia\";\n            const cellRef = database.ref(refPath);\n            cellRef.once('value').then(snapshot => {\n              let events = snapshot.val();\n              if (!Array.isArray(events)) { events = []; }\n              events.push(offlineEv.event);\n              return cellRef.set(events);\n            });\n          });\n          offlineEvents = [];\n          localStorage.setItem(\"offlineEvents\", JSON.stringify(offlineEvents));\n          showToast(\"Eventos offline sincronizados.\");\n        }\n      }\n      window.addEventListener('online', syncOfflineEvents);\n\n      /***************************************\n       * FUNÇÕES UTILITÁRIAS\n       ***************************************/\n      function showToast(message) {\n        const toast = document.createElement('div');\n        toast.className = 'toast';\n        toast.textContent = message;\n        document.getElementById('toast-container').appendChild(toast);\n        setTimeout(() => { toast.remove(); }, 3000);\n      }\n\n      /***************************************\n       * TEMAS – Alternar entre claro e escuro\n       ***************************************/\n      function toggleTheme() {\n        if(document.documentElement.classList.contains(\"theme-dark\")){\n          document.documentElement.classList.remove(\"theme-dark\");\n          localStorage.setItem(\"themeDark\", \"false\");\n        } else {\n          document.documentElement.classList.add(\"theme-dark\");\n          localStorage.setItem(\"themeDark\", \"true\");\n        }\n      }\n      if(localStorage.getItem(\"themeDark\") === \"true\"){\n        document.documentElement.classList.add(\"theme-dark\");\n      }\n      document.getElementById(\"toggle-theme\").addEventListener(\"click\", toggleTheme);\n\n      /***************************************\n       * VALIDAÇÕES\n       ***************************************/\n      function validateEmail(email) {\n        const re = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n        return re.test(email);\n      }\n      function validatePassword(password) {\n        return password.length >= 6;\n      }\n      function validateUsername(username) {\n        return username.length >= 3;\n      }\n\n      /***************************************\n       * AUTENTICAÇÃO: Login e Registro\n       ***************************************/\n      function login() {\n        const email = document.getElementById('auth-email').value.trim();\n        const password = document.getElementById('auth-password').value.trim();\n        if (!validateEmail(email)) { showToast(\"Informe um email válido.\"); return; }\n        if (!validatePassword(password)) { showToast(\"A senha deve ter pelo menos 6 caracteres.\"); return; }\n        auth.signInWithEmailAndPassword(email, password)\n          .then(() => { showToast(\"Login efetuado com sucesso.\"); })\n          .catch(error => {\n            if(error.code === \"auth/wrong-password\") {\n              showToast(\"Senha incorreta.\");\n            } else if(error.code === \"auth/user-not-found\") {\n              showToast(\"Usuário não encontrado.\");\n            } else {\n              showToast(\"Erro no login: \" + error.message);\n            }\n          });\n      }\n\n      function register() {\n        const email = document.getElementById('auth-email').value.trim();\n        const password = document.getElementById('auth-register-password').value.trim();\n        const confirmPassword = document.getElementById('auth-register-password-confirm').value.trim();\n        const username = document.getElementById('auth-username').value.trim();\n        const termosAceitos = document.getElementById('auth-terms').checked;\n        if (!validateEmail(email)) { showToast(\"Informe um email válido.\"); return; }\n        if (!validatePassword(password)) { showToast(\"A senha deve ter no mínimo 6 caracteres.\"); return; }\n        if (password !== confirmPassword) { showToast(\"Senhas não conferem.\"); return; }\n        if (!validateUsername(username)) { showToast(\"O nome de usuário deve ter pelo menos 3 caracteres.\"); return; }\n        if (!termosAceitos) { showToast(\"Aceite os Termos.\"); return; }\n        auth.createUserWithEmailAndPassword(email, password)\n          .then(userCredential => {\n            currentUser = userCredential.user;\n            return database.ref(\"usuarios/\" + currentUser.uid).set({\n              username: username,\n              criadoEm: new Date().toLocaleString()\n            });\n          })\n          .then(() => { showToast(\"Registro efetuado com sucesso!\"); })\n          .catch(error => {\n            if (error.code === \"auth/email-already-in-use\") {\n              showToast(\"Este email já está cadastrado.\");\n            } else if (error.code === \"auth/invalid-email\") {\n              showToast(\"O email informado não é válido.\");\n            } else if (error.code === \"auth/weak-password\") {\n              showToast(\"A senha é muito fraca.\");\n            } else {\n              showToast(\"Erro no registro: \" + error.message);\n            }\n          });\n      }\n\n      document.getElementById('auth-login-btn').addEventListener('click', login);\n      document.getElementById('auth-register-btn').addEventListener('click', register);\n      document.getElementById('auth-forgot-password').addEventListener('click', () => {\n        const email = document.getElementById('auth-email').value.trim();\n        if (email) {\n          auth.sendPasswordResetEmail(email)\n            .then(() => { showToast(\"Email de recuperação enviado.\"); })\n            .catch(error => { showToast(\"Erro: \" + error.message); });\n        } else {\n          showToast(\"Informe o email para recuperação.\");\n        }\n      });\n\n      auth.onAuthStateChanged(user => {\n        if (user) {\n          currentUser = user;\n          document.getElementById('profile-name').textContent = user.email.split('@')[0];\n          document.getElementById('user-info').textContent = user.email;\n          document.getElementById('auth-modal').style.display = 'none';\n          loadEvents();\n          renderCalendar();\n        } else {\n          currentUser = null;\n          document.getElementById('auth-modal').style.display = 'flex';\n        }\n      });\n\n      /***************************************\n       * EVENTOS – Manipulação e renderização\n       ***************************************/\n      function getEventsForDate(date) {\n        const dateKey = date.toISOString().slice(0,10);\n        return (allEvents[dateKey] && allEvents[dateKey][\"dia\"]) || [];\n      }\n\n      document.getElementById('prev-btn').addEventListener('click', function() {\n        if (currentView === \"week\") {\n          currentDate.setDate(currentDate.getDate() - 7);\n        } else if (currentView === \"month\") {\n          currentDate.setMonth(currentDate.getMonth() - 1);\n        } else if (currentView === \"year\") {\n          currentDate.setFullYear(currentDate.getFullYear() - 1);\n        }\n        renderCalendar();\n      });\n      document.getElementById('next-btn').addEventListener('click', function() {\n        if (currentView === \"week\") {\n          currentDate.setDate(currentDate.getDate() + 7);\n        } else if (currentView === \"month\") {\n          currentDate.setMonth(currentDate.getMonth() + 1);\n        } else if (currentView === \"year\") {\n          currentDate.setFullYear(currentDate.getFullYear() + 1);\n        }\n        renderCalendar();\n      });\n      document.getElementById('view-week').addEventListener('click', function(){ currentView = \"week\"; renderCalendar(); });\n      document.getElementById('view-month').addEventListener('click', function(){ currentView = \"month\"; renderCalendar(); });\n      document.getElementById('view-year').addEventListener('click', function(){ currentView = \"year\"; renderCalendar(); });\n      document.getElementById('sync-btn').addEventListener('click', function(){\n        syncOfflineEvents();\n        showToast(\"Calendário sincronizado.\");\n      });\n\n      function loadEvents() {\n        const eventsRef = database.ref(\"agendas/\" + currentUser.uid);\n        eventsListener = eventsRef;\n        document.getElementById(\"spinner\").style.display = \"block\";\n        eventsRef.on(\"value\", snapshot => {\n          allEvents = snapshot.val() || {};\n          renderCalendar();\n          document.getElementById(\"spinner\").style.display = \"none\";\n        }, error => {\n          console.error(\"Erro ao carregar eventos:\", error);\n          document.getElementById(\"spinner\").style.display = \"none\";\n        });\n      }\n\n      function renderCalendar() {\n        updateHeaderDisplay();\n        if (currentView === \"week\") {\n          renderWeekView();\n        } else if (currentView === \"month\") {\n          renderMonthView();\n        } else if (currentView === \"year\") {\n          renderYearView();\n        }\n      }\n\n      function updateHeaderDisplay() {\n        if (currentView === \"week\") {\n          let temp = new Date(currentDate);\n          let day = temp.getDay();\n          let diff = temp.getDate() - (day === 0 ? 6 : day - 1);\n          let monday = new Date(temp.setDate(diff));\n          let sunday = new Date(monday);\n          sunday.setDate(monday.getDate() + 6);\n          document.getElementById('current-week-display').textContent =\n            monday.toLocaleDateString() + \" - \" + sunday.toLocaleDateString();\n        } else if (currentView === \"month\") {\n          let monthName = currentDate.toLocaleString(\"pt-BR\", { month: \"long\" });\n          document.getElementById('current-week-display').textContent =\n            monthName.charAt(0).toUpperCase() + monthName.slice(1) + \" \" + currentDate.getFullYear();\n        } else if (currentView === \"year\") {\n          document.getElementById('current-week-display').textContent = currentDate.getFullYear();\n        }\n      }\n\n      function renderWeekView() {\n        let temp = new Date(currentDate);\n        let day = temp.getDay();\n        let diff = temp.getDate() - (day === 0 ? 6 : day - 1);\n        let monday = new Date(temp.setDate(diff));\n        const header = document.getElementById('calendar-header');\n        header.className = \"calendar-header week\";\n        header.innerHTML = \"\";\n        let emptyCell = document.createElement('div');\n        emptyCell.className = \"time-slot\";\n        header.appendChild(emptyCell);\n        for (let i = 0; i < 7; i++) {\n          let dayCell = document.createElement('div');\n          let dataDia = new Date(monday);\n          dataDia.setDate(monday.getDate() + i);\n          dayCell.innerHTML = `<strong>${diasSemana[i]}</strong><br>${dataDia.toLocaleDateString()}`;\n          header.appendChild(dayCell);\n        }\n        const body = document.getElementById('calendar-body');\n        body.className = \"calendar-grid week\";\n        body.innerHTML = \"\";\n        for (let hour = 0; hour < 24; hour++) {\n          let timeLabel = document.createElement('div');\n          timeLabel.className = \"time-label\";\n          timeLabel.textContent = hour + \":00\";\n          body.appendChild(timeLabel);\n          for (let i = 0; i < 7; i++) {\n            let cell = document.createElement('div');\n            cell.className = \"day-cell\";\n            let cellDate = new Date(monday);\n            cellDate.setDate(monday.getDate() + i);\n            cell.dataset.date = cellDate.toISOString().slice(0,10);\n            cell.addEventListener('dblclick', function() {\n              openEventModal(null, null, cellDate, hour);\n            });\n            body.appendChild(cell);\n            let eventsForDay = getEventsForDate(cellDate);\n            let eventosRecorrentes = [];\n            for (let key in allEvents) {\n              let evArray = (allEvents[key] && allEvents[key][\"dia\"]) || [];\n              evArray.forEach(ev => {\n                if(ev.recorrencia && ev.recorrencia !== \"none\") {\n                  let dataOriginal = new Date(ev.dataOriginal || key);\n                  if(dataOriginal <= cellDate) {\n                    if(ev.recorrencia === \"diario\") {\n                      eventosRecorrentes.push(ev);\n                    } else if(ev.recorrencia === \"semanal\" && dataOriginal.getDay() === cellDate.getDay()){\n                      eventosRecorrentes.push(ev);\n                    } else if(ev.recorrencia === \"mensal\" && dataOriginal.getDate() === cellDate.getDate()){\n                      eventosRecorrentes.push(ev);\n                    }\n                  }\n                }\n              });\n            }\n            let eventosExibir = eventsForDay.concat(eventosRecorrentes);\n            if (eventosExibir.length > 0) {\n              eventosExibir.forEach((event, index) => {\n                let eventBlock = document.createElement('div');\n                eventBlock.className = \"event-block\";\n                eventBlock.textContent = event.titulo;\n                eventBlock.addEventListener('click', function(e) {\n                  e.stopPropagation();\n                  openEventModal(parseInt(index), event, cellDate, hour);\n                });\n                cell.appendChild(eventBlock);\n              });\n            }\n          }\n        }\n      }\n\n      function renderMonthView() {\n        let year = currentDate.getFullYear();\n        let month = currentDate.getMonth();\n        let firstDay = new Date(year, month, 1);\n        let startDay = firstDay.getDay();\n        let offset = (startDay === 0 ? 6 : startDay - 1);\n        let totalDays = new Date(year, month + 1, 0).getDate();\n        const header = document.getElementById('calendar-header');\n        header.className = \"calendar-header month\";\n        header.style.display = \"grid\";\n        header.style.gridTemplateColumns = \"repeat(7, 1fr)\";\n        header.innerHTML = \"\";\n        for (let i = 0; i < 7; i++) {\n          let dayName = document.createElement('div');\n          dayName.style.textAlign = \"center\";\n          dayName.style.fontWeight = \"500\";\n          dayName.textContent = diasSemana[i].slice(0,3);\n          header.appendChild(dayName);\n        }\n        const body = document.getElementById('calendar-body');\n        body.className = \"month-grid\";\n        body.innerHTML = \"\";\n        let cells = Math.ceil((offset + totalDays) / 7) * 7;\n        for (let i = 0; i < cells; i++) {\n          let cell = document.createElement('div');\n          cell.className = \"month-cell\";\n          if (i >= offset && i < offset + totalDays) {\n            let dayNum = i - offset + 1;\n            cell.innerHTML = `<div class=\"day-number\">${dayNum}</div>`;\n            let cellDate = new Date(year, month, dayNum);\n            cell.dataset.date = cellDate.toISOString().slice(0,10);\n            cell.addEventListener('dblclick', function() {\n              openEventModal(null, null, cellDate, 9);\n            });\n            let eventsForDay = getEventsForDate(cellDate);\n            if (eventsForDay.length > 0) {\n              eventsForDay.forEach((event, index) => {\n                let eventBlock = document.createElement('div');\n                eventBlock.className = \"event-block\";\n                eventBlock.style.position = \"relative\";\n                eventBlock.style.marginTop = \"4px\";\n                eventBlock.textContent = event.titulo;\n                eventBlock.addEventListener('click', function(e) {\n                  e.stopPropagation();\n                  let eventHour = parseInt(event.inicio.split(\":\")[0]);\n                  openEventModal(parseInt(index), event, cellDate, eventHour);\n                });\n                cell.appendChild(eventBlock);\n              });\n            }\n          }\n          body.appendChild(cell);\n        }\n      }\n\n      function renderYearView() {\n        const year = currentDate.getFullYear();\n        const header = document.getElementById('calendar-header');\n        header.style.display = \"none\";\n        const body = document.getElementById('calendar-body');\n        body.className = \"year-grid\";\n        body.innerHTML = \"\";\n        for (let y = year - 1; y <= year + 2; y++) {\n          let cell = document.createElement('div');\n          cell.className = \"year-cell\";\n          cell.innerHTML = `<div class=\"month-name\">${y}</div>`;\n          let aggregatedEvents = [];\n          for (let m = 0; m < 12; m++) {\n            let daysInMonth = new Date(y, m + 1, 0).getDate();\n            for (let d = 1; d <= daysInMonth; d++) {\n              let dateObj = new Date(y, m, d);\n              aggregatedEvents = aggregatedEvents.concat(getEventsForDate(dateObj));\n            }\n          }\n          if (aggregatedEvents.length > 0) {\n            let eventsDiv = document.createElement('div');\n            eventsDiv.className = \"year-events\";\n            aggregatedEvents.forEach(ev => {\n              let span = document.createElement('span');\n              span.textContent = ev.titulo;\n              eventsDiv.appendChild(span);\n            });\n            cell.appendChild(eventsDiv);\n          }\n          cell.addEventListener('dblclick', function() {\n            currentDate = new Date(y, 0, 1);\n            currentView = \"month\";\n            renderCalendar();\n            header.style.display = \"grid\";\n          });\n          body.appendChild(cell);\n        }\n      }\n\n      function openEventModal(eventIndex = null, eventData = null, dateObj, hour) {\n        const modal = document.getElementById('event-modal');\n        modal.style.display = 'flex';\n        document.getElementById('modal-title').textContent = eventData ? \"Editar Evento\" : \"Novo Evento\";\n        document.getElementById('event-info').textContent = dateObj.toLocaleDateString() + \" | Sugestão: \" + hour + \":00\";\n        document.getElementById('event-title').value = eventData ? eventData.titulo : \"\";\n        document.getElementById('event-description').value = eventData ? eventData.descricao : \"\";\n        document.getElementById('event-start').value = (eventData && eventData.inicio) ? eventData.inicio : String(hour).padStart(2, '0') + \":00\";\n        document.getElementById('event-end').value = (eventData && eventData.termino) ? eventData.termino : String((hour + 1) % 24).padStart(2, '0') + \":00\";\n        document.getElementById('event-recurrencia').value = eventData && eventData.recorrencia ? eventData.recorrencia : \"none\";\n        modal.dataset.date = dateObj.toISOString();\n        modal.dataset.eventIndex = eventIndex;\n        document.getElementById('delete-event').style.display = eventData ? 'inline-block' : 'none';\n      }\n      function closeEventModal() {\n        const modal = document.getElementById('event-modal');\n        modal.style.display = 'none';\n        delete modal.dataset.eventIndex;\n        delete modal.dataset.date;\n      }\n      document.getElementById('cancel-event').addEventListener('click', closeEventModal);\n\n      function saveEvent() {\n        const modal = document.getElementById('event-modal');\n        const newEvent = {\n          titulo: document.getElementById('event-title').value,\n          descricao: document.getElementById('event-description').value,\n          inicio: document.getElementById('event-start').value,\n          termino: document.getElementById('event-end').value,\n          recorrencia: document.getElementById('event-recurrencia').value,\n          dataOriginal: modal.dataset.date\n        };\n        if (!newEvent.titulo || !newEvent.inicio || !newEvent.termino) {\n          showToast(\"Preencha os campos obrigatórios.\");\n          return;\n        }\n        const dateKey = new Date(modal.dataset.date).toISOString().slice(0,10);\n        const refPath = \"agendas/\" + currentUser.uid + \"/\" + dateKey + \"/dia\";\n        const cellRef = database.ref(refPath);\n        if (!navigator.onLine) {\n          offlineEvents.push({ date: dateKey, event: newEvent });\n          localStorage.setItem(\"offlineEvents\", JSON.stringify(offlineEvents));\n          showToast(\"Evento salvo offline.\");\n          closeEventModal();\n          renderCalendar();\n          return;\n        }\n        cellRef.once('value').then(snapshot => {\n          let events = snapshot.val();\n          if (!Array.isArray(events)) { events = []; }\n          const evIndex = modal.dataset.eventIndex;\n          if (evIndex !== null && evIndex !== \"\" && evIndex !== \"null\") {\n            events[parseInt(evIndex)] = newEvent;\n          } else {\n            events.push(newEvent);\n          }\n          return cellRef.set(events);\n        }).then(() => {\n          showToast(\"Evento salvo.\");\n          closeEventModal();\n        }).catch(error => {\n          showToast(\"Erro ao salvar: \" + error.message);\n        });\n      }\n      document.getElementById('save-event').addEventListener('click', saveEvent);\n\n      function deleteEvent() {\n        const modal = document.getElementById('event-modal');\n        const evIndex = parseInt(modal.dataset.eventIndex);\n        if (isNaN(evIndex)) {\n          showToast(\"Nenhum evento para excluir.\");\n          return;\n        }\n        const dateKey = new Date(modal.dataset.date).toISOString().slice(0,10);\n        const refPath = \"agendas/\" + currentUser.uid + \"/\" + dateKey + \"/dia\";\n        const cellRef = database.ref(refPath);\n        cellRef.once('value').then(snapshot => {\n          let events = snapshot.val();\n          if (!Array.isArray(events)) { events = []; }\n          if (evIndex >= events.length) {\n            showToast(\"Evento não encontrado.\");\n            return;\n          }\n          events.splice(evIndex, 1);\n          return cellRef.set(events);\n        }).then(() => {\n          showToast(\"Evento excluído.\");\n          closeEventModal();\n        }).catch(error => {\n          showToast(\"Erro ao excluir: \" + error.message);\n        });\n      }\n      document.getElementById('delete-event').addEventListener('click', deleteEvent);\n\n      let touchStartX = 0;\n      let touchEndX = 0;\n      const calendarContainer = document.getElementById('calendar-container');\n      calendarContainer.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; });\n      calendarContainer.addEventListener('touchend', e => {\n        touchEndX = e.changedTouches[0].screenX;\n        if (touchEndX < touchStartX - 50) { document.getElementById('next-btn').click(); }\n        else if (touchEndX > touchStartX + 50) { document.getElementById('prev-btn').click(); }\n      });\n\n      function checkForUpcomingEvents() {\n        const now = new Date();\n        for (let dateKey in allEvents) {\n          let events = (allEvents[dateKey] && allEvents[dateKey][\"dia\"]) || [];\n          events.forEach(ev => {\n            let [h, m] = ev.inicio.split(\":\").map(Number);\n            let eventTime = new Date(dateKey);\n            eventTime.setHours(h, m, 0);\n            if (eventTime - now > 0 && eventTime - now < 10 * 60 * 1000) {\n              new Notification(\"Próximo Evento\", { body: ev.titulo });\n            }\n          });\n        }\n      }\n      checkForUpcomingEventsInterval = setInterval(checkForUpcomingEvents, 60000);\n\n      function cleanupApp() {\n        if (eventsListener) { eventsListener.off(); }\n        if (checkForUpcomingEventsInterval) { clearInterval(checkForUpcomingEventsInterval); }\n      }\n      document.getElementById('btn-logout').addEventListener('click', function() {\n        cleanupApp();\n        auth.signOut().then(() => {\n          showToast(\"Logout efetuado.\");\n          location.reload();\n        }).catch(error => { showToast(\"Erro no logout: \" + error.message); });\n      });\n\n      function initApp() {\n        console.log(\"Sistema de agenda premium iniciado.\");\n      }\n      initApp();\n    });\n  </script>\n</body>\n</html>


