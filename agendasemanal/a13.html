<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAIp-rFuZZsBCNVJ3pSge4TE-XUuwYygrI",
        authDomain: "agenda-6accc.firebaseapp.com",
        databaseURL: "https://agenda-6accc-default-rtdb.firebaseio.com",
        projectId: "agenda-6accc",
        storageBucket: "agenda-6accc.appspot.com",
        messagingSenderId: "205960633520",
        appId: "1:205960633520:web:c9b1b9e166a8e3daed1dc6"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    let currentUserId = null;

    function checkUserLoggedIn() {
        const storedUser = localStorage.getItem('username');
        if (storedUser) {
            currentUserId = storedUser;
            showAgenda();
        } else {
            showLogin();
        }
    }

    function showLogin() {
        document.getElementById('login-container').style.display = 'block';
        document.getElementById('register-container').style.display = 'none';
        document.getElementById('agenda-container').style.display = 'none';
    }

    function showRegister() {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('register-container').style.display = 'block';
        document.getElementById('agenda-container').style.display = 'none';
    }

    function showAgenda() {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('register-container').style.display = 'none';
        document.getElementById('agenda-container').style.display = 'block';
        loadAgenda();
    }

    function loadAgenda() {
        const startDate = getStartOfWeek(new Date()); // ObtÃ©m a data da segunda-feira desta semana
        const weekDates = getWeekDates(startDate);
        updateTableHeaders(weekDates);
        const formattedStartDate = formatDateToISO(weekDates[0]);

        const agendaRef = database.ref('agendas/' + currentUserId + '/' + formattedStartDate);
        agendaRef.on('value', snapshot => {
            const agendaData = snapshot.val() || {};
            renderAgendaTable(agendaData, weekDates);
        });
    }

    function getStartOfWeek(date) {
        // Ajusta a data para a segunda-feira da semana atual
        const day = date.getDay();
        const diff = date.getDate() - day + (day == 0 ? -6 : 1); // Se for domingo (0), ajusta para -6
        return new Date(date.setDate(diff));
    }

    function getWeekDates(startDate) {
        const dates = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            dates.push(date);
        }
        return dates;
    }

    function updateTableHeaders(weekDates) {
        const thElements = document.querySelectorAll('#agenda-table thead th');
        for (let i = 1; i <= 7; i++) {
            thElements[i].textContent = `${new Intl.DateTimeFormat('pt-BR', { weekday: 'long' }).format(weekDates[i - 1])} (${formatDateToISO(weekDates[i - 1])})`;
        }
    }

    function renderAgendaTable(agendaData, weekDates) {
        const tbody = document.getElementById('agenda-body');
        tbody.innerHTML = '';
        const hours = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'];

        hours.forEach(hour => {
            let row = document.createElement('tr');
            let hourCell = document.createElement('td');
            hourCell.textContent = hour;
            row.appendChild(hourCell);

            weekDates.forEach(date => {
                const dateKey = formatDateToISO(date);
                const cell = document.createElement('td');
                cell.className = 'editable';
                cell.contentEditable = true;
                cell.textContent = agendaData[dateKey] && agendaData[dateKey][hour] ? agendaData[dateKey][hour] : '';
                cell.addEventListener('blur', () => {
                    const updatedValue = cell.textContent;
                    const agendaDayRef = database.ref(`agendas/${currentUserId}/${formatDateToISO(weekDates[0])}/${dateKey}`);
                    agendaDayRef.update({ [hour]: updatedValue });
                });
                row.appendChild(cell);
            });
            tbody.appendChild(row);
        });
    }

    function formatDateToISO(date) {
        return date.toISOString().split('T')[0];
    }

    checkUserLoggedIn();
</script>
