<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agenda Semanal – Estilo Calendário Moderno</title>
  <!-- Fontes e Ícones -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
  <style>
    /* RESET e estilos básicos */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body { font-family: 'Roboto', sans-serif; background: #f1f3f4; color: #202124; }

    /* Header – Visual similar ao Google Calendar */
    #header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background: #4285f4;
      color: white;
    }
    #header .nav-buttons button {
      background: #357ae8;
      border: none;
      color: white;
      padding: 8px 12px;
      margin-right: 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    #header .nav-buttons button:hover { background: #2a65d0; }
    #current-week-display { font-size: 1.2em; font-weight: bold; }
    #user-info { font-size: 0.9em; }

    /* Sidebar – Informação do usuário */
    #sidebar {
      width: 250px;
      background: #fff;
      border-right: 1px solid #dadce0;
      padding: 20px;
    }
    #profile-section { text-align: center; margin-bottom: 20px; }
    #profile-section img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 2px solid #4285f4;
    }
    #profile-section span { display: block; margin-top: 10px; font-weight: 500; }
    #profile-section button {
      margin-top: 10px;
      padding: 6px 10px;
      font-size: 0.9em;
      cursor: pointer;
    }
    #sidebar nav ul { list-style: none; padding: 0; }
    #sidebar nav ul li {
      padding: 10px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.3s;
    }
    #sidebar nav ul li:hover { background: #f1f3f4; }

    /* Calendário – Grid semanal */
    #calendar-container {
      margin-left: 250px;
      padding: 20px;
    }
    .calendar-header {
      display: grid;
      grid-template-columns: 60px repeat(7, 1fr);
      border-bottom: 1px solid #dadce0;
    }
    .calendar-header div {
      padding: 10px;
      text-align: center;
      font-weight: 500;
    }
    .calendar-header .time-slot { background: #f8f9fa; }
    .calendar-grid {
      display: grid;
      grid-template-columns: 60px repeat(7, 1fr);
    }
    .calendar-grid .time-label {
      padding: 10px;
      text-align: right;
      border-top: 1px solid #dadce0;
      border-right: 1px solid #dadce0;
      background: #f8f9fa;
    }
    .calendar-grid .day-cell {
      position: relative;
      border-top: 1px solid #dadce0;
      border-right: 1px solid #dadce0;
      height: 60px;
      cursor: pointer;
    }
    /* Bloco de evento */
    .event-block {
      position: absolute;
      left: 2px;
      right: 2px;
      background: #34a853;
      color: white;
      padding: 2px 4px;
      border-radius: 2px;
      font-size: 0.8em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 4px;
      width: 90%;
      max-width: 500px;
    }
    .modal-content input,
    .modal-content textarea {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border: 1px solid #dadce0;
      border-radius: 4px;
    }
    .modal-content button {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    /* Informação do evento (dia/hora) no modal */
    #event-info { font-size: 0.9em; margin-bottom: 10px; color: #555; }

    /* Toast */
    #toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
    }
    .toast {
      background: #202124;
      color: white;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
    }
    /* Responsividade */
    @media (max-width: 768px) {
      #sidebar { display: none; }
      #calendar-container { margin-left: 0; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header id="header">
    <div class="nav-buttons">
      <button id="prev-week">Anterior</button>
      <button id="next-week">Próxima</button>
    </div>
    <div id="current-week-display">Semana: ...</div>
    <div id="user-info"></div>
  </header>

  <!-- Sidebar -->
  <aside id="sidebar">
    <div id="profile-section">
      <img src="" alt="Perfil" id="profile-pic">
      <span id="profile-name">Usuário</span>
      <button id="upload-profile-pic-btn">Alterar Imagem</button>
      <input type="file" id="profile-pic-upload" accept="image/*" style="display:none;">
    </div>
    <nav>
      <ul>
        <li onclick="showHistory()">Histórico</li>
        <li onclick="logout()">Sair</li>
      </ul>
    </nav>
    <!-- Modal de Histórico -->
    <div id="history-modal" class="modal">
      <div class="modal-content">
        <h3>Histórico de Alterações</h3>
        <div id="history-log" style="max-height:300px; overflow:auto;"></div>
        <button onclick="closeHistory()">Fechar</button>
      </div>
    </div>
  </aside>

  <!-- Calendário -->
  <div id="calendar-container">
    <div class="calendar-header" id="calendar-header">
      <!-- Gerado dinamicamente: primeira célula vazia + 7 dias -->
    </div>
    <div class="calendar-grid" id="calendar-grid">
      <!-- Gerado dinamicamente: coluna de horários e células dos dias -->
    </div>
  </div>

  <!-- Modal de Autenticação -->
  <div id="auth-modal" class="modal">
    <div class="modal-content">
      <h3>Entrar / Registrar</h3>
      <input type="email" id="auth-email" placeholder="Email">
      <input type="password" id="auth-password" placeholder="Senha">
      <button id="auth-login-btn">Entrar</button>
      <hr>
      <input type="text" id="auth-username" placeholder="Usuário (5 caracteres)">
      <input type="password" id="auth-register-password" placeholder="Senha (mínimo 6 caracteres)">
      <input type="password" id="auth-register-password-confirm" placeholder="Confirme a senha">
      <label><input type="checkbox" id="auth-terms"> Aceito os Termos e Política</label>
      <button id="auth-register-btn">Registrar</button>
      <p><a href="#" id="auth-forgot-password">Esqueceu a senha?</a></p>
    </div>
  </div>

  <!-- Modal de Evento -->
  <div id="event-modal" class="modal">
    <div class="modal-content">
      <h3>Editar Evento</h3>
      <p id="event-info"></p>
      <input type="text" id="event-title" placeholder="Título do Evento">
      <textarea id="event-description" placeholder="Descrição"></textarea>
      <label>Início: <input type="time" id="event-start"></label>
      <label>Término: <input type="time" id="event-end"></label>
      <button id="save-event">Salvar</button>
      <button id="cancel-event">Cancelar</button>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

  <script>
    "use strict";
    /***************************************
     * CONFIGURAÇÃO DO FIREBASE
     ***************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyDxMWPu_CnXV-u4-vlDFd-IZ8fzlyKJHng",
      authDomain: "financeiro-5.firebaseapp.com",
      databaseURL: "https://financeiro-5-default-rtdb.firebaseio.com",
      projectId: "financeiro-5",
      storageBucket: "financeiro-5.appspot.com",
      messagingSenderId: "686639785223",
      appId: "1:686639785223:web:0314689c82c6dd1c2951a2",
      measurementId: "G-Q5REWML5DX"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    /***************************************
     * VARIÁVEIS GLOBAIS
     ***************************************/
    let currentUser = null;
    let currentWeekStart = null; // Data da segunda-feira da semana
    let calendarEvents = {};     // Eventos armazenados (chave: "hour-day")
    let historyLog = [];

    /***************************************
     * FUNÇÕES UTILITÁRIAS
     ***************************************/
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.getElementById('toast-container').appendChild(toast);
      setTimeout(() => { toast.remove(); }, 3000);
    }
    function logHistory(message) {
      const timestamp = new Date().toISOString();
      historyLog.push({ message, timestamp });
      updateHistoryModal();
    }
    function updateHistoryModal() {
      const historyDiv = document.getElementById('history-log');
      historyDiv.innerHTML = "";
      historyLog.forEach(entry => {
        const p = document.createElement('p');
        p.textContent = `[${entry.timestamp}] ${entry.message}`;
        historyDiv.appendChild(p);
      });
    }
    function showHistory() { document.getElementById('history-modal').style.display = 'flex'; }
    function closeHistory() { document.getElementById('history-modal').style.display = 'none'; }

    /***************************************
     * AUTENTICAÇÃO
     ***************************************/
    function validarUsuario(usuario) {
      if (usuario.length !== 5) return "Usuário deve ter 5 caracteres.";
      return "";
    }
    function validarSenha(senha) {
      if (senha.length < 6) return "Senha deve ter pelo menos 6 caracteres.";
      return "";
    }
    function login() {
      const email = document.getElementById('auth-email').value.trim();
      const password = document.getElementById('auth-password').value.trim();
      if (!email) { alert("Informe um email válido."); return; }
      let erro = validarSenha(password);
      if (erro) { alert(erro); return; }
      auth.signInWithEmailAndPassword(email, password)
      .then(() => { showToast("Login efetuado."); })
      .catch(error => { alert("Erro no login: " + error.message); });
    }
    function register() {
      const email = document.getElementById('auth-email').value.trim();
      const password = document.getElementById('auth-register-password').value.trim();
      const confirmPassword = document.getElementById('auth-register-password-confirm').value.trim();
      const username = document.getElementById('auth-username').value.trim();
      const termosAceitos = document.getElementById('auth-terms').checked;
      let erro = validarUsuario(username) || validarSenha(password);
      if (password !== confirmPassword) { alert("Senhas não conferem."); return; }
      if (!termosAceitos) { alert("Aceite os Termos."); return; }
      if (erro) { alert(erro); return; }
      // Email padrão usando o username
      const emailPadrao = username + "@SoundStruct.com";
      auth.createUserWithEmailAndPassword(emailPadrao, password)
      .then(userCredential => {
        currentUser = userCredential.user;
        return database.ref("usuarios/" + currentUser.uid).set({
          username: username,
          criadoEm: new Date().toISOString()
        });
      })
      .then(() => { showToast("Registro efetuado."); })
      .catch(error => { alert("Erro no registro: " + error.message); });
    }
    document.getElementById('auth-login-btn').addEventListener('click', login);
    document.getElementById('auth-register-btn').addEventListener('click', register);
    document.getElementById('auth-forgot-password').addEventListener('click', () => {
      const email = document.getElementById('auth-email').value.trim();
      if (email) {
        auth.sendPasswordResetEmail(email)
        .then(() => { showToast("Email de recuperação enviado."); })
        .catch(error => { alert("Erro: " + error.message); });
      } else { alert("Informe o email para recuperação."); }
    });
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById('user-info').textContent = user.email;
        document.getElementById('auth-modal').style.display = 'none';
        updateProfileInfo();
        initializeCalendar();
      } else {
        currentUser = null;
        document.getElementById('auth-modal').style.display = 'flex';
      }
    });

    /***************************************
     * UPLOAD DE IMAGEM DE PERFIL
     ***************************************/
    document.getElementById('upload-profile-pic-btn').addEventListener('click', () => {
      document.getElementById('profile-pic-upload').click();
    });
    document.getElementById('profile-pic-upload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          document.getElementById('profile-pic').src = evt.target.result;
          // Opcional: salvar imagem no Firebase ou localStorage
        };
        reader.readAsDataURL(file);
      }
    });
    function updateProfileInfo() {
      if (currentUser && currentUser.email) {
        document.getElementById('profile-name').textContent = currentUser.email.split('@')[0];
      }
    }
    setInterval(updateProfileInfo, 15000);

    /***************************************
     * CALENDÁRIO SEMANAL – FUNCIONALIDADE E VISUAL
     ***************************************/
    const diasSemana = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado", "Domingo"];
    function initializeCalendar() {
      // Calcula a data da segunda-feira da semana atual
      const today = new Date();
      const day = today.getDay(); // 0 (Dom) a 6 (Sáb)
      const diff = today.getDate() - (day === 0 ? 6 : day - 1);
      currentWeekStart = new Date(today.setDate(diff));
      updateCurrentWeekDisplay();
      generateCalendarHeader();
      generateCalendarGrid();
      loadCalendarEvents();
    }
    function updateCurrentWeekDisplay() {
      const start = new Date(currentWeekStart);
      const end = new Date(start);
      end.setDate(end.getDate() + 6);
      document.getElementById('current-week-display').textContent =
      start.toLocaleDateString() + " - " + end.toLocaleDateString();
    }
    // Gera o cabeçalho do calendário com dia e data
    function generateCalendarHeader() {
      const header = document.getElementById('calendar-header');
      header.innerHTML = "";
      // Primeira célula para rótulo de horário
      const emptyCell = document.createElement('div');
      emptyCell.className = "time-slot";
      header.appendChild(emptyCell);
      // Para cada dia da semana
      for (let i = 0; i < 7; i++) {
        const dayCell = document.createElement('div');
        const dataDia = new Date(currentWeekStart);
        dataDia.setDate(dataDia.getDate() + i);
        dayCell.innerHTML = `<strong>${diasSemana[i]}</strong><br>${dataDia.toLocaleDateString()}`;
        header.appendChild(dayCell);
      }
    }
    // Gera a grade do calendário: coluna de horários + células para cada dia e hora
    function generateCalendarGrid() {
      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = "";
      for (let hour = 0; hour < 24; hour++) {
        // Rótulo da hora
        const timeLabel = document.createElement('div');
        timeLabel.className = "time-label";
        timeLabel.textContent = hour + ":00";
        grid.appendChild(timeLabel);
        // Células para cada dia
        for (let day = 0; day < 7; day++) {
          const cell = document.createElement('div');
          cell.className = "day-cell";
          cell.dataset.hour = hour;
          cell.dataset.day = day; // 0 = segunda, ... 6 = domingo
          cell.addEventListener('dblclick', () => { openEventModal(cell); });
          grid.appendChild(cell);
        }
      }
    }
    // Carrega eventos do Firebase para a semana atual
    function loadCalendarEvents() {
      if (!currentUser) return;
      const dateKey = currentWeekStart.toISOString().slice(0,10);
      const eventsRef = database.ref("agendas/" + currentUser.uid + "/" + dateKey);
      eventsRef.on("value", snapshot => {
        calendarEvents = snapshot.val() || {};
        renderCalendarEvents();
      });
    }
    // Renderiza os eventos na grade
    function renderCalendarEvents() {
      // Limpa células
      const cells = document.querySelectorAll('.day-cell');
      cells.forEach(cell => { cell.innerHTML = ""; });
      Object.keys(calendarEvents).forEach(key => {
        // key no formato "hour-day" (ex: "14-3" para 14:00 na quarta)
        const [hour, day] = key.split('-').map(Number);
        let events = calendarEvents[key];
        if (events && typeof events === 'object' && !Array.isArray(events)) {
          events = Object.values(events);
        }
        if (!Array.isArray(events)) { events = []; }
        // Encontra a célula correspondente (day armazenado de 1 a 7; convertendo para 0-index)
        const cell = document.querySelector(`.day-cell[data-hour='${hour}'][data-day='${day-1}']`);
        if (cell) {
          events.forEach((event, index) => {
            const eventBlock = document.createElement('div');
            eventBlock.className = "event-block";
            eventBlock.textContent = event.titulo;
            eventBlock.addEventListener('click', (e) => {
              e.stopPropagation();
              openEventModal(cell, index, event);
            });
            cell.appendChild(eventBlock);
          });
        }
      });
    }

    /***************************************
     * MODAL DE EVENTO – CRIAÇÃO/EDIÇÃO
     ***************************************/
    function openEventModal(cell, eventIndex = null, eventData = null) {
      const modal = document.getElementById('event-modal');
      modal.style.display = 'flex';
      const hour = cell.dataset.hour;
      const dayIndex = Number(cell.dataset.day);
      const dataDia = new Date(currentWeekStart);
      dataDia.setDate(dataDia.getDate() + dayIndex);
      document.getElementById('event-info').textContent =
         "Dia: " + dataDia.toLocaleDateString() + " | Horário: " + hour + ":00";
      document.getElementById('event-title').value = eventData ? eventData.titulo : "";
      document.getElementById('event-description').value = eventData ? eventData.descricao : "";
      document.getElementById('event-start').value = eventData ? eventData.inicio : "";
      document.getElementById('event-end').value = eventData ? eventData.termino : "";
      // Armazena a chave da célula no formato "hour-day" (day de 1 a 7)
      modal.dataset.cellKey = hour + '-' + (dayIndex + 1);
      modal.dataset.eventIndex = eventIndex;
    }
    function closeEventModal() {
      const modal = document.getElementById('event-modal');
      modal.style.display = 'none';
      delete modal.dataset.cellKey;
      delete modal.dataset.eventIndex;
    }
    document.getElementById('cancel-event').addEventListener('click', closeEventModal);
    function saveEvent() {
      const modal = document.getElementById('event-modal');
      const cellKey = modal.dataset.cellKey;
      const eventIndex = modal.dataset.eventIndex;
      const titulo = document.getElementById('event-title').value;
      const descricao = document.getElementById('event-description').value;
      const inicio = document.getElementById('event-start').value;
      const termino = document.getElementById('event-end').value;
      if (!titulo || !inicio || !termino) { showToast("Preencha os campos obrigatórios."); return; }
      const newEvent = { titulo, descricao, inicio, termino };
      const dateKey = currentWeekStart.toISOString().slice(0,10);
      const cellRef = database.ref("agendas/" + currentUser.uid + "/" + dateKey + "/" + cellKey);
      let events = calendarEvents[cellKey];
      if (!Array.isArray(events)) { events = []; }
      if (eventIndex !== null && eventIndex !== "") {
         events[eventIndex] = newEvent;
         logHistory("Evento editado em " + cellKey + ": " + titulo);
      } else {
         events.push(newEvent);
         logHistory("Evento adicionado em " + cellKey + ": " + titulo);
      }
      cellRef.set(events)
      .then(() => { showToast("Evento salvo."); closeEventModal(); })
      .catch(error => { showToast("Erro ao salvar: " + error.message); });
    }
    document.getElementById('save-event').addEventListener('click', saveEvent);

    /***************************************
     * EXPORTAÇÃO/IMPORTAÇÃO CSV
     ***************************************/
    function exportCalendarToCSV() {
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Hora,Seg,Ter,Qua,Qui,Sex,Sáb,Dom\n";
      for (let hour = 0; hour < 24; hour++) {
        let row = hour + ":00";
        for (let day = 1; day <= 7; day++) {
          const key = hour + '-' + day;
          const events = Array.isArray(calendarEvents[key]) ? calendarEvents[key] : [];
          let cellText = events.map(ev => ev.titulo).join(" | ");
          row += "," + cellText;
        }
        csvContent += row + "\n";
      }
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "agenda.csv");
      document.body.appendChild(link);
      link.click();
      link.remove();
      showToast("Agenda exportada para CSV.");
    }
    function importCalendarFromCSV(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const csvData = e.target.result;
        // Implemente o processamento do CSV conforme necessário
        showToast("Agenda importada com sucesso.");
      };
      reader.readAsText(file);
    }
    document.getElementById('export-csv').addEventListener('click', exportCalendarToCSV);
    document.getElementById('import-csv-btn').addEventListener('click', () => {
      document.getElementById('import-csv').click();
    });
    document.getElementById('import-csv').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) importCalendarFromCSV(file);
    });

    /***************************************
     * LOGOUT
     ***************************************/
    function logout() {
      auth.signOut().then(() => {
        showToast("Logout efetuado.");
        location.reload();
      }).catch(error => {
        showToast("Erro no logout: " + error.message);
      });
    }

    /***************************************
     * INICIALIZAÇÃO
     ***************************************/
    function initApp() {
      console.log("Sistema de agenda iniciado.");
    }
    initApp();
  </script>
</body>
</html>

