<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sa√∫de & Performance ‚Ä¢ Avalia√ß√£o F√≠sica</title>
  <meta name="theme-color" content="#0b0d12" />
  <style>
    :root{
      --bg0:#07080b; --bg1:#0b0d12;
      --cardA: rgba(255,255,255,.09);
      --cardB: rgba(255,255,255,.03);
      --text:#eaf0ff; --muted:#9aa6c3; --line:rgba(255,255,255,.10);
      --good:#2dd4bf; --bad:#fb7185; --warn:#fbbf24; --brand:#60a5fa;
      --shadow: 0 20px 90px rgba(0,0,0,.58);
      --r:18px; --r2:26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text","Segoe UI", Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% -10%, rgba(96,165,250,.22), transparent 60%),
        radial-gradient(1000px 800px at 95% 10%, rgba(45,212,191,.14), transparent 55%),
        radial-gradient(900px 700px at 80% 115%, rgba(251,113,133,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 45%, #07090f 100%);
      overflow-x:hidden;
    }
    .safe{padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    .wrap{max-width:1280px; margin:0 auto; padding:22px 16px 88px;}
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 16px;
      margin:-22px -16px 14px;
      backdrop-filter: blur(18px);
      background: linear-gradient(180deg, rgba(7,8,11,.90), rgba(7,8,11,.35));
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background:
        radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(20px 20px at 70% 30%, rgba(255,255,255,.15), transparent 60%),
        linear-gradient(135deg, rgba(96,165,250,.95), rgba(45,212,191,.75));
      border:1px solid rgba(255,255,255,.15);
      box-shadow: 0 16px 48px rgba(96,165,250,.18);
    }
    .brand h1{margin:0; font-size:14px; letter-spacing:.2px; line-height:1.1}
    .brand p{margin:0; font-size:12px; color:var(--muted); line-height:1.2}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center}

    .btn{
      appearance:none; border:none; cursor:pointer;
      border-radius:12px; padding:10px 12px;
      color:var(--text);
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      font-size:13px;
      display:inline-flex; align-items:center; gap:9px;
      user-select:none;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }
    .btn:hover{background:rgba(255,255,255,.09); border-color:rgba(255,255,255,.14)}
    .btn:active{transform:scale(.985)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(45,212,191,.72));
      border-color: rgba(255,255,255,.18);
      color:#071017;
      font-weight:850;
    }
    .btn.danger{background:rgba(251,113,133,.14); border-color:rgba(251,113,133,.28)}
    .btn.ghost{background:transparent; box-shadow:none}
    .pill{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      border-radius:999px; padding:8px 10px;
      box-shadow: 0 6px 24px rgba(0,0,0,.25) inset;
    }
    .pill span{font-size:12px; color:var(--muted); max-width:360px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

    .grid{display:grid; grid-template-columns:1.32fr .68fr; gap:12px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .card{
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border:1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .title{display:flex; flex-direction:column; gap:4px;}
    .title h2{margin:0; font-size:14px; letter-spacing:.2px}
    .title p{margin:0; font-size:12px; color:var(--muted)}
    .card .bd{padding:14px 16px 16px;}

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      border-radius: 999px;
      padding:6px;
    }
    .tab{
      cursor:pointer;
      padding:9px 12px;
      border-radius: 999px;
      font-size:12px;
      border:1px solid transparent;
      color: rgba(233,240,255,.90);
      background: transparent;
      transition: background .15s ease, border-color .15s ease;
      user-select:none;
      display:flex; align-items:center; gap:8px;
    }
    .tab.active{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.12);
    }

    .kpis{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;}
    @media (max-width:980px){ .kpis{grid-template-columns: repeat(2, 1fr);} }
    .kpi{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius: var(--r);
      padding:12px;
      display:flex; flex-direction:column; gap:6px;
      min-height:78px;
    }
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-size:18px; font-weight:900; letter-spacing:.2px}
    .kpi .sub{font-size:11px; color:var(--muted)}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}

    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; justify-content:space-between;
      margin:12px 0 0;
    }
    .filters{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;}
    .field{display:flex; flex-direction:column; gap:6px; min-width:160px;}
    .field label{font-size:11px; color:var(--muted)}
    input, select, textarea{
      width:100%;
      background: rgba(0,0,0,.22);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding:10px 10px;
      color: var(--text);
      outline:none;
      font-family: var(--sans);
      font-size: 13px;
    }
    textarea{min-height:92px; resize: vertical;}
    input::placeholder, textarea::placeholder{color:rgba(154,166,195,.72)}
    input:focus, select:focus, textarea:focus{border-color: rgba(96,165,250,.55); box-shadow: 0 0 0 4px rgba(96,165,250,.12);}

    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width:680px){ .split{grid-template-columns:1fr;} }

    .divider{height:1px; background:var(--line); margin:12px 0;}

    .canvasBox{
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    canvas{width:100%; height:230px; display:block}
    .miniCanvas{height:210px;}
    .hint{font-size:12px; color:var(--muted); line-height:1.45}
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: rgba(233,238,252,.9);
    }

    .list{display:flex; flex-direction:column; gap:10px;}
    .row{
      display:grid;
      grid-template-columns: 1.2fr .8fr .6fr .9fr;
      gap:10px;
      align-items:center;
      padding:12px;
      border-radius: var(--r);
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      cursor:pointer;
    }
    .row:hover{border-color:rgba(255,255,255,.14); background: rgba(0,0,0,.22)}
    .row:active{transform:scale(.995)}
    @media (max-width:820px){ .row{grid-template-columns: 1fr; gap:8px;} }

    .main{display:flex; flex-direction:column; gap:3px;}
    .main .name{font-size:13px; font-weight:900}
    .main .meta{font-size:11px; color:var(--muted); display:flex; flex-wrap:wrap; gap:8px}
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
    }
    .amount{
      text-align:right;
      font-family: var(--mono);
      font-size: 13px;
      font-weight:950;
    }
    .right{display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: 16px;
      z-index:999;
      background: rgba(15,18,26,.88);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding:10px 14px;
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      max-width:min(920px, calc(100% - 22px));
      display:none;
      font-size:13px;
      color: var(--text);
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .toast.show{display:flex}

    .modal{
      position:fixed; inset:0; display:none; place-items:center; z-index:1000;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      padding: 16px;
    }
    .modal.show{display:grid}
    .panel{
      width:min(980px, 100%);
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .phd{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .panel .phd .ttl{display:flex; flex-direction:column; gap:3px}
    .panel .phd h3{margin:0; font-size:14px}
    .panel .phd p{margin:0; font-size:12px; color:var(--muted)}
    .panel .pbd{padding:14px 16px 16px}

    .noteBox{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding:10px 12px;
      font-size:12px;
      color: rgba(233,238,252,.92);
      line-height:1.35;
    }

    .evalGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width:980px){ .evalGrid{grid-template-columns:1fr;} }

    .evalCard{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
    }
    .evalTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .evalName{font-weight:950; font-size:13px;}
    .evalMeta{font-size:11px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap; margin-top:4px;}
    .bar{
      height:10px; border-radius:999px; overflow:hidden;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.08);
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(96,165,250,.95), rgba(45,212,191,.72));
      border-radius:999px;
    }

    /* bottom nav for mobile */
    .bottomNav{
      position:fixed; left:0; right:0; bottom:0; z-index:60;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      backdrop-filter: blur(18px);
      background: linear-gradient(180deg, rgba(7,8,11,.15), rgba(7,8,11,.78));
      border-top: 1px solid var(--line);
      display:none;
    }
    .bottomNav .tabs{width:100%; justify-content:space-between;}
    @media (max-width:980px){
      .bottomNav{display:block;}
      .desktopTabs{display:none;}
      .wrap{padding-bottom:120px;}
    }
  </style>

  <!-- Firebase compat: SEM auth (sem login) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>

<body class="safe">
  <div class="wrap">
    <header class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Sa√∫de & Performance</h1>
          <p>Apple-level ‚Ä¢ Avalia√ß√£o F√≠sica ‚Ä¢ KPIs ‚Ä¢ Gr√°ficos ‚Ä¢ Metas ‚Ä¢ Firebase</p>
        </div>
      </div>

      <div class="actions">
        <div class="pill" title="Banco de dados em uso">
          <span id="dbInfo">Conectando no Firebase‚Ä¶</span>
        </div>

        <div class="desktopTabs">
          <div class="tabs" id="tabsTop">
            <div class="tab active" data-tab="dash">üìä Dashboard</div>
            <div class="tab" data-tab="logs">üßæ Registros</div>
            <div class="tab" data-tab="goals">üéØ Metas</div>
            <div class="tab" data-tab="settings">‚öôÔ∏è Ajustes</div>
          </div>
        </div>

        <button class="btn ghost" id="btnExport" title="Exportar CSV">‚§ì CSV</button>
        <button class="btn ghost" id="btnPrint" title="Gerar PDF (imprimir)">üñ®Ô∏è PDF</button>
        <button class="btn primary" id="btnNew">Ôºã Registro</button>
      </div>
    </header>

    <main class="grid">
      <!-- LEFT: Main content -->
      <section class="card" aria-label="Conte√∫do">
        <div class="hd">
          <div class="title">
            <h2 id="pageTitle">Dashboard</h2>
            <p id="pageSub">Avalia√ß√£o + tend√™ncias + gr√°ficos profissionais</p>
          </div>

          <div class="right">
            <div class="field" style="min-width:240px;">
              <label for="period">Per√≠odo</label>
              <select id="period">
                <option value="thisMonth">Este m√™s</option>
                <option value="lastMonth">M√™s passado</option>
                <option value="last90">√öltimos 90 dias</option>
                <option value="thisYear">Este ano</option>
                <option value="custom">Personalizado</option>
              </select>
            </div>
            <div class="field" id="customRange" style="min-width:280px; display:none;">
              <label>Intervalo</label>
              <div class="split">
                <input id="dateFrom" type="date" />
                <input id="dateTo" type="date" />
              </div>
            </div>
          </div>
        </div>

        <div class="bd">
          <!-- DASH -->
          <div id="viewDash">
            <div class="kpis">
              <div class="kpi">
                <div class="label">Peso (√∫ltimo)</div>
                <div class="value" id="kpiWeight">‚Äî</div>
                <div class="sub" id="kpiWeightSub">Tend√™ncia: ‚Äî</div>
              </div>
              <div class="kpi">
                <div class="label">IMC</div>
                <div class="value" id="kpiBMI">‚Äî</div>
                <div class="sub" id="kpiBMISub">Faixa: ‚Äî</div>
              </div>
              <div class="kpi">
                <div class="label">% Gordura</div>
                <div class="value" id="kpiBF">‚Äî</div>
                <div class="sub" id="kpiBFSub">Classifica√ß√£o: ‚Äî</div>
              </div>
              <div class="kpi">
                <div class="label">TDEE (estim.)</div>
                <div class="value" id="kpiTDEE">‚Äî</div>
                <div class="sub" id="kpiTDEESub">BMR + atividade</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="toolbar">
              <div class="filters">
                <div class="field">
                  <label for="fMetric">M√©trica</label>
                  <select id="fMetric">
                    <option value="weight">Peso</option>
                    <option value="bmi">IMC</option>
                    <option value="bf">Gordura %</option>
                    <option value="muscle">Massa muscular (kg)</option>
                    <option value="waist">Cintura (cm)</option>
                    <option value="whr">Cintura/Altura</option>
                    <option value="tdee">TDEE (kcal)</option>
                  </select>
                </div>
                <div class="field">
                  <label for="fChart">Tipo de gr√°fico</label>
                  <select id="fChart">
                    <option value="line">Linha (tend√™ncia)</option>
                    <option value="area">√Årea (suave)</option>
                    <option value="bar">Barras (compara√ß√£o)</option>
                    <option value="spark">Sparkline (compacto)</option>
                  </select>
                </div>
                <div class="field">
                  <label for="fSmooth">Suaviza√ß√£o</label>
                  <select id="fSmooth">
                    <option value="0">Nenhuma</option>
                    <option value="3">M√©dia m√≥vel 3</option>
                    <option value="5">M√©dia m√≥vel 5</option>
                    <option value="7">M√©dia m√≥vel 7</option>
                  </select>
                </div>
                <div class="field" style="min-width:240px;">
                  <label for="fSearch">Buscar</label>
                  <input id="fSearch" placeholder="Ex: treino, jejum, corrida, dor‚Ä¶" />
                </div>
              </div>

              <div class="right">
                <button class="btn" id="btnDemo" title="Criar exemplos">‚ú® Demo</button>
                <button class="btn" id="btnRefresh" title="Atualizar">‚ü≥ Atualizar</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="chartsGrid" style="margin-top:0;">
              <div>
                <div class="canvasBox">
                  <canvas id="chartMain"></canvas>
                </div>
                <div class="hint" style="margin-top:8px;">
                  Gr√°fico principal (m√©trica + tipo). Atalhos: <span class="kbd">N</span> novo ‚Ä¢ <span class="kbd">Ctrl+E</span> CSV ‚Ä¢ <span class="kbd">Esc</span> fechar
                </div>
              </div>
              <div>
                <div class="canvasBox">
                  <canvas id="chartGauge" class="miniCanvas"></canvas>
                </div>
                <div class="hint" style="margin-top:8px;">
                  <b>Avalia√ß√£o</b> baseada em limites (idade/sexo/altura) + metas. (Estimativas ‚Äî n√£o substitui avalia√ß√£o m√©dica.)
                </div>
              </div>
            </div>

            <div class="chartsRow">
              <div>
                <div class="canvasBox">
                  <canvas id="chartComposition" class="miniCanvas"></canvas>
                </div>
                <div class="hint" style="margin-top:8px;">
                  <b>Composi√ß√£o</b>: Massa magra vs gordura (estimativa a partir dos seus inputs).
                </div>
              </div>
              <div>
                <div class="canvasBox">
                  <canvas id="chartRisk" class="miniCanvas"></canvas>
                </div>
                <div class="hint" style="margin-top:8px;">
                  <b>Risco cardio-metab√≥lico</b>: cintura e cintura/altura (alertas).
                </div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="title" style="margin-bottom:8px;">
              <h2 style="margin:0; font-size:13px;">Avalia√ß√£o completa (faixas inferiores/superiores)</h2>
              <p style="margin:0; font-size:12px; color:var(--muted)">Os limites mudam com sexo/idade/altura. Voc√™ v√™ ‚Äúonde est√°‚Äù e ‚Äúonde deveria estar‚Äù.</p>
            </div>

            <div class="evalGrid" id="evalGrid"></div>

            <div class="divider"></div>

            <div class="title" style="margin-bottom:10px;">
              <h2 style="margin:0; font-size:13px;">Registros (do per√≠odo)</h2>
              <p style="margin:0; font-size:12px; color:var(--muted)">Clique para editar.</p>
            </div>

            <div class="list" id="logList"></div>
          </div>

          <!-- LOGS -->
          <div id="viewLogs" style="display:none;">
            <div class="noteBox">
              Aqui ficam todos os registros. Use busca e per√≠odo para filtrar.
              Dica: adicione observa√ß√µes como ‚Äútreino‚Äù, ‚Äúsono‚Äù, ‚Äú√°lcool‚Äù, ‚Äúdor‚Äù, ‚ÄúPR no supino‚Äù, etc.
            </div>
            <div class="divider"></div>
            <div class="list" id="logListAll"></div>
          </div>

          <!-- GOALS -->
          <div id="viewGoals" style="display:none;">
            <div class="toolbar" style="margin-top:0;">
              <div class="title">
                <h2 style="margin:0; font-size:13px;">Metas</h2>
                <p style="margin:0; font-size:12px; color:var(--muted)">Peso, gordura, cintura, m√∫sculo e calorias</p>
              </div>
              <div class="right">
                <button class="btn primary" id="btnNewGoal">Ôºã Meta</button>
              </div>
            </div>
            <div class="divider"></div>
            <div class="noteBox" id="goalsSummary">Carregando metas‚Ä¶</div>
            <div class="divider"></div>
            <div class="list" id="goalsList"></div>
          </div>

          <!-- SETTINGS -->
          <div id="viewSettings" style="display:none;">
            <div class="noteBox">
              Ajustes ‚Äúde verdade‚Äù: perfil (sexo/idade/altura), atividade, unidades e limites.
              <b>Obs:</b> os c√°lculos aqui s√£o <b>estimativas</b> e servem para acompanhamento.
            </div>

            <div class="divider"></div>

            <div class="split">
              <div class="field">
                <label for="stSex">Sexo</label>
                <select id="stSex">
                  <option value="male">Masculino</option>
                  <option value="female">Feminino</option>
                </select>
              </div>
              <div class="field">
                <label for="stAge">Idade (anos)</label>
                <input id="stAge" inputmode="numeric" placeholder="Ex: 28" />
              </div>
            </div>

            <div class="split" style="margin-top:10px;">
              <div class="field">
                <label for="stHeight">Altura (cm)</label>
                <input id="stHeight" inputmode="decimal" placeholder="Ex: 171" />
              </div>
              <div class="field">
                <label for="stActivity">N√≠vel de atividade</label>
                <select id="stActivity">
                  <option value="1.2">Sedent√°rio (1.2)</option>
                  <option value="1.375">Leve (1.375)</option>
                  <option value="1.55" selected>Moderado (1.55)</option>
                  <option value="1.725">Alto (1.725)</option>
                  <option value="1.9">Muito alto (1.9)</option>
                </select>
              </div>
            </div>

            <div class="divider"></div>

            <div class="split">
              <div class="field">
                <label for="stUnits">Unidades</label>
                <select id="stUnits">
                  <option value="metric" selected>M√©trico (kg / cm)</option>
                </select>
              </div>
              <div class="field">
                <label for="stTrend">Janela de tend√™ncia padr√£o</label>
                <select id="stTrend">
                  <option value="3">3 pontos</option>
                  <option value="5" selected>5 pontos</option>
                  <option value="7">7 pontos</option>
                  <option value="10">10 pontos</option>
                </select>
              </div>
            </div>

            <div class="divider"></div>

            <div class="split">
              <div class="field">
                <label for="stNotes">Notas r√°pidas (1 por linha)</label>
                <textarea id="stNotes" placeholder="Ex:
Treino
Sono ruim
Jejum
√Ålcool
Corrida
Dor lombar
"></textarea>
              </div>
              <div class="noteBox">
                <b>Como o app avalia:</b><br>
                ‚Ä¢ IMC (OMS)<br>
                ‚Ä¢ % gordura (faixas por sexo/idade ‚Äì refer√™ncia pr√°tica)<br>
                ‚Ä¢ Cintura e cintura/altura (alertas)<br>
                ‚Ä¢ BMR/TDEE (Mifflin-St Jeor + fator atividade)<br><br>
                <span class="hint">Se quiser, d√° para calibrar % gordura com dobras/DEXA mais tarde.</span>
              </div>
            </div>

            <div class="divider"></div>

            <div class="right">
              <button class="btn primary" id="btnSaveSettings">‚úî Salvar Ajustes</button>
            </div>

            <div class="hint" style="margin-top:10px;">
              Salvo em: <span class="kbd">/health_settings</span> ‚Ä¢ Dados em <span class="kbd">/health_logs</span> ‚Ä¢ Metas em <span class="kbd">/health_goals</span>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Side panel -->
      <aside class="card" aria-label="A√ß√µes r√°pidas">
        <div class="hd">
          <div class="title">
            <h2>Atalhos</h2>
            <p>R√°pido, limpo e ‚ÄúApple feel‚Äù</p>
          </div>
          <button class="btn ghost" id="btnHome">‚Ü© Principal</button>
        </div>

        <div class="bd">
          <div class="noteBox">
            ‚úÖ Sem login<br>
            ‚úÖ Firebase mantido (mesma config)<br>
            ‚úÖ Avalia√ß√£o com limites din√¢micos<br>
            ‚úÖ Gr√°ficos ‚Äúpro‚Äù + CSV + PDF
          </div>

          <div class="divider"></div>

          <div class="title">
            <h2 style="margin:0; font-size:13px;">Resumo de hoje</h2>
            <p style="margin:0; font-size:12px; color:var(--muted)">Baseado no √∫ltimo registro</p>
          </div>

          <div style="margin-top:10px;" class="list" id="todayMini"></div>

          <div class="divider"></div>

          <div class="title">
            <h2 style="margin:0; font-size:13px;">Metas em destaque</h2>
            <p style="margin:0; font-size:12px; color:var(--muted)">Clique para editar</p>
          </div>
          <div style="margin-top:10px;" class="list" id="goalsMini"></div>

          <div class="divider"></div>

          <div class="right">
            <button class="btn ghost" id="btnExport2">‚§ì CSV</button>
            <button class="btn ghost" id="btnPrint2">üñ®Ô∏è PDF</button>
          </div>

          <div class="divider"></div>

          <div class="hint">
            Atalhos: <span class="kbd">N</span> novo ‚Ä¢ <span class="kbd">Ctrl+E</span> CSV ‚Ä¢ <span class="kbd">Esc</span> fechar
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Mobile bottom nav -->
  <div class="bottomNav">
    <div class="tabs" id="tabsBottom">
      <div class="tab active" data-tab="dash">üìä</div>
      <div class="tab" data-tab="logs">üßæ</div>
      <div class="tab" data-tab="goals">üéØ</div>
      <div class="tab" data-tab="settings">‚öôÔ∏è</div>
    </div>
  </div>

  <!-- MODAL: Log -->
  <div class="modal" id="logModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="logTitle">
      <div class="phd">
        <div class="ttl">
          <h3 id="logTitle">Novo registro</h3>
          <p>Peso, medidas, composi√ß√£o e observa√ß√µes</p>
        </div>
        <div class="right">
          <button class="btn ghost" id="btnCloseLog">‚úï</button>
          <button class="btn danger" id="btnDeleteLog" style="display:none;">üóëÔ∏è</button>
          <button class="btn primary" id="btnSaveLog">Salvar</button>
        </div>
      </div>

      <div class="pbd">
        <div class="split">
          <div class="field">
            <label for="logDate">Data</label>
            <input id="logDate" type="date" />
          </div>
          <div class="field">
            <label for="logTime">Hora</label>
            <input id="logTime" type="time" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="split">
          <div class="field">
            <label for="logWeight">Peso (kg)</label>
            <input id="logWeight" inputmode="decimal" placeholder="Ex: 82,0" />
          </div>
          <div class="field">
            <label for="logBF">Gordura (%)</label>
            <input id="logBF" inputmode="decimal" placeholder="Ex: 18,5 (opcional)" />
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="logMuscle">Massa muscular (kg)</label>
            <input id="logMuscle" inputmode="decimal" placeholder="Ex: 35,0 (opcional)" />
          </div>
          <div class="field">
            <label for="logWaist">Cintura (cm)</label>
            <input id="logWaist" inputmode="decimal" placeholder="Ex: 86 (opcional)" />
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="logNeck">Pesco√ßo (cm)</label>
            <input id="logNeck" inputmode="decimal" placeholder="Opcional (p/ estimar gordura pelo m√©todo US Navy)" />
          </div>
          <div class="field">
            <label for="logHip">Quadril (cm)</label>
            <input id="logHip" inputmode="decimal" placeholder="Opcional (mais √∫til no feminino p/ US Navy)" />
          </div>
        </div>

        <div class="field" style="margin-top:10px;">
          <label for="logNote">Observa√ß√µes</label>
          <textarea id="logNote" placeholder="Ex: Treino pesado, dormi 6h, muita reten√ß√£o, corrida 5km‚Ä¶"></textarea>
        </div>

        <div class="hint" id="logFoot"></div>
      </div>
    </div>
  </div>

  <!-- MODAL: Goal -->
  <div class="modal" id="goalModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="goalTitle">
      <div class="phd">
        <div class="ttl">
          <h3 id="goalTitle">Meta</h3>
          <p>Crie/edite metas (peso, gordura, cintura, m√∫sculo, calorias)</p>
        </div>
        <div class="right">
          <button class="btn ghost" id="btnCloseGoal">‚úï</button>
          <button class="btn danger" id="btnDeleteGoal" style="display:none;">üóëÔ∏è</button>
          <button class="btn primary" id="btnSaveGoal">Salvar</button>
        </div>
      </div>

      <div class="pbd">
        <div class="split">
          <div class="field">
            <label for="gType">Tipo</label>
            <select id="gType">
              <option value="weight">Peso (kg)</option>
              <option value="bf">Gordura (%)</option>
              <option value="waist">Cintura (cm)</option>
              <option value="muscle">Massa muscular (kg)</option>
              <option value="tdee">TDEE (kcal)</option>
            </select>
          </div>
          <div class="field">
            <label for="gName">Nome</label>
            <input id="gName" placeholder="Ex: Cutting 12 semanas" />
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="gTarget">Alvo</label>
            <input id="gTarget" inputmode="decimal" placeholder="Ex: 78,0" />
          </div>
          <div class="field">
            <label for="gDue">Prazo (opcional)</label>
            <input id="gDue" type="date" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="noteBox" id="goalFoot">Dica: metas ajudam o painel de avalia√ß√£o e os gauges.</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <div class="msg" id="toastMsg">‚Äî</div>
    <button class="btn ghost" id="toastClose">OK</button>
  </div>

  <script>
    /************************************************************
     * FirebaseConfig (EXATAMENTE o mesmo que voc√™ enviou)
     ************************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyAIp-rFuZZsBCNVJ3pSge4TE-XUuwYygrI",
      authDomain: "agenda-6accc.firebaseapp.com",
      databaseURL: "https://agenda-6accc-default-rtdb.firebaseio.com",
      projectId: "agenda-6accc",
      storageBucket: "agenda-6accc.appspot.com",
      messagingSenderId: "794262176773",
      appId: "1:794262176773:web:c4e3837b29f635d5dc086c",
      measurementId: "G-CVBQ54PERH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const $ = (id)=>document.getElementById(id);

    const PATH = {
      settings: "/health_settings",
      logs: "/health_logs",
      goals: "/health_goals"
    };

    const defaults = {
      sex: "male",
      age: 28,
      heightCm: 171,
      activity: 1.55,
      units: "metric",
      trendWindow: 5,
      quickNotes: ["Treino","Sono ruim","Jejum","√Ålcool","Corrida","Dor"]
    };

    const state = {
      settings: {...defaults},
      logs: [],
      goals: [],
      period: "thisMonth",
      range: {from:null, to:null},
      filters: { metric:"weight", chart:"line", smooth:0, search:"" },
      editingLogId: null,
      editingGoalId: null
    };

    function toast(msg){
      $("toastMsg").textContent = msg;
      $("toast").classList.add("show");
      setTimeout(()=> $("toast").classList.remove("show"), 2600);
    }
    $("toastClose").addEventListener("click", ()=> $("toast").classList.remove("show"));

    function openModal(id){ $(id).classList.add("show"); }
    function closeModal(id){ $(id).classList.remove("show"); }

    function nowISODate(){
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }
    function nowISOTime(){
      const d = new Date();
      return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }

    function startOfMonth(d=new Date()){ return new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0,0); }
    function endOfMonth(d=new Date()){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); }
    function startOfYear(d=new Date()){ return new Date(d.getFullYear(), 0, 1, 0,0,0,0); }
    function endOfYear(d=new Date()){ return new Date(d.getFullYear(), 11, 31, 23,59,59,999); }

    function clampRange(){
      const now = new Date();
      if(state.period==="thisMonth"){
        state.range.from = startOfMonth(now);
        state.range.to = endOfMonth(now);
      }else if(state.period==="lastMonth"){
        const prev = new Date(now.getFullYear(), now.getMonth()-1, 15);
        state.range.from = startOfMonth(prev);
        state.range.to = endOfMonth(prev);
      }else if(state.period==="last90"){
        state.range.to = new Date(now.getTime());
        state.range.from = new Date(now.getTime() - 89*86400000);
        state.range.from.setHours(0,0,0,0);
        state.range.to.setHours(23,59,59,999);
      }else if(state.period==="thisYear"){
        state.range.from = startOfYear(now);
        state.range.to = endOfYear(now);
      }else{
        const f = $("dateFrom").value ? new Date($("dateFrom").value+"T00:00:00") : startOfMonth(now);
        const t = $("dateTo").value ? new Date($("dateTo").value+"T23:59:59") : endOfMonth(now);
        state.range.from = f;
        state.range.to = t;
      }
    }

    function safeText(s){ return String(s ?? "").replace(/[<>]/g,"").trim(); }
    function toNum(str){
      if(typeof str !== "string") return Number(str||0);
      const s = str.trim().replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,"");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function fmt1(n){ return Number.isFinite(n) ? (Math.round(n*10)/10).toFixed(1).replace(".",",") : "‚Äî"; }
    function fmt2(n){ return Number.isFinite(n) ? (Math.round(n*100)/100).toFixed(2).replace(".",",") : "‚Äî"; }
    function fmt0(n){ return Number.isFinite(n) ? String(Math.round(n)) : "‚Äî"; }

    function inRange(ts){
      return ts >= state.range.from.getTime() && ts <= state.range.to.getTime();
    }

    /************************************************************
     * MODELOS DE AVALIA√á√ÉO (limites din√¢micos)
     ************************************************************/
    function bmi(weightKg, heightCm){
      const h = (heightCm||0)/100;
      if(h<=0) return NaN;
      return weightKg/(h*h);
    }
    function bmiClass(v){
      if(!Number.isFinite(v)) return {label:"‚Äî", tag:"", cls:""};
      if(v<18.5) return {label:"Baixo peso", tag:"Aten√ß√£o", cls:"warn"};
      if(v<25) return {label:"Normal", tag:"Ok", cls:"good"};
      if(v<30) return {label:"Sobrepeso", tag:"Aten√ß√£o", cls:"warn"};
      if(v<35) return {label:"Obesidade I", tag:"Alerta", cls:"bad"};
      if(v<40) return {label:"Obesidade II", tag:"Alerta", cls:"bad"};
      return {label:"Obesidade III", tag:"Alerta", cls:"bad"};
    }

    // % gordura: faixas pr√°ticas por sexo e idade (aproxima√ß√£o tipo ACE)
    function bfBands(sex, age){
      const a = Math.max(18, Math.min(80, Number(age||0)));
      const male = (a<30)
        ? {ath:[6,13], fit:[14,17], avg:[18,24], high:[25,60]}
        : (a<40)
          ? {ath:[6,13], fit:[14,18], avg:[19,25], high:[26,60]}
          : (a<50)
            ? {ath:[7,14], fit:[15,19], avg:[20,26], high:[27,60]}
            : {ath:[8,15], fit:[16,20], avg:[21,27], high:[28,60]};
      const female = (a<30)
        ? {ath:[14,20], fit:[21,24], avg:[25,31], high:[32,60]}
        : (a<40)
          ? {ath:[14,21], fit:[22,25], avg:[26,32], high:[33,60]}
          : (a<50)
            ? {ath:[15,22], fit:[23,26], avg:[27,33], high:[34,60]}
            : {ath:[16,23], fit:[24,27], avg:[28,34], high:[35,60]};
      return (sex==="female") ? female : male;
    }
    function bfClass(v, sex, age){
      if(!Number.isFinite(v)) return {label:"‚Äî", tag:"", cls:"", band:null};
      const b = bfBands(sex, age);
      const inBand = (rng)=> v>=rng[0] && v<=rng[1];
      if(inBand(b.ath)) return {label:"Atl√©tico", tag:"Top", cls:"good", band:b.ath};
      if(inBand(b.fit)) return {label:"Fitness", tag:"Ok", cls:"good", band:b.fit};
      if(inBand(b.avg)) return {label:"M√©dio", tag:"Aten√ß√£o", cls:"warn", band:b.avg};
      if(inBand(b.high)) return {label:"Alto", tag:"Alerta", cls:"bad", band:b.high};
      return {label:"‚Äî", tag:"", cls:"", band:null};
    }

    function mifflinBMR(sex, weightKg, heightCm, age){
      if(!Number.isFinite(weightKg) || !Number.isFinite(heightCm) || !Number.isFinite(age)) return NaN;
      const s = (sex==="female") ? -161 : 5;
      return 10*weightKg + 6.25*heightCm - 5*age + s;
    }
    function tdee(sex, weightKg, heightCm, age, activity){
      const b = mifflinBMR(sex, weightKg, heightCm, age);
      if(!Number.isFinite(b)) return NaN;
      const f = Number(activity||1.2);
      return b * (Number.isFinite(f) ? f : 1.2);
    }

    function waistToHeight(waistCm, heightCm){
      if(!Number.isFinite(waistCm) || !Number.isFinite(heightCm) || heightCm<=0) return NaN;
      return waistCm/heightCm;
    }
    function whtrClass(v){
      if(!Number.isFinite(v)) return {label:"‚Äî", tag:"", cls:""};
      // regra pr√°tica: <0.5 ok; 0.5-0.6 aten√ß√£o; >0.6 alto risco
      if(v<0.5) return {label:"Baixo risco", tag:"Ok", cls:"good"};
      if(v<0.6) return {label:"Risco moderado", tag:"Aten√ß√£o", cls:"warn"};
      return {label:"Alto risco", tag:"Alerta", cls:"bad"};
    }
    function waistRisk(sex, waistCm){
      if(!Number.isFinite(waistCm)) return {label:"‚Äî", tag:"", cls:"", low:null, high:null};
      // limites pr√°ticos muito usados: homens 94/102, mulheres 80/88
      const cut = (sex==="female") ? {low:80, high:88} : {low:94, high:102};
      if(waistCm<cut.low) return {label:"Ok", tag:"Ok", cls:"good", ...cut};
      if(waistCm<cut.high) return {label:"Aten√ß√£o", tag:"Moderado", cls:"warn", ...cut};
      return {label:"Alerta", tag:"Alto", cls:"bad", ...cut};
    }

    // Estimativa % gordura por US Navy (se tiver medidas)
    function navyBodyFat(sex, heightCm, neckCm, waistCm, hipCm){
      if(!Number.isFinite(heightCm) || !Number.isFinite(neckCm) || !Number.isFinite(waistCm)) return NaN;
      // f√≥rmulas em cm usando log10; aproxima√ß√£o amplamente divulgada
      const log10 = (x)=> Math.log(x)/Math.LN10;
      if(sex==="female"){
        if(!Number.isFinite(hipCm)) return NaN;
        const v = 163.205*log10(waistCm + hipCm - neckCm) - 97.684*log10(heightCm) - 78.387;
        return v;
      }else{
        const v = 86.010*log10(waistCm - neckCm) - 70.041*log10(heightCm) + 36.76;
        return v;
      }
    }

    function trend(list, getVal, windowN){
      const n = Math.max(1, Number(windowN||5));
      const vals = list.map(getVal).filter(Number.isFinite);
      if(vals.length<2) return NaN;
      const k = Math.min(n, vals.length);
      const last = vals[0];                 // list vem ordenada desc (mais recente primeiro)
      const prevAvg = vals.slice(1,k).reduce((a,b)=>a+b,0)/(k-1||1);
      return last - prevAvg; // positivo = subiu
    }

    /************************************************************
     * SETTINGS + GOALS + LOGS (Firebase)
     ************************************************************/
    async function loadSettings(){
      const snap = await db.ref(PATH.settings).get().catch(()=>null);
      if(snap && snap.exists()){
        const v = snap.val() || {};
        state.settings = {
          sex: (v.sex==="female")?"female":"male",
          age: Number(v.age||defaults.age),
          heightCm: Number(v.heightCm||defaults.heightCm),
          activity: Number(v.activity||defaults.activity),
          units: v.units||"metric",
          trendWindow: Number(v.trendWindow||defaults.trendWindow),
          quickNotes: Array.isArray(v.quickNotes) ? v.quickNotes : defaults.quickNotes
        };
      }else{
        await db.ref(PATH.settings).set(defaults);
        state.settings = {...defaults};
      }

      $("stSex").value = state.settings.sex;
      $("stAge").value = String(state.settings.age||28);
      $("stHeight").value = String(state.settings.heightCm||171);
      $("stActivity").value = String(state.settings.activity||1.55);
      $("stUnits").value = state.settings.units||"metric";
      $("stTrend").value = String(state.settings.trendWindow||5);
      $("stNotes").value = (state.settings.quickNotes||[]).join("\n");
    }

    async function saveSettings(){
      const next = {
        sex: $("stSex").value==="female" ? "female" : "male",
        age: Math.max(10, Math.min(90, parseInt($("stAge").value||"0",10) || defaults.age)),
        heightCm: Math.max(80, Math.min(250, toNum($("stHeight").value||defaults.heightCm))),
        activity: Number($("stActivity").value||defaults.activity),
        units: $("stUnits").value||"metric",
        trendWindow: Math.max(1, Math.min(30, parseInt($("stTrend").value||"5",10) || 5)),
        quickNotes: $("stNotes").value.split("\n").map(s=>s.trim()).filter(Boolean).slice(0,80)
      };
      await db.ref(PATH.settings).set(next);
      state.settings = next;
      toast("Ajustes salvos.");
      renderAll();
    }

    function listenGoals(){
      db.ref(PATH.goals).on("value",(snap)=>{
        const v = snap.val() || {};
        const list = Object.values(v).filter(Boolean).map(g=>({
          id: g.id,
          type: g.type||"weight",
          name: g.name||"Meta",
          target: Number(g.target||0),
          due: g.due||""
        }));
        state.goals = list;
        renderGoals();
        renderAll();
      });
    }

    function listenLogs(){
      db.ref(PATH.logs).on("value",(snap)=>{
        const v = snap.val() || {};
        const list = Object.keys(v).map(id=>{
          const r=v[id]||{};
          const ts = Number(r.ts||0) || (r.dateTime ? new Date(r.dateTime).getTime() : Date.now());
          return {
            id,
            ts,
            weight: Number(r.weight||0),
            bf: Number(r.bf||0),
            muscle: Number(r.muscle||0),
            waist: Number(r.waist||0),
            neck: Number(r.neck||0),
            hip: Number(r.hip||0),
            note: safeText(r.note||"")
          };
        }).filter(x=>x.ts>0);

        list.sort((a,b)=>b.ts-a.ts);
        state.logs = list;

        $("dbInfo").textContent = `DB: /health_logs ‚Ä¢ itens: ${state.logs.length}`;
        renderAll();
      });
    }

    /************************************************************
     * CRUD Logs
     ************************************************************/
    function openLogModal(item=null){
      state.editingLogId = item ? item.id : null;
      $("logTitle").textContent = item ? "Editar registro" : "Novo registro";
      $("btnDeleteLog").style.display = item ? "inline-flex" : "none";

      const d = item ? new Date(item.ts) : new Date();
      $("logDate").value = item ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}` : nowISODate();
      $("logTime").value = item ? `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}` : nowISOTime();

      $("logWeight").value = item?.weight ? String(item.weight).replace(".",",") : "";
      $("logBF").value = item?.bf ? String(item.bf).replace(".",",") : "";
      $("logMuscle").value = item?.muscle ? String(item.muscle).replace(".",",") : "";
      $("logWaist").value = item?.waist ? String(item.waist).replace(".",",") : "";
      $("logNeck").value = item?.neck ? String(item.neck).replace(".",",") : "";
      $("logHip").value = item?.hip ? String(item.hip).replace(".",",") : "";
      $("logNote").value = item?.note || "";

      $("logFoot").textContent = item ? `ID: ${item.id}` : "Dica: se preencher cintura e pesco√ßo (e quadril no feminino), d√° para estimar % gordura (US Navy).";
      openModal("logModal");
    }

    function logFromForm(){
      const date = $("logDate").value || nowISODate();
      const time = $("logTime").value || "12:00";
      const ts = new Date(`${date}T${time}:00`).getTime();

      const weight = toNum($("logWeight").value);
      const bf = toNum($("logBF").value);
      const muscle = toNum($("logMuscle").value);
      const waist = toNum($("logWaist").value);
      const neck = toNum($("logNeck").value);
      const hip = toNum($("logHip").value);
      const note = safeText($("logNote").value);

      if(!Number.isFinite(weight) || weight<=0) throw new Error("Informe o peso (>0).");
      return { ts, weight, bf: bf>0?bf:0, muscle: muscle>0?muscle:0, waist: waist>0?waist:0, neck: neck>0?neck:0, hip: hip>0?hip:0, note };
    }

    async function saveLog(){
      try{
        const data = logFromForm();

        // Se BF n√£o foi informado, tenta estimar via US Navy (se tiver medidas)
        if(!(data.bf>0)){
          const est = navyBodyFat(state.settings.sex, state.settings.heightCm, data.neck, data.waist, data.hip);
          if(Number.isFinite(est) && est>0 && est<70){
            data.bf = Math.round(est*10)/10;
            if(!data.note) data.note = "BF estimado (US Navy)";
            else data.note = (data.note + " ‚Ä¢ BF estimado (US Navy)").slice(0, 400);
          }
        }

        if(state.editingLogId){
          await db.ref(`${PATH.logs}/${state.editingLogId}`).update({ ...data, updatedAt: Date.now() });
          toast("Registro atualizado.");
        }else{
          const ref = db.ref(PATH.logs).push();
          const id = ref.key;
          await ref.set({ id, ...data, createdAt: Date.now(), updatedAt: Date.now() });
          toast("Registro criado.");
        }

        closeModal("logModal");
      }catch(err){
        alert(err.message || "Erro ao salvar.");
      }
    }

    async function deleteLog(item){
      const ok = confirm("Excluir este registro?");
      if(!ok) return;
      await db.ref(`${PATH.logs}/${item.id}`).remove();
      toast("Exclu√≠do.");
    }

    /************************************************************
     * CRUD Goals
     ************************************************************/
    function openGoalModal(g=null){
      state.editingGoalId = g ? g.id : null;
      $("goalTitle").textContent = g ? "Editar meta" : "Nova meta";
      $("btnDeleteGoal").style.display = g ? "inline-flex" : "none";

      $("gType").value = g?.type || "weight";
      $("gName").value = g?.name || "";
      $("gTarget").value = g?.target ? String(g.target).replace(".",",") : "";
      $("gDue").value = g?.due || "";
      $("goalFoot").textContent = g ? `ID: ${g.id}` : "Dica: Meta de peso e gordura afeta a avalia√ß√£o e os alerts no dashboard.";
      openModal("goalModal");
    }

    async function saveGoal(){
      const type = $("gType").value || "weight";
      const name = safeText($("gName").value);
      const target = toNum($("gTarget").value);
      const due = $("gDue").value || "";

      if(!name) return alert("Informe o nome da meta.");
      if(!Number.isFinite(target) || target<=0) return alert("Informe um alvo (>0).");

      if(state.editingGoalId){
        await db.ref(`${PATH.goals}/${state.editingGoalId}`).update({ type, name, target, due, updatedAt: Date.now() });
        toast("Meta atualizada.");
      }else{
        const ref = db.ref(PATH.goals).push();
        const id = ref.key;
        await ref.set({ id, type, name, target, due, createdAt: Date.now(), updatedAt: Date.now() });
        toast("Meta criada.");
      }
      closeModal("goalModal");
    }

    async function deleteGoal(g){
      const ok = confirm("Excluir esta meta?");
      if(!ok) return;
      await db.ref(`${PATH.goals}/${g.id}`).remove();
      toast("Meta exclu√≠da.");
      closeModal("goalModal");
    }

    /************************************************************
     * Gr√°ficos (canvas) ‚Äî ‚Äúpro‚Äù
     ************************************************************/
    function setupCanvas(canvas, height){
      const ctx = canvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const W = rect.width;
      const H = height;
      canvas.width = Math.floor(W*dpr);
      canvas.height = Math.floor(H*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return {ctx, W, H};
    }

    function roundRect(ctx, x, y, w, h, r, fill, stroke) {
      r = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }

    function drawGrid(ctx,W,H){
      ctx.lineWidth=1;
      ctx.strokeStyle="rgba(255,255,255,.07)";
      const top=18, bottom=H-18;
      for(let i=0;i<=4;i++){
        const y = top + i*((bottom-top)/4);
        ctx.beginPath(); ctx.moveTo(12,y); ctx.lineTo(W-12,y); ctx.stroke();
      }
    }

    function movingAverage(arr, win){
      const w = Number(win||0);
      if(!w || w<2) return arr.slice();
      const out=[];
      for(let i=0;i<arr.length;i++){
        const a = Math.max(0, i-(w-1));
        const sub = arr.slice(a, i+1);
        const v = sub.reduce((s,x)=>s+x,0)/sub.length;
        out.push(v);
      }
      return out;
    }

    function applySearch(list){
      const q = (state.filters.search||"").trim().toLowerCase();
      if(!q) return list;
      return list.filter(x=> (x.note||"").toLowerCase().includes(q));
    }

    function filteredLogs(){
      clampRange();
      let list = state.logs.filter(x=>inRange(x.ts));
      list = applySearch(list);
      return list.sort((a,b)=>a.ts-b.ts); // para gr√°ficos: crescente
    }

    function metricValue(item, metric){
      const h = state.settings.heightCm;
      if(metric==="weight") return Number(item.weight||0);
      if(metric==="bf") return Number(item.bf||0);
      if(metric==="muscle") return Number(item.muscle||0);
      if(metric==="waist") return Number(item.waist||0);
      if(metric==="bmi") return bmi(Number(item.weight||0), h);
      if(metric==="whr") return waistToHeight(Number(item.waist||0), h);
      if(metric==="tdee") return tdee(state.settings.sex, Number(item.weight||0), h, state.settings.age, state.settings.activity);
      return NaN;
    }

    function metricLabel(metric){
      return {
        weight:"Peso (kg)",
        bf:"Gordura (%)",
        muscle:"Massa muscular (kg)",
        waist:"Cintura (cm)",
        bmi:"IMC",
        whr:"Cintura/Altura",
        tdee:"TDEE (kcal)"
      }[metric] || "M√©trica";
    }

    function drawMainChart(){
      const canvas = $("chartMain");
      const {ctx,W,H} = setupCanvas(canvas, 230);
      ctx.clearRect(0,0,W,H);
      drawGrid(ctx,W,H);

      const list = filteredLogs();
      const metric = state.filters.metric;
      const chart = state.filters.chart;
      const smoothN = Number(state.filters.smooth||0);

      const points = list.map(x=>({
        ts:x.ts,
        v: metricValue(x, metric)
      })).filter(p=>Number.isFinite(p.v) && p.v!==0);

      ctx.fillStyle="rgba(154,166,195,.8)";
      ctx.font="12px "+getComputedStyle(document.body).fontFamily;

      if(points.length<2){
        ctx.fillText("Sem dados suficientes para gr√°fico (adicione registros).", 16, 34);
        return;
      }

      const values = points.map(p=>p.v);
      const vals = (smoothN>=2) ? movingAverage(values, smoothN) : values;

      const min = Math.min(...vals);
      const max = Math.max(...vals);
      const pad = (max-min)*0.08 || 1;
      const yMin = min - pad;
      const yMax = max + pad;

      const left=12, right=W-12;
      const top=22, bottom=H-26;

      const toX=(i)=> left + (right-left) * (i/(vals.length-1));
      const toY=(v)=> bottom - (bottom-top) * ((v-yMin)/(yMax-yMin));

      // title
      ctx.fillStyle="rgba(233,240,255,.92)";
      ctx.font="900 12px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText(`${metricLabel(metric)} ‚Ä¢ ${chart.toUpperCase()} ‚Ä¢ ${smoothN?("MM"+smoothN):"sem suaviza√ß√£o"}`, 16, 18);

      // area
      if(chart==="area"){
        ctx.beginPath();
        vals.forEach((v,i)=>{
          const x=toX(i), y=toY(v);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.lineTo(toX(vals.length-1), bottom);
        ctx.lineTo(toX(0), bottom);
        ctx.closePath();
        const grd = ctx.createLinearGradient(0, top, 0, bottom);
        grd.addColorStop(0,"rgba(96,165,250,.25)");
        grd.addColorStop(1,"rgba(45,212,191,.06)");
        ctx.fillStyle=grd;
        ctx.fill();
      }

      // bars
      if(chart==="bar"){
        const slot = (right-left)/vals.length;
        const barW = Math.max(6, Math.min(18, slot*0.55));
        vals.forEach((v,i)=>{
          const x = left + i*slot + slot/2;
          const y = toY(v);
          ctx.fillStyle="rgba(96,165,250,.78)";
          ctx.strokeStyle="rgba(255,255,255,.12)";
          roundRect(ctx, x-barW/2, y, barW, bottom-y, 10, true, true);
        });
      }else{
        // line / spark
        const lineW = (chart==="spark") ? 1.8 : 2.25;

        // glow
        ctx.lineWidth = lineW + 4;
        ctx.strokeStyle = "rgba(96,165,250,.12)";
        ctx.beginPath();
        vals.forEach((v,i)=>{
          const x=toX(i), y=toY(v);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();

        // main line
        ctx.lineWidth = lineW;
        ctx.strokeStyle = "rgba(96,165,250,.92)";
        ctx.beginPath();
        vals.forEach((v,i)=>{
          const x=toX(i), y=toY(v);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();

        // points (skip on spark)
        if(chart!=="spark"){
          ctx.fillStyle="rgba(255,255,255,.9)";
          vals.forEach((v,i)=>{
            const x=toX(i), y=toY(v);
            ctx.beginPath(); ctx.arc(x,y,2.6,0,Math.PI*2); ctx.fill();
          });
        }
      }

      // last value
      const last = vals[vals.length-1];
      const first = vals[0];
      const delta = last - first;
      const sign = delta>=0 ? "+" : "";
      ctx.fillStyle="rgba(233,240,255,.88)";
      ctx.font="12px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText(`Œî per√≠odo: ${sign}${fmt2(delta)} ‚Ä¢ √öltimo: ${fmt2(last)}`, 16, H-12);
    }

    function drawGauge(){
      const canvas = $("chartGauge");
      const {ctx,W,H} = setupCanvas(canvas, 210);
      ctx.clearRect(0,0,W,H);

      const last = state.logs[0];
      if(!last){
        ctx.fillStyle="rgba(154,166,195,.8)";
        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        ctx.fillText("Sem registro. Clique em Ôºã Registro.", 16, 34);
        return;
      }

      const sex = state.settings.sex;
      const age = state.settings.age;
      const h = state.settings.heightCm;
      const w = Number(last.weight||0);
      const bmiV = bmi(w,h);
      const bfV = Number(last.bf||0) || NaN;
      const waistV = Number(last.waist||0) || NaN;
      const whtrV = waistToHeight(waistV,h);

      // score simples (0-100) baseado em 4 dimens√µes
      let score = 100;

      // BMI penalty
      if(Number.isFinite(bmiV)){
        if(bmiV<18.5) score -= 12;
        else if(bmiV<25) score -= 0;
        else if(bmiV<30) score -= 10;
        else if(bmiV<35) score -= 18;
        else score -= 25;
      }else score -= 10;

      // BF penalty
      if(Number.isFinite(bfV) && bfV>0){
        const cls = bfClass(bfV, sex, age);
        if(cls.cls==="good") score -= 0;
        else if(cls.cls==="warn") score -= 12;
        else if(cls.cls==="bad") score -= 22;
      }else score -= 6;

      // Waist / WHtR
      if(Number.isFinite(waistV) && waistV>0){
        const wr = waistRisk(sex, waistV);
        if(wr.cls==="warn") score -= 10;
        if(wr.cls==="bad") score -= 18;
      }else score -= 4;

      if(Number.isFinite(whtrV)){
        const c = whtrClass(whtrV);
        if(c.cls==="warn") score -= 8;
        if(c.cls==="bad") score -= 16;
      }

      score = Math.max(0, Math.min(100, Math.round(score)));

      // draw semicircle gauge
      const cx=W/2, cy=H*0.62;
      const R=Math.min(W,H)*0.40;
      const start=Math.PI, end=0;

      // background arc
      ctx.lineWidth = 18;
      ctx.lineCap = "round";
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.beginPath();
      ctx.arc(cx,cy,R,start,end);
      ctx.stroke();

      // progress arc with gradient-ish segmented
      const frac = score/100;
      const segs = 40;
      for(let i=0;i<segs;i++){
        const f0=i/segs, f1=(i+1)/segs;
        if(f1>frac) break;
        const a0 = start + (end-start)*f0;
        const a1 = start + (end-start)*f1;

        // cor din√¢mica (verde->amarelo->rosa)
        let col = "rgba(45,212,191,.85)";
        if(f1>0.72) col = "rgba(251,191,36,.85)";
        if(f1>0.86) col = "rgba(251,113,133,.85)";

        ctx.strokeStyle = col;
        ctx.beginPath();
        ctx.arc(cx,cy,R,a0,a1);
        ctx.stroke();
      }

      // needle
      const a = start + (end-start)*frac;
      const nx = cx + Math.cos(a)*R*0.92;
      const ny = cy + Math.sin(a)*R*0.92;
      ctx.strokeStyle="rgba(233,240,255,.85)";
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.lineTo(nx,ny);
      ctx.stroke();
      ctx.fillStyle="rgba(233,240,255,.92)";
      ctx.beginPath(); ctx.arc(cx,cy,4,0,Math.PI*2); ctx.fill();

      // labels
      ctx.textAlign="center";
      ctx.fillStyle="rgba(233,240,255,.95)";
      ctx.font="900 26px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText(String(score), cx, H*0.52);
      ctx.fillStyle="rgba(154,166,195,.92)";
      ctx.font="12px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText("Score de sa√∫de (estim.)", cx, H*0.52+18);

      // mini status line
      const bmiC=bmiClass(bmiV);
      const bfC=bfClass(bfV, sex, age);
      const whC=whtrClass(whtrV);

      ctx.fillStyle="rgba(233,240,255,.88)";
      ctx.font="12px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText(`IMC: ${fmt1(bmiV)} ‚Ä¢ Gordura: ${bfV?fmt1(bfV)+"%":"‚Äî"} ‚Ä¢ WHtR: ${Number.isFinite(whtrV)?fmt2(whtrV):"‚Äî"}`, cx, H-14);

      ctx.textAlign="left";
    }

    function drawComposition(){
      const canvas = $("chartComposition");
      const {ctx,W,H} = setupCanvas(canvas, 210);
      ctx.clearRect(0,0,W,H);

      const last = state.logs[0];
      if(!last){
        ctx.fillStyle="rgba(154,166,195,.8)";
        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        ctx.fillText("Sem registro.", 16, 34);
        return;
      }
      const w = Number(last.weight||0);
      const bf = Number(last.bf||0);

      // estimar massa gorda e massa magra
      const fatKg = (bf>0 && bf<70) ? (w*(bf/100)) : NaN;
      const leanKg = Number.isFinite(fatKg) ? (w-fatKg) : NaN;

      const cx=W/2, cy=H/2;
      const r=Math.min(W,H)*0.34;
      const r2=r*0.62;

      // ring bg
      ctx.lineWidth = r-r2;
      ctx.strokeStyle="rgba(255,255,255,.07)";
      ctx.beginPath();
      ctx.arc(cx,cy,(r+r2)/2,0,Math.PI*2);
      ctx.stroke();

      if(!Number.isFinite(fatKg)){
        ctx.fillStyle="rgba(154,166,195,.8)";
        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        ctx.fillText("Informe % gordura (ou cintura/pesco√ßo) para composi√ß√£o.", 16, 34);
        return;
      }

      const fatFrac = Math.max(0, Math.min(1, fatKg/w));
      const a0 = -Math.PI/2;
      const aFat = a0 + fatFrac*Math.PI*2;

      // fat arc
      ctx.strokeStyle = "rgba(251,113,133,.88)";
      ctx.lineWidth = r-r2;
      ctx.beginPath();
      ctx.arc(cx,cy,(r+r2)/2,a0,aFat);
      ctx.stroke();

      // lean arc
      ctx.strokeStyle = "rgba(45,212,191,.82)";
      ctx.beginPath();
      ctx.arc(cx,cy,(r+r2)/2,aFat,a0+Math.PI*2);
      ctx.stroke();

      // text
      ctx.textAlign="center";
      ctx.fillStyle="rgba(233,240,255,.95)";
      ctx.font="900 13px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText("Composi√ß√£o", cx, cy-10);
      ctx.fillStyle="rgba(154,166,195,.95)";
      ctx.font="12px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText(`Gorda: ${fmt1(fatKg)}kg ‚Ä¢ Magra: ${fmt1(leanKg)}kg`, cx, cy+12);

      // legend
      ctx.textAlign="left";
      ctx.fillStyle="rgba(251,113,133,.9)";
      ctx.fillRect(14,18,10,10);
      ctx.fillStyle="rgba(233,240,255,.9)";
      ctx.fillText("Massa gorda", 30, 27);

      ctx.fillStyle="rgba(45,212,191,.9)";
      ctx.fillRect(14,36,10,10);
      ctx.fillStyle="rgba(233,240,255,.9)";
      ctx.fillText("Massa magra", 30, 45);
    }

    function drawRisk(){
      const canvas = $("chartRisk");
      const {ctx,W,H} = setupCanvas(canvas, 210);
      ctx.clearRect(0,0,W,H);
      drawGrid(ctx,W,H);

      const last = state.logs[0];
      if(!last){
        ctx.fillStyle="rgba(154,166,195,.8)";
        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        ctx.fillText("Sem registro.", 16, 34);
        return;
      }

      const sex = state.settings.sex;
      const h = state.settings.heightCm;
      const waist = Number(last.waist||0) || NaN;
      const whtrV = waistToHeight(waist, h);
      const wr = waistRisk(sex, waist);
      const wcTxt = Number.isFinite(waist) ? `${fmt1(waist)} cm` : "‚Äî";
      const whTxt = Number.isFinite(whtrV) ? fmt2(whtrV) : "‚Äî";

      ctx.fillStyle="rgba(233,240,255,.92)";
      ctx.font="900 12px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText("Risco cardio-metab√≥lico", 16, 18);

      // 2 barras horizontais: Cintura e WHtR
      const left=16, right=W-16;
      const top=34;
      const barH=16;
      const gap=26;

      function bar(y, v, min, max, goodMax, warnMax, label, valueText){
        // trilho
        ctx.fillStyle="rgba(255,255,255,.07)";
        roundRect(ctx, left, y, right-left, barH, 999, true, false);

        // zonas (good/warn/bad)
        const span = (max-min) || 1;
        const xGood = left + (right-left)*((goodMax-min)/span);
        const xWarn = left + (right-left)*((warnMax-min)/span);

        ctx.fillStyle="rgba(45,212,191,.20)";
        roundRect(ctx, left, y, Math.max(0, xGood-left), barH, 999, true, false);

        ctx.fillStyle="rgba(251,191,36,.18)";
        roundRect(ctx, xGood, y, Math.max(0, xWarn-xGood), barH, 999, true, false);

        ctx.fillStyle="rgba(251,113,133,.14)";
        roundRect(ctx, xWarn, y, Math.max(0, right-xWarn), barH, 999, true, false);

        // marcador
        if(Number.isFinite(v)){
          const xv = left + (right-left)*((v-min)/span);
          ctx.strokeStyle="rgba(233,240,255,.78)";
          ctx.lineWidth=2;
          ctx.beginPath();
          ctx.moveTo(Math.max(left, Math.min(right, xv)), y-4);
          ctx.lineTo(Math.max(left, Math.min(right, xv)), y+barH+4);
          ctx.stroke();
        }

        // textos
        ctx.fillStyle="rgba(233,240,255,.9)";
        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        ctx.textAlign="left";
        ctx.fillText(label, left, y-8);
        ctx.textAlign="right";
        ctx.fillText(valueText, right, y-8);
      }

      // cintura: limites variam por sexo (low/high)
      if(Number.isFinite(waist)){
        const min = (sex==="female") ? 60 : 70;
        const max = (sex==="female") ? 120 : 130;
        bar(top, waist, min, max, wr.low, wr.high, "Cintura", `${wcTxt} ‚Ä¢ ${wr.label}`);
      }else{
        bar(top, NaN, 0, 1, 0.5, 0.7, "Cintura", "‚Äî");
      }

      // WHtR: <0.5 bom; 0.5-0.6 aten√ß√£o; >0.6 risco
      if(Number.isFinite(whtrV)){
        bar(top+gap, whtrV, 0.35, 0.75, 0.50, 0.60, "Cintura/Altura", `${whTxt} ‚Ä¢ ${whtrClass(whtrV).label}`);
      }else{
        bar(top+gap, NaN, 0, 1, 0.5, 0.6, "Cintura/Altura", "‚Äî");
      }

      ctx.textAlign="left";
    }

    /************************************************************
     * Avalia√ß√£o completa (cards com limites inferiores/superiores)
     ************************************************************/
    function mkEvalCard(name, valueText, bandText, cls, pct){
      const card = document.createElement("div");
      card.className="evalCard";
      const tagCls = cls || "";
      const pctSafe = Math.max(0, Math.min(100, Number(pct||0)));

      card.innerHTML = `
        <div class="evalTop">
          <div>
            <div class="evalName">${safeText(name)}</div>
            <div class="evalMeta">
              <span class="badge ${tagCls}">${safeText(bandText||"")}</span>
            </div>
          </div>
          <div class="amount ${tagCls}">${safeText(valueText||"‚Äî")}</div>
        </div>
        <div class="bar"><div class="fill" style="width:${pctSafe}%;"></div></div>
        <div class="hint">Faixa e alertas dependem do seu perfil (sexo/idade/altura) e do √∫ltimo registro.</div>
      `;

      // bar color
      const fill = card.querySelector(".fill");
      if(tagCls==="bad") fill.style.background="linear-gradient(90deg, rgba(251,113,133,.9), rgba(251,113,133,.75))";
      else if(tagCls==="warn") fill.style.background="linear-gradient(90deg, rgba(251,191,36,.9), rgba(96,165,250,.85))";
      else fill.style.background="linear-gradient(90deg, rgba(45,212,191,.9), rgba(96,165,250,.85))";

      return card;
    }

    function renderEvalCards(){
      const grid = $("evalGrid");
      grid.innerHTML="";

      const last = state.logs[0];
      if(!last){
        const d=document.createElement("div");
        d.className="hint";
        d.textContent="Sem registros. Clique em Ôºã Registro para come√ßar.";
        grid.appendChild(d);
        return;
      }

      const sex = state.settings.sex;
      const age = state.settings.age;
      const h = state.settings.heightCm;
      const w = Number(last.weight||0);

      const bmiV = bmi(w,h);
      const bmiC = bmiClass(bmiV);

      const bfV = Number(last.bf||0) || NaN;
      const bfC = bfClass(bfV, sex, age);
      const bands = bfBands(sex, age);

      const muscleV = Number(last.muscle||0) || NaN;

      const bmr = mifflinBMR(sex, w, h, age);
      const td = tdee(sex, w, h, age, state.settings.activity);

      const waistV = Number(last.waist||0) || NaN;
      const wr = waistRisk(sex, waistV);
      const whtrV = waistToHeight(waistV,h);
      const whC = whtrClass(whtrV);

      // metas (se existirem)
      const goalOf = (type)=> state.goals.find(g=>g.type===type) || null;

      // IMC: alvo ideal 18.5‚Äì24.9
      const bmiPct = Number.isFinite(bmiV) ? Math.max(0, Math.min(100, ((bmiV-16)/(40-16))*100)) : 0;
      grid.appendChild(mkEvalCard(
        "IMC (OMS)",
        Number.isFinite(bmiV)?fmt1(bmiV):"‚Äî",
        `${bmiC.label} ‚Ä¢ ideal 18,5‚Äì24,9`,
        bmiC.cls,
        bmiPct
      ));

      // % gordura: mostrar faixa fitness como ‚Äúideal‚Äù (ou atl√©tico)
      const ideal = bands.fit;
      const bfPct = Number.isFinite(bfV) ? Math.max(0, Math.min(100, (bfV/40)*100)) : 0;
      const bfBandTxt = (Number.isFinite(bfV) && bfV>0)
        ? `${bfC.label} ‚Ä¢ ideal ~${fmt1(ideal[0])}‚Äì${fmt1(ideal[1])}%`
        : `Ideal ~${fmt1(ideal[0])}‚Äì${fmt1(ideal[1])}% (preencha BF/medidas)`;
      grid.appendChild(mkEvalCard(
        "% Gordura",
        (Number.isFinite(bfV) && bfV>0) ? (fmt1(bfV)+"%") : "‚Äî",
        bfBandTxt,
        bfC.cls || "warn",
        bfPct
      ));

      // Cintura
      const waistPct = Number.isFinite(waistV) ? Math.max(0, Math.min(100, ((waistV-60)/(130-60))*100)) : 0;
      const waistBand = Number.isFinite(waistV) ? `Ok < ${wr.low} ‚Ä¢ aten√ß√£o ${wr.low}-${wr.high} ‚Ä¢ alto ‚â• ${wr.high}` : `Preencha cintura para risco`;
      grid.appendChild(mkEvalCard(
        "Cintura",
        Number.isFinite(waistV)?(fmt1(waistV)+" cm"):"‚Äî",
        waistBand,
        wr.cls || "warn",
        waistPct
      ));

      // WHtR
      const whPct = Number.isFinite(whtrV) ? Math.max(0, Math.min(100, ((whtrV-0.35)/(0.75-0.35))*100)) : 0;
      grid.appendChild(mkEvalCard(
        "Cintura/Altura",
        Number.isFinite(whtrV)?fmt2(whtrV):"‚Äî",
        `Ideal < 0,50 ‚Ä¢ aten√ß√£o 0,50‚Äì0,60 ‚Ä¢ alto ‚â• 0,60`,
        whC.cls || "warn",
        whPct
      ));

      // BMR / TDEE
      const tdPct = Number.isFinite(td) ? Math.max(0, Math.min(100, (td/4000)*100)) : 0;
      const act = Number(state.settings.activity||1.55);
      grid.appendChild(mkEvalCard(
        "Metabolismo (BMR/TDEE)",
        (Number.isFinite(td)?`${fmt0(td)} kcal`:"‚Äî"),
        `BMR ${Number.isFinite(bmr)?fmt0(bmr):"‚Äî"} ‚Ä¢ Fator ${act}`,
        "good",
        tdPct
      ));

      // Massa muscular: sem ‚Äúfaixa universal‚Äù segura -> compara com meta (se houver) e hist√≥rico
      const mg = goalOf("muscle");
      const mTxt = Number.isFinite(muscleV) && muscleV>0 ? `${fmt1(muscleV)} kg` : "‚Äî";
      let mCls="warn", mBand="Defina uma meta para avaliar melhor.";
      if(mg && mg.target>0 && Number.isFinite(muscleV) && muscleV>0){
        const diff = muscleV - mg.target;
        mCls = diff>=0 ? "good" : "warn";
        mBand = `Meta: ${fmt1(mg.target)} kg ‚Ä¢ ${diff>=0? "acima":"abaixo"} do alvo`;
      }else{
        mBand = "Sem meta. (Boa pr√°tica: acompanhar tend√™ncia + performance.)";
      }
      const mPct = (mg && mg.target>0 && Number.isFinite(muscleV)) ? Math.max(0,Math.min(100,(muscleV/mg.target)*100)) : (Number.isFinite(muscleV)?Math.max(0,Math.min(100,(muscleV/60)*100)):0);

      grid.appendChild(mkEvalCard(
        "Massa muscular",
        mTxt,
        mBand,
        mCls,
        mPct
      ));
    }

    /************************************************************
     * KPIs + Lists + Goals rendering
     ************************************************************/
    function computeKPIs(){
      const last = state.logs[0];
      if(!last){
        $("kpiWeight").textContent="‚Äî";
        $("kpiWeightSub").textContent="Tend√™ncia: ‚Äî";
        $("kpiBMI").textContent="‚Äî";
        $("kpiBMISub").textContent="Faixa: ‚Äî";
        $("kpiBF").textContent="‚Äî";
        $("kpiBFSub").textContent="Classifica√ß√£o: ‚Äî";
        $("kpiTDEE").textContent="‚Äî";
        $("kpiTDEESub").textContent="BMR + atividade";
        return;
      }

      const sex = state.settings.sex;
      const age = state.settings.age;
      const h = state.settings.heightCm;

      const w = Number(last.weight||0);
      const bmiV = bmi(w,h);
      const bmiC = bmiClass(bmiV);

      const bfV = Number(last.bf||0) || NaN;
      const bfC = bfClass(bfV, sex, age);

      const td = tdee(sex, w, h, age, state.settings.activity);

      $("kpiWeight").textContent = `${fmt1(w)} kg`;
      const tr = trend(state.logs, x=>Number(x.weight||0), state.settings.trendWindow);
      if(Number.isFinite(tr)){
        const cls = tr<=0 ? "good" : "warn";
        const sign = tr<=0 ? "" : "+";
        $("kpiWeightSub").innerHTML = `Tend√™ncia: <span class="${cls}">${sign}${fmt1(tr)} kg</span> vs m√©dia`;
      }else{
        $("kpiWeightSub").textContent="Tend√™ncia: ‚Äî";
      }

      $("kpiBMI").textContent = Number.isFinite(bmiV) ? fmt1(bmiV) : "‚Äî";
      $("kpiBMI").className = "value " + (bmiC.cls||"");
      $("kpiBMISub").textContent = `Faixa: ${bmiC.label}`;

      $("kpiBF").textContent = (Number.isFinite(bfV) && bfV>0) ? (fmt1(bfV)+"%") : "‚Äî";
      $("kpiBF").className = "value " + (bfC.cls||"warn");
      $("kpiBFSub").textContent = `Classifica√ß√£o: ${bfC.label || "‚Äî"}`;

      $("kpiTDEE").textContent = Number.isFinite(td) ? `${fmt0(td)} kcal` : "‚Äî";
      $("kpiTDEESub").textContent = `Atividade: ${state.settings.activity}`;
    }

    function renderLogList(targetId, listDesc){
      const el = $(targetId);
      el.innerHTML = "";

      if(!listDesc.length){
        const d=document.createElement("div");
        d.className="hint";
        d.innerHTML="Sem registros neste per√≠odo. Clique em <b>Ôºã Registro</b> para come√ßar.";
        el.appendChild(d);
        return;
      }

      // mostra at√© 300
      listDesc.slice(0,300).forEach(item=>{
        const dt = new Date(item.ts).toLocaleString("pt-BR");
        const h = state.settings.heightCm;
        const bmiV = bmi(item.weight, h);
        const bfV = item.bf>0 ? item.bf : NaN;
        const waist = item.waist>0 ? item.waist : NaN;

        const row=document.createElement("div");
        row.className="row";
        row.onclick=()=>openLogModal(item);

        const main=document.createElement("div");
        main.className="main";
        main.innerHTML = `
          <div class="name">Registro</div>
          <div class="meta">
            <span class="badge">${dt}</span>
            ${item.note?`<span class="badge">üìù ${safeText(item.note).slice(0,42)}</span>`:""}
          </div>
        `;

        const mid=document.createElement("div");
        mid.className="hint";
        mid.textContent = `IMC: ${Number.isFinite(bmiV)?fmt1(bmiV):"‚Äî"} ‚Ä¢ BF: ${Number.isFinite(bfV)?fmt1(bfV)+"%":"‚Äî"} ‚Ä¢ Cintura: ${Number.isFinite(waist)?fmt1(waist)+"cm":"‚Äî"}`;

        const amount=document.createElement("div");
        amount.className="amount good";
        amount.textContent = `${fmt1(item.weight)} kg`;

        const actions=document.createElement("div");
        actions.className="right";
        actions.innerHTML = `<button class="btn danger" data-act="del">üóëÔ∏è</button>`;
        actions.querySelector('[data-act="del"]').onclick=(e)=>{e.stopPropagation(); deleteLog(item);};

        if(window.matchMedia("(min-width:821px)").matches){
          row.appendChild(main);
          row.appendChild(mid);
          row.appendChild(amount);
          row.appendChild(actions);
        }else{
          row.appendChild(amount);
          row.appendChild(mid);
          row.appendChild(actions);
        }

        el.appendChild(row);
      });
    }

    function renderGoals(){
      const list = (state.goals||[]).slice().sort((a,b)=> (a.due||"").localeCompare(b.due||""));
      $("goalsSummary").innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
          <div>
            <b>Metas:</b> ${list.length}<br>
            <span class="hint">Tipos: peso, gordura, cintura, m√∫sculo, TDEE</span>
          </div>
          <div class="kbd">üéØ</div>
        </div>
      `;

      const renderInto = (id, max=999)=>{
        const el=$(id);
        el.innerHTML="";
        if(!list.length){
          const d=document.createElement("div");
          d.className="hint";
          d.innerHTML="Sem metas ainda. Clique em <b>Ôºã Meta</b> para criar.";
          el.appendChild(d);
          return;
        }

        const last = state.logs[0] || null;

        list.slice(0,max).forEach(g=>{
          const target=Number(g.target||0);
          let current = NaN;

          if(last){
            if(g.type==="weight") current = Number(last.weight||0);
            if(g.type==="bf") current = Number(last.bf||0) || NaN;
            if(g.type==="waist") current = Number(last.waist||0) || NaN;
            if(g.type==="muscle") current = Number(last.muscle||0) || NaN;
            if(g.type==="tdee") current = tdee(state.settings.sex, Number(last.weight||0), state.settings.heightCm, state.settings.age, state.settings.activity);
          }

          const pct = (Number.isFinite(current) && target>0) ? Math.max(0,Math.min(140,(current/target)*100)) : 0;
          const due = g.due ? new Date(g.due+"T00:00:00").toLocaleDateString("pt-BR") : "Sem prazo";

          const card=document.createElement("div");
          card.className="evalCard";
          card.style.cursor="pointer";
          card.onclick=()=>openGoalModal(g);

          const goalTypeName = {
            weight:"Peso",
            bf:"Gordura %",
            waist:"Cintura",
            muscle:"Massa muscular",
            tdee:"TDEE"
          }[g.type] || "Meta";

          const curTxt = Number.isFinite(current) ? (
            g.type==="tdee" ? `${fmt0(current)} kcal` :
            g.type==="bf" ? `${fmt1(current)}%` :
            `${fmt1(current)}`
          ) : "‚Äî";

          const tarTxt = (
            g.type==="tdee" ? `${fmt0(target)} kcal` :
            g.type==="bf" ? `${fmt1(target)}%` :
            `${fmt1(target)}`
          );

          card.innerHTML = `
            <div class="evalTop">
              <div>
                <div class="evalName">${safeText(g.name)} <span class="badge">${goalTypeName}</span></div>
                <div class="evalMeta">
                  <span class="badge">Prazo: ${due}</span>
                </div>
              </div>
              <div class="amount">${curTxt} / ${tarTxt}</div>
            </div>
            <div class="bar"><div class="fill" style="width:${Math.max(0,Math.min(100,pct))}%;"></div></div>
            <div class="hint">Progresso calculado com o √∫ltimo registro (quando poss√≠vel).</div>
          `;

          el.appendChild(card);
        });
      };

      renderInto("goalsList", 999);
      renderInto("goalsMini", 3);
    }

    function renderTodayMini(){
      const el = $("todayMini");
      el.innerHTML="";
      const last = state.logs[0];
      if(!last){
        const d=document.createElement("div");
        d.className="hint";
        d.textContent="Sem registros ainda.";
        el.appendChild(d);
        return;
      }
      const h = state.settings.heightCm;
      const sex = state.settings.sex;
      const age = state.settings.age;
      const w = Number(last.weight||0);
      const bmiV = bmi(w,h);
      const bfV = Number(last.bf||0) || NaN;
      const td = tdee(sex, w, h, age, state.settings.activity);

      const items = [
        {k:"Peso", v:`${fmt1(w)} kg`},
        {k:"IMC", v:Number.isFinite(bmiV)?fmt1(bmiV):"‚Äî"},
        {k:"Gordura", v:(Number.isFinite(bfV)&&bfV>0)?fmt1(bfV)+"%":"‚Äî"},
        {k:"TDEE", v:Number.isFinite(td)?fmt0(td)+" kcal":"‚Äî"}
      ];
      items.forEach(it=>{
        const d=document.createElement("div");
        d.className="noteBox";
        d.style.padding="10px 12px";
        d.innerHTML = `<b>${it.k}:</b> ${it.v}`;
        el.appendChild(d);
      });
    }

    /************************************************************
     * CSV + Demo + Navega√ß√£o
     ************************************************************/
    function exportCSV(){
      clampRange();
      const list = state.logs.filter(x=>inRange(x.ts));
      const rows=[["data_hora","peso_kg","gordura_pct","musculo_kg","cintura_cm","pescoco_cm","quadril_cm","obs","id"]];
      list.forEach(t=>{
        rows.push([
          new Date(t.ts).toLocaleString("pt-BR"),
          String(t.weight||0).replace(".",","),
          String(t.bf||0).replace(".",","),
          String(t.muscle||0).replace(".",","),
          String(t.waist||0).replace(".",","),
          String(t.neck||0).replace(".",","),
          String(t.hip||0).replace(".",","),
          (t.note||"").replaceAll('"','""'),
          t.id
        ]);
      });
      const csv = rows.map(r=>r.map(v=>`"${String(v??"")}"`).join(";")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;
      a.download=`saude_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      toast("CSV exportado.");
    }

    async function seedDemo(){
      const ok = confirm("Criar dados de exemplo (registros + metas)?");
      if(!ok) return;

      // metas
      const g1 = db.ref(PATH.goals).push(); const id1=g1.key;
      await g1.set({ id:id1, type:"weight", name:"Peso alvo", target:78, due:"", createdAt:Date.now(), updatedAt:Date.now() });

      const g2 = db.ref(PATH.goals).push(); const id2=g2.key;
      await g2.set({ id:id2, type:"bf", name:"Gordura alvo", target:14, due:"", createdAt:Date.now(), updatedAt:Date.now() });

      const g3 = db.ref(PATH.goals).push(); const id3=g3.key;
      await g3.set({ id:id3, type:"waist", name:"Cintura alvo", target:82, due:"", createdAt:Date.now(), updatedAt:Date.now() });

      // registros (90 dias)
      const base = new Date();
      const start = new Date(base.getTime() - 80*86400000);
      let w=82.5, bf=19.5, waist=90, muscle=34.5;
      for(let i=0;i<24;i++){
        w -= 0.12 + (Math.random()*0.12);
        bf -= 0.08 + (Math.random()*0.10);
        waist -= 0.18 + (Math.random()*0.12);
        muscle += (Math.random()*0.08);

        const dt = new Date(start.getTime() + i*3*86400000);
        const ref = db.ref(PATH.logs).push();
        const id = ref.key;

        const note = (i%4===0) ? "Treino" : (i%7===0 ? "Sono ruim" : "");
        await ref.set({
          id,
          ts: dt.getTime(),
          weight: Math.round(w*10)/10,
          bf: Math.max(8, Math.round(bf*10)/10),
          muscle: Math.round(muscle*10)/10,
          waist: Math.round(waist*10)/10,
          neck: 39,
          hip: 0,
          note,
          createdAt: Date.now(),
          updatedAt: Date.now()
        });
      }

      toast("Demo criada.");
    }

    function setTab(tab){
      document.querySelectorAll(".tab").forEach(t=>{
        t.classList.toggle("active", t.dataset.tab===tab);
      });

      const titles = {
        dash: ["Dashboard","Avalia√ß√£o + tend√™ncias + gr√°ficos profissionais"],
        logs: ["Registros","Lista completa (com busca e per√≠odo)"],
        goals: ["Metas","Peso, gordura, cintura, m√∫sculo e calorias"],
        settings: ["Ajustes","Perfil, atividade, unidades e notas r√°pidas"]
      };
      $("pageTitle").textContent = titles[tab][0];
      $("pageSub").textContent = titles[tab][1];

      $("viewDash").style.display = tab==="dash" ? "block" : "none";
      $("viewLogs").style.display = tab==="logs" ? "block" : "none";
      $("viewGoals").style.display = tab==="goals" ? "block" : "none";
      $("viewSettings").style.display = tab==="settings" ? "block" : "none";

      renderAll();
    }

    function bindTabs(containerId){
      const el = $(containerId);
      el.addEventListener("click",(e)=>{
        const t = e.target.closest(".tab");
        if(!t) return;
        setTab(t.dataset.tab);
      });
    }

    /************************************************************
     * Render All
     ************************************************************/
    function renderAll(){
      computeKPIs();
      drawMainChart();
      drawGauge();
      drawComposition();
      drawRisk();
      renderEvalCards();

      // lists
      clampRange();
      const listDesc = state.logs
        .filter(x=>inRange(x.ts))
        .filter(x=>{
          const q=(state.filters.search||"").trim().toLowerCase();
          if(!q) return true;
          return (x.note||"").toLowerCase().includes(q);
        })
        .sort((a,b)=>b.ts-a.ts);

      renderLogList("logList", listDesc);
      renderLogList("logListAll", listDesc);

      renderTodayMini();
      renderGoals();
    }

    /************************************************************
     * Wire UI
     ************************************************************/
    $("btnNew").addEventListener("click", ()=> openLogModal(null));
    $("btnCloseLog").addEventListener("click", ()=> closeModal("logModal"));
    $("btnSaveLog").addEventListener("click", saveLog);
    $("btnDeleteLog").addEventListener("click", async ()=>{
      const id=state.editingLogId;
      const item=state.logs.find(x=>x.id===id);
      if(item) await deleteLog(item);
      closeModal("logModal");
    });

    $("btnNewGoal").addEventListener("click", ()=> openGoalModal(null));
    $("btnCloseGoal").addEventListener("click", ()=> closeModal("goalModal"));
    $("btnSaveGoal").addEventListener("click", saveGoal);
    $("btnDeleteGoal").addEventListener("click", async ()=>{
      const g=state.goals.find(x=>x.id===state.editingGoalId);
      if(g) await deleteGoal(g);
    });

    $("btnSaveSettings").addEventListener("click", saveSettings);

    $("btnExport").addEventListener("click", exportCSV);
    $("btnExport2").addEventListener("click", exportCSV);
    $("btnPrint").addEventListener("click", ()=> window.print());
    $("btnPrint2").addEventListener("click", ()=> window.print());
    $("btnRefresh").addEventListener("click", ()=>{ renderAll(); toast("Atualizado."); });
    $("btnDemo").addEventListener("click", seedDemo);

    $("btnHome").addEventListener("click", ()=>{
      window.location.href = "https://wilsonf1996.github.io/index.html/";
    });

    $("period").addEventListener("change", ()=>{
      state.period = $("period").value;
      $("customRange").style.display = (state.period==="custom") ? "block" : "none";
      renderAll();
    });
    $("dateFrom").addEventListener("change", renderAll);
    $("dateTo").addEventListener("change", renderAll);

    $("fMetric").addEventListener("change", ()=>{ state.filters.metric=$("fMetric").value; renderAll(); });
    $("fChart").addEventListener("change", ()=>{ state.filters.chart=$("fChart").value; renderAll(); });
    $("fSmooth").addEventListener("change", ()=>{ state.filters.smooth=Number($("fSmooth").value||0); renderAll(); });
    $("fSearch").addEventListener("input", ()=>{ state.filters.search=$("fSearch").value; renderAll(); });

    bindTabs("tabsTop");
    bindTabs("tabsBottom");

    document.addEventListener("keydown",(e)=>{
      const k=e.key.toLowerCase();
      if(k==="n" && !e.ctrlKey && !e.metaKey) openLogModal(null);
      if((e.ctrlKey||e.metaKey) && k==="e"){ e.preventDefault(); exportCSV(); }
      if(k==="escape"){
        closeModal("logModal");
        closeModal("goalModal");
      }
    });

    window.addEventListener("resize", ()=> renderAll());

    /************************************************************
     * Boot
     ************************************************************/
    async function boot(){
      $("period").value = state.period;
      $("dateFrom").value = nowISODate();
      $("dateTo").value = nowISODate();

      state.filters = { metric:"weight", chart:"line", smooth:0, search:"" };
      $("fMetric").value="weight";
      $("fChart").value="line";
      $("fSmooth").value="0";
      $("fSearch").value="";

      await loadSettings();
      listenGoals();
      listenLogs();

      clampRange();
      renderAll();
      toast("Pronto. Sa√∫de & Performance (Apple-level).");
    }

    boot();
  </script>
</body>
</html>
