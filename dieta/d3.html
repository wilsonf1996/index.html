<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Health ‚Ä¢ Avalia√ß√£o F√≠sica (Apple-level)</title>
  <meta name="theme-color" content="#0b0d12" />
  <style>
    :root{
      --bg0:#07080b; --bg1:#0b0d12;
      --cardA: rgba(255,255,255,.09);
      --cardB: rgba(255,255,255,.03);
      --text:#eaf0ff; --muted:#9aa6c3; --line:rgba(255,255,255,.10);
      --good:#2dd4bf; --bad:#fb7185; --warn:#fbbf24; --brand:#60a5fa;
      --shadow: 0 20px 90px rgba(0,0,0,.58);
      --r:18px; --r2:26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text","Segoe UI", Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% -10%, rgba(96,165,250,.22), transparent 60%),
        radial-gradient(1000px 800px at 95% 10%, rgba(45,212,191,.14), transparent 55%),
        radial-gradient(900px 700px at 80% 115%, rgba(251,113,133,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 45%, #07090f 100%);
      overflow-x:hidden;
    }
    .safe{padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    .wrap{max-width:1280px; margin:0 auto; padding:22px 16px 94px;}
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 16px;
      margin:-22px -16px 14px;
      backdrop-filter: blur(18px);
      background: linear-gradient(180deg, rgba(7,8,11,.90), rgba(7,8,11,.35));
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background:
        radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(20px 20px at 70% 30%, rgba(255,255,255,.15), transparent 60%),
        linear-gradient(135deg, rgba(96,165,250,.95), rgba(45,212,191,.75));
      border:1px solid rgba(255,255,255,.15);
      box-shadow: 0 16px 48px rgba(96,165,250,.18);
    }
    .brand h1{margin:0; font-size:14px; letter-spacing:.2px; line-height:1.1}
    .brand p{margin:0; font-size:12px; color:var(--muted); line-height:1.2}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center}

    .btn{
      appearance:none; border:none; cursor:pointer;
      border-radius:12px; padding:10px 12px;
      color:var(--text);
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      font-size:13px;
      display:inline-flex; align-items:center; gap:9px;
      user-select:none;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.09); border-color:rgba(255,255,255,.14)}
    .btn:active{transform:scale(.985)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(45,212,191,.72));
      border-color: rgba(255,255,255,.18);
      color:#071017;
      font-weight:850;
    }
    .btn.danger{background:rgba(251,113,133,.14); border-color:rgba(251,113,133,.28)}
    .btn.ghost{background:transparent; box-shadow:none}
    .pill{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      border-radius:999px; padding:8px 10px;
      box-shadow: 0 6px 24px rgba(0,0,0,.25) inset;
    }
    .pill span{font-size:12px; color:var(--muted); max-width:360px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

    .grid{display:grid; grid-template-columns:1.32fr .68fr; gap:12px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .card{
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border:1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .title{display:flex; flex-direction:column; gap:4px;}
    .title h2{margin:0; font-size:14px; letter-spacing:.2px}
    .title p{margin:0; font-size:12px; color:var(--muted)}
    .card .bd{padding:14px 16px 16px;}

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      border-radius: 999px;
      padding:6px;
    }
    .tab{
      cursor:pointer;
      padding:9px 12px;
      border-radius: 999px;
      font-size:12px;
      border:1px solid transparent;
      color: rgba(233,240,255,.90);
      background: transparent;
      transition: background .15s ease, border-color .15s ease;
      user-select:none;
      display:flex; align-items:center; gap:8px;
    }
    .tab.active{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.12);
    }

    .kpis{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;}
    @media (max-width:980px){ .kpis{grid-template-columns: repeat(2, 1fr);} }
    .kpi{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius: var(--r);
      padding:12px;
      display:flex; flex-direction:column; gap:6px;
      min-height:78px;
    }
    .kpi .label{font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center}
    .dot{width:8px;height:8px;border-radius:99px;background:rgba(255,255,255,.25); border:1px solid rgba(255,255,255,.16)}
    .dot.good{background:rgba(45,212,191,.75)}
    .dot.warn{background:rgba(251,191,36,.80)}
    .dot.bad{background:rgba(251,113,133,.75)}
    .kpi .value{font-size:18px; font-weight:900; letter-spacing:.2px}
    .kpi .sub{font-size:11px; color:var(--muted)}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}

    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; justify-content:space-between;
      margin:12px 0 0;
    }
    .filters{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;}
    .field{display:flex; flex-direction:column; gap:6px; min-width:160px;}
    .field label{font-size:11px; color:var(--muted)}
    input, select, textarea{
      width:100%;
      background: rgba(0,0,0,.22);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding:10px 10px;
      color: var(--text);
      outline:none;
      font-family: var(--sans);
      font-size: 13px;
    }
    textarea{min-height:92px; resize: vertical;}
    input::placeholder, textarea::placeholder{color:rgba(154,166,195,.72)}
    input:focus, select:focus, textarea:focus{border-color: rgba(96,165,250,.55); box-shadow: 0 0 0 4px rgba(96,165,250,.12);}

    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width:680px){ .split{grid-template-columns:1fr;} }

    .divider{height:1px; background:var(--line); margin:12px 0;}

    .canvasBox{
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      position:relative;
    }
    canvas{width:100%; height:260px; display:block}
    .miniCanvas{height:220px;}
    .hint{font-size:12px; color:var(--muted); line-height:1.45}
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: rgba(233,238,252,.9);
    }

    .list{display:flex; flex-direction:column; gap:10px;}
    .row{
      display:grid;
      grid-template-columns: 1.1fr .8fr .8fr .8fr;
      gap:10px;
      align-items:center;
      padding:12px;
      border-radius: var(--r);
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      cursor:pointer;
    }
    .row:hover{border-color:rgba(255,255,255,.14); background: rgba(0,0,0,.22)}
    .row:active{transform:scale(.995)}
    @media (max-width:820px){ .row{grid-template-columns: 1fr; gap:8px;} }

    .row .main{display:flex; flex-direction:column; gap:3px;}
    .row .main .name{font-size:13px; font-weight:900}
    .row .main .meta{font-size:11px; color:var(--muted); display:flex; flex-wrap:wrap; gap:8px}
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--muted);
    }
    .amount{
      text-align:right;
      font-family: var(--mono);
      font-size: 13px;
      font-weight:950;
    }
    .right{display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: 16px;
      z-index:999;
      background: rgba(15,18,26,.88);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding:10px 14px;
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      max-width:min(980px, calc(100% - 22px));
      display:none;
      font-size:13px;
      color: var(--text);
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .toast.show{display:flex}

    .modal{
      position:fixed; inset:0; display:none; place-items:center; z-index:1000;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      padding: 16px;
    }
    .modal.show{display:grid}
    .panel{
      width:min(1040px, 100%);
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .phd{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .panel .phd .ttl{display:flex; flex-direction:column; gap:3px}
    .panel .phd h3{margin:0; font-size:14px}
    .panel .phd p{margin:0; font-size:12px; color:var(--muted)}
    .panel .pbd{padding:14px 16px 16px}

    .noteBox{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding:10px 12px;
      font-size:12px;
      color: rgba(233,238,252,.92);
      line-height:1.35;
    }

    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      border-radius: 999px;
      padding:6px;
    }
    .seg button{
      cursor:pointer;
      padding:9px 12px;
      border-radius: 999px;
      font-size:12px;
      border:1px solid transparent;
      color: rgba(233,240,255,.90);
      background: transparent;
      transition: background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .seg button.active{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.12);
    }

    .legendMini{
      position:absolute; left:12px; top:12px;
      display:flex; gap:6px; flex-wrap:wrap;
      pointer-events:none;
    }
    .lg{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      color: rgba(233,240,255,.88);
      backdrop-filter: blur(10px);
    }

    .bottomNav{
      position:fixed; left:0; right:0; bottom:0; z-index:60;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      backdrop-filter: blur(18px);
      background: linear-gradient(180deg, rgba(7,8,11,.15), rgba(7,8,11,.78));
      border-top: 1px solid var(--line);
      display:none;
    }
    .bottomNav .tabs{width:100%; justify-content:space-between;}
    @media (max-width:980px){
      .bottomNav{display:block;}
      .desktopTabs{display:none;}
      .wrap{padding-bottom:130px;}
    }
  </style>

  <!-- Firebase compat (mant√©m o seu config intacto) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>

<body class="safe">
  <div class="wrap">
    <header class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Health ‚Ä¢ Avalia√ß√£o F√≠sica</h1>
          <p>Apple-level ‚Ä¢ Dashboard ‚Ä¢ Registros ‚Ä¢ Metas ‚Ä¢ Avalia√ß√£o ‚Ä¢ Firebase</p>
        </div>
      </div>

      <div class="actions">
        <div class="pill" title="Banco de dados em uso">
          <span id="dbInfo">Conectando no Firebase‚Ä¶</span>
        </div>

        <div class="desktopTabs">
          <div class="tabs" id="tabsTop">
            <div class="tab active" data-tab="dash">üìä Dashboard</div>
            <div class="tab" data-tab="logs">üßæ Registros</div>
            <div class="tab" data-tab="goals">üéØ Metas</div>
            <div class="tab" data-tab="settings">‚öôÔ∏è Ajustes</div>
          </div>
        </div>

        <button class="btn ghost" id="btnImport" title="Importar JSON/CSV">‚≠≥ Importar</button>
        <button class="btn ghost" id="btnExport" title="Exportar backup (JSON + CSV)">‚§ì Exportar</button>
        <button class="btn primary" id="btnNew">Ôºã Registro</button>
      </div>
    </header>

    <main class="grid">
      <!-- LEFT -->
      <section class="card" aria-label="Conte√∫do">
        <div class="hd">
          <div class="title">
            <h2 id="pageTitle">Dashboard</h2>
            <p id="pageSub">Evolu√ß√£o + gr√°ficos + avalia√ß√£o saud√°vel/n√£o saud√°vel</p>
          </div>

          <div class="right">
            <div class="field" style="min-width:220px;">
              <label for="period">Per√≠odo</label>
              <select id="period">
                <option value="thisMonth">Este m√™s</option>
                <option value="lastMonth">M√™s passado</option>
                <option value="thisYear">Este ano</option>
                <option value="custom">Personalizado</option>
              </select>
            </div>
            <div class="field" id="customRange" style="min-width:280px; display:none;">
              <label>Intervalo</label>
              <div class="split">
                <input id="dateFrom" type="date" />
                <input id="dateTo" type="date" />
              </div>
            </div>
          </div>
        </div>

        <div class="bd">
          <!-- DASH -->
          <div id="viewDash">
            <div class="kpis" id="kpis"></div>

            <div class="divider"></div>

            <div class="toolbar">
              <div class="filters">
                <div class="field">
                  <label for="chartMetric">M√©trica</label>
                  <select id="chartMetric">
                    <option value="weightKg">Peso (kg)</option>
                    <option value="bmi">IMC</option>
                    <option value="bfPct">Gordura corporal (%)</option>
                    <option value="lbmKg">Massa magra (kg)</option>
                    <option value="ffmi">FFMI</option>
                    <option value="bmr">Metabolismo basal (BMR)</option>
                    <option value="tdee">Gasto di√°rio (TDEE)</option>
                    <option value="waistCm">Cintura (cm)</option>
                    <option value="whr">Cintura/Quadril (WHR)</option>
                  </select>
                </div>

                <div class="field">
                  <label for="chartStyle">Visual</label>
                  <select id="chartStyle">
                    <option value="line">Linha (tend√™ncia)</option>
                    <option value="area">√Årea (suave)</option>
                    <option value="candles">Varia√ß√£o (mini-candles)</option>
                    <option value="bars">Barras (discreto)</option>
                  </select>
                </div>

                <div class="field">
                  <label for="evalProfile">Perfil</label>
                  <select id="evalProfile">
                    <option value="general">Geral (sa√∫de)</option>
                    <option value="fitness">Fitness</option>
                    <option value="athlete">Atleta</option>
                  </select>
                </div>

                <div class="field" style="min-width:240px;">
                  <label for="fSearch">Buscar</label>
                  <input id="fSearch" placeholder="Ex: treino, descanso, dor, medida‚Ä¶" />
                </div>
              </div>

              <div class="right">
                <button class="btn" id="btnDemo" title="Criar exemplos">‚ú® Demo</button>
                <button class="btn" id="btnRefresh" title="Atualizar">‚ü≥ Atualizar</button>
              </div>
            </div>

            <div class="chartsGrid" style="margin-top:12px;">
              <div>
                <div class="canvasBox">
                  <div class="legendMini" id="legendMain"></div>
                  <canvas id="chartMain"></canvas>
                </div>
                <div class="hint" style="margin-top:8px;">
                  Intera√ß√£o: <span class="kbd">Arraste</span> para inspecionar ‚Ä¢ <span class="kbd">Duplo clique</span> reseta zoom ‚Ä¢
                  Atalho: <span class="kbd">N</span> novo ‚Ä¢ <span class="kbd">Ctrl+E</span> export ‚Ä¢ <span class="kbd">Esc</span> fechar
                </div>
              </div>

              <div>
                <div class="canvasBox">
                  <div class="legendMini" id="legendRadar"></div>
                  <canvas id="chartRadar" class="miniCanvas"></canvas>
                </div>
                <div class="hint" style="margin-top:8px;">
                  Radar: ‚Äúscore‚Äù de sa√∫de por dimens√µes (IMC, BF%, cintura, ritmo, consist√™ncia).
                </div>
              </div>
            </div>

            <div class="chartsRow">
              <div>
                <div class="canvasBox">
                  <div class="legendMini" id="legendZones"></div>
                  <canvas id="chartZones" class="miniCanvas"></canvas>
                </div>
                <div class="hint" style="margin-top:8px;">
                  Zonas: quantos dias em <b>saud√°vel</b>, <b>aten√ß√£o</b> e <b>risco</b> (pela m√©trica atual).
                </div>
              </div>
              <div>
                <div class="canvasBox">
                  <div class="legendMini" id="legendDist"></div>
                  <canvas id="chartDist" class="miniCanvas"></canvas>
                </div>
                <div class="hint" style="margin-top:8px;">
                  Distribui√ß√£o: valores no per√≠odo + faixa recomendada.
                </div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="title" style="margin-bottom:10px;">
              <h2 style="margin:0; font-size:13px;">Registros (do per√≠odo)</h2>
              <p style="margin:0; font-size:12px; color:var(--muted)">Clique para editar. As avalia√ß√µes s√£o recalculadas automaticamente.</p>
            </div>
            <div class="list" id="logsList"></div>
          </div>

          <!-- LOGS -->
          <div id="viewLogs" style="display:none;">
            <div class="noteBox">
              Aqui ficam todos os registros (peso, medidas, BF%, massa muscular e notas). Use busca e export/import profissional.
            </div>
            <div class="divider"></div>
            <div class="list" id="logsListAll"></div>
          </div>

          <!-- GOALS -->
          <div id="viewGoals" style="display:none;">
            <div class="toolbar" style="margin-top:0;">
              <div class="title">
                <h2 style="margin:0; font-size:13px;">Metas</h2>
                <p style="margin:0; font-size:12px; color:var(--muted)">Peso alvo, BF% alvo, cintura alvo (com progresso real)</p>
              </div>
              <div class="right">
                <button class="btn primary" id="btnNewGoal">Ôºã Meta</button>
              </div>
            </div>
            <div class="divider"></div>
            <div class="noteBox" id="goalsSummary">Carregando metas‚Ä¶</div>
            <div class="divider"></div>
            <div class="list" id="goalsList"></div>
          </div>

          <!-- SETTINGS -->
          <div id="viewSettings" style="display:none;">
            <div class="noteBox">
              Ajustes do app: <b>perfil</b>, <b>unidades</b>, <b>valores padr√£o</b> e <b>crit√©rios de avalia√ß√£o</b>.
              Tudo fica salvo no Firebase.
            </div>

            <div class="divider"></div>

            <div class="split">
              <div class="field">
                <label for="stSex">Sexo biol√≥gico (para f√≥rmulas)</label>
                <select id="stSex">
                  <option value="male">Masculino</option>
                  <option value="female">Feminino</option>
                </select>
              </div>
              <div class="field">
                <label for="stActivity">Atividade (TDEE)</label>
                <select id="stActivity">
                  <option value="1.2">Sedent√°rio (1.2)</option>
                  <option value="1.375">Leve (1.375)</option>
                  <option value="1.55">Moderado (1.55)</option>
                  <option value="1.725">Alto (1.725)</option>
                  <option value="1.9">Muito alto (1.9)</option>
                </select>
              </div>
            </div>

            <div class="split" style="margin-top:10px;">
              <div class="field">
                <label for="stUnits">Unidades</label>
                <select id="stUnits">
                  <option value="metric">M√©trico (kg, cm)</option>
                  <option value="imperial">Imperial (lb, in)</option>
                </select>
              </div>
              <div class="noteBox">
                <b>F√≥rmulas usadas:</b> IMC, BMR (Mifflin), TDEE (fator), FFMI, massa magra, WHR.<br>
                <span class="hint">Obs: avalia√ß√µes s√£o informativas ‚Äî para diagn√≥stico, procure profissional.</span>
              </div>
            </div>

            <div class="divider"></div>

            <div class="split">
              <div class="field">
                <label for="stHeight">Altura padr√£o (cm)</label>
                <input id="stHeight" inputmode="decimal" placeholder="Ex: 171" />
              </div>
              <div class="field">
                <label for="stAge">Idade padr√£o</label>
                <input id="stAge" inputmode="numeric" placeholder="Ex: 28" />
              </div>
            </div>

            <div class="split" style="margin-top:10px;">
              <div class="field">
                <label for="stWaistGoal">Cintura alvo (cm) (opcional)</label>
                <input id="stWaistGoal" inputmode="decimal" placeholder="Ex: 85" />
              </div>
              <div class="field">
                <label for="stBfGoal">Gordura alvo (%) (opcional)</label>
                <input id="stBfGoal" inputmode="decimal" placeholder="Ex: 15" />
              </div>
            </div>

            <div class="divider"></div>

            <div class="title" style="margin-bottom:8px;">
              <h2 style="margin:0; font-size:13px;">Crit√©rios de avalia√ß√£o (auto)</h2>
              <p style="margin:0; font-size:12px; color:var(--muted)">O app calcula faixas saud√°veis com base em idade/sexo/altura e nas m√©tricas registradas.</p>
            </div>

            <div class="noteBox" id="criteriaPreview">
              Carregando crit√©rios‚Ä¶
            </div>

            <div class="divider"></div>

            <div class="right">
              <button class="btn primary" id="btnSaveSettings">‚úî Salvar Ajustes</button>
            </div>

            <div class="hint" style="margin-top:10px;">
              Salvo em: <span class="kbd">/health_settings</span> ‚Ä¢ Registros em <span class="kbd">/health_logs</span> ‚Ä¢ Metas em <span class="kbd">/health_goals</span>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card" aria-label="A√ß√µes r√°pidas">
        <div class="hd">
          <div class="title">
            <h2>Atalhos</h2>
            <p>R√°pido, limpo, ‚ÄúApple feel‚Äù</p>
          </div>
          <button class="btn ghost" id="btnHome">‚Ü© Principal</button>
        </div>

        <div class="bd">
          <div class="noteBox" id="sideSummary">
            ‚úÖ Sem login por enquanto<br>
            ‚úÖ Import/Export profissional (JSON+CSV+Valida√ß√£o)<br>
            ‚úÖ Gr√°ficos avan√ßados + zonas saud√°veis<br>
            ‚úÖ Avalia√ß√£o autom√°tica baseada nos par√¢metros
          </div>

          <div class="divider"></div>

          <div class="title">
            <h2 style="margin:0; font-size:13px;">Insights</h2>
            <p style="margin:0; font-size:12px; color:var(--muted)">Alertas e tend√™ncia</p>
          </div>
          <div style="margin-top:10px;" class="list" id="insights"></div>

          <div class="divider"></div>

          <div class="right">
            <button class="btn ghost" id="btnImport2">‚≠≥ Importar</button>
            <button class="btn ghost" id="btnExport2">‚§ì Exportar</button>
          </div>

          <div class="divider"></div>

          <div class="hint">
            Atalhos: <span class="kbd">N</span> novo ‚Ä¢ <span class="kbd">Ctrl+E</span> export ‚Ä¢ <span class="kbd">Esc</span> fechar
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Mobile bottom nav -->
  <div class="bottomNav">
    <div class="tabs" id="tabsBottom">
      <div class="tab active" data-tab="dash">üìä</div>
      <div class="tab" data-tab="logs">üßæ</div>
      <div class="tab" data-tab="goals">üéØ</div>
      <div class="tab" data-tab="settings">‚öôÔ∏è</div>
    </div>
  </div>

  <!-- MODAL: Registro -->
  <div class="modal" id="logModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="logTitle">
      <div class="phd">
        <div class="ttl">
          <h3 id="logTitle">Novo registro</h3>
          <p>Peso, medidas e composi√ß√£o (com c√°lculo autom√°tico)</p>
        </div>
        <div class="right">
          <button class="btn ghost" id="btnCloseLog">‚úï</button>
          <button class="btn danger" id="btnDeleteLog" style="display:none;">üóëÔ∏è</button>
          <button class="btn primary" id="btnSaveLog">Salvar</button>
        </div>
      </div>

      <div class="pbd">
        <div class="split">
          <div class="field">
            <label for="logDate">Data</label>
            <input id="logDate" type="date" />
          </div>
          <div class="field">
            <label for="logTime">Hora</label>
            <input id="logTime" type="time" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="split">
          <div class="field">
            <label for="logWeight">Peso (kg)</label>
            <input id="logWeight" inputmode="decimal" placeholder="Ex: 82,0" />
          </div>
          <div class="field">
            <label for="logHeight">Altura (cm) (opcional)</label>
            <input id="logHeight" inputmode="decimal" placeholder="Ex: 171" />
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="logAge">Idade (opcional)</label>
            <input id="logAge" inputmode="numeric" placeholder="Ex: 28" />
          </div>
          <div class="field">
            <label for="logBf">Gordura corporal (%)</label>
            <input id="logBf" inputmode="decimal" placeholder="Ex: 18,5" />
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="logMuscle">Massa muscular (kg) (opcional)</label>
            <input id="logMuscle" inputmode="decimal" placeholder="Ex: 35,0" />
          </div>
          <div class="field">
            <label for="logWater">√Ågua corporal (%) (opcional)</label>
            <input id="logWater" inputmode="decimal" placeholder="Ex: 56,0" />
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="logWaist">Cintura (cm) (opcional)</label>
            <input id="logWaist" inputmode="decimal" placeholder="Ex: 88" />
          </div>
          <div class="field">
            <label for="logHip">Quadril (cm) (opcional)</label>
            <input id="logHip" inputmode="decimal" placeholder="Ex: 100" />
          </div>
        </div>

        <div class="field" style="margin-top:10px;">
          <label for="logNote">Observa√ß√µes (treino, sono, dor, etc.)</label>
          <textarea id="logNote" placeholder="Ex: treino pesado, dormi mal, cardio‚Ä¶"></textarea>
        </div>

        <div class="divider"></div>

        <div class="noteBox" id="logPreview">
          Preencha os campos para ver a avalia√ß√£o (IMC, BMR, TDEE, FFMI, zonas).
        </div>

        <div class="hint" id="logFoot"></div>
      </div>
    </div>
  </div>

  <!-- MODAL: Meta -->
  <div class="modal" id="goalModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="goalTitle">
      <div class="phd">
        <div class="ttl">
          <h3 id="goalTitle">Meta</h3>
          <p>Peso/BF%/Cintura com progresso autom√°tico</p>
        </div>
        <div class="right">
          <button class="btn ghost" id="btnCloseGoal">‚úï</button>
          <button class="btn danger" id="btnDeleteGoal" style="display:none;">üóëÔ∏è</button>
          <button class="btn primary" id="btnSaveGoal">Salvar</button>
        </div>
      </div>

      <div class="pbd">
        <div class="split">
          <div class="field">
            <label for="gName">Nome</label>
            <input id="gName" placeholder="Ex: Cutting (12 semanas)" />
          </div>
          <div class="field">
            <label for="gDue">Prazo (opcional)</label>
            <input id="gDue" type="date" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="split">
          <div class="field">
            <label for="gWeight">Peso alvo (kg) (opcional)</label>
            <input id="gWeight" inputmode="decimal" placeholder="Ex: 78,0" />
          </div>
          <div class="field">
            <label for="gBf">Gordura alvo (%) (opcional)</label>
            <input id="gBf" inputmode="decimal" placeholder="Ex: 15,0" />
          </div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div class="field">
            <label for="gWaist">Cintura alvo (cm) (opcional)</label>
            <input id="gWaist" inputmode="decimal" placeholder="Ex: 85" />
          </div>
          <div class="field">
            <label for="gNote">Notas</label>
            <input id="gNote" placeholder="Ex: d√©ficit leve + 3x muscula√ß√£o" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="noteBox" id="goalFoot"></div>
      </div>
    </div>
  </div>

  <!-- hidden input for import -->
  <input id="filePicker" type="file" accept=".json,.csv,text/csv,application/json" style="display:none" />

  <div class="toast" id="toast" role="status" aria-live="polite">
    <div class="msg" id="toastMsg">‚Äî</div>
    <button class="btn ghost" id="toastClose">OK</button>
  </div>

  <script>
    /************************************************************
     * FirebaseConfig (EXATAMENTE o mesmo que voc√™ enviou)
     ************************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyAIp-rFuZZsBCNVJ3pSge4TE-XUuwYygrI",
      authDomain: "agenda-6accc.firebaseapp.com",
      databaseURL: "https://agenda-6accc-default-rtdb.firebaseio.com",
      projectId: "agenda-6accc",
      storageBucket: "agenda-6accc.appspot.com",
      messagingSenderId: "794262176773",
      appId: "1:794262176773:web:c4e3837b29f635d5dc086c",
      measurementId: "G-CVBQ54PERH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const $ = (id)=>document.getElementById(id);

    const PATH = {
      settings: "/health_settings",
      logs: "/health_logs",
      goals: "/health_goals",
      backup: "/health_backups" // opcional (n√£o usado automaticamente)
    };

    /************************************************************
     * Defaults + State
     ************************************************************/
    const defaults = {
      units: "metric",
      sex: "male",
      activity: 1.55,
      defaultHeightCm: 171,
      defaultAge: 28,
      waistGoalCm: "",
      bfGoalPct: "",
      version: 1
    };

    const state = {
      settings: {...defaults},
      logs: [],
      goals: [],
      period: "thisMonth",
      range: {from:null, to:null},
      filters: { search:"" },
      editingLogId: null,
      editingGoalId: null,
      chartMetric: "weightKg",
      chartStyle: "line",
      evalProfile: "general",
      ui: {
        hoverX: null,
        zoom: {min:null, max:null},
      }
    };

    /************************************************************
     * Utils
     ************************************************************/
    function toast(msg){
      $("toastMsg").textContent = msg;
      $("toast").classList.add("show");
      setTimeout(()=> $("toast").classList.remove("show"), 2600);
    }
    $("toastClose").addEventListener("click", ()=> $("toast").classList.remove("show"));

    function openModal(id){ $(id).classList.add("show"); }
    function closeModal(id){ $(id).classList.remove("show"); }

    function nowISODate(){
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }
    function nowISOTime(){
      const d = new Date();
      return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }
    function startOfMonth(d=new Date()){ return new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0,0); }
    function endOfMonth(d=new Date()){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); }
    function startOfYear(d=new Date()){ return new Date(d.getFullYear(), 0, 1, 0,0,0,0); }
    function endOfYear(d=new Date()){ return new Date(d.getFullYear(), 11, 31, 23,59,59,999); }

    function clampRange(){
      const now = new Date();
      if(state.period==="thisMonth"){
        state.range.from = startOfMonth(now);
        state.range.to = endOfMonth(now);
      }else if(state.period==="lastMonth"){
        const prev = new Date(now.getFullYear(), now.getMonth()-1, 15);
        state.range.from = startOfMonth(prev);
        state.range.to = endOfMonth(prev);
      }else if(state.period==="thisYear"){
        state.range.from = startOfYear(now);
        state.range.to = endOfYear(now);
      }else{
        const f = $("dateFrom").value ? new Date($("dateFrom").value+"T00:00:00") : startOfMonth(now);
        const t = $("dateTo").value ? new Date($("dateTo").value+"T23:59:59") : endOfMonth(now);
        state.range.from = f;
        state.range.to = t;
      }
    }

    function safeText(s){ return String(s ?? "").replace(/[<>]/g,"").trim(); }

    function toNumber(str){
      if(typeof str !== "string") return Number(str||0);
      const s = str.trim().replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,"");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    function round1(x){ return Math.round(x*10)/10; }
    function round2(x){ return Math.round(x*100)/100; }

    function formatUnit(metric, v){
      if(v==null || !Number.isFinite(v)) return "‚Äî";
      const u = state.settings.units;
      const map = {
        weightKg: {s:"kg", d:1},
        bmi: {s:"", d:1},
        bfPct: {s:"%", d:1},
        lbmKg: {s:"kg", d:1},
        ffmi: {s:"", d:1},
        bmr: {s:"kcal", d:0},
        tdee: {s:"kcal", d:0},
        waistCm: {s:"cm", d:0},
        whr: {s:"", d:2}
      };
      const m = map[metric] || {s:"", d:1};
      const num = (m.d===0) ? Math.round(v) : (m.d===2 ? round2(v) : round1(v));
      return `${String(num).replace(".",",")}${m.s?(" "+m.s):""}`;
    }

    function setupCanvas(canvas, height){
      const ctx = canvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const W = Math.max(280, rect.width);
      const H = height;
      canvas.width = Math.floor(W*dpr);
      canvas.height = Math.floor(H*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return {ctx, W, H};
    }

    function roundRect(ctx, x, y, w, h, r, fill, stroke) {
      r = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }

    function drawGrid(ctx,W,H){
      ctx.lineWidth=1;
      ctx.strokeStyle="rgba(255,255,255,.07)";
      const top=20, bottom=H-26;
      for(let i=0;i<=4;i++){
        const y = top + i*((bottom-top)/4);
        ctx.beginPath(); ctx.moveTo(12,y); ctx.lineTo(W-12,y); ctx.stroke();
      }
      // vertical light ticks
      ctx.strokeStyle="rgba(255,255,255,.05)";
      for(let i=0;i<=6;i++){
        const x=12 + i*((W-24)/6);
        ctx.beginPath(); ctx.moveTo(x, top); ctx.lineTo(x, bottom); ctx.stroke();
      }
    }

    /************************************************************
     * Unidades + F√≥rmulas
     ************************************************************/
    function toMetric(v, kind){ // kind: weight(kg), length(cm)
      const u = state.settings.units;
      if(u==="metric") return v;
      // imperial -> metric
      if(kind==="weight"){ // lb -> kg
        return v * 0.45359237;
      }
      if(kind==="length"){ // in -> cm
        return v * 2.54;
      }
      return v;
    }

    function computeDerived(log){
      // Resolve altura/idade (do registro ou padr√£o)
      const hCm = Number(log.heightCm || state.settings.defaultHeightCm || 0);
      const age = Number(log.age || state.settings.defaultAge || 0);
      const sex = state.settings.sex || "male";
      const activity = Number(state.settings.activity || 1.55);

      const wKg = Number(log.weightKg || 0);
      const bf = (log.bfPct!=null && log.bfPct!=="") ? Number(log.bfPct) : null;
      const waist = (log.waistCm!=null && log.waistCm!=="") ? Number(log.waistCm) : null;
      const hip = (log.hipCm!=null && log.hipCm!=="") ? Number(log.hipCm) : null;

      const hM = hCm/100;
      const bmi = (wKg>0 && hM>0) ? (wKg/(hM*hM)) : null;

      // Massa magra (kg)
      const lbmKg = (wKg>0 && bf!=null && bf>=0 && bf<=80) ? (wKg*(1 - bf/100)) : null;

      // FFMI = LBM / (h^2)
      const ffmi = (lbmKg!=null && hM>0) ? (lbmKg/(hM*hM)) : null;

      // BMR Mifflin-St Jeor
      let bmr = null;
      if(wKg>0 && hCm>0 && age>0){
        bmr = (10*wKg) + (6.25*hCm) - (5*age) + (sex==="male" ? 5 : -161);
      }
      const tdee = (bmr!=null) ? (bmr*activity) : null;

      const whr = (waist!=null && hip!=null && hip>0) ? (waist/hip) : null;

      return {hCm, age, sex, activity, wKg, bf, waist, hip, bmi, lbmKg, ffmi, bmr, tdee, whr};
    }

    /************************************************************
     * Zonas Saud√°veis (limites din√¢micos)
     * - IMC: WHO (informativo)
     * - BF%: faixas por sexo e idade (heur√≠stica t√≠pica fitness)
     * - Cintura: risco cardiometab√≥lico por sexo (cm)
     * - WHR: risco por sexo
     ************************************************************/
    function getZones(derived, metric, profile){
      const sex = derived.sex;
      const age = derived.age || 0;

      // helper: returns {good:[min,max], warn:[...], bad:[...], labelGood, labelWarn, labelBad}
      if(metric==="bmi"){
        // WHO: <18.5 baixo, 18.5-24.9 normal, 25-29.9 sobrepeso, >=30 obesidade
        return {
          good: [18.5, 24.9],
          warn: [25.0, 29.9],
          bad:  [30.0, 200],
          lowBad: [0, 18.49],
          labels: {
            lowBad: "Baixo",
            good: "Saud√°vel",
            warn: "Aten√ß√£o",
            bad: "Risco"
          }
        };
      }

      if(metric==="bfPct"){
        // Heur√≠stica por sexo/idade (n√£o diagn√≥stico). Ajusta pelo perfil.
        // base ranges (aprox.)
        let goodMin, goodMax, warnMax, riskMax;
        if(sex==="male"){
          // idade: jovem/medio/mais velho -> BF saud√°vel tende a subir um pouco
          if(age<=29){ goodMin=10; goodMax=17; }
          else if(age<=39){ goodMin=11; goodMax=18; }
          else if(age<=49){ goodMin=12; goodMax=20; }
          else { goodMin=13; goodMax=22; }
          warnMax = goodMax + 7;     // aten√ß√£o
          riskMax = warnMax + 8;     // risco alto
        }else{
          if(age<=29){ goodMin=18; goodMax=25; }
          else if(age<=39){ goodMin=19; goodMax=26; }
          else if(age<=49){ goodMin=20; goodMax=28; }
          else { goodMin=21; goodMax=30; }
          warnMax = goodMax + 8;
          riskMax = warnMax + 10;
        }

        // profile tweak
        if(profile==="fitness"){
          goodMin += (sex==="male"? -1 : -1);
          goodMax += (sex==="male"? -2 : -2);
          warnMax += (sex==="male"? -2 : -2);
        }else if(profile==="athlete"){
          goodMin += (sex==="male"? -2 : -2);
          goodMax += (sex==="male"? -4 : -4);
          warnMax += (sex==="male"? -4 : -4);
        }

        goodMin = clamp(goodMin, 2, 60);
        goodMax = clamp(goodMax, goodMin+2, 60);
        warnMax = clamp(warnMax, goodMax+1, 70);
        riskMax = clamp(riskMax, warnMax+1, 80);

        return {
          good: [goodMin, goodMax],
          warn: [goodMax+0.01, warnMax],
          bad:  [warnMax+0.01, riskMax],
          lowBad: [0, goodMin-0.01],
          labels:{
            lowBad:"Muito baixo",
            good:"Saud√°vel",
            warn:"Aten√ß√£o",
            bad:"Risco"
          }
        };
      }

      if(metric==="waistCm"){
        // Cintura (cm): risco metab√≥lico (valores cl√°ssicos informativos)
        // homens: >=94 risco ‚Üë, >=102 alto; mulheres: >=80 risco ‚Üë, >=88 alto
        if(sex==="male"){
          return {
            good:[0, 93.9],
            warn:[94, 101.9],
            bad:[102, 300],
            labels:{good:"Saud√°vel", warn:"Aten√ß√£o", bad:"Risco"}
          };
        }else{
          return {
            good:[0, 79.9],
            warn:[80, 87.9],
            bad:[88, 300],
            labels:{good:"Saud√°vel", warn:"Aten√ß√£o", bad:"Risco"}
          };
        }
      }

      if(metric==="whr"){
        // WHR: (informativo) homens <0.90 bom, 0.90-0.99 aten√ß√£o, >=1.0 risco
        // mulheres <0.80 bom, 0.80-0.84 aten√ß√£o, >=0.85 risco
        if(sex==="male"){
          return {
            good:[0, 0.899],
            warn:[0.90, 0.99],
            bad:[1.00, 9],
            labels:{good:"Saud√°vel", warn:"Aten√ß√£o", bad:"Risco"}
          };
        }else{
          return {
            good:[0, 0.799],
            warn:[0.80, 0.84],
            bad:[0.85, 9],
            labels:{good:"Saud√°vel", warn:"Aten√ß√£o", bad:"Risco"}
          };
        }
      }

      if(metric==="ffmi"){
        // FFMI (informativo): ranges aproximados (homens: 18-22 bom, 22-24 alto; mulheres: 15-18 bom)
        if(sex==="male"){
          return {
            good:[18, 22],
            warn:[22.01, 24],
            bad:[24.01, 40],
            lowBad:[0, 17.99],
            labels:{lowBad:"Baixo", good:"Bom", warn:"Alto", bad:"Muito alto"}
          };
        }else{
          return {
            good:[15, 18],
            warn:[18.01, 20],
            bad:[20.01, 35],
            lowBad:[0, 14.99],
            labels:{lowBad:"Baixo", good:"Bom", warn:"Alto", bad:"Muito alto"}
          };
        }
      }

      // default: sem zonas fixas
      return null;
    }

    function classifyValue(z, v){
      if(v==null || !Number.isFinite(v) || !z) return {tag:"‚Äî", cls:"", dot:""};
      if(z.lowBad && v>=z.lowBad[0] && v<=z.lowBad[1]) return {tag:z.labels.lowBad || "Baixo", cls:"bad", dot:"bad"};
      if(v>=z.good[0] && v<=z.good[1]) return {tag:z.labels.good || "Saud√°vel", cls:"good", dot:"good"};
      if(z.warn && v>=z.warn[0] && v<=z.warn[1]) return {tag:z.labels.warn || "Aten√ß√£o", cls:"warn", dot:"warn"};
      if(v>=z.bad[0] && v<=z.bad[1]) return {tag:z.labels.bad || "Risco", cls:"bad", dot:"bad"};
      // fallback
      return {tag:"Aten√ß√£o", cls:"warn", dot:"warn"};
    }

    /************************************************************
     * Data model
     ************************************************************/
    function normalizeLog(id, raw){
      let ts = 0;
      if(raw.ts) ts = Number(raw.ts);
      else if(raw.dateTime) ts = new Date(raw.dateTime).getTime();
      else ts = Date.now();

      const obj = {
        id,
        ts,
        weightKg: Number(raw.weightKg || 0),
        heightCm: raw.heightCm!=null && raw.heightCm!=="" ? Number(raw.heightCm) : null,
        age: raw.age!=null && raw.age!=="" ? Number(raw.age) : null,
        bfPct: raw.bfPct!=null && raw.bfPct!=="" ? Number(raw.bfPct) : null,
        muscleKg: raw.muscleKg!=null && raw.muscleKg!=="" ? Number(raw.muscleKg) : null,
        waterPct: raw.waterPct!=null && raw.waterPct!=="" ? Number(raw.waterPct) : null,
        waistCm: raw.waistCm!=null && raw.waistCm!=="" ? Number(raw.waistCm) : null,
        hipCm: raw.hipCm!=null && raw.hipCm!=="" ? Number(raw.hipCm) : null,
        note: safeText(raw.note || ""),
        createdAt: raw.createdAt || ts,
        updatedAt: raw.updatedAt || ts
      };
      return obj;
    }

    function applyFilters(list){
      const q = (state.filters.search||"").trim().toLowerCase();
      return list.filter(l=>{
        if(l.ts < state.range.from.getTime() || l.ts > state.range.to.getTime()) return false;
        if(q){
          const bag = `${l.note||""} ${l.weightKg||""} ${l.bfPct||""} ${l.waistCm||""} ${l.hipCm||""}`.toLowerCase();
          if(!bag.includes(q)) return false;
        }
        return true;
      }).sort((a,b)=>b.ts-a.ts);
    }

    /************************************************************
     * Firebase: load/listen
     ************************************************************/
    async function loadSettings(){
      const snap = await db.ref(PATH.settings).get().catch(()=>null);
      if(snap && snap.exists()){
        const v = snap.val();
        state.settings = {
          units: v.units || defaults.units,
          sex: v.sex || defaults.sex,
          activity: Number(v.activity || defaults.activity),
          defaultHeightCm: Number(v.defaultHeightCm || defaults.defaultHeightCm),
          defaultAge: Number(v.defaultAge || defaults.defaultAge),
          waistGoalCm: v.waistGoalCm ?? defaults.waistGoalCm,
          bfGoalPct: v.bfGoalPct ?? defaults.bfGoalPct,
          version: v.version || 1
        };
      }else{
        await db.ref(PATH.settings).set(defaults);
        state.settings = {...defaults};
      }

      $("stUnits").value = state.settings.units;
      $("stSex").value = state.settings.sex;
      $("stActivity").value = String(state.settings.activity);
      $("stHeight").value = String(state.settings.defaultHeightCm || "");
      $("stAge").value = String(state.settings.defaultAge || "");
      $("stWaistGoal").value = state.settings.waistGoalCm || "";
      $("stBfGoal").value = state.settings.bfGoalPct || "";

      renderCriteriaPreview();
    }

    function listenGoals(){
      db.ref(PATH.goals).on("value",(snap)=>{
        const v = snap.val() || {};
        const list = Object.values(v).filter(Boolean).map(g=>({
          id: g.id,
          name: g.name || "Meta",
          due: g.due || "",
          weightKg: g.weightKg!=null && g.weightKg!=="" ? Number(g.weightKg) : null,
          bfPct: g.bfPct!=null && g.bfPct!=="" ? Number(g.bfPct) : null,
          waistCm: g.waistCm!=null && g.waistCm!=="" ? Number(g.waistCm) : null,
          note: g.note || ""
        }));
        state.goals = list;
        renderGoals();
      });
    }

    function listenLogs(){
      db.ref(PATH.logs).on("value",(snap)=>{
        const v = snap.val() || {};
        const list = Object.keys(v).map(id=> normalizeLog(id, v[id])).filter(Boolean);
        list.sort((a,b)=>b.ts-a.ts);
        state.logs = list;
        $("dbInfo").textContent = `DB: /health_logs ‚Ä¢ itens: ${state.logs.length}`;
        renderAll();
      });
    }

    async function saveSettings(){
      const next = {
        units: $("stUnits").value || "metric",
        sex: $("stSex").value || "male",
        activity: Number($("stActivity").value || 1.55),
        defaultHeightCm: toNumber($("stHeight").value) || defaults.defaultHeightCm,
        defaultAge: parseInt($("stAge").value||defaults.defaultAge,10) || defaults.defaultAge,
        waistGoalCm: $("stWaistGoal").value.trim(),
        bfGoalPct: $("stBfGoal").value.trim(),
        version: 1,
        updatedAt: Date.now()
      };
      await db.ref(PATH.settings).set(next);
      state.settings = {...next};
      renderCriteriaPreview();
      renderAll();
      toast("Ajustes salvos.");
    }

    /************************************************************
     * CRUD Logs
     ************************************************************/
    function openLogModal(log=null){
      state.editingLogId = log ? log.id : null;
      $("logTitle").textContent = log ? "Editar registro" : "Novo registro";
      $("btnDeleteLog").style.display = log ? "inline-flex" : "none";

      const d = log ? new Date(log.ts) : new Date();
      $("logDate").value = log ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}` : nowISODate();
      $("logTime").value = log ? `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}` : nowISOTime();

      $("logWeight").value = log?.weightKg!=null ? String(log.weightKg).replace(".",",") : "";
      $("logHeight").value = log?.heightCm!=null ? String(log.heightCm).replace(".",",") : "";
      $("logAge").value = log?.age!=null ? String(log.age) : "";
      $("logBf").value = log?.bfPct!=null ? String(log.bfPct).replace(".",",") : "";
      $("logMuscle").value = log?.muscleKg!=null ? String(log.muscleKg).replace(".",",") : "";
      $("logWater").value = log?.waterPct!=null ? String(log.waterPct).replace(".",",") : "";
      $("logWaist").value = log?.waistCm!=null ? String(log.waistCm).replace(".",",") : "";
      $("logHip").value = log?.hipCm!=null ? String(log.hipCm).replace(".",",") : "";
      $("logNote").value = log?.note || "";

      $("logFoot").textContent = log ? `ID: ${log.id}` : "Dica: registre sempre no mesmo hor√°rio (ex: manh√£).";
      updateLogPreview();
      openModal("logModal");
    }

    function logFromForm(){
      const date = $("logDate").value || nowISODate();
      const time = $("logTime").value || "12:00";
      const ts = new Date(`${date}T${time}:00`).getTime();

      const weightKg = toNumber($("logWeight").value);
      const heightCm = $("logHeight").value.trim() ? toNumber($("logHeight").value) : null;
      const age = $("logAge").value.trim() ? parseInt($("logAge").value,10) : null;
      const bfPct = $("logBf").value.trim() ? toNumber($("logBf").value) : null;
      const muscleKg = $("logMuscle").value.trim() ? toNumber($("logMuscle").value) : null;
      const waterPct = $("logWater").value.trim() ? toNumber($("logWater").value) : null;
      const waistCm = $("logWaist").value.trim() ? toNumber($("logWaist").value) : null;
      const hipCm = $("logHip").value.trim() ? toNumber($("logHip").value) : null;
      const note = safeText($("logNote").value);

      if(!Number.isFinite(weightKg) || weightKg<=0) throw new Error("Informe um peso v√°lido (>0).");

      // valida√ß√µes suaves
      if(heightCm!=null && (heightCm<120 || heightCm>230)) throw new Error("Altura parece inv√°lida (cm).");
      if(age!=null && (age<5 || age>120)) throw new Error("Idade parece inv√°lida.");
      if(bfPct!=null && (bfPct<2 || bfPct>80)) throw new Error("BF% parece inv√°lido (2‚Äì80).");
      if(waistCm!=null && (waistCm<40 || waistCm>200)) throw new Error("Cintura parece inv√°lida.");
      if(hipCm!=null && (hipCm<50 || hipCm>220)) throw new Error("Quadril parece inv√°lido.");

      return {ts, weightKg, heightCm, age, bfPct, muscleKg, waterPct, waistCm, hipCm, note};
    }

    async function saveLog(){
      try{
        const data = logFromForm();
        if(state.editingLogId){
          await db.ref(`${PATH.logs}/${state.editingLogId}`).update({ ...data, updatedAt: Date.now() });
          toast("Registro atualizado.");
        }else{
          const ref = db.ref(PATH.logs).push();
          const id = ref.key;
          await ref.set({ id, ...data, createdAt: Date.now(), updatedAt: Date.now() });
          toast("Registro criado.");
        }
        closeModal("logModal");
      }catch(err){
        alert(err.message || "Erro ao salvar.");
      }
    }

    async function deleteLog(log){
      const ok = confirm("Excluir este registro?");
      if(!ok) return;
      await db.ref(`${PATH.logs}/${log.id}`).remove();
      toast("Exclu√≠do.");
    }

    /************************************************************
     * Goals CRUD
     ************************************************************/
    function openGoalModal(g=null){
      state.editingGoalId = g ? g.id : null;
      $("goalTitle").textContent = g ? "Editar meta" : "Nova meta";
      $("btnDeleteGoal").style.display = g ? "inline-flex" : "none";

      $("gName").value = g?.name || "";
      $("gDue").value = g?.due || "";
      $("gWeight").value = g?.weightKg!=null ? String(g.weightKg).replace(".",",") : "";
      $("gBf").value = g?.bfPct!=null ? String(g.bfPct).replace(".",",") : "";
      $("gWaist").value = g?.waistCm!=null ? String(g.waistCm).replace(".",",") : "";
      $("gNote").value = g?.note || "";

      $("goalFoot").innerHTML = `Dica: metas usam o <b>√∫ltimo registro</b> como ‚Äúatual‚Äù para progresso.`;
      openModal("goalModal");
    }

    async function saveGoal(){
      const name = safeText($("gName").value);
      const due = $("gDue").value || "";
      const weightKg = $("gWeight").value.trim() ? toNumber($("gWeight").value) : null;
      const bfPct = $("gBf").value.trim() ? toNumber($("gBf").value) : null;
      const waistCm = $("gWaist").value.trim() ? toNumber($("gWaist").value) : null;
      const note = safeText($("gNote").value);

      if(!name) return alert("Informe o nome da meta.");
      if(weightKg==null && bfPct==null && waistCm==null) return alert("Defina pelo menos 1 alvo (peso, BF% ou cintura).");

      if(state.editingGoalId){
        await db.ref(`${PATH.goals}/${state.editingGoalId}`).update({
          name, due, weightKg, bfPct, waistCm, note, updatedAt: Date.now()
        });
        toast("Meta atualizada.");
      }else{
        const ref = db.ref(PATH.goals).push();
        const id = ref.key;
        await ref.set({ id, name, due, weightKg, bfPct, waistCm, note, createdAt: Date.now(), updatedAt: Date.now() });
        toast("Meta criada.");
      }
      closeModal("goalModal");
    }

    async function deleteGoal(g){
      const ok = confirm("Excluir esta meta?");
      if(!ok) return;
      await db.ref(`${PATH.goals}/${g.id}`).remove();
      toast("Meta exclu√≠da.");
      closeModal("goalModal");
    }

    /************************************************************
     * Import / Export (PRO)
     ************************************************************/
    function buildBackupPayload(){
      // vers√£o e schema
      const payload = {
        app: "health_apple_level",
        schemaVersion: 1,
        exportedAt: new Date().toISOString(),
        settings: state.settings,
        goals: state.goals,
        logs: state.logs
      };
      return payload;
    }

    function downloadBlob(name, blob){
      const url = URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;
      a.download=name;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportAll(){
      // JSON (backup completo)
      const payload = buildBackupPayload();
      const json = JSON.stringify(payload, null, 2);
      downloadBlob(`health_backup_${Date.now()}.json`, new Blob([json], {type:"application/json;charset=utf-8"}));

      // CSV logs
      const rows = [
        ["id","data_hora","peso_kg","altura_cm","idade","bf_pct","musculo_kg","agua_pct","cintura_cm","quadril_cm","obs"]
      ];
      state.logs.slice().sort((a,b)=>a.ts-b.ts).forEach(l=>{
        rows.push([
          l.id,
          new Date(l.ts).toISOString(),
          String(l.weightKg??"").replace(".",","),
          String(l.heightCm??"").replace(".",","),
          String(l.age??""),
          String(l.bfPct??"").replace(".",","),
          String(l.muscleKg??"").replace(".",","),
          String(l.waterPct??"").replace(".",","),
          String(l.waistCm??"").replace(".",","),
          String(l.hipCm??"").replace(".",","),
          (l.note||"").replaceAll('"','""')
        ]);
      });
      const csv = rows.map(r=>r.map(v=>`"${String(v??"")}"`).join(";")).join("\n");
      downloadBlob(`health_logs_${Date.now()}.csv`, new Blob([csv], {type:"text/csv;charset=utf-8"}));

      toast("Export: JSON (backup) + CSV (logs).");
    }

    function parseCSV(text){
      // simples (separador ; e aspas). suficiente pro seu caso.
      const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
      if(lines.length<2) throw new Error("CSV vazio.");
      const header = splitCsvLine(lines[0]);
      const out = [];
      for(let i=1;i<lines.length;i++){
        const cols = splitCsvLine(lines[i]);
        const row = {};
        header.forEach((h,idx)=> row[h]=cols[idx] ?? "");
        out.push(row);
      }
      return out;
    }

    function splitCsvLine(line){
      const res=[];
      let cur="", inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch === '"'){
          if(inQ && line[i+1] === '"'){ cur+='"'; i++; }
          else inQ=!inQ;
        }else if(ch === ';' && !inQ){
          res.push(cur); cur="";
        }else{
          cur+=ch;
        }
      }
      res.push(cur);
      return res.map(s=>s.trim());
    }

    async function importFile(file){
      const name = (file.name||"").toLowerCase();
      const text = await file.text();

      // JSON backup
      if(name.endsWith(".json")){
        let payload;
        try{ payload = JSON.parse(text); }catch{ throw new Error("JSON inv√°lido."); }
        // valida√ß√£o m√≠nima
        if(!payload || typeof payload!=="object") throw new Error("JSON inv√°lido (obj).");
        if(payload.schemaVersion!==1) throw new Error("schemaVersion incompat√≠vel.");
        if(!payload.settings || !payload.logs) throw new Error("Backup incompleto (settings/logs).");

        const ok = confirm("Importar backup completo? Isso vai SUBSTITUIR settings, logs e goals.");
        if(!ok) return;

        // escreve em batch simples (substitui n√≥s)
        await db.ref(PATH.settings).set(payload.settings);
        const logsObj = {};
        (payload.logs||[]).forEach(l=>{
          const id = l.id || db.ref(PATH.logs).push().key;
          const normalized = normalizeLog(id, l);
          logsObj[id] = { id, ...normalized, createdAt: l.createdAt||Date.now(), updatedAt: Date.now() };
        });
        await db.ref(PATH.logs).set(logsObj);

        const goalsObj = {};
        (payload.goals||[]).forEach(g=>{
          const id = g.id || db.ref(PATH.goals).push().key;
          goalsObj[id] = { id, ...g, updatedAt: Date.now(), createdAt: g.createdAt||Date.now() };
        });
        await db.ref(PATH.goals).set(goalsObj);

        toast("Import JSON conclu√≠do.");
        return;
      }

      // CSV logs
      if(name.endsWith(".csv")){
        const rows = parseCSV(text);
        const ok = confirm(`Importar ${rows.length} linhas do CSV para logs? (vai ADICIONAR; IDs iguais ser√£o atualizados)`); 
        if(!ok) return;

        const updates = {};
        for(const r of rows){
          const id = (r.id && r.id.trim()) ? r.id.trim() : db.ref(PATH.logs).push().key;
          const ts = r.data_hora ? new Date(r.data_hora).getTime() : Date.now();
          const obj = {
            id,
            ts: Number.isFinite(ts)?ts:Date.now(),
            weightKg: toNumber(r.peso_kg || r.weightKg || ""),
            heightCm: (r.altura_cm||"").trim()? toNumber(r.altura_cm): null,
            age: (r.idade||"").trim()? parseInt(r.idade,10): null,
            bfPct: (r.bf_pct||"").trim()? toNumber(r.bf_pct): null,
            muscleKg: (r.musculo_kg||"").trim()? toNumber(r.musculo_kg): null,
            waterPct: (r.agua_pct||"").trim()? toNumber(r.agua_pct): null,
            waistCm: (r.cintura_cm||"").trim()? toNumber(r.cintura_cm): null,
            hipCm: (r.quadril_cm||"").trim()? toNumber(r.quadril_cm): null,
            note: safeText(r.obs || r.note || ""),
            updatedAt: Date.now()
          };
          if(!obj.weightKg || obj.weightKg<=0) continue; // ignora linha ruim
          updates[id] = obj;
        }
        if(Object.keys(updates).length===0) throw new Error("CSV sem linhas v√°lidas (peso>0).");
        await db.ref(PATH.logs).update(updates);
        toast(`Import CSV ok: ${Object.keys(updates).length} registros.`);
        return;
      }

      throw new Error("Formato n√£o suportado. Use .json ou .csv");
    }

    /************************************************************
     * Render: Criteria preview
     ************************************************************/
    function renderCriteriaPreview(){
      const dummy = computeDerived({
        weightKg: 80,
        heightCm: state.settings.defaultHeightCm,
        age: state.settings.defaultAge,
        bfPct: 18,
        waistCm: 90,
        hipCm: 100
      });

      const zBMI = getZones(dummy, "bmi", state.evalProfile);
      const zBF = getZones(dummy, "bfPct", state.evalProfile);
      const zW = getZones(dummy, "waistCm", state.evalProfile);
      const zWHR = getZones(dummy, "whr", state.evalProfile);
      const zFFMI = getZones(dummy, "ffmi", state.evalProfile);

      const fmtRange = (z, key)=>{
        if(!z) return "‚Äî";
        if(key==="lowBad" && !z.lowBad) return "‚Äî";
        const r = z[key];
        const a = (r[0]!=null)? String(round2(r[0])).replace(".",","):"";
        const b = (r[1]!=null)? String(round2(r[1])).replace(".",","):"";
        return `${a} ‚Üí ${b}`;
      };

      $("criteriaPreview").innerHTML = `
        <b>Faixas (baseadas em sexo/idade/perfil):</b><br><br>
        ‚Ä¢ <b>IMC</b>: baixo ${fmtRange(zBMI,"lowBad")} | saud√°vel ${fmtRange(zBMI,"good")} | aten√ß√£o ${fmtRange(zBMI,"warn")} | risco ${fmtRange(zBMI,"bad")}<br>
        ‚Ä¢ <b>BF%</b>: baixo ${fmtRange(zBF,"lowBad")} | saud√°vel ${fmtRange(zBF,"good")} | aten√ß√£o ${fmtRange(zBF,"warn")} | risco ${fmtRange(zBF,"bad")}<br>
        ‚Ä¢ <b>Cintura (cm)</b>: saud√°vel ${fmtRange(zW,"good")} | aten√ß√£o ${fmtRange(zW,"warn")} | risco ${fmtRange(zW,"bad")}<br>
        ‚Ä¢ <b>WHR</b>: saud√°vel ${fmtRange(zWHR,"good")} | aten√ß√£o ${fmtRange(zWHR,"warn")} | risco ${fmtRange(zWHR,"bad")}<br>
        ‚Ä¢ <b>FFMI</b>: baixo ${fmtRange(zFFMI,"lowBad")} | bom ${fmtRange(zFFMI,"good")} | alto ${fmtRange(zFFMI,"warn")} | muito alto ${fmtRange(zFFMI,"bad")}
      `;
    }

    /************************************************************
     * KPIs + Insights
     ************************************************************/
    function renderKPIs(filtered){
      const kpisEl = $("kpis");
      kpisEl.innerHTML = "";

      const latest = filtered[0] ? normalizeLog(filtered[0].id, filtered[0]) : null;
      const lastAll = state.logs[0] ? normalizeLog(state.logs[0].id, state.logs[0]) : null;
      const base = latest || lastAll;

      const make = (label, value, sub, statusDot="")=>{
        const div = document.createElement("div");
        div.className="kpi";
        div.innerHTML = `
          <div class="label"><span class="dot ${statusDot}"></span>${label}</div>
          <div class="value">${value}</div>
          <div class="sub">${sub}</div>
        `;
        return div;
      };

      if(!base){
        kpisEl.appendChild(make("Status", "‚Äî", "Sem registros ainda", "warn"));
        kpisEl.appendChild(make("IMC", "‚Äî", "Registre peso/altura", ""));
        kpisEl.appendChild(make("BF%", "‚Äî", "Opcional", ""));
        kpisEl.appendChild(make("TDEE", "‚Äî", "Ajuste atividade em Ajustes", ""));
        return;
      }

      const d = computeDerived(base);
      const zBMI = getZones(d, "bmi", state.evalProfile);
      const zBF = getZones(d, "bfPct", state.evalProfile);
      const zW = getZones(d, "waistCm", state.evalProfile);
      const zFFMI = getZones(d, "ffmi", state.evalProfile);

      const bmiClass = classifyValue(zBMI, d.bmi);
      const bfClass = classifyValue(zBF, d.bf);
      const waistClass = classifyValue(zW, d.waist);
      const ffmiClass = classifyValue(zFFMI, d.ffmi);

      const dt = new Date(base.ts).toLocaleString("pt-BR");
      const weightDelta = (filtered.length>=2) ? (filtered[0].weightKg - filtered[1].weightKg) : null;

      kpisEl.appendChild(make("Peso", formatUnit("weightKg", d.wKg), weightDelta!=null ? `Œî vs anterior: ${String(round1(weightDelta)).replace(".",",")} kg` : `√öltimo: ${dt}`, (weightDelta!=null ? (weightDelta<=0?"good":"warn") : "")));
      kpisEl.appendChild(make("IMC", d.bmi!=null ? String(round1(d.bmi)).replace(".",",") : "‚Äî", d.bmi!=null ? `Faixa: ${bmiClass.tag}` : "Informe altura", bmiClass.dot));
      kpisEl.appendChild(make("Gordura", d.bf!=null ? `${String(round1(d.bf)).replace(".",",")} %` : "‚Äî", d.bf!=null ? `Faixa: ${bfClass.tag}` : "Opcional", bfClass.dot));
      kpisEl.appendChild(make("Metabolismo", d.tdee!=null ? `${Math.round(d.tdee)} kcal` : "‚Äî", d.bmr!=null ? `BMR: ${Math.round(d.bmr)} kcal` : "Precisa idade/altura", "good"));

      // side summary
      $("sideSummary").innerHTML = `
        ‚úÖ <b>√öltimo registro:</b> ${dt}<br>
        ‚úÖ <b>Perfil:</b> ${state.evalProfile}<br>
        ‚úÖ <b>Atividade:</b> ${state.settings.activity}<br>
        ‚úÖ <b>Altura/Idade base:</b> ${state.settings.defaultHeightCm} cm ‚Ä¢ ${state.settings.defaultAge} anos
      `;

      // insights
      renderInsights(filtered);
    }

    function renderInsights(filtered){
      const el = $("insights");
      el.innerHTML = "";
      if(filtered.length<2){
        const d=document.createElement("div");
        d.className="hint";
        d.textContent="Crie mais registros para ver tend√™ncias e alertas.";
        el.appendChild(d);
        return;
      }

      const series = filtered.slice().sort((a,b)=>a.ts-b.ts);
      const last = series[series.length-1];
      const prev = series[series.length-2];
      const dLast = computeDerived(last);
      const dPrev = computeDerived(prev);

      const items = [];

      const deltaW = dLast.wKg - dPrev.wKg;
      items.push({
        title: "Varia√ß√£o de peso",
        text: `${deltaW>=0?"+":"‚àí"} ${String(Math.abs(round1(deltaW))).replace(".",",")} kg vs registro anterior`,
        cls: Math.abs(deltaW)<=0.4 ? "good" : (deltaW<=0? "good":"warn")
      });

      if(dLast.bf!=null && dPrev.bf!=null){
        const deltaBF = dLast.bf - dPrev.bf;
        items.push({
          title: "Varia√ß√£o de BF%",
          text: `${deltaBF>=0?"+":"‚àí"} ${String(Math.abs(round1(deltaBF))).replace(".",",")} p.p.`,
          cls: deltaBF<=0 ? "good":"warn"
        });
      }

      // consist√™ncia (dias entre registros)
      const dtDays = Math.round((dLast.ts - dPrev.ts)/86400000);
      items.push({
        title: "Consist√™ncia",
        text: dtDays<=2 ? "Excelente: registrando com frequ√™ncia" : `Intervalo: ${dtDays} dias`,
        cls: dtDays<=2 ? "good" : (dtDays<=7 ? "warn":"bad")
      });

      items.forEach(it=>{
        const card=document.createElement("div");
        card.className="noteBox";
        card.innerHTML = `<b class="${it.cls}">${safeText(it.title)}</b><br>${safeText(it.text)}`;
        el.appendChild(card);
      });
    }

    /************************************************************
     * Charts (Apple-level): linha/√°rea/barras/candles + zoom + hover
     ************************************************************/
    function getMetricValue(derived, metric){
      const map = {
        weightKg: derived.wKg,
        bmi: derived.bmi,
        bfPct: derived.bf,
        lbmKg: derived.lbmKg,
        ffmi: derived.ffmi,
        bmr: derived.bmr,
        tdee: derived.tdee,
        waistCm: derived.waist,
        whr: derived.whr
      };
      return map[metric] ?? null;
    }

    function buildSeries(filtered){
      const series = filtered.slice().sort((a,b)=>a.ts-b.ts).map(l=>{
        const d = computeDerived(l);
        return {
          ts: l.ts,
          date: new Date(l.ts),
          raw: l,
          derived: d,
          v: getMetricValue(d, state.chartMetric)
        };
      }).filter(p=>p.v!=null && Number.isFinite(p.v));
      return series;
    }

    function getSeriesBounds(series){
      if(series.length===0) return null;
      let min=Infinity, max=-Infinity;
      for(const p of series){
        min = Math.min(min, p.v);
        max = Math.max(max, p.v);
      }
      if(min===max){ min -= 1; max += 1; }
      return {min, max};
    }

    function getVisibleRange(series){
      if(series.length===0) return {a:0,b:-1};
      let a=0,b=series.length-1;
      const z=state.ui.zoom;
      if(z.min==null || z.max==null) return {a,b};

      // find indices within ts range
      while(a<series.length && series[a].ts<z.min) a++;
      while(b>=0 && series[b].ts>z.max) b--;
      if(a>b){ a=0; b=series.length-1; }
      return {a,b};
    }

    function setLegend(elId, items){
      const el = $(elId);
      el.innerHTML = "";
      items.forEach(t=>{
        const span=document.createElement("div");
        span.className="lg";
        span.textContent=t;
        el.appendChild(span);
      });
    }

    function drawMainChart(series, zones){
      const canvas = $("chartMain");
      const {ctx,W,H} = setupCanvas(canvas, 260);
      ctx.clearRect(0,0,W,H);
      drawGrid(ctx,W,H);

      const {a,b} = getVisibleRange(series);
      const vis = series.slice(a,b+1);
      if(vis.length===0){
        ctx.fillStyle="rgba(154,166,195,.75)";
        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        ctx.fillText("Sem dados para esta m√©trica no per√≠odo.", 16, 34);
        setLegend("legendMain", ["Sem dados"]);
        return;
      }

      // bounds
      const bounds = getSeriesBounds(vis);
      let yMin=bounds.min, yMax=bounds.max;

      // include zones in vertical scale (so ‚Äúfaixa recomendada‚Äù sempre aparece)
      if(zones){
        yMin = Math.min(yMin, zones.good[0], zones.bad[0], zones.warn?zones.warn[0]:yMin, zones.lowBad?zones.lowBad[0]:yMin);
        yMax = Math.max(yMax, zones.good[1], zones.bad[1], zones.warn?zones.warn[1]:yMax, zones.lowBad?zones.lowBad[1]:yMax);
      }
      if(yMin===yMax){ yMin-=1; yMax+=1; }

      const padL=12, padR=12, padT=20, padB=26;
      const x0=padL, x1=W-padR;
      const y0=padT, y1=H-padB;

      const toX = (i)=> x0 + (x1-x0)*(i/(vis.length-1 || 1));
      const toY = (v)=> y1 - (y1-y0)*((v - yMin)/(yMax-yMin));

      // draw zones (bands)
      if(zones){
        // good band
        ctx.fillStyle="rgba(45,212,191,.08)";
        const gy0 = toY(zones.good[1]);
        const gy1 = toY(zones.good[0]);
        roundRect(ctx, x0, gy0, x1-x0, (gy1-gy0), 14, true, false);

        // warn band (if present)
        if(zones.warn){
          ctx.fillStyle="rgba(251,191,36,.08)";
          const wy0 = toY(zones.warn[1]);
          const wy1 = toY(zones.warn[0]);
          roundRect(ctx, x0, wy0, x1-x0, (wy1-wy0), 14, true, false);
        }

        // bad band
        ctx.fillStyle="rgba(251,113,133,.07)";
        const by0 = toY(zones.bad[1]);
        const by1 = toY(zones.bad[0]);
        roundRect(ctx, x0, by0, x1-x0, (by1-by0), 14, true, false);

        // low bad (if present)
        if(zones.lowBad){
          ctx.fillStyle="rgba(251,113,133,.06)";
          const ly0 = toY(zones.lowBad[1]);
          const ly1 = toY(zones.lowBad[0]);
          roundRect(ctx, x0, ly0, x1-x0, (ly1-ly0), 14, true, false);
        }

        // zone labels
        ctx.fillStyle="rgba(233,240,255,.85)";
        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        ctx.textAlign="left";
        ctx.fillText(`Faixa: ${zones.labels?.good || "Saud√°vel"}`, 16, 18);
      }

      // line/area
      const style = state.chartStyle;

      // glow
      const lineColor = "rgba(96,165,250,.92)";
      const glowColor = "rgba(96,165,250,.14)";

      if(style==="area"){
        // area fill under curve
        ctx.beginPath();
        vis.forEach((p,i)=>{
          const x=toX(i), y=toY(p.v);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.lineTo(toX(vis.length-1), y1);
        ctx.lineTo(toX(0), y1);
        ctx.closePath();
        const grad = ctx.createLinearGradient(0,y0,0,y1);
        grad.addColorStop(0, "rgba(96,165,250,.22)");
        grad.addColorStop(1, "rgba(96,165,250,.02)");
        ctx.fillStyle=grad;
        ctx.fill();
      }

      if(style==="bars"){
        // bars centered
        const slot=(x1-x0)/(vis.length||1);
        const bw=Math.max(6, Math.min(18, slot*0.65));
        ctx.strokeStyle="rgba(255,255,255,.14)";
        for(let i=0;i<vis.length;i++){
          const x=toX(i);
          const y=toY(vis[i].v);
          const h=y1-y;
          ctx.fillStyle="rgba(96,165,250,.55)";
          roundRect(ctx, x-bw/2, y, bw, h, 10, true, true);
        }
      }else if(style==="candles"){
        // mini candles: open=prev close=current; high/low = min/max between
        const slot=(x1-x0)/(vis.length||1);
        const cw=Math.max(6, Math.min(16, slot*0.55));
        for(let i=0;i<vis.length;i++){
          const prevV = (i===0) ? vis[i].v : vis[i-1].v;
          const curV = vis[i].v;
          const open=prevV, close=curV;
          const hi=Math.max(open, close);
          const lo=Math.min(open, close);

          const x=toX(i);
          const yOpen=toY(open), yClose=toY(close);
          const yHi=toY(hi), yLo=toY(lo);

          // wick
          ctx.strokeStyle="rgba(255,255,255,.16)";
          ctx.lineWidth=1;
          ctx.beginPath(); ctx.moveTo(x, yHi); ctx.lineTo(x, yLo); ctx.stroke();

          // body
          const up = close<=open; // for health metrics sometimes lower is better (not always). We'll keep neutral.
          ctx.fillStyle = up ? "rgba(45,212,191,.55)" : "rgba(251,191,36,.45)";
          ctx.strokeStyle="rgba(255,255,255,.14)";
          const yTop = Math.min(yOpen, yClose);
          const h = Math.max(3, Math.abs(yClose - yOpen));
          roundRect(ctx, x-cw/2, yTop, cw, h, 8, true, true);
        }
      }else{
        // line
        ctx.lineWidth=6;
        ctx.strokeStyle=glowColor;
        ctx.beginPath();
        vis.forEach((p,i)=>{
          const x=toX(i), y=toY(p.v);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();

        ctx.lineWidth=2.5;
        ctx.strokeStyle=lineColor;
        ctx.beginPath();
        vis.forEach((p,i)=>{
          const x=toX(i), y=toY(p.v);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();

        // points
        ctx.fillStyle="rgba(255,255,255,.92)";
        vis.forEach((p,i)=>{
          const x=toX(i), y=toY(p.v);
          ctx.beginPath(); ctx.arc(x,y,2.6,0,Math.PI*2); ctx.fill();
        });
      }

      // hover line + tooltip
      if(state.ui.hoverX!=null){
        const hx = clamp(state.ui.hoverX, x0, x1);
        // nearest
        const i = Math.round((hx - x0)/(x1-x0) * (vis.length-1));
        const p = vis[clamp(i,0,vis.length-1)];
        const px = toX(clamp(i,0,vis.length-1));
        const py = toY(p.v);

        ctx.strokeStyle="rgba(255,255,255,.18)";
        ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(px, y0); ctx.lineTo(px, y1); ctx.stroke();

        ctx.fillStyle="rgba(255,255,255,.92)";
        ctx.beginPath(); ctx.arc(px, py, 4, 0, Math.PI*2); ctx.fill();

        // tooltip bubble
        const label = `${p.date.toLocaleDateString("pt-BR")} ‚Ä¢ ${formatUnit(state.chartMetric, p.v)}`;
        const z = zones ? classifyValue(zones, p.v) : null;
        const tag = z ? ` ‚Ä¢ ${z.tag}` : "";

        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        const text = label + tag;
        const tw = ctx.measureText(text).width;
        const bx = clamp(px - tw/2 - 10, 12, W-12 - (tw+20));
        const by = clamp(py - 42, 18, H-70);

        ctx.fillStyle="rgba(0,0,0,.55)";
        ctx.strokeStyle="rgba(255,255,255,.14)";
        roundRect(ctx, bx, by, tw+20, 30, 12, true, true);

        ctx.fillStyle="rgba(233,240,255,.92)";
        ctx.textAlign="left";
        ctx.fillText(text, bx+10, by+20);
      }

      // x labels (few)
      ctx.fillStyle="rgba(154,166,195,.85)";
      ctx.font="11px "+getComputedStyle(document.body).fontFamily;
      ctx.textAlign="center";
      const marks = Math.min(5, vis.length);
      for(let i=0;i<marks;i++){
        const idx = Math.round(i*(vis.length-1)/(marks-1 || 1));
        const x=toX(idx);
        const dd=vis[idx].date;
        const s=`${String(dd.getDate()).padStart(2,"0")}/${String(dd.getMonth()+1).padStart(2,"0")}`;
        ctx.fillText(s, x, H-10);
      }

      // legend
      const last = vis[vis.length-1];
      const lastCls = zones ? classifyValue(zones, last.v) : {tag:"‚Äî"};
      const trend = (vis.length>=2) ? (last.v - vis[vis.length-2].v) : 0;
      setLegend("legendMain", [
        `M√©trica: ${$("chartMetric").selectedOptions[0].textContent}`,
        `Atual: ${formatUnit(state.chartMetric, last.v)} ‚Ä¢ ${lastCls.tag}`,
        `Trend: ${trend>=0?"+":"‚àí"} ${formatUnit(state.chartMetric, Math.abs(trend))}`
      ]);
    }

    function drawZonesChart(series, zones){
      const canvas = $("chartZones");
      const {ctx,W,H} = setupCanvas(canvas, 220);
      ctx.clearRect(0,0,W,H);
      drawGrid(ctx,W,H);

      if(!zones || series.length===0){
        ctx.fillStyle="rgba(154,166,195,.75)";
        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        ctx.fillText("Zonas indispon√≠veis para esta m√©trica.", 16, 34);
        setLegend("legendZones", ["Sem zonas"]);
        return;
      }

      let good=0,warn=0,bad=0,lowBad=0;
      series.forEach(p=>{
        const c = classifyValue(zones, p.v);
        if(c.tag===(zones.labels?.good || "Saud√°vel")) good++;
        else if(zones.labels?.warn && c.tag===zones.labels.warn) warn++;
        else if(zones.labels?.lowBad && c.tag===zones.labels.lowBad) lowBad++;
        else bad++;
      });

      const total = Math.max(1, series.length);
      const parts = [
        {name: zones.labels?.good || "Saud√°vel", v: good, col:"rgba(45,212,191,.85)"},
        ...(zones.labels?.warn ? [{name: zones.labels.warn, v: warn, col:"rgba(251,191,36,.85)"}] : []),
        ...(zones.labels?.lowBad ? [{name: zones.labels.lowBad, v: lowBad, col:"rgba(251,113,133,.55)"}] : []),
        {name: zones.labels?.bad || "Risco", v: bad, col:"rgba(251,113,133,.85)"}
      ].filter(x=>x.v>0);

      // donut
      const cx=W/2, cy=H/2;
      const r=Math.min(W,H)*0.34;
      const r2=r*0.65;
      ctx.lineWidth = r-r2;
      ctx.strokeStyle="rgba(255,255,255,.07)";
      ctx.beginPath();
      ctx.arc(cx,cy,(r+r2)/2,0,Math.PI*2);
      ctx.stroke();

      let a0 = -Math.PI/2;
      parts.forEach(p=>{
        const frac = p.v/total;
        const a1 = a0 + frac*Math.PI*2;
        ctx.strokeStyle = p.col;
        ctx.beginPath();
        ctx.arc(cx,cy,(r+r2)/2,a0,a1);
        ctx.stroke();
        a0=a1;
      });

      ctx.fillStyle="rgba(233,240,255,.95)";
      ctx.font="900 13px "+getComputedStyle(document.body).fontFamily;
      ctx.textAlign="center";
      ctx.fillText("Zonas", cx, cy-6);
      ctx.fillStyle="rgba(154,166,195,.9)";
      ctx.font="12px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText(`${series.length} dias`, cx, cy+14);

      // legend text
      setLegend("legendZones", parts.map(p=>`${p.name}: ${Math.round((p.v/total)*100)}%`));
    }

    function drawDistChart(series, zones){
      const canvas = $("chartDist");
      const {ctx,W,H} = setupCanvas(canvas, 220);
      ctx.clearRect(0,0,W,H);
      drawGrid(ctx,W,H);

      if(series.length===0){
        ctx.fillStyle="rgba(154,166,195,.75)";
        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        ctx.fillText("Sem dados para distribui√ß√£o.", 16, 34);
        setLegend("legendDist", ["Sem dados"]);
        return;
      }

      // histogram bins
      const vals = series.map(p=>p.v).slice().sort((a,b)=>a-b);
      const min=vals[0], max=vals[vals.length-1];
      const bins = Math.min(10, Math.max(5, Math.round(Math.sqrt(vals.length))));
      const step = (max-min)/bins || 1;

      const counts = new Array(bins).fill(0);
      vals.forEach(v=>{
        const idx = clamp(Math.floor((v-min)/step), 0, bins-1);
        counts[idx]++;
      });
      const maxC = Math.max(...counts, 1);

      const padL=16, padR=16, padT=22, padB=28;
      const x0=padL, x1=W-padR;
      const y0=padT, y1=H-padB;

      // zone overlay (recommended)
      if(zones){
        ctx.fillStyle="rgba(45,212,191,.08)";
        const zx0 = x0 + (x1-x0)*((zones.good[0]-min)/(max-min||1));
        const zx1 = x0 + (x1-x0)*((zones.good[1]-min)/(max-min||1));
        roundRect(ctx, Math.min(zx0,zx1), y0, Math.abs(zx1-zx0), y1-y0, 14, true, false);
      }

      // bars
      const slot=(x1-x0)/bins;
      for(let i=0;i<bins;i++){
        const x = x0 + i*slot + 3;
        const w = Math.max(8, slot-6);
        const h = (y1-y0)*(counts[i]/maxC);
        const y = y1 - h;

        ctx.fillStyle="rgba(96,165,250,.55)";
        ctx.strokeStyle="rgba(255,255,255,.14)";
        roundRect(ctx, x, y, w, h, 10, true, true);
      }

      // labels
      ctx.fillStyle="rgba(233,240,255,.92)";
      ctx.font="12px "+getComputedStyle(document.body).fontFamily;
      ctx.textAlign="left";
      ctx.fillText("Distribui√ß√£o (histograma)", 16, 18);

      const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
      ctx.textAlign="right";
      ctx.fillText(`M√©dia: ${formatUnit(state.chartMetric, avg)}`, W-16, 18);

      setLegend("legendDist", [
        `Min: ${formatUnit(state.chartMetric, min)}`,
        `Max: ${formatUnit(state.chartMetric, max)}`,
        `M√©dia: ${formatUnit(state.chartMetric, avg)}`
      ]);
    }

    function drawRadar(series){
      const canvas = $("chartRadar");
      const {ctx,W,H} = setupCanvas(canvas, 220);
      ctx.clearRect(0,0,W,H);

      if(series.length===0){
        ctx.fillStyle="rgba(154,166,195,.75)";
        ctx.font="12px "+getComputedStyle(document.body).fontFamily;
        ctx.fillText("Sem dados para radar.", 16, 34);
        setLegend("legendRadar", ["Sem dados"]);
        return;
      }

      // Use o √∫ltimo ponto para score de sa√∫de
      const last = series[series.length-1];
      const d = last.derived;

      // Scores 0..100 (heur√≠sticos)
      function scoreFromZones(metric, val){
        const z = getZones(d, metric, state.evalProfile);
        if(!z || val==null) return 55;
        const c = classifyValue(z, val);
        if(c.cls==="good") return 88;
        if(c.cls==="warn") return 62;
        return 35;
      }

      const sBMI = scoreFromZones("bmi", d.bmi);
      const sBF  = scoreFromZones("bfPct", d.bf);
      const sW   = scoreFromZones("waistCm", d.waist);
      const sWHR = scoreFromZones("whr", d.whr);

      // Consist√™ncia (√∫ltimos 14 dias)
      const now = last.ts;
      const last14 = series.filter(p=> (now - p.ts) <= 14*86400000);
      const sCons = clamp((last14.length/7)*100, 10, 100); // ~1 registro/dia -> 100; 7/14 -> 50

      const dims = [
        {name:"IMC", v:sBMI},
        {name:"BF%", v:sBF},
        {name:"Cintura", v:sW},
        {name:"WHR", v:sWHR},
        {name:"Consist.", v:sCons},
      ];

      const cx=W/2, cy=H/2;
      const r=Math.min(W,H)*0.33;

      // grid polygons
      ctx.strokeStyle="rgba(255,255,255,.10)";
      ctx.lineWidth=1;
      for(let g=1; g<=4; g++){
        const rr = r*(g/4);
        ctx.beginPath();
        dims.forEach((d,i)=>{
          const ang = -Math.PI/2 + i*(2*Math.PI/dims.length);
          const x = cx + rr*Math.cos(ang);
          const y = cy + rr*Math.sin(ang);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.closePath();
        ctx.stroke();
      }

      // axes + labels
      ctx.fillStyle="rgba(154,166,195,.9)";
      ctx.font="11px "+getComputedStyle(document.body).fontFamily;
      ctx.textAlign="center";
      dims.forEach((d,i)=>{
        const ang = -Math.PI/2 + i*(2*Math.PI/dims.length);
        const x = cx + (r+14)*Math.cos(ang);
        const y = cy + (r+14)*Math.sin(ang);
        ctx.strokeStyle="rgba(255,255,255,.08)";
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.lineTo(cx + r*Math.cos(ang), cy + r*Math.sin(ang));
        ctx.stroke();

        ctx.fillText(d.name, x, y+4);
      });

      // data polygon
      ctx.beginPath();
      dims.forEach((d,i)=>{
        const ang = -Math.PI/2 + i*(2*Math.PI/dims.length);
        const rr = r*(d.v/100);
        const x = cx + rr*Math.cos(ang);
        const y = cy + rr*Math.sin(ang);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.closePath();
      ctx.fillStyle="rgba(96,165,250,.18)";
      ctx.fill();
      ctx.strokeStyle="rgba(96,165,250,.92)";
      ctx.lineWidth=2.2;
      ctx.stroke();

      // score global
      const score = Math.round(dims.reduce((s,x)=>s+x.v,0)/dims.length);
      ctx.fillStyle="rgba(233,240,255,.95)";
      ctx.font="900 14px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText(`Score ${score}`, cx, cy+5);

      setLegend("legendRadar", [
        `Score: ${score}/100`,
        `Consist√™ncia (14d): ${last14.length} regs`,
      ]);
    }

    function attachChartInteractions(){
      const canvas = $("chartMain");
      let isDown=false;
      let downX=0;
      let downTs=null;

      function canvasXToTs(x, series){
        const rect = canvas.getBoundingClientRect();
        const W = rect.width;
        const padL=12, padR=12;
        const x0=padL, x1=W-padR;
        const {a,b} = getVisibleRange(series);
        const vis = series.slice(a,b+1);
        if(vis.length===0) return null;
        const t = clamp((x - x0)/(x1-x0), 0, 1);
        const idx = Math.round(t*(vis.length-1));
        return vis[clamp(idx,0,vis.length-1)].ts;
      }

      canvas.addEventListener("mousemove",(e)=>{
        const rect = canvas.getBoundingClientRect();
        state.ui.hoverX = e.clientX - rect.left;
        renderCharts(); // s√≥ redesenha charts
      });

      canvas.addEventListener("mouseleave",()=>{
        state.ui.hoverX = null;
        renderCharts();
      });

      // drag zoom
      canvas.addEventListener("mousedown",(e)=>{
        isDown=true;
        downX=e.clientX;
        const series = buildSeries(applyFilters(state.logs));
        downTs = canvasXToTs(e.clientX - canvas.getBoundingClientRect().left, series);
      });
      window.addEventListener("mouseup",(e)=>{
        if(!isDown) return;
        isDown=false;

        const upX=e.clientX;
        if(Math.abs(upX-downX)<12) return;

        const series = buildSeries(applyFilters(state.logs));
        const upTs = canvasXToTs(e.clientX - canvas.getBoundingClientRect().left, series);
        if(downTs==null || upTs==null) return;

        const min=Math.min(downTs, upTs);
        const max=Math.max(downTs, upTs);
        state.ui.zoom.min=min;
        state.ui.zoom.max=max;
        toast("Zoom aplicado (arraste). Duplo clique para resetar.");
        renderCharts();
      });

      canvas.addEventListener("dblclick",()=>{
        state.ui.zoom.min=null;
        state.ui.zoom.max=null;
        toast("Zoom resetado.");
        renderCharts();
      });
    }

    /************************************************************
     * Render Lists
     ************************************************************/
    function renderLogsList(targetId, list){
      const el = $(targetId);
      el.innerHTML = "";
      if(list.length===0){
        const d=document.createElement("div");
        d.className="hint";
        d.innerHTML="Sem registros neste per√≠odo. Clique em <b>Ôºã Registro</b> para come√ßar.";
        el.appendChild(d);
        return;
      }

      list.slice(0, 320).forEach(l=>{
        const d = computeDerived(l);
        const z = getZones(d, state.chartMetric, state.evalProfile);
        const cur = getMetricValue(d, state.chartMetric);
        const cl = classifyValue(z, cur);

        const dt=new Date(l.ts).toLocaleString("pt-BR");

        const row=document.createElement("div");
        row.className="row";
        row.onclick=()=>openLogModal(l);

        const main=document.createElement("div");
        main.className="main";
        main.innerHTML = `
          <div class="name">Registro ‚Ä¢ ${dt}</div>
          <div class="meta">
            <span class="badge">Peso: ${String(round1(d.wKg)).replace(".",",")} kg</span>
            ${d.bmi!=null?`<span class="badge">IMC: ${String(round1(d.bmi)).replace(".",",")}</span>`:""}
            ${d.bf!=null?`<span class="badge">BF: ${String(round1(d.bf)).replace(".",",")} %</span>`:""}
            ${d.waist!=null?`<span class="badge">Cintura: ${Math.round(d.waist)} cm</span>`:""}
            ${l.note?`<span class="badge">üìù ${safeText(l.note).slice(0,22)}${l.note.length>22?"‚Ä¶":""}</span>`:""}
          </div>
        `;

        const m1=document.createElement("div");
        m1.className="hint";
        m1.textContent = d.tdee!=null ? `TDEE ~ ${Math.round(d.tdee)} kcal ‚Ä¢ BMR ${Math.round(d.bmr)} kcal` : "Complete altura/idade para BMR/TDEE.";

        const m2=document.createElement("div");
        m2.className="hint";
        m2.textContent = d.ffmi!=null ? `Massa magra: ${round1(d.lbmKg)} kg ‚Ä¢ FFMI: ${round1(d.ffmi)}` : "Complete BF% para massa magra/FFMI.";

        const amount=document.createElement("div");
        amount.className="amount "+(cl.cls||"");
        amount.innerHTML = `${formatUnit(state.chartMetric, cur)}<br><span class="hint">${cl.tag}</span>`;

        const actions=document.createElement("div");
        actions.className="right";
        actions.innerHTML = `
          <button class="btn ghost" data-act="del">üóëÔ∏è</button>
        `;
        actions.querySelector('[data-act="del"]').onclick=(e)=>{e.stopPropagation(); deleteLog(l);};

        if(window.matchMedia("(min-width:821px)").matches){
          row.appendChild(main);
          row.appendChild(m1);
          row.appendChild(m2);
          row.appendChild(amount);
          row.appendChild(actions);
        }else{
          row.appendChild(amount);
          row.appendChild(m1);
          row.appendChild(actions);
        }

        el.appendChild(row);
      });
    }

    function renderGoals(){
      const list = (state.goals||[]).slice().sort((a,b)=> (a.due||"").localeCompare(b.due||""));
      const last = state.logs.slice().sort((a,b)=>b.ts-a.ts)[0] || null;
      const dLast = last ? computeDerived(last) : null;

      $("goalsSummary").innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
          <div>
            <b>Metas:</b> ${list.length}<br>
            <span class="hint">Base: ${dLast ? new Date(last.ts).toLocaleString("pt-BR") : "sem registros"}</span>
          </div>
          <div class="kbd">üéØ</div>
        </div>
      `;

      const el = $("goalsList");
      el.innerHTML = "";
      if(list.length===0){
        const d=document.createElement("div");
        d.className="hint";
        d.innerHTML="Sem metas ainda. Clique em <b>Ôºã Meta</b> para criar.";
        el.appendChild(d);
        return;
      }

      list.forEach(g=>{
        const card=document.createElement("div");
        card.className="noteBox";
        card.style.cursor="pointer";
        card.onclick=()=>openGoalModal(g);

        const due = g.due ? new Date(g.due+"T00:00:00").toLocaleDateString("pt-BR") : "Sem prazo";
        let lines = [];

        if(dLast){
          if(g.weightKg!=null){
            const diff = dLast.wKg - g.weightKg;
            lines.push(`Peso: atual ${round1(dLast.wKg)}kg ‚Ä¢ alvo ${round1(g.weightKg)}kg ‚Ä¢ falta ${String(round1(diff)).replace(".",",")}kg`);
          }
          if(g.bfPct!=null && dLast.bf!=null){
            const diff = dLast.bf - g.bfPct;
            lines.push(`BF%: atual ${round1(dLast.bf)}% ‚Ä¢ alvo ${round1(g.bfPct)}% ‚Ä¢ falta ${String(round1(diff)).replace(".",",")} p.p.`);
          }
          if(g.waistCm!=null && dLast.waist!=null){
            const diff = dLast.waist - g.waistCm;
            lines.push(`Cintura: atual ${Math.round(dLast.waist)}cm ‚Ä¢ alvo ${Math.round(g.waistCm)}cm ‚Ä¢ falta ${Math.round(diff)}cm`);
          }
        }else{
          lines.push("Crie registros para calcular progresso.");
        }

        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <div>
              <b>${safeText(g.name)}</b><br>
              <span class="hint">Prazo: ${due}${g.note?` ‚Ä¢ ${safeText(g.note)}`:""}</span>
            </div>
            <div class="kbd">‚úé</div>
          </div>
          <div class="divider"></div>
          <div class="hint">${lines.map(x=>`‚Ä¢ ${safeText(x)}`).join("<br>")}</div>
        `;
        el.appendChild(card);
      });
    }

    /************************************************************
     * Modal previews
     ************************************************************/
    function updateLogPreview(){
      try{
        const data = {
          ts: Date.now(),
          weightKg: toNumber($("logWeight").value),
          heightCm: $("logHeight").value.trim()? toNumber($("logHeight").value): null,
          age: $("logAge").value.trim()? parseInt($("logAge").value,10): null,
          bfPct: $("logBf").value.trim()? toNumber($("logBf").value): null,
          waistCm: $("logWaist").value.trim()? toNumber($("logWaist").value): null,
          hipCm: $("logHip").value.trim()? toNumber($("logHip").value): null
        };
        if(!data.weightKg || data.weightKg<=0){
          $("logPreview").textContent = "Preencha o peso para ver a avalia√ß√£o.";
          return;
        }
        const d = computeDerived(data);

        const zBMI = getZones(d,"bmi",state.evalProfile);
        const zBF  = getZones(d,"bfPct",state.evalProfile);
        const zW   = getZones(d,"waistCm",state.evalProfile);
        const zFFMI = getZones(d,"ffmi",state.evalProfile);

        const bmiC = classifyValue(zBMI, d.bmi);
        const bfC  = classifyValue(zBF, d.bf);
        const wC   = classifyValue(zW, d.waist);
        const ffmiC= classifyValue(zFFMI, d.ffmi);

        $("logPreview").innerHTML = `
          <b>Pr√©via (auto):</b><br>
          ‚Ä¢ IMC: <b class="${bmiC.cls}">${d.bmi!=null?String(round1(d.bmi)).replace(".",","):"‚Äî"}</b> (${bmiC.tag})<br>
          ‚Ä¢ BF%: <b class="${bfC.cls}">${d.bf!=null?String(round1(d.bf)).replace(".",","):"‚Äî"}</b> (${d.bf!=null?bfC.tag:"‚Äî"})<br>
          ‚Ä¢ Massa magra: <b>${d.lbmKg!=null?String(round1(d.lbmKg)).replace(".",","):"‚Äî"}</b> kg<br>
          ‚Ä¢ FFMI: <b class="${ffmiC.cls}">${d.ffmi!=null?String(round1(d.ffmi)).replace(".",","):"‚Äî"}</b> (${d.ffmi!=null?ffmiC.tag:"‚Äî"})<br>
          ‚Ä¢ BMR: <b>${d.bmr!=null?Math.round(d.bmr):"‚Äî"}</b> kcal ‚Ä¢ TDEE: <b>${d.tdee!=null?Math.round(d.tdee):"‚Äî"}</b> kcal<br>
          ‚Ä¢ Cintura: <b class="${wC.cls}">${d.waist!=null?Math.round(d.waist):"‚Äî"}</b> cm (${d.waist!=null?wC.tag:"‚Äî"})
        `;
      }catch{
        $("logPreview").textContent="Preencha os campos para ver a avalia√ß√£o.";
      }
    }

    /************************************************************
     * Charts render pipeline
     ************************************************************/
    function renderCharts(){
      const filtered = applyFilters(state.logs);
      const series = buildSeries(filtered);

      // zones for current metric based on last available derived (or defaults)
      const base = series.length ? series[series.length-1].derived : computeDerived({
        weightKg: 80,
        heightCm: state.settings.defaultHeightCm,
        age: state.settings.defaultAge,
        bfPct: 18,
        waistCm: 90,
        hipCm: 100
      });

      const zones = getZones(base, state.chartMetric, state.evalProfile);

      drawMainChart(series, zones);
      drawRadar(series);
      drawZonesChart(series, zones);
      drawDistChart(series, zones);
    }

    /************************************************************
     * Render all
     ************************************************************/
    function renderAll(){
      clampRange();
      const filtered = applyFilters(state.logs);

      renderKPIs(filtered);
      renderCharts();

      renderLogsList("logsList", filtered);
      renderLogsList("logsListAll", filtered);
      renderGoals();
      renderCriteriaPreview();
    }

    /************************************************************
     * Tabs
     ************************************************************/
    function setTab(tab){
      document.querySelectorAll(".tab").forEach(t=>{
        t.classList.toggle("active", t.dataset.tab===tab);
      });

      const titles = {
        dash: ["Dashboard","Evolu√ß√£o + gr√°ficos + zonas saud√°veis/n√£o saud√°veis"],
        logs: ["Registros","Lista completa (com busca e a√ß√µes r√°pidas)"],
        goals: ["Metas","Peso/BF%/Cintura com progresso real"],
        settings: ["Ajustes","Perfil, unidades e crit√©rios de avalia√ß√£o"]
      };
      $("pageTitle").textContent = titles[tab][0];
      $("pageSub").textContent = titles[tab][1];

      $("viewDash").style.display = tab==="dash" ? "block" : "none";
      $("viewLogs").style.display = tab==="logs" ? "block" : "none";
      $("viewGoals").style.display = tab==="goals" ? "block" : "none";
      $("viewSettings").style.display = tab==="settings" ? "block" : "none";

      // ao trocar aba, limpa hover pra evitar flicker
      state.ui.hoverX = null;

      renderAll();
    }

    /************************************************************
     * Demo data
     ************************************************************/
    async function seedDemo(){
      const ok = confirm("Criar dados de exemplo (12 registros + 2 metas)?");
      if(!ok) return;

      // metas
      const g1 = db.ref(PATH.goals).push(); const id1=g1.key;
      await g1.set({ id:id1, name:"Cutting 12 semanas", due:"", weightKg:78, bfPct:15, waistCm:85, note:"d√©ficit leve + for√ßa", createdAt:Date.now(), updatedAt:Date.now() });

      const g2 = db.ref(PATH.goals).push(); const id2=g2.key;
      await g2.set({ id:id2, name:"Performance", due:"", weightKg:null, bfPct:12, waistCm:null, note:"manter massa magra", createdAt:Date.now(), updatedAt:Date.now() });

      // logs
      const base = new Date();
      const updates = {};
      for(let i=0;i<12;i++){
        const dt = new Date(base.getTime() - (11-i)*3*86400000);
        const ref = db.ref(PATH.logs).push();
        const id = ref.key;

        const weight = 82 - i*0.25 + (i%3===0?0.2:0);
        const bf = 19 - i*0.18 + (i%4===0?0.2:0);
        const waist = 92 - i*0.35 + (i%5===0?0.2:0);

        updates[id] = {
          id,
          ts: dt.getTime(),
          weightKg: round2(weight),
          heightCm: state.settings.defaultHeightCm,
          age: state.settings.defaultAge,
          bfPct: round2(bf),
          muscleKg: 35 + i*0.05,
          waterPct: 55 + i*0.05,
          waistCm: round2(waist),
          hipCm: 100,
          note: i%2===0 ? "treino + cardio" : "descanso/sono ok",
          createdAt: Date.now(),
          updatedAt: Date.now()
        };
      }
      await db.ref(PATH.logs).update(updates);
      toast("Demo criada.");
    }

    /************************************************************
     * Wire UI
     ************************************************************/
    $("btnNew").addEventListener("click", ()=> openLogModal(null));
    $("btnCloseLog").addEventListener("click", ()=> closeModal("logModal"));
    $("btnSaveLog").addEventListener("click", saveLog);
    $("btnDeleteLog").addEventListener("click", async ()=>{
      const id=state.editingLogId;
      const l=state.logs.find(x=>x.id===id);
      if(l) await deleteLog(l);
      closeModal("logModal");
    });

    $("btnNewGoal").addEventListener("click", ()=> openGoalModal(null));
    $("btnCloseGoal").addEventListener("click", ()=> closeModal("goalModal"));
    $("btnSaveGoal").addEventListener("click", saveGoal);
    $("btnDeleteGoal").addEventListener("click", async ()=>{
      const g=state.goals.find(x=>x.id===state.editingGoalId);
      if(g) await deleteGoal(g);
    });

    $("btnSaveSettings").addEventListener("click", saveSettings);

    // live preview in modal
    ["logWeight","logHeight","logAge","logBf","logWaist","logHip"].forEach(id=>{
      $(id).addEventListener("input", updateLogPreview);
    });

    // period + range
    $("period").addEventListener("change", ()=>{
      state.period = $("period").value;
      $("customRange").style.display = (state.period==="custom") ? "block" : "none";
      // reset zoom ao mudar per√≠odo
      state.ui.zoom.min=null; state.ui.zoom.max=null;
      renderAll();
    });
    $("dateFrom").addEventListener("change", renderAll);
    $("dateTo").addEventListener("change", renderAll);

    // chart controls
    $("chartMetric").addEventListener("change", ()=>{
      state.chartMetric = $("chartMetric").value;
      state.ui.zoom.min=null; state.ui.zoom.max=null;
      renderAll();
    });
    $("chartStyle").addEventListener("change", ()=>{
      state.chartStyle = $("chartStyle").value;
      renderAll();
    });
    $("evalProfile").addEventListener("change", ()=>{
      state.evalProfile = $("evalProfile").value;
      renderCriteriaPreview();
      renderAll();
    });
    $("fSearch").addEventListener("input", ()=>{
      state.filters.search = $("fSearch").value;
      renderAll();
    });

    $("btnExport").addEventListener("click", exportAll);
    $("btnExport2").addEventListener("click", exportAll);

    $("btnImport").addEventListener("click", ()=> $("filePicker").click());
    $("btnImport2").addEventListener("click", ()=> $("filePicker").click());
    $("filePicker").addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        await importFile(file);
      }catch(err){
        alert(err.message || "Falha ao importar.");
      }finally{
        $("filePicker").value="";
      }
    });

    $("btnDemo").addEventListener("click", seedDemo);
    $("btnRefresh").addEventListener("click", ()=>{ renderAll(); toast("Atualizado."); });

    $("btnHome").addEventListener("click", ()=>{
      window.location.href = "https://wilsonf1996.github.io/index.html/";
    });

    // tabs
    function bindTabs(containerId){
      const el = $(containerId);
      el.addEventListener("click",(e)=>{
        const t = e.target.closest(".tab");
        if(!t) return;
        setTab(t.dataset.tab);
      });
    }
    bindTabs("tabsTop");
    bindTabs("tabsBottom");

    // keyboard
    document.addEventListener("keydown",(e)=>{
      const k=e.key.toLowerCase();
      if(k==="n" && !e.ctrlKey && !e.metaKey) openLogModal(null);
      if((e.ctrlKey||e.metaKey) && k==="e"){ e.preventDefault(); exportAll(); }
      if(k==="escape"){
        closeModal("logModal");
        closeModal("goalModal");
      }
    });

    window.addEventListener("resize", ()=> renderAll());

    /************************************************************
     * Boot
     ************************************************************/
    async function boot(){
      $("period").value = state.period;
      $("dateFrom").value = nowISODate();
      $("dateTo").value = nowISODate();

      state.filters = { search:"" };
      $("fSearch").value = "";

      state.chartMetric = $("chartMetric").value;
      state.chartStyle = $("chartStyle").value;
      state.evalProfile = $("evalProfile").value;

      await loadSettings();
      listenGoals();
      listenLogs();

      clampRange();
      renderAll();
      attachChartInteractions();
      toast("Pronto. Avalia√ß√£o f√≠sica Apple-level (gr√°ficos + zonas).");
    }

    boot();
  </script>
</body>
</html>
