<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Pilar CA ‚Äì NBR 6118 (Biaxial N‚ÄìMx‚ÄìMy)</title>
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; }
    html, body { margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #020617 0%, #020617 45%, #000 100%);
      color: #e5e7eb;
      font-size: 14px;
      line-height: 1.5;
    }
    .container {
      max-width: 1380px;
      margin: 20px auto 40px;
      padding: 22px 22px 26px;
      background: rgba(15, 23, 42, 0.97);
      border-radius: 20px;
      border: 1px solid #1f2937;
      box-shadow: 0 24px 70px rgba(0,0,0,0.9);
    }
    h1, h2, h3, h4 {
      margin-top: 0;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    h1 {
      text-align: center;
      font-size: 26px;
      margin-bottom: 4px;
    }
    .subtitle {
      text-align: center;
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 6px;
    }
    .credit {
      text-align: center;
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 12px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148,163,184,0.5);
      background: radial-gradient(circle at top left,#0f172a,#020617);
      color:#e5e7eb;
    }
    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,0.6);
    }
    .project-bar {
      display:grid;
      grid-template-columns:1.4fr 1.2fr 1.1fr 0.9fr;
      gap:10px;
      margin-bottom:14px;
      align-items:center;
      border-radius:16px;
      padding:10px 14px;
      background:radial-gradient(circle at top left,#020617,#020617 50%,#020617 100%);
      border:1px solid #111827;
    }
    .project-field label {
      display:block;
      font-size:11px;
      margin-bottom:2px;
      color:#e5e7eb;
    }
    .project-field input {
      width:100%;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid #374151;
      background:#020617;
      color:#e5e7eb;
      font-size:12px;
    }
    .project-field input:focus {
      outline:none;
      border-color:#22c55e;
      box-shadow:0 0 0 1px #22c55e55;
      background:#02081b;
    }
    .layout-grid {
      display:grid;
      grid-template-columns:1.1fr 1.1fr 1.2fr;
      gap:16px;
      align-items:flex-start;
    }
    .card {
      background:radial-gradient(circle at top left,#020617,#020617 40%,#020617 100%);
      border-radius:16px;
      padding:12px 14px 14px;
      border:1px solid #111827;
      position:relative;
      overflow:hidden;
    }
    .card::before {
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(34,197,94,0.05),transparent 40%,transparent 60%,rgba(59,130,246,0.04));
      pointer-events:none;
    }
    .card-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
      position:relative;
      z-index:1;
    }
    .card-header h2 {
      font-size:15px;
      margin:0;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .card-header h2 span.icon { font-size:14px; opacity:0.9; }
    .card-subtitle {
      font-size:11px;
      color:#9ca3af;
      margin-bottom:8px;
      position:relative;
      z-index:1;
    }
    .chip {
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      border:1px solid #374151;
      color:#9ca3af;
      background:rgba(15,23,42,0.9);
    }
    label {
      display:block;
      font-size:11px;
      margin-bottom:3px;
      color:#e5e7eb;
    }
    input[type="number"], select {
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #374151;
      background:#020617;
      color:#e5e7eb;
      font-size:12px;
      transition:border-color 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }
    input[type="number"]:focus, select:focus {
      outline:none;
      border-color:#22c55e;
      box-shadow:0 0 0 1px #22c55e55;
      background:#02081b;
    }
    .field { margin-bottom:8px; position:relative; z-index:1; }
    .units { font-size:10px; color:#9ca3af; }
    .field-group-title {
      margin:8px 0 4px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:#9ca3af;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .field-group-title::before {
      content:"";
      width:10px;
      height:2px;
      border-radius:999px;
      background:linear-gradient(90deg,#22c55e,transparent);
    }
    .two-cols {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .four-cols {
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:6px;
    }
    .btn-row {
      display:flex;
      gap:10px;
      margin-top:8px;
      margin-bottom:6px;
      justify-content:center;
      flex-wrap:wrap;
    }
    button {
      border-radius:999px;
      border:none;
      padding:8px 16px;
      font-size:13px;
      cursor:pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:transform 0.1s ease, box-shadow 0.1s ease, background 0.15s ease, border-color 0.1s ease;
    }
    button.primary {
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#022c22;
      box-shadow:0 10px 26px rgba(34,197,94,0.4);
    }
    button.secondary {
      background:#020617;
      color:#e5e7eb;
      border:1px solid #374151;
    }
    button.tertiary {
      background:#020617;
      color:#e5e7eb;
      border:1px dashed #4b5563;
      font-size:12px;
      padding-inline:12px;
    }
    button span.icon { font-size:14px; }
    button:hover {
      transform:translateY(-1px);
      box-shadow:0 15px 32px rgba(0,0,0,0.6);
    }
    button:active {
      transform:translateY(0);
      box-shadow:none;
    }
    .results {
      margin-top:4px;
      border-radius:14px;
      background:#020617;
      border:1px solid #111827;
      padding:12px 14px 14px;
      font-size:13px;
      line-height:1.6;
      max-height:620px;
      overflow-y:auto;
      position:relative;
    }
    .results h3 {
      margin-top:0;
      font-size:15px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .results h3::before {
      content:"";
      width:5px;
      height:18px;
      border-radius:999px;
      background:linear-gradient(180deg,#22c55e,#0ea5e9);
    }
    .tag {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      margin-left:4px;
    }
    .tag-ok {
      background:rgba(22,163,74,0.12);
      color:#4ade80;
      border:1px solid rgba(22,163,74,0.7);
    }
    .tag-warn {
      background:rgba(234,179,8,0.12);
      color:#facc15;
      border:1px solid rgba(234,179,8,0.7);
    }
    .tag-err {
      background:rgba(239,68,68,0.12);
      color:#f87171;
      border:1px solid rgba(239,68,68,0.7);
    }
    .note {
      font-size:11px;
      color:#9ca3af;
      margin-top:6px;
    }
    .section-title {
      margin-top:10px;
      margin-bottom:4px;
      font-weight:700;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .section-title::before {
      content:"";
      width:8px;
      height:8px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,0.6);
    }
    ul { margin:4px 0 6px 18px; padding:0; }
    ul li { margin-bottom:2px; }
    .results hr {
      border:none;
      border-top:1px dashed #1f2937;
      margin:10px 0;
    }
    .footer-credit {
      margin-top:18px;
      text-align:right;
      font-size:11px;
      color:#6b7280;
    }
    ::-webkit-scrollbar { width:7px; }
    ::-webkit-scrollbar-track { background:#020617; border-radius:999px; }
    ::-webkit-scrollbar-thumb { background:#111827; border-radius:999px; }
    ::-webkit-scrollbar-thumb:hover { background:#1f2937; }
    @media (max-width:1100px){
      .layout-grid { grid-template-columns:1fr 1fr; grid-template-rows:auto auto; }
      .layout-grid > .card:nth-child(3) { grid-column:1/-1; }
      .project-bar { grid-template-columns:1.4fr 1.2fr; }
    }
    @media (max-width:800px){
      .layout-grid { grid-template-columns:1fr; }
      .project-bar { grid-template-columns:1fr; border-radius:14px; }
    }
    @media print{
      *{ box-shadow:none !important; }
      body{ background:#fff; color:#000; font-size:10pt; line-height:1.4; }
      .container{ box-shadow:none; border-radius:0; border:none; background:#fff; padding:10mm 8mm; }
      .project-bar{ background:#fff; border-color:#000; }
      .card{ border-color:#000; background:#fff; }
      .results{ max-height:none; border-color:#000; }
      h1,h2,h3,h4{ color:#000; }
      .subtitle,.credit{ color:#000; }
      .badge,.btn-row,.chip{ display:none !important; }
      .section-title::before,.results h3::before{ background:#000; box-shadow:none; }
      .tag-ok,.tag-warn,.tag-err{ border-color:#000; color:#000; background:#fff; }
      input,select{ border:1px solid #000; background:#fff; color:#000; }
      .footer-credit{ color:#000; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Pilar de Concreto Armado ‚Äì NBR 6118</h1>
  <div class="subtitle">
    N‚ÄìMx‚ÄìMy (biaxial), compress√£o / flexo-compress√£o / tra√ß√£o / flexo-tra√ß√£o, flambagem, 2¬™ ordem e ELS.<br>
    Se√ß√£o retangular ou circular, armadura assim√©trica nas 4 faces, em um √∫nico arquivo.
  </div>
  <div class="credit">
    Conceito e especifica√ß√£o de c√°lculo: <b>Wilson Fernandes Junior</b>.
  </div>

  <div style="display:flex;justify-content:center;margin-bottom:10px;">
    <div class="badge">
      <span class="badge-dot"></span>
      N√∫cleo N‚ÄìMx‚ÄìMy com faces independentes e intera√ß√£o biaxial (expoente Œ±)
    </div>
  </div>

  <!-- IDENTIFICA√á√ÉO -->
  <div class="project-bar">
    <div class="project-field">
      <label>Nome da obra</label>
      <input type="text" id="obra" placeholder="Ex.: Edif√≠cio / Galp√£o / Infraestrutura">
    </div>
    <div class="project-field">
      <label>Projeto</label>
      <input type="text" id="projeto" placeholder="Ex.: Estruturas ‚Äì Bloco A">
    </div>
    <div class="project-field">
      <label>Pilar</label>
      <input type="text" id="pilar" placeholder="Ex.: P1-E1">
    </div>
    <div class="project-field">
      <label>Eng. respons√°vel / CREA</label>
      <input type="text" id="engenheiro" placeholder="Ex.: Eng. Fulano ‚Äì CREA 000000-0">
    </div>
  </div>

  <div class="layout-grid">
    <!-- COLUNA 1 ‚Äì Materiais & se√ß√£o -->
    <div class="card">
      <div class="card-header">
        <h2><span class="icon">üß±</span> Materiais & Se√ß√£o</h2>
        <span class="chip">Concreto, a√ßo, geometria</span>
      </div>
      <div class="card-subtitle">
        Defina materiais, tipo de se√ß√£o (retangular ou circular), dimens√µes, cobrimento e comprimentos equivalentes.
      </div>

      <div class="field-group-title">Materiais</div>
      <div class="two-cols">
        <div class="field">
          <label>fck (MPa)</label>
          <input type="number" id="fck" value="30" step="1">
        </div>
        <div class="field">
          <label>fyk long. (MPa)</label>
          <input type="number" id="fyk" value="500" step="10">
        </div>
        <div class="field">
          <label>Œ≥c</label>
          <input type="number" id="gamma_c" value="1.4" step="0.05">
        </div>
        <div class="field">
          <label>Œ≥s</label>
          <input type="number" id="gamma_s" value="1.15" step="0.05">
        </div>
        <div class="field">
          <label>Es (MPa)</label>
          <input type="number" id="Es" value="210000" step="1000">
        </div>
        <div class="field">
          <label>œÜ (flu√™ncia)</label>
          <input type="number" id="phi_creep" value="2.0" step="0.1">
          <span class="units">Para Ec,eff e Ncr.</span>
        </div>
      </div>

      <div class="field-group-title">Tipo de se√ß√£o</div>
      <div class="field">
        <label>Se√ß√£o</label>
        <select id="tipoSecao" onchange="atualizarSecao()">
          <option value="ret">Retangular / quadrada</option>
          <option value="cir">Circular / redonda</option>
        </select>
      </div>

      <div id="secRet">
        <div class="two-cols">
          <div class="field">
            <label>b (cm) ‚Äì dimens√£o na dire√ß√£o x</label>
            <input type="number" id="b" value="25" step="0.5">
          </div>
          <div class="field">
            <label>h (cm) ‚Äì dimens√£o na dire√ß√£o y</label>
            <input type="number" id="h" value="40" step="0.5">
          </div>
        </div>
      </div>

      <div id="secCir" style="display:none;">
        <div class="field">
          <label>D (cm) ‚Äì di√¢metro</label>
          <input type="number" id="D" value="40" step="0.5">
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>Cobrimento c<sub>nom</sub> (cm)</label>
          <input type="number" id="cob" value="3" step="0.5">
        </div>
        <div class="field">
          <label>œï base (mm) ‚Äì refer√™ncia</label>
          <input type="number" id="phi_long" value="16" step="2">
        </div>
      </div>

      <div class="field-group-title">Comprimentos equivalentes</div>
      <div class="two-cols">
        <div class="field">
          <label>‚Ñì<sub>0x</sub> (m) ‚Äì flex√£o em Mx</label>
          <input type="number" id="l0x" value="3.0" step="0.1">
        </div>
        <div class="field">
          <label>‚Ñì<sub>0y</sub> (m) ‚Äì flex√£o em My</label>
          <input type="number" id="l0y" value="3.0" step="0.1">
        </div>
      </div>
      <div class="note">
        ‚Ñì<sub>0</sub> ‚âà k¬∑l, conforme v√≠nculos (engastado, biapoiado, balan√ßo).  
        Ec,eff = Ec/(1+œÜ) √© usado em Ncr (Euler) e amplifica√ß√£o de 2¬™ ordem local.
      </div>
    </div>

    <!-- COLUNA 2 ‚Äì Esfor√ßos + combina√ß√µes + faces -->
    <div class="card">
      <div class="card-header">
        <h2><span class="icon">‚öôÔ∏è</span> Esfor√ßos, Combina√ß√µes & Faces</h2>
        <span class="chip">N‚ÄìMx‚ÄìMy + As por face</span>
      </div>
      <div class="card-subtitle">
        Defina origem dos esfor√ßos (direto ou Gk/Qk), modo dimensionar/verificar e armadura em cada face.
      </div>

      <div class="field-group-title">Origem dos esfor√ßos</div>
      <div class="two-cols">
        <div class="field">
          <label>Origem</label>
          <select id="origemEsforcos">
            <option value="direto">Direto (Nsd, Msdx, Msdy)</option>
            <option value="combos">A partir de Gk e Qk (combina√ß√µes NBR simplificadas)</option>
          </select>
        </div>
        <div class="field">
          <label>Tipo de an√°lise</label>
          <select id="tipoAnalise">
            <option value="biaxial">Biaxial (N‚ÄìMx‚ÄìMy)</option>
            <option value="uniaxial_x">Uniaxial em x (N‚ÄìMx)</option>
            <option value="uniaxial_y">Uniaxial em y (N‚ÄìMy)</option>
          </select>
        </div>
      </div>

      <div class="field-group-title">ULS ‚Äì Esfor√ßos de c√°lculo (entrada direta)</div>
      <div class="two-cols">
        <div class="field">
          <label>Nsd (kN) ‚Äì compress√£o (+), tra√ß√£o (‚àí)</label>
          <input type="number" id="Nsd" value="1000" step="10">
        </div>
        <div class="field">
          <label>Msd,x (kN¬∑m)</label>
          <input type="number" id="Msdx" value="60" step="1">
        </div>
      </div>
      <div class="field">
        <label>Msd,y (kN¬∑m)</label>
        <input type="number" id="Msdy" value="20" step="1">
      </div>

      <div class="field-group-title">ELS ‚Äì Esfor√ßos de servi√ßo (entrada direta)</div>
      <div class="two-cols">
        <div class="field">
          <label>Nser (kN)</label>
          <input type="number" id="Nser" value="700" step="10">
        </div>
        <div class="field">
          <label>Mser,x (kN¬∑m)</label>
          <input type="number" id="Mserx" value="40" step="1">
        </div>
      </div>
      <div class="field">
        <label>Mser,y (kN¬∑m)</label>
        <input type="number" id="Msery" value="15" step="1">
      </div>

      <div class="field-group-title">Combina√ß√µes NBR (Gk + Qk) ‚Äì opcional</div>
      <div class="two-cols">
        <div class="field">
          <label>N<sub>Gk</sub> (kN)</label>
          <input type="number" id="Ngk" step="1">
        </div>
        <div class="field">
          <label>N<sub>Qk</sub> (kN)</label>
          <input type="number" id="Nqk" step="1">
        </div>
      </div>
      <div class="two-cols">
        <div class="field">
          <label>Mx<sub>Gk</sub> (kN¬∑m)</label>
          <input type="number" id="Mxgk" step="1">
        </div>
        <div class="field">
          <label>Mx<sub>Qk</sub> (kN¬∑m)</label>
          <input type="number" id="Mxqk" step="1">
        </div>
      </div>
      <div class="two-cols">
        <div class="field">
          <label>My<sub>Gk</sub> (kN¬∑m)</label>
          <input type="number" id="Mygk" step="1">
        </div>
        <div class="field">
          <label>My<sub>Qk</sub> (kN¬∑m)</label>
          <input type="number" id="Myqk" step="1">
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>Œ≥<sub>G</sub> (ULS)</label>
          <input type="number" id="gammaG" value="1.4" step="0.05">
        </div>
        <div class="field">
          <label>Œ≥<sub>Q</sub> (ULS)</label>
          <input type="number" id="gammaQ" value="1.4" step="0.05">
        </div>
      </div>
      <div class="two-cols">
        <div class="field">
          <label>œà1 (ELS frequente)</label>
          <input type="number" id="psi1" value="0.7" step="0.05">
        </div>
        <div class="field">
          <label>œà2 (ELS quase permanente)</label>
          <input type="number" id="psi2" value="0.5" step="0.05">
        </div>
      </div>
      <div class="field">
        <label>Tipo de combina√ß√£o ELS</label>
        <select id="tipoELS">
          <option value="freq">Frequente (Gk + œà1¬∑Qk)</option>
          <option value="quasi">Quase permanente (Gk + œà2¬∑Qk)</option>
        </select>
      </div>

      <div class="field-group-title">Œ≥<sub>z</sub> global (NBR ‚Äì opcional)</div>
      <div class="two-cols">
        <div class="field">
          <label>M<sub>1,tot,d</sub> (kN¬∑m)</label>
          <input type="number" id="M1tot" step="1">
        </div>
        <div class="field">
          <label>ŒîM<sub>tot,d</sub> (kN¬∑m)</label>
          <input type="number" id="DeltaMtot" step="1">
          <span class="units">Œ≥z = 1/(1‚àíŒîM/M1) se informado.</span>
        </div>
      </div>

      <div class="field-group-title">Intera√ß√£o biaxial</div>
      <div class="two-cols">
        <div class="field">
          <label>Expoente Œ± da intera√ß√£o</label>
          <input type="number" id="alpha_int" value="1.5" step="0.1">
        </div>
        <div class="field">
          <label>Modo</label>
          <select id="modo">
            <option value="dimensionar">Dimensionar As (N‚ÄìMx‚ÄìMy)</option>
            <option value="verificar">Somente verificar As (N‚ÄìMx‚ÄìMy)</option>
          </select>
        </div>
      </div>

      <div class="field-group-title">Armadura por face (retangular)</div>
      <div id="AsRet">
        <div class="four-cols">
          <div class="field">
            <label>Topo (+y): n¬∫ barras</label>
            <input type="number" id="n_top" value="3" step="1">
            <span class="units">œï topo (mm)</span>
            <input type="number" id="phi_top" value="16" step="2">
          </div>
          <div class="field">
            <label>Base (‚àíy): n¬∫ barras</label>
            <input type="number" id="n_base" value="3" step="1">
            <span class="units">œï base (mm)</span>
            <input type="number" id="phi_base" value="16" step="2">
          </div>
          <div class="field">
            <label>Esquerda (‚àíx): n¬∫ barras</label>
            <input type="number" id="n_esq" value="2" step="1">
            <span class="units">œï esq. (mm)</span>
            <input type="number" id="phi_esq" value="12.5" step="2.5">
          </div>
          <div class="field">
            <label>Direita (+x): n¬∫ barras</label>
            <input type="number" id="n_dir" value="2" step="1">
            <span class="units">œï dir. (mm)</span>
            <input type="number" id="phi_dir" value="12.5" step="2.5">
          </div>
        </div>
        <div class="note">
          As em cada face = n ¬∑ œÄ¬∑œï¬≤/4. O app checa espa√ßamento m√≠nimo/m√°ximo das barras em cada face.
        </div>
      </div>

      <div id="AsCir" style="display:none;">
        <div class="two-cols">
          <div class="field">
            <label>As,total (mm¬≤) ‚Äì circular</label>
            <input type="number" id="As_circ" value="1600" step="10">
          </div>
          <div class="field">
            <label>N¬∫ de barras (circunfer√™ncia)</label>
            <input type="number" id="n_barras_circ" value="8" step="1">
          </div>
        </div>
        <div class="note">
          œï das barras circulares = œï base (campo ao lado da se√ß√£o). O app checa espa√ßamento na circunfer√™ncia.
        </div>
      </div>

      <div class="field-group-title">ELS ‚Äì Flecha lateral</div>
      <div class="two-cols">
        <div class="field">
          <label>V√≠nculo lateral aproximado</label>
          <select id="tipoVinculo">
            <option value="biapoiado">Biapoiado (simplesmente apoiado)</option>
            <option value="engastado_livre">Engastado-livre (balan√ßo)</option>
          </select>
        </div>
        <div class="field">
          <label>Limite de flecha (L/?)</label>
          <input type="number" id="Ldiv" value="250" step="10">
        </div>
      </div>
    </div>

    <!-- COLUNA 3 ‚Äì Resultados -->
    <div class="card">
      <div class="card-header">
        <h2><span class="icon">üìä</span> Resultados</h2>
        <span class="chip">ULS + ELS + Biaxial</span>
      </div>

      <div class="btn-row">
        <button class="primary" onclick="calcular()">
          <span class="icon">‚öôÔ∏è</span> Calcular pilar
        </button>
        <button class="secondary" onclick="limparResultados()">
          <span class="icon">üßπ</span> Limpar
        </button>
        <button class="tertiary" onclick="window.print()">
          <span class="icon">üßæ</span> Gerar PDF
        </button>
        <button class="tertiary" onclick="exportarTXT()">
          <span class="icon">üìÑ</span> Exportar TXT
        </button>
      </div>

      <div class="results" id="resultados">
        <h3>Resultados aparecer√£o aqui‚Ä¶</h3>
        <p class="note">
          Preencha materiais, geometria, esfor√ßos e armaduras, depois clique em <b>Calcular pilar</b>.<br>
          Use <b>Gerar PDF</b> para impress√£o e <b>Exportar TXT</b> para relat√≥rio num√©rico.
        </p>
      </div>
    </div>
  </div>

  <div class="footer-credit">
    Aplicativo de c√°lculo de pilares de concreto armado ‚Äì concep√ß√£o: <b>Wilson Fernandes Junior</b>.
  </div>
</div>

<script>
  let lastReportTxt = "";

  function fmt(n, dec = 2) {
    if (isNaN(n) || !isFinite(n)) return "-";
    return n.toLocaleString("pt-BR", {
      minimumFractionDigits: dec,
      maximumFractionDigits: dec
    });
  }

  function atualizarSecao(){
    const t = document.getElementById("tipoSecao").value;
    document.getElementById("secRet").style.display = t==="ret" ? "block" : "none";
    document.getElementById("secCir").style.display = t==="cir" ? "block" : "none";
    document.getElementById("AsRet").style.display = t==="ret" ? "block" : "none";
    document.getElementById("AsCir").style.display = t==="cir" ? "block" : "none";
  }

  function limparResultados(){
    document.getElementById("resultados").innerHTML = `
      <h3>Resultados aparecer√£o aqui‚Ä¶</h3>
      <p class="note">
        Preencha dados e clique em <b>Calcular pilar</b>.  
        Use <b>Exportar TXT</b> ap√≥s o c√°lculo para salvar o relat√≥rio num√©rico.
      </p>
    `;
    lastReportTxt = "";
  }

  function exportarTXT(){
    if (!lastReportTxt) {
      alert("Nenhum c√°lculo dispon√≠vel para exportar.");
      return;
    }
    const blob = new Blob([lastReportTxt], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "relatorio_pilar_CA_biaxial.txt";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function rhoMinFlexao(fck, fyk){
    // fctm ~ 0,3 fck^(2/3); œÅmin ‚âà 0,15¬∑fctm/fyk
    const fctm = 0.3*Math.pow(fck,2/3);
    return 0.15*fctm/fyk;
  }

  function calcNcr(Ec_eff, I_mm4, l0_mm){
    return Math.PI*Math.PI*Ec_eff*I_mm4/(l0_mm*l0_mm)/1000.0;
  }

  // Dimensionamento N-M uniaxial (compress√£o) ‚Äì bloco 0.68 fcd
  function dimensionarNM_compressao(Nsd_kN, Msd_kNm, b_eff_mm, d_mm, dLinha_mm, fcd, fyd, As_min_mm2, As_max_mm2){
    const Nsd_N = Nsd_kN*1000;
    const Msd_Nmm = Msd_kNm*1e6;
    const x_min = 0.05*d_mm;
    const x_max = 0.45*d_mm;
    let best = null;

    for(let i=0;i<=200;i++){
      const x = x_min + (x_max-x_min)*i/200;
      const Cc = 0.68*fcd*b_eff_mm*x;
      const yC = 0.4*x;
      const yS = dLinha_mm;
      const yT = d_mm;

      const denom = yT - yS;
      if (Math.abs(denom)<1e-9) continue;

      const Cs = (Msd_Nmm - Cc*(yC - yT) - Nsd_N*yT)/denom;
      const T  = Cc + Cs - Nsd_N;
      if (Cs<0 || T<=0) continue;

      const As_c = Cs/fyd;
      const As_t = T/fyd;
      const As_tot = As_c + As_t;
      if (As_t < As_min_mm2) continue;
      if (As_tot > As_max_mm2) continue;

      const N_int = Cc + Cs - T;
      const M_int = Cc*yC + Cs*yS - T*yT;
      const errN = Math.abs(N_int - Nsd_N)/Math.max(Math.abs(Nsd_N),1e-3);
      const errM = Math.abs(M_int - Msd_Nmm)/Math.max(Math.abs(Msd_Nmm),1e-3);
      const err  = Math.max(errN,errM);
      if (err>0.05) continue;

      if (!best || As_tot<best.As_tot) {
        best = {x, As_t, As_c, As_tot, N_int, M_int};
      }
    }
    return best;
  }

  // Verifica√ß√£o N-M uniaxial com As_t e As_c conhecidos
  function verificarNM_asym(Nsd_kN, Msd_kNm, As_t_mm2, As_c_mm2, b_eff_mm, d_mm, dLinha_mm, fcd, fyd){
    const Nsd_N = Nsd_kN*1000;
    const Msd_Nmm = Msd_kNm*1e6;
    const x_min = 0.05*d_mm;
    const x_max = 0.45*d_mm;
    let best = null;

    for(let i=0;i<=220;i++){
      const x = x_min + (x_max-x_min)*i/220;
      const Cc = 0.68*fcd*b_eff_mm*x;
      const yC = 0.4*x;
      const yS = dLinha_mm;
      const yT = d_mm;

      const T  = As_t_mm2*fyd;
      const Cs = As_c_mm2*fyd;

      const N_int = Cc + Cs - T;
      const M_int = Cc*yC + Cs*yS - T*yT;

      const errN = Math.abs(N_int - Nsd_N);
      const errM = Math.abs(M_int - Msd_Nmm);
      const err  = errN + errM;
      if (!best || err<best.err){
        best = {x, Cc, Cs, T, N_int, M_int, err};
      }
    }
    if (!best) return null;

    const Nrd_kN = best.N_int/1000;
    const Mrd_kNm = best.M_int/1e6;
    return {
      x: best.x,
      Nrd_kN,
      Mrd_kNm,
      FSN: Nsd_kN!==0 ? Nrd_kN/Nsd_kN : Infinity,
      FSM: Msd_kNm!==0 ? Mrd_kNm/Msd_kNm : Infinity,
      Cc: best.Cc,
      Cs: best.Cs,
      T: best.T
    };
  }

  function calcular(){
    const out = document.getElementById("resultados");
    try {
      const obra = (document.getElementById("obra").value||"").trim();
      const proj = (document.getElementById("projeto").value||"").trim();
      const pilarID = (document.getElementById("pilar").value||"").trim();
      const engenheiro = (document.getElementById("engenheiro").value||"").trim();

      const fck = parseFloat(document.getElementById("fck").value);
      const fyk = parseFloat(document.getElementById("fyk").value);
      const gamma_c = parseFloat(document.getElementById("gamma_c").value);
      const gamma_s = parseFloat(document.getElementById("gamma_s").value);
      const Es = parseFloat(document.getElementById("Es").value);
      const phi_creep = parseFloat(document.getElementById("phi_creep").value);

      const tipoSecao = document.getElementById("tipoSecao").value;
      const b_cm = parseFloat(document.getElementById("b").value || "0");
      const h_cm = parseFloat(document.getElementById("h").value || "0");
      const D_cm = parseFloat(document.getElementById("D").value || "0");
      const cob_cm = parseFloat(document.getElementById("cob").value);
      const phi_base_all = parseFloat(document.getElementById("phi_long").value);

      const l0x_m = parseFloat(document.getElementById("l0x").value);
      const l0y_m = parseFloat(document.getElementById("l0y").value);

      const origemEsforcos = document.getElementById("origemEsforcos").value;
      const tipoAnalise = document.getElementById("tipoAnalise").value;
      const modo = document.getElementById("modo").value;
      const alpha_int = parseFloat(document.getElementById("alpha_int").value || "1.5");

      // esfor√ßos diretos
      let Nsd_kN = parseFloat(document.getElementById("Nsd").value);
      let Msdx_kNm = parseFloat(document.getElementById("Msdx").value);
      let Msdy_kNm = parseFloat(document.getElementById("Msdy").value);
      let Nser_kN = parseFloat(document.getElementById("Nser").value || "0");
      let Mserx_kNm = parseFloat(document.getElementById("Mserx").value || "0");
      let Msery_kNm = parseFloat(document.getElementById("Msery").value || "0");

      // combina√ß√µes Gk/Qk
      const Ngk = parseFloat(document.getElementById("Ngk").value || "NaN");
      const Nqk = parseFloat(document.getElementById("Nqk").value || "NaN");
      const Mxgk = parseFloat(document.getElementById("Mxgk").value || "NaN");
      const Mxqk = parseFloat(document.getElementById("Mxqk").value || "NaN");
      const Mygk = parseFloat(document.getElementById("Mygk").value || "NaN");
      const Myqk = parseFloat(document.getElementById("Myqk").value || "NaN");
      const gammaG = parseFloat(document.getElementById("gammaG").value || "1.4");
      const gammaQ = parseFloat(document.getElementById("gammaQ").value || "1.4");
      const psi1 = parseFloat(document.getElementById("psi1").value || "0.7");
      const psi2 = parseFloat(document.getElementById("psi2").value || "0.5");
      const tipoELS = document.getElementById("tipoELS").value;

      const M1tot_kNm = parseFloat(document.getElementById("M1tot").value || "NaN");
      const DeltaMtot_kNm = parseFloat(document.getElementById("DeltaMtot").value || "NaN");

      // faces e barras
      const n_top = parseInt(document.getElementById("n_top").value || "0",10);
      const n_base = parseInt(document.getElementById("n_base").value || "0",10);
      const n_esq = parseInt(document.getElementById("n_esq").value || "0",10);
      const n_dir = parseInt(document.getElementById("n_dir").value || "0",10);
      const phi_top = parseFloat(document.getElementById("phi_top").value || phi_base_all);
      const phi_base = parseFloat(document.getElementById("phi_base").value || phi_base_all);
      const phi_esq = parseFloat(document.getElementById("phi_esq").value || phi_base_all);
      const phi_dir = parseFloat(document.getElementById("phi_dir").value || phi_base_all);

      const As_circ_mm2 = parseFloat(document.getElementById("As_circ").value || "0");
      const n_barras_circ = parseInt(document.getElementById("n_barras_circ").value || "0",10);

      const tipoVinculo = document.getElementById("tipoVinculo").value;
      const Ldiv = parseFloat(document.getElementById("Ldiv").value);

      if (!isFinite(fck) || fck<=0 || !isFinite(fyk) || !isFinite(gamma_c) || !isFinite(gamma_s)){
        out.innerHTML = "<p><span class='tag tag-err'>Erro</span> Verifique fck, fyk, Œ≥c, Œ≥s.</p>";
        lastReportTxt = "";
        return;
      }

      // Resist√™ncias
      const fcd = 0.85*fck/gamma_c;
      const fyd = fyk/gamma_s;
      const Eci = 5600*Math.sqrt(fck);
      const Ec  = 0.85*Eci;
      const Ec_eff = Ec/(1+phi_creep);

      // Se√ß√£o
      let Ac_mm2, Ix_mm4, Iy_mm4, b_mm, h_mm, D_mm;
      const cob_mm = cob_cm*10;
      const phi_long_mm = phi_base_all;

      if (tipoSecao==="ret"){
        if (!isFinite(b_cm) || !isFinite(h_cm) || b_cm<=0 || h_cm<=0){
          out.innerHTML = "<p><span class='tag tag-err'>Erro</span> Se√ß√£o retangular inv√°lida.</p>";
          lastReportTxt = "";
          return;
        }
        b_mm = b_cm*10;
        h_mm = h_cm*10;
        Ac_mm2 = b_mm*h_mm;
        Ix_mm4 = b_mm*Math.pow(h_mm,3)/12;
        Iy_mm4 = h_mm*Math.pow(b_mm,3)/12;
      } else {
        if (!isFinite(D_cm) || D_cm<=0){
          out.innerHTML = "<p><span class='tag tag-err'>Erro</span> Di√¢metro inv√°lido.</p>";
          lastReportTxt = "";
          return;
        }
        D_mm = D_cm*10;
        Ac_mm2 = Math.PI*Math.pow(D_mm,2)/4;
        const I_circ = Math.PI*Math.pow(D_mm,4)/64;
        Ix_mm4 = I_circ;
        Iy_mm4 = I_circ;
        b_mm = D_mm;
        h_mm = D_mm;
      }

      const d_mm = h_mm - cob_mm - phi_long_mm/2;
      const dLinha_mm = cob_mm + phi_long_mm/2;
      if (d_mm <= 0){
        out.innerHTML = "<p><span class='tag tag-err'>Geometria inv√°lida</span> d ‚â§ 0. Ajuste h, cobrimento, œï.</p>";
        lastReportTxt = "";
        return;
      }

      const i_x_mm = Math.sqrt(Ix_mm4/Ac_mm2);
      const i_y_mm = Math.sqrt(Iy_mm4/Ac_mm2);
      const l0x_mm = l0x_m*1000;
      const l0y_mm = l0y_m*1000;
      const lambda_x = l0x_mm/i_x_mm;
      const lambda_y = l0y_mm/i_y_mm;

      // Taxas de armadura
      const rho_min = rhoMinFlexao(fck,fyk);
      const As_min_mm2 = rho_min*Ac_mm2;
      const As_max_mm2 = 0.04*Ac_mm2;

      // Se usar combina√ß√µes Gk/Qk
      if (origemEsforcos==="combos" && isFinite(Ngk) && isFinite(Nqk)){
        const gG = gammaG, gQ = gammaQ;
        Nsd_kN  = gG*Ngk + gQ*Nqk;
        Msdx_kNm = (isFinite(Mxgk)? gG*Mxgk:0) + (isFinite(Mxqk)? gQ*Mxqk:0);
        Msdy_kNm = (isFinite(Mygk)? gG*Mygk:0) + (isFinite(Myqk)? gQ*Myqk:0);
        const psi = (tipoELS==="freq")? psi1 : psi2;
        Nser_kN  = Ngk + psi*Nqk;
        Mserx_kNm = (isFinite(Mxgk)? Mxgk:0) + psi*(isFinite(Mxqk)? Mxqk:0);
        Msery_kNm = (isFinite(Mygk)? Mygk:0) + psi*(isFinite(Myqk)? Myqk:0);
      }

      const Nsd_N = Nsd_kN*1000;

      // Estabilidade
      const Ncrx_kN = calcNcr(Ec_eff,Ix_mm4,l0x_mm);
      const Ncry_kN = calcNcr(Ec_eff,Iy_mm4,l0y_mm);
      const Nsd_abs = Math.abs(Nsd_kN);
      const Ncr_med_kN = (Ncrx_kN+Ncry_kN)/2;

      let gamma_z_NBR = NaN;
      if (isFinite(M1tot_kNm) && isFinite(DeltaMtot_kNm) && M1tot_kNm>0){
        const raz = DeltaMtot_kNm/M1tot_kNm;
        gamma_z_NBR = 1.0/(1.0 - raz);
      }
      const gamma_z_auto = Ncr_med_kN>0 ? 1.0/(1.0 - Nsd_abs/Ncr_med_kN) : NaN;
      const gamma_z_final = isFinite(gamma_z_NBR)? gamma_z_NBR : gamma_z_auto;

      // Excentricidades
      let e1x_mm = 0, e1y_mm = 0;
      if (Nsd_kN!==0){
        e1x_mm = (Msdx_kNm*1e6)/Nsd_N;
        e1y_mm = (Msdy_kNm*1e6)/Nsd_N;
      }
      const h_y_mm = h_mm;
      const h_x_mm = b_mm;
      const e_over_hx = h_y_mm>0 ? Math.abs(e1x_mm)/h_y_mm : 0;
      const e_over_hy = h_x_mm>0 ? Math.abs(e1y_mm)/h_x_mm : 0;

      function lambda1(eh){
        const base = 25 + 12.5*eh;
        const raw = base;
        return Math.max(35, Math.min(raw, 90));
      }
      const lambda1x = lambda1(e_over_hx);
      const lambda1y = lambda1(e_over_hy);

      function M2ord(M1_kNm, Nsd_kN_local, Ncr_kN, lambda_dir, lambda1_dir){
        if (Nsd_kN_local<=0 || Ncr_kN<=0) return {M2:M1_kNm, texto:"Elemento tracionado ou Ncr inv√°lido."};
        const uso2ord = lambda_dir>lambda1_dir;
        const gamma_loc = 1.0/(1.0 - Math.abs(Nsd_kN_local)/Ncr_kN);
        const M2 = uso2ord? M1_kNm*gamma_loc : M1_kNm;
        const texto = uso2ord
          ? `Œª=${fmt(lambda_dir,1)} &gt; Œª‚ÇÅ‚âà${fmt(lambda1_dir,1)} ‚áí Œ≥_loc‚âà${fmt(gamma_loc,3)}`
          : `Œª=${fmt(lambda_dir,1)} ‚â§ Œª‚ÇÅ‚âà${fmt(lambda1_dir,1)} ‚áí 2¬™ ordem local dispensada`;
        return {M2, texto};
      }

      const M2x = M2ord(Msdx_kNm,Nsd_kN,Ncrx_kN,lambda_x,lambda1x);
      const M2y = M2ord(Msdy_kNm,Nsd_kN,Ncry_kN,lambda_y,lambda1y);
      const Msdx2_kNm = M2x.M2;
      const Msdy2_kNm = M2y.M2;

      // Armadura por face ‚Äì c√°lculo de As e espa√ßamento
      function As_face(n,phi){
        return n>0 && phi>0 ? n*Math.PI*phi*phi/4 : 0;
      }
      const As_top_calc = As_face(n_top,phi_top);
      const As_base_calc = As_face(n_base,phi_base);
      const As_esq_calc = As_face(n_esq,phi_esq);
      const As_dir_calc = As_face(n_dir,phi_dir);

      function espacamentoFace(n,phi,dim_mm,cob_mm){
        if (n<=1) return NaN;
        const util = dim_mm - 2*(cob_mm + phi/2);
        if (util<=0) return NaN;
        return util/(n-1); // mm
      }
      let esp_top=NaN, esp_base=NaN, esp_esq=NaN, esp_dir=NaN;
      if (tipoSecao==="ret"){
        esp_top  = espacamentoFace(n_top,phi_top,b_mm,cob_mm);
        esp_base = espacamentoFace(n_base,phi_base,b_mm,cob_mm);
        esp_esq  = espacamentoFace(n_esq,phi_esq,h_mm,cob_mm);
        esp_dir  = espacamentoFace(n_dir,phi_dir,h_mm,cob_mm);
      }

      function checkEsp(esp_mm, phi){
        if (!isFinite(esp_mm)) return null;
        const smin = Math.max(1.5*phi,20); // mm ‚Äì refer√™ncia NBR
        const smax = 200; // mm ‚Äì refer√™ncia t√≠pica
        let txt="";
        if (esp_mm<smin) txt+="Menor que smin‚âà"+smin.toFixed(0)+" mm. ";
        if (esp_mm>smax) txt+="Maior que smax‚âà"+smax.toFixed(0)+" mm. ";
        if (!txt) txt="Ok (dentro de faixa usual).";
        return {s:esp_mm,smin,smax,txt};
      }
      const espTopInfo  = checkEsp(esp_top,phi_top);
      const espBaseInfo = checkEsp(esp_base,phi_base);
      const espEsqInfo  = checkEsp(esp_esq,phi_esq);
      const espDirInfo  = checkEsp(esp_dir,phi_dir);

      let espCircInfo = null;
      if (tipoSecao==="cir" && n_barras_circ>1 && D_mm>0){
        const Lcirc = Math.PI*D_mm;
        const s_lin = Lcirc/n_barras_circ;
        const smin_c = Math.max(1.5*phi_long_mm,20);
        const smax_c = 200;
        let txt="";
        if (s_lin<smin_c) txt+="Menor que smin‚âà"+smin_c.toFixed(0)+" mm. ";
        if (s_lin>smax_c) txt+="Maior que smax‚âà"+smax_c.toFixed(0)+" mm. ";
        if (!txt) txt="Ok (dentro de faixa usual na circunfer√™ncia).";
        espCircInfo = {s:s_lin,smin:smin_c,smax:smax_c,txt};
      }

      // Esf. ULS ‚Äì tag
      let tagN = "";
      if (Nsd_kN>0) tagN = "<span class='tag tag-ok'>Compress√£o (Nsd &gt; 0)</span>";
      else if (Nsd_kN<0) tagN = "<span class='tag tag-warn'>Tra√ß√£o (Nsd &lt; 0)</span>";
      else tagN = "<span class='tag tag-warn'>Nsd ‚âà 0 (flex√£o pura)</span>";

      const modoDim = (modo==="dimensionar");
      let As_top_dim=0,As_base_dim=0,As_esq_dim=0,As_dir_dim=0,As_tot_dim=0;
      let detalhesDim = "";
      const eps_cu = 0.0035;
      const eps_y = fyd/Es;
      let eps_s_t=0,eps_s_c=0,status_eps_s_t="",status_eps_s_c="";
      let Nrd_kN=0,Mrdx_kNm=0,Mrdy_kNm=0,FSN=Infinity,FSx=Infinity,FSy=Infinity;
      let intBiax = NaN, FS_biax=NaN;

      // DIMENSIONAR
      if (modoDim){
        if (Nsd_kN>0){
          // compress√£o / flexo-comp
          if (tipoSecao==="ret"){
            let As_tot_x=0, As_t_y=0, As_c_y=0;
            if (Math.abs(Msdx2_kNm)>1e-6){
              const solx = dimensionarNM_compressao(Nsd_kN,Msdx2_kNm,b_mm,d_mm,dLinha_mm,fcd,fyd,As_min_mm2,As_max_mm2);
              if (solx){
                As_t_y = solx.As_t;
                As_c_y = solx.As_c;
                As_tot_x = solx.As_tot;
              }
            }
            let As_tot_y=0, As_t_x=0, As_c_x=0;
            if (Math.abs(Msdy2_kNm)>1e-6){
              const soly = dimensionarNM_compressao(Nsd_kN,Msdy2_kNm,h_mm,d_mm,dLinha_mm,fcd,fyd,As_min_mm2,As_max_mm2);
              if (soly){
                As_t_x = soly.As_t;
                As_c_x = soly.As_c;
                As_tot_y = soly.As_tot;
              }
            }
            As_top_dim  = As_c_y;
            As_base_dim = As_t_y;
            As_esq_dim  = As_c_x;
            As_dir_dim  = As_t_x;
            As_tot_dim  = As_top_dim+As_base_dim+As_esq_dim+As_dir_dim;
            detalhesDim =
              "Dimensionamento independente em cada dire√ß√£o: Mx ‚Üí faces topo/base, My ‚Üí faces esq/dir. " +
              "As_total = soma das contribui√ß√µes, o que √© conservador para flex√£o biaxial.";
          } else {
            const Mres = Math.sqrt(Msdx2_kNm*Msdx2_kNm + Msdy2_kNm*Msdy2_kNm);
            const D = b_mm;
            const d_circ = 0.9*(D/2);
            const sol = dimensionarNM_compressao(Nsd_kN,Mres,D,d_circ,dLinha_mm,fcd,fyd,As_min_mm2,As_max_mm2);
            if (sol){
              As_tot_dim = sol.As_tot;
              detalhesDim = "Se√ß√£o circular: dimensionado para N‚ÄìMres (‚àö(Mx¬≤+My¬≤)).";
            } else {
              detalhesDim = "N√£o convergiu dimensionamento circular para N‚ÄìMres.";
            }
          }
        } else {
          // tra√ß√£o / flexo-tra√ß√£o
          const Nten_kN = Math.abs(Nsd_kN);
          const Nten_N = Nten_kN*1000;
          const As_N = Nten_N/fyd;
          if (tipoSecao==="ret"){
            let As_top_M=0,As_base_M=0,As_esq_M=0,As_dir_M=0;
            if (Math.abs(Msdx2_kNm)>1e-6){
              const M_Nmm = Msdx2_kNm*1e6;
              const z = 0.9*d_mm;
              const AsMx = M_Nmm/(fyd*z);
              As_base_M += AsMx;
            }
            if (Math.abs(Msdy2_kNm)>1e-6){
              const M_Nmm = Msdy2_kNm*1e6;
              const z = 0.9*d_mm;
              const AsMy = M_Nmm/(fyd*z);
              As_dir_M += AsMy;
            }
            const As_face_N = As_N/4;
            As_top_dim  = As_face_N + As_top_M;
            As_base_dim = As_face_N + As_base_M;
            As_esq_dim  = As_face_N + As_esq_M;
            As_dir_dim  = As_face_N + As_dir_M;
            As_tot_dim  = As_top_dim+As_base_dim+As_esq_dim+As_dir_dim;
            detalhesDim =
              "Tra√ß√£o exc√™ntrica: As para N (distribu√≠da em 4 faces) + As adicionais para Mx/My nas faces mais tracionadas.";
          } else {
            const Mres = Math.sqrt(Msdx2_kNm*Msdx2_kNm + Msdy2_kNm*Msdy2_kNm);
            const D = b_mm;
            const z = 0.9*(D/2);
            const AsM = Mres*1e6/(fyd*z);
            As_tot_dim = As_N + AsM;
            detalhesDim =
              "Se√ß√£o circular tracionada: As para N + As para momento resultante Mres.";
          }
        }
      }

      // Armaduras efetivamente usadas para verifica√ß√£o
      let As_top_use = tipoSecao==="ret" ? As_top_calc : 0;
      let As_base_use = tipoSecao==="ret" ? As_base_calc : 0;
      let As_esq_use = tipoSecao==="ret" ? As_esq_calc : 0;
      let As_dir_use = tipoSecao==="ret" ? As_dir_calc : 0;
      let As_circ_use = As_circ_mm2;

      if (modoDim){
        if (tipoSecao==="ret"){
          // s√≥ substitui se dimensionou algo
          As_top_use  = As_top_dim>0 ? As_top_dim : As_top_use;
          As_base_use = As_base_dim>0 ? As_base_dim : As_base_use;
          As_esq_use  = As_esq_dim>0 ? As_esq_dim : As_esq_use;
          As_dir_use  = As_dir_dim>0 ? As_dir_dim : As_dir_use;
        } else {
          As_circ_use = As_tot_dim>0 ? As_tot_dim : As_circ_use;
        }
      }

      // VERIFICA√á√ÉO N‚ÄìMx‚ÄìMy
      if (tipoSecao==="ret"){
        let verx=null, very=null;
        let Mrdx=0, Mrdy=0;

        if (tipoAnalise!=="uniaxial_y" && (Math.abs(Msdx2_kNm)>1e-6 || Nsd_kN!==0)){
          const as_t = Msdx2_kNm>=0 ? As_base_use : As_top_use;
          const as_c = Msdx2_kNm>=0 ? As_top_use : As_base_use;
          verx = verificarNM_asym(Nsd_kN,Msdx2_kNm,as_t,as_c,b_mm,d_mm,dLinha_mm,fcd,fyd);
          if (verx) Mrdx = verx.Mrd_kNm;
        }
        if (tipoAnalise!=="uniaxial_x" && (Math.abs(Msdy2_kNm)>1e-6 || Nsd_kN!==0)){
          const as_t_y = Msdy2_kNm>=0 ? As_dir_use : As_esq_use;
          const as_c_y = Msdy2_kNm>=0 ? As_esq_use : As_dir_use;
          very = verificarNM_asym(Nsd_kN,Msdy2_kNm,as_t_y,as_c_y,h_mm,d_mm,dLinha_mm,fcd,fyd);
          if (very) Mrdy = very.Mrd_kNm;
        }

        if (verx){
          Nrd_kN = verx.Nrd_kN;
          Mrdx_kNm = Mrdx;
        }
        if (very){
          if (!verx) Nrd_kN = very.Nrd_kN;
          Mrdy_kNm = Mrdy;
        }

        const As_tot_use = As_top_use+As_base_use+As_esq_use+As_dir_use;
        const rho_adot = As_tot_use/Ac_mm2;
        const FSN_arr = [];
        if (verx) FSN_arr.push(verx.FSN);
        if (very) FSN_arr.push(very.FSN);
        FSN = FSN_arr.length? Math.min.apply(null,FSN_arr) : Infinity;
        FSx = verx ? verx.FSM : Infinity;
        FSy = very ? very.FSM : Infinity;

        if (verx){
          const x = verx.x;
          eps_s_t = eps_cu*(d_mm-x)/x;
          eps_s_c = eps_cu*(x-dLinha_mm)/x;
          status_eps_s_t = eps_s_t>=eps_y? "a√ßo tracionado escoando":"a√ßo tracionado n√£o escoando";
          status_eps_s_c = eps_s_c>=eps_y? "a√ßo comprimido escoando":"a√ßo comprimido n√£o escoando";
        }

        if (tipoAnalise==="biaxial" && verx && very && Mrdx>0 && Mrdy>0){
          const ax = Math.abs(Msdx2_kNm/Mrdx);
          const ay = Math.abs(Msdy2_kNm/Mrdy);
          const a = isFinite(alpha_int) && alpha_int>0 ? alpha_int : 1.5;
          const I = Math.pow(Math.pow(ax,a)+Math.pow(ay,a),1/a);
          intBiax = I;
          FS_biax = I>0? 1/I : Infinity;
        }

      } else {
        // circular
        const Mres2 = Math.sqrt(Msdx2_kNm*Msdx2_kNm + Msdy2_kNm*Msdy2_kNm);
        const As_tot_use = As_circ_use;
        const As_t = As_tot_use/2;
        const As_c = As_tot_use/2;
        const ver = verificarNM_asym(Nsd_kN,Mres2,As_t,As_c,b_mm,0.9*(b_mm/2),dLinha_mm,fcd,fyd);
        if (ver){
          Nrd_kN = ver.Nrd_kN;
          Mrdx_kNm = ver.Mrd_kNm;
          Mrdy_kNm = ver.Mrd_kNm;
          FSN = ver.FSN;
          FSx = ver.FSM;
          FSy = ver.FSM;
          const x = ver.x;
          eps_s_t = eps_cu*(0.9*(b_mm/2)-x)/x;
          eps_s_c = eps_cu*(x-dLinha_mm)/x;
          status_eps_s_t = eps_s_t>=eps_y? "a√ßo tracionado escoando":"a√ßo tracionado n√£o escoando";
          status_eps_s_c = eps_s_c>=eps_y? "a√ßo comprimido escoando":"a√ßo comprimido n√£o escoando";
          const ax = Math.abs(Msdx2_kNm/ver.Mrd_kNm);
          const ay = Math.abs(Msdy2_kNm/ver.Mrd_kNm);
          const a = isFinite(alpha_int) && alpha_int>0 ? alpha_int : 1.5;
          const I = Math.pow(Math.pow(ax,a)+Math.pow(ay,a),1/a);
          intBiax = I;
          FS_biax = I>0? 1/I : Infinity;
        }
      }

      // ELS ‚Äì flecha & œÉs,ser
      const l0x_dir_mm = l0x_mm;
      const l0y_dir_mm = l0y_mm;
      const Mser_Nmm_x = Mserx_kNm*1e6;
      const Mser_Nmm_y = Msery_kNm*1e6;
      let Idir = Ix_mm4;
      let Lref_mm = l0x_dir_mm;
      let Mser_Nmm = Mser_Nmm_x;
      if (Math.abs(Msery_kNm)>Math.abs(Mserx_kNm)){
        Idir = Iy_mm4;
        Lref_mm = l0y_dir_mm;
        Mser_Nmm = Mser_Nmm_y;
      }
      let delta_mm = 0;
      if (tipoVinculo==="biapoiado"){
        delta_mm = Mser_Nmm*Math.pow(Lref_mm,2)/(8*Ec_eff*Idir);
      } else {
        delta_mm = Mser_Nmm*Math.pow(Lref_mm,2)/(3*Ec_eff*Idir);
      }
      const lim_def_mm = Lref_mm/Ldiv;

      const Mser_res = Math.sqrt(Mserx_kNm*Mserx_kNm + Msery_kNm*Msery_kNm);
      const Mser_res_Nmm = Mser_res*1e6;
      let As_total_serv = (tipoSecao==="ret")
        ? (As_top_use+As_base_use+As_esq_use+As_dir_use)
        : As_circ_use;
      let sigma_s_ser = NaN;
      if (As_total_serv>0){
        const z_ser = 0.9*d_mm;
        sigma_s_ser = Math.abs(Nser_kN)*1000/As_total_serv + Math.abs(Mser_res_Nmm)/(As_total_serv*z_ser);
      }

      // Sa√≠da HTML
      let html = "";
      html += `<h3>Resumo do pilar ${pilarID || "-"}</h3>`;
      html += `<p><b>Obra:</b> ${obra||"-"}<br><b>Projeto:</b> ${proj||"-"}<br><b>Eng.:</b> ${engenheiro||"-"}</p>`;

      html += `<p><b>Materiais:</b><br>
        fck = ${fmt(fck,0)} MPa ‚áí fcd ‚âà ${fmt(fcd,2)} MPa<br>
        fyk = ${fmt(fyk,0)} MPa ‚áí fyd ‚âà ${fmt(fyd,2)} MPa<br>
        Eci ‚âà ${fmt(Eci,0)} MPa; Ec ‚âà ${fmt(Ec,0)} MPa; Ec,eff ‚âà ${fmt(Ec_eff,0)} MPa (œÜ=${fmt(phi_creep,2)})</p>`;

      html += `<p><b>Se√ß√£o:</b><br>`;
      if (tipoSecao==="ret"){
        html += `Retangular: b = ${fmt(b_cm,1)} cm; h = ${fmt(h_cm,1)} cm<br>`;
      } else {
        html += `Circular: D = ${fmt(D_cm,1)} cm<br>`;
      }
      html += `Ac ‚âà ${fmt(Ac_mm2/100,2)} cm¬≤<br>
        Ix ‚âà ${fmt(Ix_mm4/1e4,2)} cm‚Å¥; Iy ‚âà ${fmt(Iy_mm4/1e4,2)} cm‚Å¥<br>
        i<sub>x</sub> ‚âà ${fmt(i_x_mm/10,2)} cm; i<sub>y</sub> ‚âà ${fmt(i_y_mm/10,2)} cm<br>
        d ‚âà ${fmt(d_mm/10,2)} cm; d' ‚âà ${fmt(dLinha_mm/10,2)} cm</p>`;

      html += `<p><b>Esfor√ßos ULS (ap√≥s origem escolhida):</b> ${tagN}<br>
        Nsd = ${fmt(Nsd_kN,1)} kN<br>
        Msd,x = ${fmt(Msdx_kNm,1)} kN¬∑m ‚áí Msd,x,2ord ‚âà ${fmt(Msdx2_kNm,1)} kN¬∑m<br>
        Msd,y = ${fmt(Msdy_kNm,1)} kN¬∑m ‚áí Msd,y,2ord ‚âà ${fmt(Msdy2_kNm,1)} kN¬∑m</p>`;

      html += `<p><b>Estabilidade (Euler):</b><br>
        ‚Ñì<sub>0x</sub> = ${fmt(l0x_m,2)} m ‚áí Œªx ‚âà ${fmt(lambda_x,1)}<br>
        ‚Ñì<sub>0y</sub> = ${fmt(l0y_m,2)} m ‚áí Œªy ‚âà ${fmt(lambda_y,1)}<br>
        Œª1x ‚âà ${fmt(lambda1x,1)}, Œª1y ‚âà ${fmt(lambda1y,1)}<br>
        ${M2x.texto}<br>
        ${M2y.texto}<br>
        Ncr,x ‚âà ${fmt(Ncrx_kN,1)} kN; Ncr,y ‚âà ${fmt(Ncry_kN,1)} kN</p>`;

      if (isFinite(gamma_z_final)){
        html += `<p><b>Œ≥<sub>z</sub> global aproximado:</b> Œ≥z ‚âà ${fmt(gamma_z_final,3)}</p>`;
      } else {
        html += `<p><b>Œ≥<sub>z</sub> global:</b> n√£o informado (ŒîM/M1 n√£o fornecido).</p>`;
      }

      html += `<p><b>Limites de armadura:</b><br>
        œÅmin ‚âà ${fmt(rho_min*100,3)} % ‚áí As,min ‚âà ${fmt(As_min_mm2,1)} mm¬≤<br>
        œÅm√°x = 4% ‚áí As,max ‚âà ${fmt(As_max_mm2,1)} mm¬≤</p>`;

      html += `<hr><p class="section-title">ULS ‚Äì N‚ÄìMx‚ÄìMy</p>`;

      if (modoDim){
        html += `<p><b>Dimensionamento autom√°tico:</b><br>${detalhesDim}</p>`;
      } else {
        html += `<p><b>Verifica√ß√£o com armadura informada.</b></p>`;
      }

      if (tipoSecao==="ret"){
        const As_tot_use = As_top_use+As_base_use+As_esq_use+As_dir_use;
        const rho_adot = As_tot_use/Ac_mm2;
        let tagAs="";
        if (As_tot_use<As_min_mm2) tagAs="<span class='tag tag-err'>As,total &lt; As,min</span>";
        else if (As_tot_use>As_max_mm2) tagAs="<span class='tag tag-err'>As,total &gt; 4%¬∑Ac</span>";
        else tagAs="<span class='tag tag-ok'>Taxa de armadura entre As,min e As,max</span>";

        html += `<p>${tagAs}</p>`;
        html += `<p><b>Armadura por face (retangular):</b><br>
          As topo (+y) ‚âà ${fmt(As_top_use,1)} mm¬≤<br>
          As base (‚àíy) ‚âà ${fmt(As_base_use,1)} mm¬≤<br>
          As esquerda (‚àíx) ‚âà ${fmt(As_esq_use,1)} mm¬≤<br>
          As direita (+x) ‚âà ${fmt(As_dir_use,1)} mm¬≤<br>
          As,total ‚âà ${fmt(As_tot_use,1)} mm¬≤ (œÅ ‚âà ${fmt(rho_adot*100,3)} %)</p>`;

        html += `<p><b>Espa√ßamento entre barras (estimado):</b><br>`;
        if (espTopInfo){
          html += `Topo: s‚âà${fmt(espTopInfo.s,1)} mm (smin‚âà${fmt(espTopInfo.smin,0)}; smax‚âà${fmt(espTopInfo.smax,0)}) ‚Üí ${espTopInfo.txt}<br>`;
        }
        if (espBaseInfo){
          html += `Base: s‚âà${fmt(espBaseInfo.s,1)} mm (smin‚âà${fmt(espBaseInfo.smin,0)}; smax‚âà${fmt(espBaseInfo.smax,0)}) ‚Üí ${espBaseInfo.txt}<br>`;
        }
        if (espEsqInfo){
          html += `Esquerda: s‚âà${fmt(espEsqInfo.s,1)} mm (smin‚âà${fmt(espEsqInfo.smin,0)}; smax‚âà${fmt(espEsqInfo.smax,0)}) ‚Üí ${espEsqInfo.txt}<br>`;
        }
        if (espDirInfo){
          html += `Direita: s‚âà${fmt(espDirInfo.s,1)} mm (smin‚âà${fmt(espDirInfo.smin,0)}; smax‚âà${fmt(espDirInfo.smax,0)}) ‚Üí ${espDirInfo.txt}<br>`;
        }
      } else {
        const As_tot_use = As_circ_use;
        const rho_adot = As_tot_use/Ac_mm2;
        let tagAs="";
        if (As_tot_use<As_min_mm2) tagAs="<span class='tag tag-err'>As,total &lt; As,min</span>";
        else if (As_tot_use>As_max_mm2) tagAs="<span class='tag tag-err'>As,total &gt; 4%¬∑Ac</span>";
        else tagAs="<span class='tag tag-ok'>Taxa de armadura entre As,min e As,max</span>";
        html += `<p>${tagAs}</p>`;
        html += `<p><b>Se√ß√£o circular:</b><br>
          As,total ‚âà ${fmt(As_tot_use,1)} mm¬≤ (œÅ ‚âà ${fmt(rho_adot*100,3)} %)<br>
          n¬∫ de barras ‚âà ${n_barras_circ||"-"}</p>`;
        if (espCircInfo){
          html += `<p><b>Espa√ßamento na circunfer√™ncia:</b><br>
            s‚âà${fmt(espCircInfo.s,1)} mm (smin‚âà${fmt(espCircInfo.smin,0)}; smax‚âà${fmt(espCircInfo.smax,0)}) ‚Üí ${espCircInfo.txt}</p>`;
        }
      }

      html += `<p><b>Capacidades uniaxiais aproximadas:</b><br>
        Nrd ‚âà ${fmt(Nrd_kN,1)} kN ‚áí FS<sub>N</sub> ‚âà ${fmt(FSN,2)}<br>
        Mrd,x ‚âà ${fmt(Mrdx_kNm,1)} kN¬∑m ‚áí FS<sub>Mx</sub> ‚âà ${fmt(FSx,2)}<br>
        Mrd,y ‚âà ${fmt(Mrdy_kNm,1)} kN¬∑m ‚áí FS<sub>My</sub> ‚âà ${fmt(FSy,2)}</p>`;

      if (!isNaN(intBiax)){
        html += `<p><b>Intera√ß√£o biaxial (expoente Œ±=${fmt(alpha_int,2)}):</b><br>
          I = (|Msdx,2ord/Mrdx|^Œ± + |Msdy,2ord/Mrdy|^Œ±)^(1/Œ±) ‚âà ${fmt(intBiax,3)}<br>`;
        if (intBiax<=1){
          html += `<span class="tag tag-ok">I ‚â§ 1 ‚áí condi√ß√£o biaxial atendida (FS‚âà${fmt(FS_biax,2)})</span>`;
        } else {
          html += `<span class="tag tag-err">I &gt; 1 ‚áí refor√ßar se√ß√£o/armadura ou rever esfor√ßos (FS‚âà${fmt(FS_biax,2)})</span>`;
        }
        html += `</p>`;
      }

      html += `<p><b>Deforma√ß√µes de c√°lculo (refer√™ncia):</b><br>
        Œµc,u ‚âà 3,50 ‚Ä∞<br>
        Œµs,t ‚âà ${fmt(eps_s_t*1000,3)} ‚Ä∞ (Œµy ‚âà ${fmt(eps_y*1000,3)} ‚Ä∞) ‚Üí ${status_eps_s_t || "-"}<br>
        Œµs,c ‚âà ${fmt(eps_s_c*1000,3)} ‚Ä∞ ‚Üí ${status_eps_s_c || "-"}</p>`;

      html += `<hr><p class="section-title">ELS ‚Äì Flecha & fissura√ß√£o (qualitativo)</p>`;
      html += `<p><b>Flecha lateral (estimativa):</b><br>
        Œ¥<sub>ser</sub> ‚âà ${fmt(delta_mm,1)} mm<br>
        Limite L/${fmt(Ldiv,0)} ‚áí Œ¥_lim ‚âà ${fmt(lim_def_mm,1)} mm<br>`;
      if (delta_mm<=lim_def_mm){
        html += `<span class="tag tag-ok">Flecha estimada ‚â§ L/${fmt(Ldiv,0)}</span>`;
      } else {
        html += `<span class="tag tag-warn">Flecha estimada &gt; L/${fmt(Ldiv,0)}</span>`;
      }
      html += `</p>`;

      html += `<p><b>Tens√£o de servi√ßo no a√ßo (estimativa global):</b><br>`;
      if (isFinite(sigma_s_ser)){
        html += `œÉ<sub>s,ser</sub> ‚âà ${fmt(sigma_s_ser,1)} MPa<br>`;
        if (sigma_s_ser<=160) html += `<span class="tag tag-ok">Tens√£o baixa ‚Üí fissuras pequenas</span>`;
        else if (sigma_s_ser<=240) html += `<span class="tag tag-warn">Tens√£o moderada ‚Üí fissura√ß√£o usual</span>`;
        else html += `<span class="tag tag-err">Tens√£o alta ‚Üí risco de fissuras mais abertas</span>`;
      } else {
        html += `Informe Gk/Qk ou Nser, Mserx, Msery e As para estimar œÉ<sub>s,ser</sub>.`;
      }

      html += `<p class="note">
        ELS aqui √© aproximado (curvatura simplificada, flecha tipo viga). Para pilares muito esbeltos e verifica√ß√µes
        normativas rigorosas de fissura√ß√£o e deslocamentos, ainda √© necess√°rio aplicar diretamente os modelos completos
        da NBR 6118 ou softwares dedicados (TQS, Eberick, etc.).
      </p>`;

      if (fck<20 || fck>50){
        html += `<p class="note"><b>Aviso:</b> fck fora da faixa t√≠pica de concreto normal (20‚Äì50 MPa). Tenha cautela com extrapola√ß√µes.</p>`;
      }

      out.innerHTML = html;

      // TXT
      let txt = "";
      txt += "Pilar de Concreto Armado ‚Äì NBR 6118 ‚Äì N‚ÄìMx‚ÄìMy\n";
      txt += "-------------------------------------------------\n";
      txt += `Obra: ${obra}\nProjeto: ${proj}\nPilar: ${pilarID}\nEngenheiro: ${engenheiro}\n\n`;
      txt += `Materiais:\n  fck = ${fck} MPa, fcd = ${fcd.toFixed(2)} MPa\n`;
      txt += `  fyk = ${fyk} MPa, fyd = ${fyd.toFixed(2)} MPa\n`;
      txt += `  Eci ‚âà ${Eci.toFixed(0)} MPa, Ec ‚âà ${Ec.toFixed(0)} MPa, Ec,eff ‚âà ${Ec_eff.toFixed(0)} MPa (phi=${phi_creep})\n\n`;
      if (tipoSecao==="ret"){
        txt += `Se√ß√£o retangular: b = ${b_cm} cm, h = ${h_cm} cm\n`;
      } else {
        txt += `Se√ß√£o circular: D = ${D_cm} cm\n`;
      }
      txt += `  Ac ‚âà ${(Ac_mm2/100).toFixed(2)} cm¬≤\n  d ‚âà ${(d_mm/10).toFixed(2)} cm, d' ‚âà ${(dLinha_mm/10).toFixed(2)} cm\n\n`;
      txt += `Esfor√ßos ULS (ap√≥s origem escolhida):\n  Nsd = ${Nsd_kN} kN\n`;
      txt += `  Msdx = ${Msdx_kNm} kN¬∑m (Msdx,2ord‚âà${Msdx2_kNm.toFixed(2)} kN¬∑m)\n`;
      txt += `  Msdy = ${Msdy_kNm} kN¬∑m (Msdy,2ord‚âà${Msdy2_kNm.toFixed(2)} kN¬∑m)\n\n`;
      txt += `Estabilidade:\n  l0x = ${l0x_m} m, Œªx ‚âà ${lambda_x.toFixed(1)}, Œª1x‚âà${lambda1x.toFixed(1)}\n`;
      txt += `  l0y = ${l0y_m} m, Œªy ‚âà ${lambda_y.toFixed(1)}, Œª1y‚âà${lambda1y.toFixed(1)}\n`;
      txt += `  Ncrx ‚âà ${Ncrx_kN.toFixed(1)} kN, Ncry ‚âà ${Ncry_kN.toFixed(1)} kN\n`;
      if (isFinite(gamma_z_final)) txt += `  Œ≥z,global ‚âà ${gamma_z_final.toFixed(3)}\n`;
      txt += `\nULS ‚Äì N‚ÄìMx‚ÄìMy:\n  Nrd ‚âà ${Nrd_kN.toFixed(1)} kN (FS_N‚âà${FSN.toFixed(2)})\n`;
      txt += `  Mrdx ‚âà ${Mrdx_kNm.toFixed(1)} kN¬∑m (FS_Mx‚âà${FSx.toFixed(2)})\n`;
      txt += `  Mrdy ‚âà ${Mrdy_kNm.toFixed(1)} kN¬∑m (FS_My‚âà${FSy.toFixed(2)})\n`;
      if (!isNaN(intBiax)) txt += `  Intera√ß√£o biaxial (Œ±=${alpha_int}): I‚âà${intBiax.toFixed(3)} (FS_biax‚âà${FS_biax.toFixed(2)})\n\n`;
      txt += `ELS:\n  Nser = ${Nser_kN} kN, Mserx = ${Mserx_kNm} kN¬∑m, Msery = ${Msery_kNm} kN¬∑m\n`;
      txt += `  Flecha Œ¥ ‚âà ${delta_mm.toFixed(1)} mm (lim‚âà${lim_def_mm.toFixed(1)} mm, L/${Ldiv})\n`;
      if (isFinite(sigma_s_ser)) txt += `  œÉ_s,ser ‚âà ${sigma_s_ser.toFixed(1)} MPa\n`;
      txt += "\nObserva√ß√£o: modelo ainda aproximado; conferir com NBR 6118 e softwares dedicados em casos cr√≠ticos.\n";

      lastReportTxt = txt;

    } catch(err){
      console.error(err);
      document.getElementById("resultados").innerHTML =
        "<p><span class='tag tag-err'>Erro inesperado</span> ‚Äì revise os dados.</p>";
      lastReportTxt = "";
    }
  }
</script>
</body>
</html>
