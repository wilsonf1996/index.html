<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MusicPro – Spotify Clone Completo</title>
  <!-- Tailwind CSS para estilo moderno -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Animate.css para animações -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <!-- FontAwesome para ícones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"/>
  <style>
    /* Fundo dinâmico animado (tons de azul sóbrios e profissionais) */
    body {
      background: linear-gradient(-45deg, #0f2027, #203a43, #2c5364, #0f2027);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    /* Loader simples */
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4A90E2;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="text-gray-100">
  <!-- Modal de Autenticação (Login/Registro) -->
  <div id="auth-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-60 animate__animated animate__fadeIn">
    <div class="bg-white rounded-lg p-6 w-11/12 max-w-sm">
      <h2 id="auth-title" class="text-2xl font-bold mb-4 text-center">Login</h2>
      <div id="auth-error" class="text-red-500 mb-2 text-center"></div>
      <div class="mb-4">
        <label for="auth-email" class="block text-sm font-medium mb-1">Email</label>
        <input type="email" id="auth-email" placeholder="Seu email" class="w-full border border-gray-300 rounded px-3 py-2">
      </div>
      <div class="mb-4">
        <label for="auth-password" class="block text-sm font-medium mb-1">Senha (4 dígitos)</label>
        <input type="password" id="auth-password" placeholder="Ex: 1234" class="w-full border border-gray-300 rounded px-3 py-2">
      </div>
      <button id="auth-submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition">Entrar</button>
      <span id="toggle-auth" class="block mt-4 text-blue-500 text-center cursor-pointer">Não tem conta? Registre-se</span>
    </div>
  </div>

  <!-- Interface Principal do App -->
  <div id="app" class="hidden">
    <!-- Cabeçalho -->
    <header class="bg-blue-900 text-white flex items-center justify-between p-4">
      <h1 class="text-xl font-bold">MusicPro – Playlists</h1>
      <button onclick="signOut()" class="bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded">Sair</button>
    </header>
    <!-- Conteúdo Principal -->
    <main class="p-4">
      <!-- View de Listagem de Playlists -->
      <section id="playlists-view" class="animate__animated animate__fadeIn">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Suas Playlists</h2>
          <button onclick="createPlaylist()" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 transition">Criar Nova Playlist</button>
        </div>
        <div id="playlists-container">
          <div id="playlists-loader" class="loader hidden"></div>
          <div id="playlist-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
      </section>

      <!-- View de Detalhe da Playlist (Gerenciamento de Músicas) -->
      <section id="playlist-detail-view" class="hidden animate__animated animate__fadeIn">
        <div class="flex items-center justify-between mb-4">
          <button onclick="backToPlaylists()" class="text-blue-500 flex items-center">
            <i class="fas fa-arrow-left mr-2"></i> Voltar
          </button>
          <h2 id="playlist-detail-title" class="text-2xl font-semibold"></h2>
          <div></div>
        </div>
        <div class="mb-4">
          <button onclick="uploadMusic()" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 transition">Upload de Música</button>
        </div>
        <div id="musicas-container">
          <div id="musicas-loader" class="loader hidden"></div>
          <div id="musica-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- Player Global (para áudio e vídeo) -->
  <div id="player-bar" class="fixed inset-x-0 bottom-0 bg-blue-900 text-white flex items-center p-4">
    <div id="track-info" class="flex items-center flex-1">
      <img id="track-art" src="https://dummyimage.com/60x60/000/fff.png&text=Capa" alt="Capa" class="w-12 h-12 rounded mr-4">
      <div>
        <div id="track-name" class="font-bold">Nenhuma faixa</div>
        <div id="track-artist" class="text-sm">—</div>
      </div>
    </div>
    <div id="playback-controls" class="flex items-center space-x-4">
      <button id="prevBtn" onclick="playPrevious()" title="Faixa Anterior"><i class="fas fa-step-backward text-2xl"></i></button>
      <button id="playPauseBtn" onclick="togglePlayPause()" title="Play/Pause"><i class="fas fa-play text-2xl"></i></button>
      <button id="nextBtn" onclick="playNext()" title="Próxima Faixa"><i class="fas fa-step-forward text-2xl"></i></button>
    </div>
    <div id="volume-controls" class="flex items-center ml-4">
      <button id="muteBtn" onclick="toggleMute()" title="Mutar/Desmutar"><i id="muteIcon" class="fas fa-volume-up text-xl"></i></button>
      <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="0.5" class="ml-2">
    </div>
  </div>

  <!-- Modal de Vídeo (sem controles nativos) -->
  <div id="video-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 animate__animated animate__fadeIn">
    <div class="relative">
      <button onclick="closeVideoModal()" class="absolute top-0 right-0 text-white text-3xl p-2">
        <i class="fas fa-times"></i>
      </button>
      <video id="video-player" class="max-w-full max-h-full"></video>
    </div>
  </div>

  <!-- Firebase SDKs: Auth, Firestore e Storage -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
  
  <script>
    /*************** Configuração do Firebase ***************/
    const firebaseConfig = {
      apiKey: "AIzaSyDxMWPu_CnXV-u4-vlDFd-IZ8fzlyKJHng",
      authDomain: "financeiro-5.firebaseapp.com",
      projectId: "financeiro-5",
      storageBucket: "financeiro-5.appspot.com",
      messagingSenderId: "686639785223",
      appId: "1:686639785223:web:0314689c82c6dd1c2951a2",
      measurementId: "G-Q5REWML5DX"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const firestore = firebase.firestore();
    const storage = firebase.storage();

    /*************** Autenticação ***************/
    const authModal = document.getElementById("auth-modal");
    const authTitle = document.getElementById("auth-title");
    const authEmail = document.getElementById("auth-email");
    const authPassword = document.getElementById("auth-password");
    const authSubmit = document.getElementById("auth-submit");
    const toggleAuth = document.getElementById("toggle-auth");
    const authError = document.getElementById("auth-error");
    let isRegisterMode = false;
    toggleAuth.addEventListener("click", () => {
      isRegisterMode = !isRegisterMode;
      if (isRegisterMode) {
        authTitle.textContent = "Registro";
        authSubmit.textContent = "Registrar";
        toggleAuth.textContent = "Já tem conta? Faça login";
      } else {
        authTitle.textContent = "Login";
        authSubmit.textContent = "Entrar";
        toggleAuth.textContent = "Não tem conta? Registre-se";
      }
      authError.textContent = "";
    });
    authSubmit.addEventListener("click", () => {
      const email = authEmail.value;
      const password = authPassword.value;
      if (isRegisterMode) {
        if (!/^\d{4}$/.test(password)) {
          authError.textContent = "A senha deve ter exatamente 4 dígitos.";
          return;
        }
        auth.createUserWithEmailAndPassword(email, password)
          .then(userCredential => {
            const user = userCredential.user;
            return firestore.collection("users").doc(user.uid).set({
              email: user.email,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          })
          .catch(error => { authError.textContent = error.message; });
      } else {
        auth.signInWithEmailAndPassword(email, password)
          .catch(error => { authError.textContent = error.message; });
      }
    });
    auth.onAuthStateChanged(user => {
      if (user) {
        authModal.classList.remove("active");
        document.getElementById("app").classList.remove("hidden");
        loadPlaylists();
      } else {
        authModal.classList.add("active");
        document.getElementById("app").classList.add("hidden");
      }
    });
    function signOut() { auth.signOut(); }

    /*************** Loaders (Feedback Visual) ***************/
    function showLoader(id) { document.getElementById(id).classList.remove("hidden"); }
    function hideLoader(id) { document.getElementById(id).classList.add("hidden"); }

    /*************** Gerenciamento de Playlists ***************/
    async function loadPlaylists() {
      showLoader("playlists-loader");
      const user = auth.currentUser;
      if (!user) return;
      const playlistsRef = firestore.collection("users").doc(user.uid).collection("playlists");
      playlistsRef.orderBy("createdAt", "desc").onSnapshot(snapshot => {
        const playlistList = document.getElementById("playlist-list");
        playlistList.innerHTML = "";
        snapshot.forEach(doc => {
          const playlist = doc.data();
          const div = document.createElement("div");
          div.className = "playlist-item p-4 bg-white rounded shadow hover:shadow-lg cursor-pointer animate__animated animate__fadeIn";
          div.innerHTML = `<h3 class="font-semibold mb-2">${playlist.name}</h3>`;
          div.addEventListener("click", () => { openPlaylist(doc.id, playlist.name); });
          playlistList.appendChild(div);
        });
        hideLoader("playlists-loader");
      });
    }
    async function createPlaylist() {
      const user = auth.currentUser;
      if (!user) return;
      const name = prompt("Digite o nome da nova playlist:");
      if (!name) return;
      const playlistsRef = firestore.collection("users").doc(user.uid).collection("playlists");
      try {
        await playlistsRef.add({
          name: name,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert(`Playlist "${name}" criada com sucesso.`);
      } catch (error) {
        alert("Erro ao criar playlist: " + error.message);
      }
    }

    /*************** Gerenciamento de Músicas na Playlist ***************/
    let currentPlaylistId = null;
    function openPlaylist(playlistId, playlistName) {
      currentPlaylistId = playlistId;
      document.getElementById("playlist-detail-title").textContent = playlistName;
      document.getElementById("playlists-view").classList.add("hidden");
      document.getElementById("playlist-detail-view").classList.remove("hidden");
      loadMusicas();
    }
    function backToPlaylists() {
      document.getElementById("playlist-detail-view").classList.add("hidden");
      document.getElementById("playlists-view").classList.remove("hidden");
    }
    async function loadMusicas() {
      showLoader("musicas-loader");
      const user = auth.currentUser;
      if (!user || !currentPlaylistId) return;
      const musicasRef = firestore.collection("users").doc(user.uid)
                           .collection("playlists").doc(currentPlaylistId)
                           .collection("musicas");
      musicasRef.orderBy("createdAt", "desc").onSnapshot(snapshot => {
        const musicaList = document.getElementById("musica-list");
        musicaList.innerHTML = "";
        snapshot.forEach(doc => {
          const musica = doc.data();
          const div = document.createElement("div");
          div.className = "p-4 bg-white rounded shadow hover:shadow-lg cursor-pointer animate__animated animate__fadeIn";
          div.innerHTML = `<h4 class="font-medium mb-1">${musica.name}</h4>
                           <button class="text-red-500 text-sm" onclick="event.stopPropagation(); deleteMusica('${doc.id}')">Excluir</button>`;
          div.addEventListener("click", () => { playMusic(musica.url, musica.name); });
          musicaList.appendChild(div);
        });
        hideLoader("musicas-loader");
      });
    }
    async function uploadMusic() {
      const user = auth.currentUser;
      if (!user || !currentPlaylistId) return;
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "audio/*,video/*";
      input.onchange = async () => {
        const file = input.files[0];
        if (!file) return;
        // Armazena o arquivo no Storage: users/{uid}/playlists/{playlistId}/{filename}
        const storagePath = `users/${user.uid}/playlists/${currentPlaylistId}/${file.name}`;
        const fileRef = storage.ref(storagePath);
        try {
          await fileRef.put(file);
          const downloadURL = await fileRef.getDownloadURL();
          const musicasRef = firestore.collection("users").doc(user.uid)
                              .collection("playlists").doc(currentPlaylistId)
                              .collection("musicas");
          await musicasRef.add({
            name: file.name,
            url: downloadURL,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          alert("Música enviada com sucesso!");
        } catch (error) {
          alert("Erro ao enviar música: " + error.message);
        }
      };
      input.click();
    }
    async function deleteMusica(musicaId) {
      if (!confirm("Deseja excluir esta música?")) return;
      const user = auth.currentUser;
      if (!user || !currentPlaylistId) return;
      const musicaRef = firestore.collection("users").doc(user.uid)
                           .collection("playlists").doc(currentPlaylistId)
                           .collection("musicas").doc(musicaId);
      try {
        await musicaRef.delete();
        alert("Música excluída com sucesso.");
      } catch (error) {
        alert("Erro ao excluir música: " + error.message);
      }
    }
    function playMusic(url, name) {
      const ext = url.split('.').pop().toLowerCase();
      if (["mp4", "webm", "ogg"].includes(ext)) {
        audioPlayer.pause();
        document.getElementById("video-player").src = url;
        openVideoModal();
        updatePlayerInfo(name, "Vídeo", true);
      } else {
        closeVideoModal();
        audioPlayer.src = url;
        audioPlayer.play();
        updatePlayerInfo(name, "Áudio", false);
        setPlayPauseIcon(true);
      }
    }

    /*************** Player Global ***************/
    // Definido aqui novamente para garantir que seja único
    const audioPlayer = new Audio();
    audioPlayer.volume = 0.5;
    audioPlayer.addEventListener("error", (e) => {
      console.error("Erro no player de áudio:", e);
    });
    function updatePlayerInfo(title, artist, isVideo) {
      document.getElementById("track-name").textContent = title;
      document.getElementById("track-artist").textContent = artist;
      document.getElementById("track-art").src = isVideo 
        ? "https://dummyimage.com/60x60/000/fff.png&text=Video" 
        : "https://dummyimage.com/60x60/000/fff.png&text=Capa";
    }
    function togglePlayPause() {
      const videoModal = document.getElementById("video-modal");
      if (!videoModal.classList.contains("hidden")) {
        const videoPlayer = document.getElementById("video-player");
        if (videoPlayer.paused) { videoPlayer.play(); setPlayPauseIcon(true); }
        else { videoPlayer.pause(); setPlayPauseIcon(false); }
      } else {
        if (!audioPlayer.src) return;
        if (audioPlayer.paused) { audioPlayer.play(); setPlayPauseIcon(true); }
        else { audioPlayer.pause(); setPlayPauseIcon(false); }
      }
    }
    function setPlayPauseIcon(isPlaying) {
      const btn = document.getElementById("playPauseBtn");
      btn.innerHTML = isPlaying ? '<i class="fas fa-pause text-2xl"></i>' : '<i class="fas fa-play text-2xl"></i>';
    }
    function playNext() { /* Implementar se desejado */ }
    function playPrevious() { /* Implementar se desejado */ }
    let isMuted = false;
    function toggleMute() {
      isMuted = !isMuted;
      audioPlayer.muted = isMuted;
      const videoPlayer = document.getElementById("video-player");
      if (videoPlayer) videoPlayer.muted = isMuted;
      document.getElementById("muteIcon").className = isMuted ? "fas fa-volume-mute text-xl" : "fas fa-volume-up text-xl";
    }
    function adjustVolume() {
      const vol = document.getElementById("volume-slider").value;
      audioPlayer.volume = vol;
      const videoPlayer = document.getElementById("video-player");
      if (videoPlayer) videoPlayer.volume = vol;
    }

    /*************** Modal de Vídeo ***************/
    function openVideoModal() {
      const modal = document.getElementById("video-modal");
      modal.classList.remove("hidden");
      modal.classList.add("block", "animate__animated", "animate__fadeIn");
    }
    function closeVideoModal() {
      const modal = document.getElementById("video-modal");
      modal.classList.remove("block");
      modal.classList.add("hidden");
      const videoPlayer = document.getElementById("video-player");
      videoPlayer.pause();
      videoPlayer.currentTime = 0;
    }
    document.addEventListener("keydown", (e) => {
      if (e.code === "Escape") { closeVideoModal(); }
    });
  </script>
</body>
</html>
