<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>NEXUS ‚Ä¢ Decision Intelligence OS (vX)</title>

  <meta name="theme-color" content="#0b0d12" />
  <meta name="color-scheme" content="dark light" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --bg0:#05060a; --bg1:#0a0c12; --bg2:#0e1220;
      --cardA: rgba(255,255,255,.10);
      --cardB: rgba(255,255,255,.05);
      --line: rgba(255,255,255,.11);
      --text:#eaf0ff; --muted:#98a6c7; --muted2:#7e8bb0;
      --a:#69a8ff; --b:#58f2c5; --w:#ffcf5a; --r:#ff5c7a;
      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --shadow2: 0 12px 30px rgba(0,0,0,.40);
      --radius: 18px; --radius2: 22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(105,168,255,.18), transparent 60%),
        radial-gradient(1000px 650px at 85% 20%, rgba(88,242,197,.12), transparent 60%),
        radial-gradient(900px 700px at 50% 110%, rgba(255,92,122,.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    a{color:inherit}
    .app{max-width:1280px;margin:0 auto;padding:16px 14px 28px}
    .topbar{
      position:sticky;top:0;z-index:50;
      padding:12px 0 10px;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      background: linear-gradient(180deg, rgba(10,12,18,.86), rgba(10,12,18,.62));
      border-bottom: 1px solid var(--line);
    }
    .topbarInner{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px;min-width:300px}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:
        radial-gradient(12px 12px at 25% 25%, rgba(255,255,255,.24), transparent 70%),
        linear-gradient(135deg, rgba(105,168,255,.95), rgba(88,242,197,.75));
      border:1px solid rgba(255,255,255,.16); box-shadow: var(--shadow2);
    }
    .brand h1{margin:0;font-size:13px;letter-spacing:.35px;line-height:1.15}
    .brand .sub{margin-top:2px;font-size:12px;color:var(--muted)}
    .meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:9px 11px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06);
      box-shadow:0 10px 22px rgba(0,0,0,.28); font-size:12px;white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.55);box-shadow:0 0 0 4px rgba(255,255,255,.08)}
    .dot.ok{background:var(--b);box-shadow:0 0 0 4px rgba(88,242,197,.14)}
    .dot.warn{background:var(--w);box-shadow:0 0 0 4px rgba(255,207,90,.14)}
    .dot.bad{background:var(--r);box-shadow:0 0 0 4px rgba(255,92,122,.14)}
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06); color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:700;letter-spacing:.2px;
      cursor:pointer; box-shadow:0 10px 25px rgba(0,0,0,.30);
      transition:transform .12s ease,background .12s ease,border-color .12s ease, filter .12s ease;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.22)}
    .btn:active{transform:translateY(0) scale(.98)}
    .btn.primary{
      border-color:rgba(105,168,255,.35);
      background: linear-gradient(135deg, rgba(105,168,255,.22), rgba(88,242,197,.12));
    }
    .btn.ghost{background:transparent;box-shadow:none}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:12px}
    .btn.danger{border-color:rgba(255,92,122,.35);background:linear-gradient(135deg, rgba(255,92,122,.16), rgba(255,255,255,.04))}
    .grid{display:grid;grid-template-columns:380px 1fr;gap:14px;margin-top:14px}
    .panel{
      border-radius:var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
      box-shadow:var(--shadow); overflow:hidden;
      min-width:0;
    }
    .panelHeader{padding:14px 14px 10px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .panelHeader h2{margin:0;font-size:13px;letter-spacing:.3px}
    .panelHeader .hint{font-size:12px;color:var(--muted)}
    .panelBody{padding:12px 12px 14px}
    .tabsTop{
      display:flex; gap:8px; padding:10px 12px 0;
      overflow-x:auto; -webkit-overflow-scrolling:touch;
      scrollbar-width:thin;
    }
    .tabsTop::-webkit-scrollbar{height:8px}
    .tabsTop::-webkit-scrollbar-thumb{background:rgba(255,255,255,.16);border-radius:999px}
    .tab{
      flex:0 0 auto;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05);
      cursor:pointer; font-weight:800; font-size:12px; color:var(--muted);
      user-select:none; white-space:nowrap;
    }
    .tab.active{
      color:var(--text); border-color:rgba(105,168,255,.28);
      background: linear-gradient(135deg, rgba(105,168,255,.18), rgba(88,242,197,.10));
    }

    .searchRow{display:flex;gap:10px;padding:12px}
    .field, textarea.field, select.field{
      width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22); color:var(--text);
      padding:11px 12px; outline:none; box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    textarea.field{min-height:92px;resize:vertical}
    .field::placeholder{color:rgba(152,166,199,.74)}
    .list{padding:0 8px 10px;max-height:calc(100vh - 240px);overflow:auto}
    .item{margin:8px 6px;padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);cursor:pointer;transition:transform .12s ease, background .12s ease, border-color .12s ease}
    .item:hover{transform:translateY(-1px);background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.18)}
    .item.active{border-color:rgba(105,168,255,.30);background:linear-gradient(135deg, rgba(105,168,255,.14), rgba(88,242,197,.08))}
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .itemTitle{margin:0;font-weight:900;font-size:13px;line-height:1.25}
    .badge{font-size:11px;padding:6px 9px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.20);color:var(--muted);white-space:nowrap;display:inline-flex;gap:7px;align-items:center}
    .badge strong{color:var(--text)}
    .itemMeta{margin-top:8px;display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);font-size:12px;color:var(--muted)}
    .chip .miniDot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.45)}
    .mainHero{padding:14px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .mainHero h2{margin:0;font-size:16px;letter-spacing:.25px}
    .mainHero .sub{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.35}
    .heroActions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .cols{display:grid;grid-template-columns: 1.2fr .8fr;gap:14px;padding:14px}
    .card{
      border-radius:var(--radius); border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow:0 14px 40px rgba(0,0,0,.38); overflow:hidden; min-width:0;
    }
    .cardHeader{padding:12px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .cardHeader h3{margin:0;font-size:13px;letter-spacing:.25px}
    .cardBody{padding:12px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .kpi{
      border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);
      padding:10px 10px 9px;
    }
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .v{margin-top:6px;font-family:var(--mono);font-weight:900;font-size:18px;letter-spacing:.2px}
    .kpi .s{margin-top:4px;font-size:12px;color:var(--muted2)}
    .kpi.good .v{color:var(--b)}
    .kpi.warn .v{color:var(--w)}
    .kpi.bad  .v{color:var(--r)}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .tiny{font-size:12px;color:var(--muted);line-height:1.35}

    /* Table grid that MUST scroll horizontally */
    .hscroll{
      overflow-x:auto; overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:thin;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
    }
    .hscroll::-webkit-scrollbar{height:10px}
    .hscroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.16);border-radius:999px}
    table{border-collapse:separate;border-spacing:0;min-width:720px;width:100%}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);border-right:1px solid rgba(255,255,255,.08);text-align:left;font-size:12px}
    th{position:sticky;top:0;background:rgba(15,18,30,.90);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:1}
    th:last-child, td:last-child{border-right:none}
    tr:last-child td{border-bottom:none}
    .cellIn{
      width:72px; padding:8px 8px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22); color:var(--text); outline:none; text-align:center;
      font-family:var(--mono); font-weight:900;
    }
    .cellIn:focus{border-color: rgba(105,168,255,.35); box-shadow: 0 0 0 4px rgba(105,168,255,.10)}
    .rankRow{display:flex;gap:10px;flex-wrap:wrap}
    .rankPill{
      flex:1 1 220px;
      border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.20);
      padding:10px;
    }
    .rankPill .h{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .rankPill .name{font-weight:900}
    .rankPill .score{font-family:var(--mono);font-weight:900}
    .bar{
      height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;margin-top:8px;border:1px solid rgba(255,255,255,.08)
    }
    .bar > i{display:block;height:100%;width:0%;background:linear-gradient(90deg, rgba(105,168,255,.95), rgba(88,242,197,.85))}
    .rankPill.bad i{background:linear-gradient(90deg, rgba(255,92,122,.95), rgba(255,207,90,.70))}
    .rankPill.warn i{background:linear-gradient(90deg, rgba(255,207,90,.95), rgba(105,168,255,.70))}
    .rankPill.good i{background:linear-gradient(90deg, rgba(88,242,197,.95), rgba(105,168,255,.70))}
    .spark{
      height:120px;width:100%;border-radius:16px;border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      display:block;
    }

    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.58);display:none;align-items:center;justify-content:center;padding:14px;z-index:80}
    .modal{
      width:min(1100px, 100%);
      max-height:min(92vh, 860px);
      border-radius:24px;border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(20,24,38,.92), rgba(12,14,20,.92));
      box-shadow: 0 30px 100px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .mHead{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;justify-content:space-between;gap:10px;align-items:center}
    .mHead .t{font-weight:900}
    .mBody{padding:12px 14px;overflow:auto; /* <-- vertical & horizontal if needed */ }
    .mBody{max-height: calc(min(92vh, 860px) - 56px); }
    .mGrid{display:grid;grid-template-columns: 1.1fr .9fr; gap:12px}
    .toolRow{display:flex;gap:10px;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:6px}
    .toolRow::-webkit-scrollbar{height:9px}
    .toolRow::-webkit-scrollbar-thumb{background:rgba(255,255,255,.16);border-radius:999px}
    .seg{display:flex;gap:8px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.12);padding:6px;border-radius:14px;overflow-x:auto}
    .seg button{flex:0 0 auto;border:1px solid transparent;background:transparent;color:var(--muted);padding:10px 10px;border-radius:12px;cursor:pointer;font-weight:900;font-size:12px;white-space:nowrap}
    .seg button.active{color:var(--text);border-color:rgba(105,168,255,.24);background:linear-gradient(135deg, rgba(105,168,255,.16), rgba(88,242,197,.10))}
    .noteBox{border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);padding:10px}
    .flex{display:flex;gap:10px;flex-wrap:wrap}
    .mono{font-family:var(--mono)}
    .miniTitle{font-size:12px;color:var(--muted);font-weight:900;letter-spacing:.2px;margin:0 0 8px}

    /* Responsive */
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
      .cols{grid-template-columns: 1fr}
      .kpis{grid-template-columns:1fr 1fr}
      .brand{min-width: 220px}
    }
    @media (max-width: 520px){
      .kpis{grid-template-columns:1fr}
      .brand h1{font-size:12px}
      .meta{gap:8px}
      .pill{padding:8px 10px}
    }
  
    /* ====== Guia / Tour (coach marks) ====== */
    .tour{ position:fixed; inset:0; z-index:120; display:none; }
    .tour.show{ display:block; }
    .tourDim{ position:absolute; inset:0; background: rgba(0,0,0,.62); backdrop-filter: blur(8px); }
    .tourRing{
      position:absolute; border-radius: 18px;
      border: 2px solid rgba(105,168,255,.85);
      box-shadow: 0 0 0 6px rgba(105,168,255,.14), 0 26px 80px rgba(0,0,0,.65);
      pointer-events:none;
      transition: all .18s var(--ease);
    }
    .tourTip{
      position:absolute;
      width: min(420px, calc(100vw - 32px));
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      box-shadow: 0 25px 80px rgba(0,0,0,.72);
      padding: 12px 12px;
      backdrop-filter: blur(16px);
      transition: all .18s var(--ease);
    }
    .tourTitle{ font-weight: 950; letter-spacing:.2px; font-size: 13px; }
    .tourText{ margin-top: 8px; font-size: 12px; color: var(--muted); line-height: 1.45; }
    .tourBtns{ margin-top: 10px; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }
    .tourBtns .btn{ pointer-events:auto; }

  
/* ===== i4 Ecosystem Gate (non-invasive) ===== */
.ecoPill{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);box-shadow:var(--shadow2)}
.ecoDot{width:9px;height:9px;border-radius:50%;background:#ff5c7a;box-shadow:0 0 0 4px rgba(255,92,122,.15)}
.ecoDot.on{background:#58f2c5;box-shadow:0 0 0 4px rgba(88,242,197,.14)}
.ecoTxt{display:flex;flex-direction:column;line-height:1.1}
.ecoTxt b{font-size:12px}
.ecoTxt span{font-size:11px;color:var(--muted)}
.ecoBar{position:fixed;top:14px;right:14px;z-index:9997;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.ecoBar .btn{cursor:pointer}
.ecoOverlay{display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.62);align-items:center;justify-content:center;padding:18px}
.ecoOverlay.show{display:flex}
.ecoModal{max-width:980px;width:min(980px,96vw);max-height:88vh;overflow:auto;-webkit-overflow-scrolling:touch;border-radius:22px;background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.05));border:1px solid rgba(255,255,255,.12);box-shadow:var(--shadow);backdrop-filter:blur(18px)}
.ecoHead{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:16px 16px 10px}
.ecoHead .t{font-size:16px;font-weight:800}
.ecoHead .s{font-size:12px;color:var(--muted);margin-top:4px}
.ecoBody{padding:14px 16px 16px}
.ecoGrid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:820px){.ecoGrid{grid-template-columns:1fr}}
.ecoCard{border-radius:18px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.10);padding:14px}
.ecoCard label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
.ecoCard input{width:100%;padding:12px 12px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:var(--text);outline:none}
.ecoRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.ecoHr{height:1px;background:rgba(255,255,255,.10);margin:14px 0}
.ecoLock{position:fixed;inset:0;z-index:9996;pointer-events:none;display:none}
.ecoLock.on{display:block;backdrop-filter:blur(10px);background:rgba(0,0,0,.30)}

</style>
</head>
<body>
  <div class="topbar">
    <div class="app">
      <div class="topbarInner">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>NEXUS ‚Ä¢ Decision Intelligence OS</h1>
            <div class="sub" id="subline">um sistema √∫nico de decis√µes (vida + trabalho + tudo)</div>
          </div>
        </div>
        <div class="meta">
          <div class="pill"><span class="dot ok" id="sysDot"></span><span id="sysState">Pronto</span></div>
          <div class="pill"><span>üë§</span><strong id="who">Wilson</strong></div>
          <div class="pill"><span>üïí</span><span id="clock">--:--</span></div>
          <button class="btn small ghost" id="btnHelp">Guia</button>
          <button class="btn small" id="btnImport">Importar</button>
          <button class="btn small" id="btnExport">Exportar</button>
          <button class="btn small primary" id="btnNew">+ Nova decis√£o</button>
        </div>
      </div>
    </div>
  </div>

  <div class="app">
    <div class="grid">
      <!-- Sidebar -->
      <div class="panel">
        <div class="tabsTop" id="tabsLeft">
          <div class="tab active" data-left="decisoes">Decis√µes</div>
          <div class="tab" data-left="biblioteca">Biblioteca</div>
          <div class="tab" data-left="revisoes">Revis√µes</div>
          <div class="tab" data-left="sistema">Sistema</div>
        </div>

        <div class="searchRow">
          <input class="field" id="q" placeholder="Buscar (t√≠tulo, tags, dom√≠nio, status)..." />
          <button class="btn small" id="btnExamples">10 exemplos</button>
        </div>

        <div class="list" id="list"></div>

        <div class="panelBody">
          <div class="tiny" id="leftHint">
            Dica: selecione uma decis√£o. <span class="mono">Ctrl+K</span> abre a busca r√°pida. <span class="mono">Ctrl+E</span> edita.
          </div>
        </div>
      </div>

      <!-- Main -->
      <div class="panel">
        <div class="tabsTop" id="tabsTop">
          <div class="tab active" data-main="cockpit">üöÄ Cockpit</div>
          <div class="tab" data-main="editor">üß† Editor</div>
          <div class="tab" data-main="whatif">üéõÔ∏è What‚Äëif</div>
          <div class="tab" data-main="sensitivity">üåÄ Sensibilidade</div>
          <div class="tab" data-main="timeline">üßæ Trilha</div>
          <div class="tab" data-main="futuro">üß≠ Futuro</div>
          <div class="tab" data-main="academy">üéì Guia & Demo</div>
        </div>

        <div class="mainHero">
          <div>
            <h2 id="mainTitle">Selecione uma decis√£o</h2>
            <div class="sub" id="mainSub">Quando voc√™ escolhe uma decis√£o, o NEXUS calcula score, risco, recomenda√ß√£o e mostra o porqu√™.</div>
          </div>
          <div class="heroActions">
            <button class="btn small" id="btnQuickFill" disabled>‚ö° Preencher exemplo</button>
            <button class="btn small" id="btnRecalc" disabled>‚Üª Recalcular</button>
            <button class="btn small" id="btnStar" disabled>‚òÜ Favoritar</button>
            <button class="btn small" id="btnEdit" disabled>Editar</button>
            <button class="btn small danger" id="btnDel" disabled>Excluir</button>
          </div>
        </div>

        <div id="mainContent"></div>
      </div>
    </div>
  </div>

  <!-- Modal editor -->
  <div class="overlay" id="ov">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Editor">
      <div class="mHead">
        <div class="t" id="mTitle">Editor</div>
        <div class="flex">
          <button class="btn small ghost" id="mClose">Fechar</button>
          <button class="btn small" id="mSave">Salvar</button>
        </div>
      </div>
      <div class="mBody">
        <div class="toolRow" style="margin-bottom:10px">
          <button class="btn small" id="mAuto">Auto: exemplo (A/B)</button>
          <button class="btn small" id="mPreMortem">Pr√©‚Äëmortem</button>
          <button class="btn small" id="mNormalize">Normalizar pesos</button>
          <button class="btn small" id="mReset">Zerar matriz</button>
        </div>

        <div class="mGrid">
          <div class="card">
            <div class="cardHeader"><h3>Identidade</h3><span class="hint">t√≠tulo + dom√≠nio + contexto</span></div>
            <div class="cardBody">
              <div class="row2">
                <div>
                  <label>T√≠tulo</label>
                  <input class="field" id="e_title" />
                </div>
                <div>
                  <label>Dom√≠nio</label>
                  <select class="field" id="e_domain">
                    <option>Profissional</option>
                    <option>Pessoal</option>
                    <option>Sa√∫de</option>
                    <option>Finan√ßas</option>
                    <option>Relacionamentos</option>
                    <option>Aprendizado</option>
                    <option>Projetos</option>
                    <option>Estilo de vida</option>
                    <option>Espiritual</option>
                    <option>Outro</option>
                  </select>
                </div>
              </div>
              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Status</label>
                  <select class="field" id="e_status">
                    <option>Rascunho</option>
                    <option>Em an√°lise</option>
                    <option>Decidida</option>
                    <option>Em execu√ß√£o</option>
                    <option>Revisar</option>
                    <option>Arquivada</option>
                  </select>
                </div>
                <div>
                  <label>Revisar em (dias)</label>
                  <input class="field" id="e_reviewDays" type="number" min="1" step="1" />
                </div>
              </div>
              <div style="margin-top:10px">
                <label>Resumo</label>
                <textarea class="field" id="e_summary"></textarea>
              </div>
              <div style="margin-top:10px">
                <label>Tags (separadas por v√≠rgula)</label>
                <input class="field" id="e_tags" placeholder="ex: carreira, risco, crescimento" />
              </div>
            </div>
          </div>

          <div class="card">
            <div class="cardHeader"><h3>Op√ß√µes</h3><span class="hint">m√≠nimo 2</span></div>
            <div class="cardBody" id="optBox"></div>
          </div>

          <div class="card">
            <div class="cardHeader"><h3>Crit√©rios e pesos</h3><span class="hint">0‚Äì100</span></div>
            <div class="cardBody" id="critBox"></div>
          </div>

          <div class="card">
            <div class="cardHeader"><h3>Matriz + Risco</h3><span class="hint">nota 0‚Äì10, risco 0‚Äì100</span></div>
            <div class="cardBody">
              <div class="seg" id="eMode">
                <button class="active" data-mode="matrix">Matriz</button>
                <button data-mode="risk">Risco</button>
                <button data-mode="notes">Pros/Contras</button>
              </div>
              <div style="margin-top:10px" id="modeArea"></div>
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="tiny">
          O NEXUS mant√©m uma trilha: hip√≥tese ‚Üí evid√™ncia ‚Üí decis√£o ‚Üí revis√£o. Use isso como ‚Äúauditoria‚Äù pessoal (e profissional).
        </div>
      </div>
    </div>
  </div>

<script>
(()=> {
  'use strict';

  /* ----------------------- Utilities ----------------------- */
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
  const clamp = (v,min,max) => Math.max(min, Math.min(max, v));
  const nowISO = () => new Date().toISOString();
  const fmtDate = (iso) => {
    try{
      const d = new Date(iso);
      return d.toLocaleDateString('pt-BR', {year:'numeric', month:'short', day:'2-digit'});
    }catch(e){ return iso||''; }
  };
  const deepClone = (x)=> JSON.parse(JSON.stringify(x));

  /* ----------------------- Storage ----------------------- */
  const KEY = 'NEXUS_DECISION_OS_V1';
  const load = () => {
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){ return null; }
  };
  const save = (state) => {
    localStorage.setItem(KEY, JSON.stringify(state));
  };

  /* ----------------------- Default Data ----------------------- */
  function defaultState(){
    const base = {
      user: { name: 'Wilson', createdAt: nowISO() },
      settings: {
        riskPenalty: 0.55,          // how much risk reduces score
        decisionThresholdGo: 7.6,   // adjusted score threshold
        decisionThresholdMaybe: 6.6,
        biasChecklist: {
          overconfidence: true, sunkCost: true, statusQuo: true, confirmation: true,
          availability: true, socialProof: true, lossAversion: true, optimism: true
        },
        northStar: {
          horizonMonths: 12,
          vision: 'Construir uma vida com decis√µes claras, consistentes e alinhadas com valores.',
          principles: ['Clareza > pressa', 'Evid√™ncia > opini√£o', 'Longo prazo > curto prazo', 'Sa√∫de e energia primeiro'],
          constraints: ['Evitar decis√µes irrevers√≠veis sem ‚Äúper√≠odo de teste‚Äù', 'Limitar risco financeiro desnecess√°rio'],
          antiGoals: ['N√£o virar ref√©m de urg√™ncia alheia', 'N√£o trocar sa√∫de por status']
        }
      },
      decisions: [],
      library: buildLibrary(),
      lastOpenId: null
    };

    // one starter decision
    base.decisions.push(makeDecision({
      title: 'Exemplo (inicial): Trocar de celular este m√™s?',
      domain: 'Finan√ßas',
      status: 'Em an√°lise',
      reviewDays: 30,
      summary: 'Avaliar se a troca agora traz retorno real vs esperar.',
      tags: ['compras','ROI','prioridades'],
      options: ['Trocar agora', 'Esperar 3 meses', 'Comprar usado'],
      criteria: [
        {name:'Impacto real', weight: 25},
        {name:'Custo total', weight: 25},
        {name:'Risco/arrependimento', weight: 15},
        {name:'Prazo/urg√™ncia', weight: 10},
        {name:'Satisfa√ß√£o', weight: 15},
        {name:'Alinhamento', weight: 10},
      ],
      seed: 'A'
    }));

    base.lastOpenId = base.decisions[0].id;
    return base;
  }

  function makeDecision(seed){
    const id = uid();
    const createdAt = nowISO();
    const d = {
      id,
      createdAt,
      updatedAt: createdAt,
      title: seed?.title || 'Nova decis√£o',
      domain: seed?.domain || 'Outro',
      status: seed?.status || 'Rascunho',
      reviewDays: Number(seed?.reviewDays ?? 30),
      summary: seed?.summary || '',
      tags: seed?.tags || [],
      starred: false,

      options: (seed?.options || ['Op√ß√£o A','Op√ß√£o B']).map((n,i)=>({id:uid(), name:n, order:i})),
      criteria: (seed?.criteria || [
        {name:'Crescimento', weight: 25},
        {name:'Aprendizado', weight: 15},
        {name:'Reputa√ß√£o', weight: 15},
        {name:'Autonomia', weight: 15},
        {name:'Estabilidade', weight: 15},
        {name:'Prazer', weight: 15},
      ]).map((c,i)=>({id:uid(), name:c.name, weight:Number(c.weight||0), order:i})),

      matrix: {}, // key: optionId|critId -> 0..10
      risk: {},   // optionId -> {p:0..10, i:0..10}
      notes: { pros: {}, cons: {}, assumptions: '', evidence: '', preMortem: '' },

      trail: [
        {at: createdAt, type:'create', text:'Decis√£o criada.'}
      ]
    };

    autoSeedDecision(d, seed?.seed || 'B');
    return d;
  }

  function autoSeedDecision(d, mode='B'){
    // fill matrix & risk with plausible numbers (0..10), so it's never blank
    const optIds = d.options.map(o=>o.id);
    const critIds = d.criteria.map(c=>c.id);
    const baseA = mode==='A';
    for(const oid of optIds){
      for(const cid of critIds){
        const w = (d.criteria.find(c=>c.id===cid)?.weight || 10);
        let v = 5;
        // differentiate options a bit
        const idxO = d.options.findIndex(o=>o.id===oid);
        const idxC = d.criteria.findIndex(c=>c.id===cid);
        const wiggle = ((idxO+1) * (idxC+2)) % 5; // 0..4
        v = baseA ? (6 + (wiggle-2)*0.8) : (5.6 + (wiggle-2)*0.7);
        // bias: option 0 slightly higher on high weights
        if(idxO===0) v += (w>=20?1.1:0.4);
        if(idxO===1) v -= (w>=20?0.6:0.2);
        v = clamp(Math.round(v*10)/10, 0, 10);
        d.matrix[oid+'|'+cid] = v;
      }
      const idxO = d.options.findIndex(o=>o.id===oid);
      const p = clamp( (baseA? (3 + idxO): (4 + idxO)) , 0,10);
      const i = clamp( (baseA? (4 + idxO): (5 + idxO)) , 0,10);
      d.risk[oid] = {p, i};
      d.notes.pros[oid] = d.notes.pros[oid] || '';
      d.notes.cons[oid] = d.notes.cons[oid] || '';
    }
    if(!d.notes.assumptions) d.notes.assumptions = 'Assuma que o cen√°rio atual se mant√©m por 3‚Äì6 meses.';
    if(!d.notes.evidence) d.notes.evidence = 'Evid√™ncias: custos, tempo, alternativas e impacto no longo prazo.';
  }

  function buildLibrary(){
    // 10 validated examples (pre-filled and with typical outputs)
    const ex = [
      {
        title:'Aceitar promo√ß√£o que aumenta carga e exposi√ß√£o',
        domain:'Profissional', status:'Em an√°lise', reviewDays:21,
        tags:['carreira','lideran√ßa','tradeoff'],
        summary:'Avaliar promo√ß√£o vs sa√∫de, autonomia e aprendizado no longo prazo.',
        options:['Aceitar agora', 'Negociar escopo', 'Recusar e preparar em 6m'],
        criteria:[
          {name:'Crescimento', weight:22},
          {name:'Aprendizado', weight:18},
          {name:'Sa√∫de/Energia', weight:18},
          {name:'Autonomia', weight:14},
          {name:'Renda/benef√≠cios', weight:14},
          {name:'Risco de burnout', weight:14},
        ],
        seed:'A',
        modelNotes:{
          assumptions:'Promo√ß√£o aumentar√° reuni√µes e responsabilidade; voc√™ pode negociar escopo.',
          evidence:'Feedbacks anteriores, carga atual, m√©tricas de performance, tempo de deslocamento.'
        }
      },
      {
        title:'Comprar carro vs manter e investir no atual',
        domain:'Finan√ßas', status:'Em an√°lise', reviewDays:30,
        tags:['ROI','custo total','lifestyle'],
        summary:'Decidir com base em custo total, risco, utilidade e paz mental.',
        options:['Comprar novo/seminew', 'Manter e reformar', 'Trocar por usado mais barato'],
        criteria:[
          {name:'Custo total (TCO)', weight:26},
          {name:'Risco de manuten√ß√£o', weight:16},
          {name:'Qualidade de vida', weight:16},
          {name:'Seguran√ßa', weight:14},
          {name:'Liquidez/Revenda', weight:14},
          {name:'Alinhamento com metas', weight:14},
        ],
        seed:'B'
      },
      {
        title:'Come√ßar um MBA agora ou esperar 1 ano',
        domain:'Aprendizado', status:'Em an√°lise', reviewDays:14,
        tags:['carreira','estudo','tempo'],
        summary:'Comparar impacto na carreira vs custo e energia no curto prazo.',
        options:['Come√ßar agora', 'Esperar 12 meses', 'Fazer curso modular'],
        criteria:[
          {name:'Impacto de carreira', weight:24},
          {name:'Custo/ROI', weight:18},
          {name:'Tempo dispon√≠vel', weight:16},
          {name:'Energia/sa√∫de', weight:14},
          {name:'Networking', weight:14},
          {name:'Risco de desist√™ncia', weight:14},
        ],
        seed:'A'
      },
      {
        title:'Mudar de cidade por oportunidade melhor',
        domain:'Estilo de vida', status:'Em an√°lise', reviewDays:30,
        tags:['mudan√ßa','fam√≠lia','carreira'],
        summary:'Avaliar crescimento vs rede de apoio e custo emocional.',
        options:['Mudar em 60 dias', 'Negociar h√≠brido', 'Ficar e buscar local'],
        criteria:[
          {name:'Crescimento', weight:20},
          {name:'Renda', weight:16},
          {name:'Rede de apoio', weight:16},
          {name:'Custo de vida', weight:16},
          {name:'Qualidade de vida', weight:16},
          {name:'Risco', weight:16},
        ],
        seed:'B'
      },
      {
        title:'Entrar em dieta agressiva vs sustent√°vel',
        domain:'Sa√∫de', status:'Em an√°lise', reviewDays:10,
        tags:['sa√∫de','consist√™ncia'],
        summary:'Escolher a estrat√©gia com maior ader√™ncia e menor efeito rebote.',
        options:['Agressiva 6 semanas', 'Sustent√°vel 12 semanas', 'Recomp + treino'],
        criteria:[
          {name:'Ader√™ncia', weight:24},
          {name:'Resultados', weight:18},
          {name:'Sa√∫de mental', weight:16},
          {name:'Energia/Performance', weight:14},
          {name:'Risco rebote', weight:14},
          {name:'Custo', weight:14},
        ],
        seed:'A'
      },
      {
        title:'Assinar servi√ßo caro que promete produtividade',
        domain:'Finan√ßas', status:'Em an√°lise', reviewDays:7,
        tags:['ferramenta','produtividade','custo'],
        summary:'Decidir por evid√™ncia: tempo economizado e impacto real.',
        options:['Assinar', 'Testar gratuito', 'N√£o assinar'],
        criteria:[
          {name:'Impacto real', weight:28},
          {name:'Custo', weight:20},
          {name:'Ader√™ncia', weight:16},
          {name:'Integra√ß√£o', weight:12},
          {name:'Risco de distra√ß√£o', weight:12},
          {name:'Prazer', weight:12},
        ],
        seed:'B'
      },
      {
        title:'Pedir demiss√£o agora ou preparar transi√ß√£o',
        domain:'Profissional', status:'Em an√°lise', reviewDays:14,
        tags:['risco','transi√ß√£o','carreira'],
        summary:'Balancear seguran√ßa financeira, energia e oportunidade.',
        options:['Sair agora', 'Sair em 90 dias', 'Ficar e renegociar'],
        criteria:[
          {name:'Sa√∫de/Energia', weight:20},
          {name:'Risco financeiro', weight:20},
          {name:'Oportunidade', weight:16},
          {name:'Aprendizado', weight:14},
          {name:'Autonomia', weight:14},
          {name:'Reputa√ß√£o', weight:16},
        ],
        seed:'A'
      },
      {
        title:'Investir em certifica√ß√£o PMP este trimestre',
        domain:'Aprendizado', status:'Em an√°lise', reviewDays:10,
        tags:['certifica√ß√£o','planejamento'],
        summary:'Comparar ROI, tempo de estudo e impacto na posi√ß√£o atual.',
        options:['Fazer agora', 'Fazer em 6 meses', 'Fazer outra certifica√ß√£o'],
        criteria:[
          {name:'Impacto de carreira', weight:26},
          {name:'Tempo', weight:16},
          {name:'Custo', weight:16},
          {name:'Ader√™ncia', weight:14},
          {name:'Satisfa√ß√£o', weight:14},
          {name:'Risco de atrasar', weight:14},
        ],
        seed:'B'
      },
      {
        title:'Relacionamento: conversar sobre limites agora',
        domain:'Relacionamentos', status:'Em an√°lise', reviewDays:7,
        tags:['comunica√ß√£o','limites'],
        summary:'A√ß√£o dif√≠cil, mas pode evitar fric√ß√£o e desgaste.',
        options:['Conversar hoje', 'Planejar e conversar', 'Evitar por enquanto'],
        criteria:[
          {name:'Sa√∫de da rela√ß√£o', weight:28},
          {name:'Clareza', weight:18},
          {name:'Risco de conflito', weight:16},
          {name:'Respeito', weight:14},
          {name:'Energia emocional', weight:12},
          {name:'Longo prazo', weight:12},
        ],
        seed:'A'
      },
      {
        title:'Comprar equipamento caro para hobby/projeto',
        domain:'Projetos', status:'Em an√°lise', reviewDays:14,
        tags:['compra','projeto','prazer'],
        summary:'Decidir se vira ativo ou s√≥ custo parado.',
        options:['Comprar agora', 'Alugar/emprestar', 'Esperar 3 meses'],
        criteria:[
          {name:'Uso real', weight:26},
          {name:'Custo', weight:18},
          {name:'Aprendizado', weight:16},
          {name:'Prazer', weight:14},
          {name:'Risco de n√£o usar', weight:14},
          {name:'Revenda', weight:12},
        ],
        seed:'B'
      },
    ];
    return ex;
  }

  /* ----------------------- Scoring ----------------------- */
  function compute(d, settings){
    const totalW = d.criteria.reduce((s,c)=>s + (Number(c.weight)||0), 0) || 1;
    const W = (c)=> (Number(c.weight)||0) / totalW;

    const optScores = d.options.map(o=>{
      let weighted = 0;
      for(const c of d.criteria){
        const key = o.id+'|'+c.id;
        const v = Number(d.matrix[key] ?? 0);
        weighted += (v/10) * W(c);
      }
      // weighted 0..1 -> 0..10
      const raw = weighted * 10;

      const rp = d.risk[o.id]?.p ?? 0; // 0..10
      const ri = d.risk[o.id]?.i ?? 0; // 0..10
      const risk = clamp((rp*ri), 0, 100); // 0..100
      const penalty = (risk/100) * 10 * (settings.riskPenalty ?? 0.55); // 0.. ~5.5
      const adjusted = clamp(raw - penalty, 0, 10);

      return { optionId:o.id, name:o.name, raw, risk, adjusted, p:rp, i:ri };
    });

    optScores.sort((a,b)=> b.adjusted - a.adjusted);

    const best = optScores[0];
    const second = optScores[1] || best;
    const gap = clamp(best.adjusted - second.adjusted, 0, 10);

    // confidence heuristic: gap + low risk + completeness
    const completeness = completenessScore(d); // 0..1
    const conf = clamp( (gap/2.5) + (1 - best.risk/100) + completeness, 0, 3) / 3; // 0..1
    const confPct = Math.round(conf*100);

    const go = settings.decisionThresholdGo ?? 7.6;
    const maybe = settings.decisionThresholdMaybe ?? 6.6;
    let rec = 'N√ÉO AGORA';
    if(best.adjusted >= go) rec = 'IR';
    else if(best.adjusted >= maybe) rec = 'TALVEZ';

    // reasons: top criteria contributions
    const contrib = d.criteria.map(c=>{
      const key = best.optionId+'|'+c.id;
      const v = Number(d.matrix[key] ?? 0);
      return { name:c.name, weight: Number(c.weight)||0, val:v, points: (v/10) * (Number(c.weight)||0) };
    }).sort((a,b)=> b.points - a.points);

    return {
      totalW,
      rec,
      best,
      gap,
      confPct,
      optScores,
      contrib
    };
  }

  function completenessScore(d){
    // % matrix filled and risks present
    const cells = d.options.length * d.criteria.length;
    let filled = 0;
    for(const o of d.options){
      for(const c of d.criteria){
        const v = d.matrix[o.id+'|'+c.id];
        if(v !== undefined && v !== null && v !== '' && !Number.isNaN(Number(v))) filled++;
      }
    }
    const riskFilled = d.options.filter(o=> d.risk[o.id] && typeof d.risk[o.id].p==='number' && typeof d.risk[o.id].i==='number').length / Math.max(1,d.options.length);
    const matFilled = filled / Math.max(1,cells);
    return clamp(0.7*matFilled + 0.3*riskFilled, 0, 1);
  }

  /* ----------------------- UI State ----------------------- */
  let S = load() || defaultState();
  save(S);

  let leftTab = 'decisoes';
  let mainTab = 'cockpit';
  let activeId = S.lastOpenId || (S.decisions[0]?.id ?? null);

  function setSys(state='Pronto', level='ok'){
    $('#sysState').textContent = state;
    const dot = $('#sysDot');
    dot.classList.remove('ok','warn','bad');
    dot.classList.add(level);
  }

  function tick(){
    const d = new Date();
    $('#clock').textContent = d.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
  }
  tick(); setInterval(tick, 1000*10);

  $('#who').textContent = S.user?.name || 'Usu√°rio';

  /* ----------------------- Render: Left ----------------------- */
  function filteredDecisions(){
    const q = ($('#q').value || '').trim().toLowerCase();
    let arr = [...S.decisions];
    if(leftTab === 'biblioteca'){
      // show library as pseudo decisions
      return [];
    }
    if(leftTab === 'revisoes'){
      // show those due
      const now = Date.now();
      arr = arr.filter(d=>{
        const days = Number(d.reviewDays||0);
        const last = new Date(d.updatedAt || d.createdAt).getTime();
        const due = last + days*86400000;
        return days>0 && due <= now;
      });
    }
    if(q){
      arr = arr.filter(d=>{
        const text = [
          d.title, d.domain, d.status, (d.tags||[]).join(','), d.summary
        ].join(' ').toLowerCase();
        return text.includes(q);
      });
    }
    // favorite first, then updated
    arr.sort((a,b)=>{
      if(!!b.starred !== !!a.starred) return (b.starred?1:0) - (a.starred?1:0);
      return new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime();
    });
    return arr;
  }

  function renderLeft(){
    // tabs
    $$('#tabsLeft .tab').forEach(t=>{
      t.classList.toggle('active', t.dataset.left===leftTab);
    });

    const list = $('#list');
    list.innerHTML = '';

    if(leftTab === 'biblioteca'){
      $('#leftHint').innerHTML = 'Biblioteca: selecione um exemplo e clique em <span class="mono">Importar</span> para virar uma decis√£o sua.';
      S.library.forEach((m, i)=>{
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <div class="itemTop">
            <p class="itemTitle">${m.title}</p>
            <span class="badge">üì¶ <strong>Modelo</strong></span>
          </div>
          <div class="itemMeta">
            <span class="chip"><span class="miniDot"></span>${m.domain}</span>
            <span class="chip"><span class="miniDot"></span>${(m.tags||[]).slice(0,3).join(' ‚Ä¢ ') || '‚Äî'}</span>
          </div>
        `;
        el.addEventListener('click', ()=>{
          openLibrary(i);
        });
        list.appendChild(el);
      });
      return;
    }

    const arr = filteredDecisions();
    $('#leftHint').textContent = leftTab==='revisoes'
      ? 'Revis√µes vencidas: clique e marque como revisada.'
      : 'Dica: Ctrl+E edita ‚Ä¢ Ctrl+Enter recalcula ‚Ä¢ Ctrl+Shift+N cria nova decis√£o';

    if(!arr.length){
      const empty = document.createElement('div');
      empty.className='panelBody';
      empty.innerHTML = `<div class="tiny">Nada aqui ainda. Use <b>+ Nova decis√£o</b> ou clique em <b>10 exemplos</b>.</div>`;
      list.appendChild(empty);
      return;
    }

    for(const d of arr){
      const m = compute(d, S.settings);
      const badge = m.rec==='IR' ? '‚úÖ IR' : (m.rec==='TALVEZ' ? 'üü° TALVEZ' : '‚õî N√ÉO');
      const el = document.createElement('div');
      el.className = 'item' + (d.id===activeId ? ' active' : '');
      el.innerHTML = `
        <div class="itemTop">
          <p class="itemTitle">${escapeHtml(d.title)}</p>
          <span class="badge">${d.starred?'‚òÖ':'‚òÜ'} <strong>${badge}</strong></span>
        </div>
        <div class="itemMeta">
          <span class="chip"><span class="miniDot"></span>${escapeHtml(d.domain)}</span>
          <span class="chip"><span class="miniDot"></span>${escapeHtml(d.status)}</span>
          <span class="chip"><span class="miniDot"></span>${fmtDate(d.updatedAt)}</span>
        </div>
      `;
      el.addEventListener('click', ()=>{
        activeId = d.id;
        S.lastOpenId = activeId;
        save(S);
        renderAll();
      });
      list.appendChild(el);
    }
  }

  function escapeHtml(s){
    return (s??'').toString()
      .replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  /* ----------------------- Render: Main ----------------------- */
  function getActive(){
    return S.decisions.find(x=>x.id===activeId) || null;
  }

  function renderMain(){
    // tabs
    $$('#tabsTop .tab').forEach(t=>{
      t.classList.toggle('active', t.dataset.main===mainTab);
    });

    const d = getActive();
    const main = $('#mainContent');

    const has = !!d;
    $('#btnQuickFill').disabled = !has;
    $('#btnRecalc').disabled = !has;
    $('#btnStar').disabled = !has;
    $('#btnEdit').disabled = !has;
    $('#btnDel').disabled = !has;

    if(!d){
      $('#mainTitle').textContent = 'Selecione uma decis√£o';
      $('#mainSub').textContent = 'Ou clique em ‚Äú10 exemplos‚Äù para carregar uma biblioteca de decis√µes prontas.';
      main.innerHTML = `
        <div class="cols">
          <div class="card">
            <div class="cardHeader"><h3>Como isso muda sua vida</h3><span class="hint">padr√£o de decis√£o</span></div>
            <div class="cardBody">
              <div class="tiny">
                O NEXUS transforma decis√£o em um objeto audit√°vel: <b>op√ß√µes</b> + <b>crit√©rios</b> + <b>notas</b> + <b>risco</b>.
                Voc√™ v√™ <b>resultado num√©rico</b>, ‚Äúporqu√™‚Äù, sensibilidade e revis√£o.
              </div>
              <div class="hr"></div>
              <div class="tiny">
                Comece com 10 exemplos, edite e adapte. Depois, crie suas decis√µes reais.
              </div>
            </div>
          </div>
          <div class="card">
            <div class="cardHeader"><h3>Atalhos</h3><span class="hint">r√°pido</span></div>
            <div class="cardBody">
              <div class="tiny mono">
                Ctrl+Shift+N = nova decis√£o<br/>
                Ctrl+E = editar<br/>
                Ctrl+Enter = recalcular<br/>
                Ctrl+K = foco na busca<br/>
                Ctrl+L = carregar 10 exemplos
              </div>
            </div>
          </div>
        </div>
      `;
      return;
    }

    const M = compute(d, S.settings);
    $('#mainTitle').textContent = d.title;
    $('#mainSub').textContent = `${d.domain} ‚Ä¢ ${d.status} ‚Ä¢ revis√£o: ${d.reviewDays}d ‚Ä¢ atualizado: ${fmtDate(d.updatedAt)}`;
    $('#btnStar').textContent = d.starred ? '‚òÖ Favorito' : '‚òÜ Favoritar';

    if(mainTab==='cockpit'){
      main.innerHTML = renderCockpit(d, M);
      drawSpark($('#spark'), d, M);
      wireCockpit(d);
      return;
    }
    if(mainTab==='whatif'){
      main.innerHTML = renderWhatIf(d, M);
      wireWhatIf(d);
      return;
    }
    if(mainTab==='sensitivity'){
      main.innerHTML = renderSensitivity(d, M);
      wireSensitivity(d);
      return;
    }
    if(mainTab==='academy'){
      main.innerHTML = renderAcademy();
      wireAcademy();
      return;
    }
    if(mainTab==='timeline'){
      main.innerHTML = renderTimeline(d, M);
      wireTimeline(d);
      return;
    }
    if(mainTab==='futuro'){
      main.innerHTML = renderFuturo(d, M);
      wireFuturo(d);
      return;
    }
    // editor shortcut -> open modal
    openEditor(d.id);
  }

  
  function renderAcademy(){
    const rows = [
      {t:'Come√ßo r√°pido (90s)', d:'Crie/seleciona uma decis√£o ‚Üí Editor ‚Üí Matriz (notas) ‚Üí Risco ‚Üí Recalcular ‚Üí Leia ‚ÄúRecomenda√ß√£o‚Äù no Cockpit.'},
      {t:'O que √© ‚ÄúScore ajustado‚Äù', d:'Score bruto (0‚Äì100) menos penalidade por risco (0‚Äì100). A penalidade depende do modo (Balanced/Bold/Conservador‚Ä¶).'},
      {t:'Como confiar no resultado', d:'Use ‚ÄúAssumptions & Evidence‚Äù: cada nota deve ter evid√™ncia. Depois fa√ßa revis√£o em X dias e registre o que aconteceu (Trilha).'},
      {t:'Interatividade', d:'Use ‚ÄúWhat‚Äëif‚Äù para mexer em pesos/risco e ver ranking mudar ao vivo. Use ‚ÄúSensibilidade‚Äù para ver o que mais influencia o resultado.'},
    ];
    const demo = S.decisions.filter(x=>x._isDemo).slice(0,10);
    const demoList = demo.map(x=>`<div class="item" data-open="${x.id}">
      <div class="itemTop"><div class="itemTitle">${escapeHtml(x.title)}</div><span class="badge"><strong>Demo</strong></span></div>
      <div class="itemMeta"><span class="chip"><span class="miniDot"></span>${escapeHtml(x.domain||'‚Äî')}</span><span class="chip"><span class="miniDot"></span>rev ${x.reviewDays||21}d</span></div>
    </div>`).join('') || `<div class="notice">Nenhum demo carregado. Clique em <b>Carregar 10 exemplos</b> no topo ou no Guia.</div>`;

    const map = [
      ['üöÄ Cockpit','KPIs, recomenda√ß√£o, ranking, radar. Onde voc√™ decide.'],
      ['üß† Editor','Onde voc√™ constr√≥i a decis√£o: op√ß√µes, crit√©rios/pesos, matriz, risco, evid√™ncias.'],
      ['üéõÔ∏è What‚Äëif','Simulador ao vivo: mexa em pesos e penalidade de risco.'],
      ['üåÄ Sensibilidade','Tornado: mostra quais crit√©rios mudam o resultado.'],
      ['üßæ Trilha','Auditoria: o que voc√™ mudou, quando revisou, o que aprendeu.'],
      ['üß≠ Futuro','B√∫ssola: princ√≠pios, dire√ß√£o 12 meses, restri√ß√µes. Alinhamento da decis√£o.'],
    ].map(x=>`<div class="notice"><b>${x[0]}</b><br/>${x[1]}</div>`).join('');

    return `
      <div class="card">
        <div class="cardHeader">
          <h3>üéì Guia & Demo</h3>
          <div class="safeX" style="display:flex;gap:8px;align-items:center">
            <button class="btn small primary" id="aStartTour">Iniciar tour</button>
            <button class="btn small" id="aLoad">Carregar 10 exemplos</button>
            <button class="btn small" id="aRunDemo">Rodar demo guiada</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="grid2">
            <div>${rows.map(x=>`<div class="notice" style="margin-bottom:10px"><b>${x.t}</b><br/>${x.d}</div>`).join('')}</div>
            <div>${map}</div>
          </div>
          <div class="hr"></div>
          <div class="notice"><b>Demos (clique para abrir):</b> decis√µes reais de exemplo com notas e risco preenchidos, prontas para ver o resultado num√©rico.</div>
          <div class="hr"></div>
          <div>${demoList}</div>
          <div class="hr"></div>
          <div class="notice">
            <b>Explica√ß√£o dos bot√µes principais</b><br/>
            ‚Ä¢ <b>Editar</b>: abre o modal e mostra a ‚Äúengenharia‚Äù da decis√£o.<br/>
            ‚Ä¢ <b>Auto: preencher</b>: injeta valores plaus√≠veis (√≥timo pra testar).<br/>
            ‚Ä¢ <b>Recalcular</b>: atualiza score, risco e recomenda√ß√£o.<br/>
            ‚Ä¢ <b>Import/Export</b>: backup JSON. Sem servidor ‚Äî tudo local.
          </div>
        </div>
      </div>
    `;
  }

  function wireAcademy(){
    const aLoad = $('#aLoad'); if(aLoad) aLoad.addEventListener('click', ()=>{ loadExamples(true); toast('Exemplos','10 demos carregados'); });
    const aStart = $('#aStartTour'); if(aStart) aStart.addEventListener('click', ()=> startTour());
    const aRun = $('#aRunDemo'); if(aRun) aRun.addEventListener('click', ()=> runGuidedDemo());
    // open demo decision
    $$('#mainContent [data-open]').forEach(el=>{
      el.addEventListener('click', ()=>{
        const id = el.getAttribute('data-open');
        activeId = id; mainTab='cockpit'; renderAll();
        toast('Demo','Abrindo Cockpit da decis√£o‚Ä¶');
      });
    });
  }

  /* ---------- Tour engine ---------- */
  const TOUR = [
    {sel:'#tabsTop', title:'Abas principais', text:'Voc√™ navega por Cockpit, What‚Äëif, Sensibilidade, Trilha e Futuro. No celular, arraste para o lado (scroll).'},
    {sel:'#btnNew', title:'Nova decis√£o', text:'Crie uma decis√£o do zero. Dica: comece pelo Editor ‚Üí Op√ß√µes ‚Üí Crit√©rios ‚Üí Matriz.'},
    {sel:'#btnQuickFill', title:'Auto preencher', text:'Preenche notas e risco com valores plaus√≠veis para testar o fluxo. Depois substitua por evid√™ncias reais.'},
    {sel:'#btnEdit', title:'Editar decis√£o', text:'O ‚Äún√∫cleo‚Äù do app: op√ß√µes, crit√©rios/pesos, matriz, risco, evid√™ncias e pr√©‚Äëmortem.'},
    {sel:'#mainContent', title:'Cockpit', text:'Aqui fica o resultado: score bruto, risco, score ajustado, recomenda√ß√£o e ranking.'},
    {sel:'#q', title:'Busca', text:'Busque por t√≠tulo, dom√≠nio ou tags. Atalho: Ctrl+K.'},
    {sel:'#btnExport', title:'Backup', text:'Exporta JSON para salvar/transferir. Importa para restaurar.'},
  ];
  let tourI = 0;

  function showTour(i){
    const t = TOUR[i]; if(!t) return endTour();
    const el = $(t.sel);
    if(!el){ tourI = Math.min(tourI+1, TOUR.length-1); return showTour(tourI); }

    const ring = $('#tourRing');
    const tip = $('#tourTip');
    const r = el.getBoundingClientRect();

    // ensure visible
    try{ el.scrollIntoView({block:'center', inline:'center', behavior:'smooth'}); }catch(e){}

    // ring
    const pad = 8;
    ring.style.left = (r.left - pad) + 'px';
    ring.style.top  = (r.top  - pad) + 'px';
    ring.style.width  = (r.width + pad*2) + 'px';
    ring.style.height = (r.height + pad*2) + 'px';

    $('#tourTitle').textContent = t.title;
    $('#tourText').textContent = t.text;
    $('#tourMeta').textContent = `Passo ${i+1} de ${TOUR.length}`;

    // place tip
    const vw = window.innerWidth, vh = window.innerHeight;
    const tipW = Math.min(420, vw-32);
    const below = (r.bottom + 14 + 190) < vh;
    let x = Math.min(vw - tipW - 16, Math.max(16, r.left));
    let y = below ? (r.bottom + 14) : Math.max(16, r.top - 14 - 220);
    tip.style.left = x + 'px';
    tip.style.top = y + 'px';
  }

  function startTour(){
    const t = $('#tour');
    t.classList.add('show');
    t.setAttribute('aria-hidden','false');
    tourI = 0;
    showTour(tourI);
  }
  function endTour(){
    const t = $('#tour');
    t.classList.remove('show');
    t.setAttribute('aria-hidden','true');
  }

  function runGuidedDemo(){
    // load demos then pick the first one and open editor and cockpit
    loadExamples(true);
    const demo = S.decisions.find(x=>x._isDemo);
    if(!demo){ toast('Demo','Nenhum exemplo dispon√≠vel','warn'); return; }
    activeId = demo.id;
    mainTab = 'cockpit';
    renderAll();
    toast('Demo','Abrindo decis√£o de exemplo‚Ä¶');
    setTimeout(()=>{ openEditor(demo.id); }, 380);
  }


  function recClass(rec){
    if(rec==='IR') return 'good';
    if(rec==='TALVEZ') return 'warn';
    return 'bad';
  }

  function renderCockpit(d, M){
    const cls = recClass(M.rec);
    const bestName = escapeHtml(M.best?.name || '‚Äî');
    const chips = (d.tags||[]).slice(0,6).map(t=>`<span class="chip"><span class="miniDot"></span>${escapeHtml(t)}</span>`).join('');
    const why = M.contrib.slice(0,4).map(x=>`<div class="chip"><span class="miniDot"></span><b>${escapeHtml(x.name)}</b>&nbsp;${x.val}/10</div>`).join('');
    const ranks = M.optScores.map((o,i)=>{
      const pct = Math.round((o.adjusted/10)*100);
      const c = i===0 ? cls : 'warn';
      return `
        <div class="rankPill ${c}">
          <div class="h">
            <div class="name">${escapeHtml(o.name)}</div>
            <div class="score mono">${o.adjusted.toFixed(2)} <span style="color:var(--muted)">(raw ${o.raw.toFixed(2)} ‚Ä¢ risco ${Math.round(o.risk)})</span></div>
          </div>
          <div class="bar"><i style="width:${pct}%"></i></div>
        </div>
      `;
    }).join('');

    return `
      <div class="cols">
        <div class="card">
          <div class="cardHeader"><h3>Resultado</h3><span class="hint">num√©rico + recomenda√ß√£o</span></div>
          <div class="cardBody">
            <div class="kpis">
              <div class="kpi ${cls}">
                <div class="t">Recomenda√ß√£o</div>
                <div class="v">${M.rec}</div>
                <div class="s">melhor op√ß√£o: ${bestName}</div>
              </div>
              <div class="kpi">
                <div class="t">Score ajustado</div>
                <div class="v">${M.best.adjusted.toFixed(2)}</div>
                <div class="s">0‚Äì10 (risco penaliza)</div>
              </div>
              <div class="kpi">
                <div class="t">Risco (prob√óimpacto)</div>
                <div class="v">${Math.round(M.best.risk)}</div>
                <div class="s">0‚Äì100</div>
              </div>
              <div class="kpi">
                <div class="t">Confian√ßa</div>
                <div class="v">${M.confPct}%</div>
                <div class="s">gap + risco + completude</div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="miniTitle">Por qu√™ (top fatores)</div>
            <div class="flex">${why}</div>

            <div class="hr"></div>

            <div class="miniTitle">Tags</div>
            <div class="flex">${chips || '<span class="tiny">‚Äî</span>'}</div>

            <div class="hr"></div>

            <div class="tiny">
              <b>Nota:</b> isso n√£o √© ‚Äúverdade absoluta‚Äù. √â uma m√°quina de clareza.
              O poder est√° no processo: crit√©rios, evid√™ncias, risco e revis√£o.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader"><h3>Radar</h3><span class="hint">vis√£o r√°pida</span></div>
          <div class="cardBody">
            <canvas class="spark" id="spark" width="900" height="320"></canvas>
            <div class="hr"></div>
            <div class="miniTitle">Ranking (ajustado)</div>
            <div class="rankRow">${ranks}</div>
          </div>
        </div>

        <div class="card" style="grid-column: 1 / -1;">
          <div class="cardHeader"><h3>Matriz (op√ß√£o √ó crit√©rio)</h3><span class="hint">rola para o lado se precisar</span></div>
          <div class="cardBody">
            ${renderMatrixReadOnly(d)}
          </div>
        </div>
      </div>
    `;
  }

  function renderMatrixReadOnly(d){
    const th = d.criteria.map(c=> `<th>${escapeHtml(c.name)}<div style="color:var(--muted);font-size:11px">peso ${Number(c.weight)||0}</div></th>`).join('');
    const rows = d.options.map(o=>{
      const tds = d.criteria.map(c=>{
        const v = Number(d.matrix[o.id+'|'+c.id] ?? 0);
        return `<td><span class="mono" style="font-weight:900">${v.toFixed(1)}</span></td>`;
      }).join('');
      const r = d.risk[o.id] || {p:0,i:0};
      const risk = clamp((r.p*r.i),0,100);
      return `<tr>
        <td style="position:sticky;left:0;background:rgba(15,18,30,.92);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);font-weight:900">${escapeHtml(o.name)}</td>
        ${tds}
        <td><span class="mono" style="font-weight:900">${Math.round(risk)}</span> <span style="color:var(--muted)">(p${r.p}/i${r.i})</span></td>
      </tr>`;
    }).join('');

    return `
      <div class="hscroll">
        <table>
          <thead><tr>
            <th style="position:sticky;left:0;z-index:2">Op√ß√£o</th>
            ${th}
            <th>Risco</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }

  function drawSpark(canvas, d, M){
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    // background grid
    ctx.globalAlpha = 0.35;
    for(let i=0;i<6;i++){
      const y = 20 + i*(h-40)/5;
      ctx.fillStyle = 'rgba(255,255,255,.06)';
      ctx.fillRect(20, y, w-40, 1);
    }
    ctx.globalAlpha = 1;

    // plot adjusted score per option as bars
    const padX = 26, padY = 32;
    const bw = (w - padX*2) / Math.max(1, M.optScores.length);
    M.optScores.forEach((o, idx)=>{
      const x = padX + idx*bw + 6;
      const hh = (o.adjusted/10) * (h - padY*2);
      // bar
      const grad = ctx.createLinearGradient(0,0,0,h);
      grad.addColorStop(0,'rgba(105,168,255,.95)');
      grad.addColorStop(1,'rgba(88,242,197,.55)');
      ctx.fillStyle = grad;
      ctx.fillRect(x, h-padY-hh, bw-12, hh);
      // labels
      ctx.fillStyle = 'rgba(234,240,255,.85)';
      ctx.font = 'bold 18px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      ctx.fillText(o.adjusted.toFixed(1), x, h-padY-hh-8);
      ctx.fillStyle = 'rgba(152,166,199,.9)';
      ctx.font = '12px -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Helvetica, Arial';
      ctx.fillText(o.name.slice(0,10), x, h-10);
    });
  }

  function renderWhatIf(d, M){
    return `
      <div class="cols">
        <div class="card">
          <div class="cardHeader"><h3>What‚Äëif (controle ao vivo)</h3><span class="hint">pesos + risco</span></div>
          <div class="cardBody">
            <div class="tiny">Ajuste os pesos ou a penalidade de risco e veja o ranking mudar em tempo real.</div>
            <div class="hr"></div>

            <label>Penalidade do risco (0.0‚Äì1.0)</label>
            <input class="field mono" type="range" id="wf_riskPenalty" min="0" max="1" step="0.01" value="${S.settings.riskPenalty}">
            <div class="tiny">Atual: <span class="mono" id="wf_riskPenaltyV">${S.settings.riskPenalty.toFixed(2)}</span></div>

            <div class="hr"></div>

            <div class="miniTitle">Pesos (arraste)</div>
            <div id="wf_weights"></div>

            <div class="hr"></div>

            <button class="btn small" id="wf_reset">Reset (voltar ao salvo)</button>
            <button class="btn small primary" id="wf_apply">Aplicar mudan√ßas</button>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader"><h3>Ranking ao vivo</h3><span class="hint">antes / depois</span></div>
          <div class="cardBody">
            <div id="wf_live"></div>
          </div>
        </div>
      </div>
    `;
  }

  function renderSensitivity(d, M){
    // tornado: vary each criterion weight +/- 20% and see impact on best option adjusted
    return `
      <div class="cols">
        <div class="card">
          <div class="cardHeader"><h3>Sensibilidade (Tornado)</h3><span class="hint">o que mais influencia</span></div>
          <div class="cardBody">
            <div class="tiny">Para cada crit√©rio, variamos o peso e medimos o impacto no score da melhor op√ß√£o.</div>
            <div class="hr"></div>
            <div id="sensList"></div>
          </div>
        </div>
        <div class="card">
          <div class="cardHeader"><h3>Explica√ß√£o</h3><span class="hint">como ler</span></div>
          <div class="cardBody">
            <div class="tiny">
              Crit√©rios no topo do tornado s√£o os que mais mudam o resultado quando o peso oscila.
              Use isso para checar se voc√™ est√° supervalorizando algo sem perceber.
            </div>
            <div class="hr"></div>
            <div class="noteBox">
              <div class="miniTitle">Checklist anti‚Äëvieses (r√°pido)</div>
              <div id="biasBox"></div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderTimeline(d, M){
    const rows = (d.trail||[]).slice().reverse().map(e=>`
      <div class="noteBox" style="margin-bottom:10px">
        <div class="flex" style="justify-content:space-between;align-items:center">
          <div><b>${escapeHtml(e.type)}</b> <span style="color:var(--muted)">‚Ä¢ ${fmtDate(e.at)}</span></div>
          <button class="btn small ghost" data-deltrail="${escapeHtml(e.at)}">remover</button>
        </div>
        <div class="tiny" style="margin-top:8px">${escapeHtml(e.text||'')}</div>
      </div>
    `).join('');

    return `
      <div class="cols">
        <div class="card">
          <div class="cardHeader"><h3>Trilha (auditoria)</h3><span class="hint">hip√≥tese ‚Üí evid√™ncia ‚Üí a√ß√£o</span></div>
          <div class="cardBody">
            <div class="row2">
              <div>
                <label>Tipo</label>
                <select class="field" id="tl_type">
                  <option value="note">note</option>
                  <option value="evidence">evidence</option>
                  <option value="assumption">assumption</option>
                  <option value="decision">decision</option>
                  <option value="review">review</option>
                </select>
              </div>
              <div>
                <label>Data</label>
                <input class="field" id="tl_at" type="date"/>
              </div>
            </div>
            <div style="margin-top:10px">
              <label>Texto</label>
              <textarea class="field" id="tl_text" placeholder="O que mudou? Qual evid√™ncia entrou? Qual hip√≥tese foi refutada?"></textarea>
            </div>
            <div style="margin-top:10px" class="flex">
              <button class="btn small primary" id="tl_add">Adicionar</button>
              <button class="btn small" id="tl_markReview">Marcar revisada hoje</button>
            </div>
            <div class="hr"></div>
            ${rows || '<div class="tiny">Sem eventos ainda.</div>'}
          </div>
        </div>

        <div class="card">
          <div class="cardHeader"><h3>Resumo da decis√£o</h3><span class="hint">estado atual</span></div>
          <div class="cardBody">
            <div class="kpis">
              <div class="kpi ${recClass(M.rec)}"><div class="t">Recomenda√ß√£o</div><div class="v">${M.rec}</div><div class="s">${escapeHtml(M.best.name)}</div></div>
              <div class="kpi"><div class="t">Score</div><div class="v">${M.best.adjusted.toFixed(2)}</div><div class="s">ajustado</div></div>
              <div class="kpi"><div class="t">Risco</div><div class="v">${Math.round(M.best.risk)}</div><div class="s">0‚Äì100</div></div>
              <div class="kpi"><div class="t">Confian√ßa</div><div class="v">${M.confPct}%</div><div class="s">heur√≠stica</div></div>
            </div>
            <div class="hr"></div>
            <div class="miniTitle">Resumo</div>
            <div class="tiny">${escapeHtml(d.summary||'‚Äî')}</div>
            <div class="hr"></div>
            <div class="miniTitle">Evid√™ncia atual</div>
            <div class="tiny">${escapeHtml(d.notes?.evidence||'‚Äî')}</div>
          </div>
        </div>
      </div>
    `;
  }

  function renderFuturo(d, M){
    const ns = S.settings.northStar;
    const p = (ns.principles||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join('');
    const c = (ns.constraints||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join('');
    const a = (ns.antiGoals||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join('');
    return `
      <div class="cols">
        <div class="card">
          <div class="cardHeader"><h3>B√∫ssola (12 meses)</h3><span class="hint">norte + limites</span></div>
          <div class="cardBody">
            <label>Vis√£o</label>
            <textarea class="field" id="ns_vision">${escapeHtml(ns.vision||'')}</textarea>
            <div class="row2" style="margin-top:10px">
              <div class="noteBox">
                <div class="miniTitle">Princ√≠pios</div>
                <textarea class="field" id="ns_principles" style="min-height:120px">${(ns.principles||[]).join('\n')}</textarea>
              </div>
              <div class="noteBox">
                <div class="miniTitle">Restri√ß√µes</div>
                <textarea class="field" id="ns_constraints" style="min-height:120px">${(ns.constraints||[]).join('\n')}</textarea>
              </div>
            </div>
            <div style="margin-top:10px" class="noteBox">
              <div class="miniTitle">Anti‚Äëobjetivos</div>
              <textarea class="field" id="ns_antigoals" style="min-height:110px">${(ns.antiGoals||[]).join('\n')}</textarea>
            </div>
            <div class="hr"></div>
            <button class="btn small primary" id="ns_save">Salvar b√∫ssola</button>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader"><h3>Alinhamento desta decis√£o</h3><span class="hint">score de alinhamento</span></div>
          <div class="cardBody">
            <div class="tiny">
              Marque: a decis√£o respeita suas restri√ß√µes? fortalece princ√≠pios? evita anti‚Äëobjetivos?
              Isso vira um ‚Äúmeta‚Äëcrit√©rio‚Äù impl√≠cito.
            </div>
            <div class="hr"></div>
            <div class="noteBox">
              <div class="miniTitle">Checklist</div>
              <div id="alignBox"></div>
            </div>
            <div class="hr"></div>
            <button class="btn small" id="mkAligned">Criar nova decis√£o alinhada</button>
            <button class="btn small" id="mkPremortem">Criar decis√£o (pr√©‚Äëmortem)</button>
          </div>
        </div>
      </div>
    `;
  }

  /* ----------------------- Wire main tabs ----------------------- */
  function wireCockpit(d){
    // nothing special besides buttons
  }

  function wireWhatIf(d){
    const wWrap = $('#wf_weights');
    const local = deepClone(d);
    const baseSettings = deepClone(S.settings);

    function renderWeights(){
      wWrap.innerHTML = '';
      local.criteria.forEach((c, idx)=>{
        const row = document.createElement('div');
        row.className = 'noteBox';
        row.style.marginBottom = '10px';
        row.innerHTML = `
          <div class="flex" style="justify-content:space-between;align-items:center">
            <div><b>${escapeHtml(c.name)}</b> <span style="color:var(--muted)">peso</span></div>
            <div class="mono"><span id="w_${c.id}">${Number(c.weight)||0}</span></div>
          </div>
          <input class="field mono" type="range" min="0" max="100" step="1" value="${Number(c.weight)||0}" data-w="${c.id}">
        `;
        row.querySelector('input').addEventListener('input', (ev)=>{
          const v = Number(ev.target.value);
          const cid = ev.target.dataset.w;
          const cc = local.criteria.find(x=>x.id===cid);
          cc.weight = v;
          row.querySelector('#w_'+cid).textContent = v;
          renderLive();
        });
        wWrap.appendChild(row);
      });
    }

    function renderLive(){
      const tmp = compute(local, { ...S.settings, riskPenalty: Number($('#wf_riskPenalty').value) });
      const html = tmp.optScores.map((o,i)=>{
        const cls = i===0 ? recClass(tmp.rec) : 'warn';
        const pct = Math.round((o.adjusted/10)*100);
        return `
          <div class="rankPill ${cls}" style="margin-bottom:10px">
            <div class="h">
              <div class="name">${escapeHtml(o.name)}</div>
              <div class="score mono">${o.adjusted.toFixed(2)} <span style="color:var(--muted)">(raw ${o.raw.toFixed(2)} ‚Ä¢ risco ${Math.round(o.risk)})</span></div>
            </div>
            <div class="bar"><i style="width:${pct}%"></i></div>
          </div>
        `;
      }).join('');
      $('#wf_live').innerHTML = html + `<div class="tiny">Recomenda√ß√£o: <b>${tmp.rec}</b> ‚Ä¢ Confian√ßa ${tmp.confPct}%</div>`;
    }

    const rp = $('#wf_riskPenalty');
    rp.addEventListener('input', ()=>{
      $('#wf_riskPenaltyV').textContent = Number(rp.value).toFixed(2);
      renderLive();
    });

    $('#wf_reset').addEventListener('click', ()=>{
      // restore from saved
      const saved = getActive();
      Object.assign(local, deepClone(saved));
      rp.value = String(baseSettings.riskPenalty);
      $('#wf_riskPenaltyV').textContent = Number(rp.value).toFixed(2);
      renderWeights(); renderLive();
    });

    $('#wf_apply').addEventListener('click', ()=>{
      const real = getActive();
      if(!real) return;
      real.criteria = deepClone(local.criteria);
      S.settings.riskPenalty = Number($('#wf_riskPenalty').value);
      pushTrail(real, 'note', 'What‚Äëif aplicado: pesos e penalidade de risco atualizados.');
      touch(real);
      save(S);
      setSys('Aplicado', 'ok');
      renderAll();
      setTimeout(()=>setSys('Pronto','ok'), 700);
    });

    renderWeights(); renderLive();
  }

  function wireSensitivity(d, M){
    const box = $('#sensList');
    const base = compute(d, S.settings).best.adjusted;
    const items = [];

    const total = d.criteria.reduce((s,c)=>s+(Number(c.weight)||0),0) || 1;

    for(const c of d.criteria){
      const w0 = Number(c.weight)||0;
      const delta = Math.max(2, Math.round(w0*0.2));
      const up = clamp(w0 + delta, 0, 100);
      const down = clamp(w0 - delta, 0, 100);

      const dUp = deepClone(d);
      dUp.criteria.find(x=>x.id===c.id).weight = up;
      const upScore = compute(dUp, S.settings).best.adjusted;

      const dDn = deepClone(d);
      dDn.criteria.find(x=>x.id===c.id).weight = down;
      const dnScore = compute(dDn, S.settings).best.adjusted;

      const impact = Math.max(Math.abs(upScore-base), Math.abs(dnScore-base));
      items.push({name:c.name, impact, upScore, dnScore, w0, up, down});
    }

    items.sort((a,b)=>b.impact-a.impact);

    box.innerHTML = items.map(it=>{
      const pct = clamp(Math.round((it.impact/2.5)*100),0,100);
      return `
        <div class="rankPill" style="margin-bottom:10px">
          <div class="h">
            <div class="name">${escapeHtml(it.name)}</div>
            <div class="score mono">¬±${it.impact.toFixed(2)} <span style="color:var(--muted)">(w ${it.w0} ‚Üí ${it.down}/${it.up})</span></div>
          </div>
          <div class="bar"><i style="width:${pct}%"></i></div>
          <div class="tiny" style="margin-top:8px;color:var(--muted)">
            score melhor op√ß√£o: ${it.dnScore.toFixed(2)} (‚Üì) ‚Ä¢ ${it.upScore.toFixed(2)} (‚Üë)
          </div>
        </div>
      `;
    }).join('');

    const bias = S.settings.biasChecklist;
    const biasBox = $('#biasBox');
    const items2 = [
      ['overconfidence','Excesso de confian√ßa','Estou assumindo que ‚Äúvai dar certo‚Äù sem evid√™ncia?'],
      ['sunkCost','Custo afundado','Estou preso ao que j√° investi (tempo/dinheiro) sem sentido?'],
      ['statusQuo','Status quo','Estou evitando mudan√ßa s√≥ por conforto?'],
      ['confirmation','Confirma√ß√£o','S√≥ estou buscando provas do que eu j√° acredito?'],
      ['availability','Disponibilidade','Estou supervalorizando o que aconteceu ‚Äúrecentemente‚Äù?'],
      ['socialProof','Prova social','Estou decidindo por opini√£o dos outros?'],
      ['lossAversion','Avers√£o √† perda','Estou fugindo de perder algo e ignorando ganhos maiores?'],
      ['optimism','Otimismo','Estou subestimando risco e tempo?'],
    ];
    biasBox.innerHTML = items2.map(([k,t,q])=>{
      const on = !!bias[k];
      return `
        <div class="noteBox" style="margin-bottom:8px">
          <div class="flex" style="justify-content:space-between;align-items:center">
            <div><b>${t}</b><div class="tiny">${q}</div></div>
            <label style="display:flex;gap:8px;align-items:center;margin:0">
              <input type="checkbox" ${on?'checked':''} data-bias="${k}" />
              <span class="tiny">${on?'ativado':'desativado'}</span>
            </label>
          </div>
        </div>
      `;
    }).join('');

    $$('input[data-bias]').forEach(ch=>{
      ch.addEventListener('change', ()=>{
        const k = ch.dataset.bias;
        S.settings.biasChecklist[k] = ch.checked;
        save(S);
      });
    });
  }

  function wireTimeline(d){
    const inp = $('#tl_at');
    // set today
    const today = new Date();
    inp.value = today.toISOString().slice(0,10);

    $('#tl_add').addEventListener('click', ()=>{
      const type = $('#tl_type').value;
      const at = new Date($('#tl_at').value || today.toISOString().slice(0,10)).toISOString();
      const text = ($('#tl_text').value || '').trim();
      if(!text){ setSys('Texto vazio','warn'); return; }
      d.trail = d.trail || [];
      d.trail.push({at, type, text});
      touch(d);
      save(S);
      renderAll();
      setSys('Adicionado','ok'); setTimeout(()=>setSys('Pronto','ok'), 700);
    });

    $('#tl_markReview').addEventListener('click', ()=>{
      pushTrail(d, 'review', 'Revis√£o conclu√≠da e estado reavaliado.');
      touch(d); save(S); renderAll();
    });

    $$('[data-deltrail]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const at = b.dataset.deltrail;
        d.trail = (d.trail||[]).filter(e=> e.at!==at);
        touch(d); save(S); renderAll();
      });
    });
  }

  function wireFuturo(d){
    // alignment checklist (3 items)
    const box = $('#alignBox');
    const state = d._align || {principles:true, constraints:true, antiGoals:true};
    d._align = state;

    const rows = [
      ['principles','Fortalece princ√≠pios','Esta decis√£o refor√ßa pelo menos 1 princ√≠pio?'],
      ['constraints','Respeita restri√ß√µes','Ela viola alguma restri√ß√£o? (se sim, cuidado)'],
      ['antiGoals','Evita anti‚Äëobjetivos','Ela n√£o te leva para os anti‚Äëobjetivos?'],
    ];
    box.innerHTML = rows.map(([k,t,q])=>{
      const on = !!state[k];
      return `
        <div class="noteBox" style="margin-bottom:8px">
          <div class="flex" style="justify-content:space-between;align-items:center">
            <div><b>${t}</b><div class="tiny">${q}</div></div>
            <label style="display:flex;gap:8px;align-items:center;margin:0">
              <input type="checkbox" ${on?'checked':''} data-align="${k}" />
              <span class="tiny">${on?'ok':'rever'}</span>
            </label>
          </div>
        </div>
      `;
    }).join('');

    $$('input[data-align]').forEach(ch=>{
      ch.addEventListener('change', ()=>{
        const k = ch.dataset.align;
        d._align[k] = ch.checked;
        touch(d); save(S);
      });
    });

    $('#ns_save').addEventListener('click', ()=>{
      const ns = S.settings.northStar;
      ns.vision = $('#ns_vision').value.trim();
      ns.principles = ($('#ns_principles').value||'').split('\n').map(s=>s.trim()).filter(Boolean);
      ns.constraints = ($('#ns_constraints').value||'').split('\n').map(s=>s.trim()).filter(Boolean);
      ns.antiGoals = ($('#ns_antigoals').value||'').split('\n').map(s=>s.trim()).filter(Boolean);
      save(S);
      setSys('B√∫ssola salva','ok'); setTimeout(()=>setSys('Pronto','ok'), 700);
    });

    $('#mkAligned').addEventListener('click', ()=>{
      const base = makeDecision({
        title: 'Nova decis√£o alinhada',
        domain: d.domain,
        status: 'Em an√°lise',
        reviewDays: 14,
        summary: 'Criada a partir da b√∫ssola (princ√≠pios + restri√ß√µes).',
        tags: ['alinhamento','b√∫ssola'],
        options: ['Op√ß√£o A','Op√ß√£o B','Op√ß√£o C'],
        criteria: [
          {name:'Alinhamento (b√∫ssola)', weight: 24},
          {name:'Impacto real', weight: 20},
          {name:'Risco', weight: 16},
          {name:'Tempo', weight: 14},
          {name:'Custo', weight: 14},
          {name:'Satisfa√ß√£o', weight: 12},
        ],
        seed:'A'
      });
      base.notes.assumptions = 'Assuma que voc√™ seguir√° a b√∫ssola (princ√≠pios + restri√ß√µes).';
      base.notes.evidence = 'Liste evid√™ncias concretas (dados, custos, prazos, alternativas).';
      pushTrail(base,'create','Criada a partir da B√∫ssola.');
      S.decisions.unshift(base);
      activeId = base.id; S.lastOpenId = activeId;
      save(S); renderAll();
      setSys('Criada','ok'); setTimeout(()=>setSys('Pronto','ok'), 700);
    });

    $('#mkPremortem').addEventListener('click', ()=>{
      const base = makeDecision({
        title: 'Nova decis√£o (pr√©‚Äëmortem)',
        domain: d.domain,
        status: 'Em an√°lise',
        reviewDays: 10,
        summary: 'Pr√©‚Äëmortem: imagine que deu errado e identifique por qu√™.',
        tags: ['pr√©-mortem','risco'],
        options: ['Op√ß√£o A','Op√ß√£o B'],
        criteria: [
          {name:'Robustez', weight: 24},
          {name:'Risco', weight: 20},
          {name:'Impacto', weight: 18},
          {name:'Custo', weight: 14},
          {name:'Tempo', weight: 12},
          {name:'Reversibilidade', weight: 12},
        ],
        seed:'B'
      });
      base.notes.preMortem = 'Imagine que falhou. Liste 5 raz√µes. Para cada uma, crie mitiga√ß√£o.';
      pushTrail(base,'create','Criada como pr√©‚Äëmortem.');
      S.decisions.unshift(base);
      activeId = base.id; S.lastOpenId = activeId;
      save(S); renderAll();
      openEditor(base.id);
    });
  }

  /* ----------------------- Editor Modal ----------------------- */
  let editingId = null;
  let editingMode = 'matrix';

  function openEditor(id){
    const d = S.decisions.find(x=>x.id===id);
    if(!d) return;
    editingId = id;
    $('#ov').style.display = 'flex';
    $('#mTitle').textContent = 'Editor ‚Ä¢ ' + d.title;

    // identity
    $('#e_title').value = d.title;
    $('#e_domain').value = d.domain;
    $('#e_status').value = d.status;
    $('#e_reviewDays').value = Number(d.reviewDays||30);
    $('#e_summary').value = d.summary||'';
    $('#e_tags').value = (d.tags||[]).join(', ');

    renderOptBox(d);
    renderCritBox(d);
    setEditMode('matrix', d);
    setSys('Editando','warn');
  }

  
  function openGuide(){
    const ov = $('#ovGuide');
    $('#gBody').innerHTML = `
      <div class="grid2">
        <div class="notice">
          <b>Como usar (fluxo recomendado)</b><br/>
          1) Abra <b>Editor</b> ‚Üí defina <b>Op√ß√µes</b><br/>
          2) Crie <b>Crit√©rios</b> + pesos<br/>
          3) Preencha a <b>Matriz</b> (notas 0‚Äì10) + <b>Risco</b><br/>
          4) Volte ao <b>Cockpit</b> e leia: Score bruto, risco, score ajustado e recomenda√ß√£o.<br/>
          5) Use <b>What‚Äëif</b> e <b>Sensibilidade</b> para checar robustez.<br/>
          6) Registre evid√™ncias e marque revis√£o na <b>Trilha</b>.
        </div>
        <div class="notice">
          <b>Demonstra√ß√£o</b><br/>
          Clique em <b>Carregar 10 exemplos</b> e depois abra qualquer demo. Voc√™ ver√° n√∫meros preenchidos na matriz + resultado final num√©rico.<br/><br/>
          <b>Tour</b>: destaca bot√µes/abas e explica para que servem (√≥timo no mobile).
        </div>
      </div>
      <div class="hr"></div>
      <div class="notice"><b>Explica√ß√£o r√°pida dos resultados</b><br/>
        ‚Ä¢ <b>Score bruto</b>: m√©dia ponderada das notas (0‚Äì10) √ó 10.<br/>
        ‚Ä¢ <b>Risco</b>: prob √ó impacto (0‚Äì100).<br/>
        ‚Ä¢ <b>Score ajustado</b>: Score bruto ‚àí (penalidade por risco, depende do modo).<br/>
        ‚Ä¢ <b>Recomenda√ß√£o</b>: IR / TALVEZ / N√ÉO AGORA (com base em score ajustado + gap do 2¬∫ lugar).
      </div>
      <div class="hr"></div>
      <div class="notice"><b>Atalhos</b><br/>
        Ctrl+Shift+N nova decis√£o ‚Ä¢ Ctrl+E editar ‚Ä¢ Ctrl+Enter recalcular ‚Ä¢ Ctrl+K buscar ‚Ä¢ Ctrl+L carregar exemplos ‚Ä¢ Esc fechar editor
      </div>
    `;
    ov.classList.add('show');
    ov.setAttribute('aria-hidden','false');
  }
  function closeGuide(){
    const ov = $('#ovGuide');
    ov.classList.remove('show');
    ov.setAttribute('aria-hidden','true');
  }


  function closeEditor(){
    $('#ov').style.display = 'none';
    editingId = null;
    setSys('Pronto','ok');
  }

  function setEditMode(mode, d){
    editingMode = mode;
    $$('#eMode button').forEach(b=> b.classList.toggle('active', b.dataset.mode===mode));
    const area = $('#modeArea');
    if(mode==='matrix'){
      area.innerHTML = renderMatrixEditor(d);
      wireMatrixEditor(d);
    }else if(mode==='risk'){
      area.innerHTML = renderRiskEditor(d);
      wireRiskEditor(d);
    }else{
      area.innerHTML = renderNotesEditor(d);
      wireNotesEditor(d);
    }
  }

  function renderOptBox(d){
    const box = $('#optBox');
    box.innerHTML = '';
    d.options.forEach((o, idx)=>{
      const row = document.createElement('div');
      row.className = 'noteBox';
      row.style.marginBottom = '10px';
      row.innerHTML = `
        <label>Op√ß√£o ${idx+1}</label>
        <div class="flex" style="align-items:center">
          <input class="field" value="${escapeHtml(o.name)}" data-opt="${o.id}" />
          <button class="btn small danger" data-opt-del="${o.id}">‚àí</button>
        </div>
      `;
      box.appendChild(row);
    });
    const add = document.createElement('button');
    add.className = 'btn small';
    add.textContent = '+ Adicionar op√ß√£o';
    add.addEventListener('click', ()=>{
      d.options.push({id:uid(), name:'Nova op√ß√£o', order:d.options.length});
      autoSeedDecision(d,'B'); // ensure keys exist
      renderOptBox(d);
      setEditMode(editingMode, d);
    });
    box.appendChild(add);

    // wire
    $$('input[data-opt]').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const oid = inp.dataset.opt;
        const o = d.options.find(x=>x.id===oid);
        o.name = inp.value;
      });
    });
    $$('button[data-opt-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(d.options.length<=2){ setSys('M√≠nimo 2 op√ß√µes','warn'); return; }
        const oid = btn.dataset.optDel;
        d.options = d.options.filter(x=>x.id!==oid);
        // clean matrix/risk
        Object.keys(d.matrix).forEach(k=>{ if(k.startsWith(oid+'|')) delete d.matrix[k]; });
        delete d.risk[oid];
        delete d.notes.pros[oid];
        delete d.notes.cons[oid];
        renderOptBox(d);
        setEditMode(editingMode, d);
      });
    });
  }

  function renderCritBox(d){
    const box = $('#critBox');
    box.innerHTML = '';
    d.criteria.forEach((c, idx)=>{
      const row = document.createElement('div');
      row.className = 'noteBox';
      row.style.marginBottom = '10px';
      row.innerHTML = `
        <label>Crit√©rio ${idx+1}</label>
        <div class="flex" style="align-items:center">
          <input class="field" value="${escapeHtml(c.name)}" data-crit="${c.id}" />
          <input class="field mono" style="max-width:140px" type="number" min="0" max="100" value="${Number(c.weight)||0}" data-w="${c.id}" />
          <button class="btn small danger" data-crit-del="${c.id}">‚àí</button>
        </div>
      `;
      box.appendChild(row);
    });

    const add = document.createElement('button');
    add.className = 'btn small';
    add.textContent = '+ Adicionar crit√©rio';
    add.addEventListener('click', ()=>{
      d.criteria.push({id:uid(), name:'Novo crit√©rio', weight:10, order:d.criteria.length});
      autoSeedDecision(d,'B');
      renderCritBox(d);
      setEditMode(editingMode, d);
    });
    box.appendChild(add);

    // wire
    $$('input[data-crit]').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const cid = inp.dataset.crit;
        const c = d.criteria.find(x=>x.id===cid);
        c.name = inp.value;
        if(editingMode==='matrix') setEditMode('matrix', d);
      });
    });
    $$('input[data-w]').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const cid = inp.dataset.w;
        const c = d.criteria.find(x=>x.id===cid);
        c.weight = clamp(Number(inp.value||0),0,100);
      });
    });
    $$('button[data-crit-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(d.criteria.length<=3){ setSys('M√≠nimo 3 crit√©rios','warn'); return; }
        const cid = btn.dataset.critDel;
        d.criteria = d.criteria.filter(x=>x.id!==cid);
        Object.keys(d.matrix).forEach(k=>{ if(k.endsWith('|'+cid)) delete d.matrix[k]; });
        renderCritBox(d);
        setEditMode(editingMode, d);
      });
    });
  }

  function renderMatrixEditor(d){
    const th = d.criteria.map(c=> `<th>${escapeHtml(c.name)}<div style="color:var(--muted);font-size:11px">peso ${Number(c.weight)||0}</div></th>`).join('');
    const rows = d.options.map(o=>{
      const tds = d.criteria.map(c=>{
        const key = o.id+'|'+c.id;
        const v = Number(d.matrix[key] ?? 0);
        return `<td><input class="cellIn" type="number" min="0" max="10" step="0.1" value="${v}" data-cell="${key}"></td>`;
      }).join('');
      return `<tr>
        <td style="position:sticky;left:0;background:rgba(15,18,30,.92);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);font-weight:900">${escapeHtml(o.name)}</td>
        ${tds}
      </tr>`;
    }).join('');
    return `
      <div class="tiny">Dica: role para o lado. Notas vazias viram 0. Use ‚ÄúAuto: exemplo (A/B)‚Äù se quiser preenchimento imediato.</div>
      <div style="margin-top:10px" class="hscroll">
        <table>
          <thead><tr>
            <th style="position:sticky;left:0;z-index:2">Op√ß√£o</th>
            ${th}
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }

  function wireMatrixEditor(d){
    $$('input[data-cell]').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const key = inp.dataset.cell;
        const v = clamp(Number(inp.value||0),0,10);
        d.matrix[key] = v;
      });
    });
  }

  function renderRiskEditor(d){
    const rows = d.options.map(o=>{
      const r = d.risk[o.id] || {p:0,i:0};
      const risk = clamp(r.p*r.i,0,100);
      return `
        <div class="noteBox" style="margin-bottom:10px">
          <div class="flex" style="justify-content:space-between;align-items:center">
            <div><b>${escapeHtml(o.name)}</b><div class="tiny">Risco = prob(0‚Äì10) √ó impacto(0‚Äì10) ‚Üí 0‚Äì100</div></div>
            <div class="mono"><b>${Math.round(risk)}</b></div>
          </div>
          <div class="row2" style="margin-top:8px">
            <div>
              <label>Probabilidade (0‚Äì10)</label>
              <input class="field mono" type="range" min="0" max="10" step="1" value="${r.p}" data-rp="${o.id}">
              <div class="tiny mono">p = <span id="rp_${o.id}">${r.p}</span></div>
            </div>
            <div>
              <label>Impacto (0‚Äì10)</label>
              <input class="field mono" type="range" min="0" max="10" step="1" value="${r.i}" data-ri="${o.id}">
              <div class="tiny mono">i = <span id="ri_${o.id}">${r.i}</span></div>
            </div>
          </div>
        </div>
      `;
    }).join('');
    return rows;
  }

  function wireRiskEditor(d){
    $$('input[data-rp]').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const oid = inp.dataset.rp;
        d.risk[oid] = d.risk[oid] || {p:0,i:0};
        d.risk[oid].p = Number(inp.value||0);
        $('#rp_'+oid).textContent = d.risk[oid].p;
      });
    });
    $$('input[data-ri]').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const oid = inp.dataset.ri;
        d.risk[oid] = d.risk[oid] || {p:0,i:0};
        d.risk[oid].i = Number(inp.value||0);
        $('#ri_'+oid).textContent = d.risk[oid].i;
      });
    });
  }

  function renderNotesEditor(d){
    const pros = d.options.map(o=>{
      return `
        <div class="noteBox" style="margin-bottom:10px">
          <div class="miniTitle">Pros ‚Ä¢ ${escapeHtml(o.name)}</div>
          <textarea class="field" data-pros="${o.id}" style="min-height:80px">${escapeHtml(d.notes.pros[o.id]||'')}</textarea>
          <div class="miniTitle" style="margin-top:10px">Contras ‚Ä¢ ${escapeHtml(o.name)}</div>
          <textarea class="field" data-cons="${o.id}" style="min-height:80px">${escapeHtml(d.notes.cons[o.id]||'')}</textarea>
        </div>
      `;
    }).join('');

    return `
      <div class="row2">
        <div class="noteBox">
          <div class="miniTitle">Assumptions (hip√≥teses)</div>
          <textarea class="field" id="n_ass" style="min-height:120px">${escapeHtml(d.notes.assumptions||'')}</textarea>
        </div>
        <div class="noteBox">
          <div class="miniTitle">Evidence (evid√™ncias)</div>
          <textarea class="field" id="n_evd" style="min-height:120px">${escapeHtml(d.notes.evidence||'')}</textarea>
        </div>
      </div>
      <div style="margin-top:10px" class="noteBox">
        <div class="miniTitle">Pr√©‚Äëmortem</div>
        <textarea class="field" id="n_pm" style="min-height:120px">${escapeHtml(d.notes.preMortem||'')}</textarea>
      </div>
      <div style="margin-top:10px">${pros}</div>
    `;
  }

  function wireNotesEditor(d){
    $('#n_ass').addEventListener('input', ()=> d.notes.assumptions = $('#n_ass').value);
    $('#n_evd').addEventListener('input', ()=> d.notes.evidence = $('#n_evd').value);
    $('#n_pm').addEventListener('input', ()=> d.notes.preMortem = $('#n_pm').value);
    $$('textarea[data-pros]').forEach(t=>{
      t.addEventListener('input', ()=> d.notes.pros[t.dataset.pros] = t.value);
    });
    $$('textarea[data-cons]').forEach(t=>{
      t.addEventListener('input', ()=> d.notes.cons[t.dataset.cons] = t.value);
    });
  }

  function normalizeWeights(d){
    const sum = d.criteria.reduce((s,c)=>s+(Number(c.weight)||0),0) || 1;
    d.criteria.forEach(c=>{
      c.weight = Math.round((Number(c.weight)||0)/sum*100);
    });
    // fix rounding drift
    let drift = 100 - d.criteria.reduce((s,c)=>s+(Number(c.weight)||0),0);
    if(d.criteria.length){
      d.criteria[0].weight = clamp((Number(d.criteria[0].weight)||0) + drift, 0, 100);
    }
  }

  function pushTrail(d, type, text){
    d.trail = d.trail || [];
    d.trail.push({at: nowISO(), type, text});
  }
  function touch(d){
    d.updatedAt = nowISO();
  }

  /* ----------------------- Library Import ----------------------- */
  let libOpenIndex = null;
  function openLibrary(i){
    libOpenIndex = i;
    const m = S.library[i];
    // show in main area as cockpit-like preview
    mainTab = 'cockpit';
    // create a temporary decision preview (not stored)
    const tmp = makeDecision({
      title: m.title,
      domain: m.domain,
      status: m.status,
      reviewDays: m.reviewDays,
      summary: m.summary,
      tags: m.tags,
      options: m.options,
      criteria: m.criteria,
      seed: m.seed || 'B'
    });
    tmp.notes.assumptions = m.modelNotes?.assumptions || tmp.notes.assumptions;
    tmp.notes.evidence = m.modelNotes?.evidence || tmp.notes.evidence;
    // render preview
    $('#mainTitle').textContent = m.title;
    $('#mainSub').textContent = `${m.domain} ‚Ä¢ modelo da biblioteca`;
    const M = compute(tmp, S.settings);
    $('#mainContent').innerHTML = `
      <div class="cols">
        <div class="card">
          <div class="cardHeader"><h3>Modelo (preview)</h3><span class="hint">importar vira decis√£o sua</span></div>
          <div class="cardBody">
            <div class="kpis">
              <div class="kpi ${recClass(M.rec)}"><div class="t">Recomenda√ß√£o t√≠pica</div><div class="v">${M.rec}</div><div class="s">com seed ${m.seed||'B'}</div></div>
              <div class="kpi"><div class="t">Melhor op√ß√£o</div><div class="v">${escapeHtml(M.best.name)}</div><div class="s">score ${M.best.adjusted.toFixed(2)}</div></div>
              <div class="kpi"><div class="t">Risco</div><div class="v">${Math.round(M.best.risk)}</div><div class="s">0‚Äì100</div></div>
              <div class="kpi"><div class="t">Confian√ßa</div><div class="v">${M.confPct}%</div><div class="s">heur√≠stica</div></div>
            </div>
            <div class="hr"></div>
            <button class="btn small primary" id="libImport">Importar este modelo</button>
          </div>
        </div>
        <div class="card">
          <div class="cardHeader"><h3>Matriz</h3><span class="hint">rolagem lateral</span></div>
          <div class="cardBody">${renderMatrixReadOnly(tmp)}</div>
        </div>
      </div>
    `;
    $('#libImport').addEventListener('click', ()=>{
      const m = S.library[libOpenIndex];
      const d = makeDecision({
        title: m.title,
        domain: m.domain,
        status: 'Em an√°lise',
        reviewDays: m.reviewDays || 14,
        summary: m.summary,
        tags: m.tags,
        options: m.options,
        criteria: m.criteria,
        seed: m.seed || 'B'
      });
      d.notes.assumptions = m.modelNotes?.assumptions || d.notes.assumptions;
      d.notes.evidence = m.modelNotes?.evidence || d.notes.evidence;
      pushTrail(d,'create','Importado da biblioteca.');
      S.decisions.unshift(d);
      activeId = d.id; S.lastOpenId = activeId;
      save(S);
      leftTab = 'decisoes';
      renderAll();
      setSys('Importado','ok'); setTimeout(()=>setSys('Pronto','ok'), 700);
    });
  }

  /* ----------------------- Global Actions ----------------------- */
  function renderAll(){
    renderLeft();
    renderMain();
  }

  // tabs
  $$('#tabsLeft .tab').forEach(t=>{
    t.addEventListener('click', ()=>{
      leftTab = t.dataset.left;
      renderAll();
    });
  });
  $$('#tabsTop .tab').forEach(t=>{
    t.addEventListener('click', ()=>{
      const id = t.dataset.main;
      if(id==='editor'){
        const d = getActive();
        if(d) openEditor(d.id);
        else setSys('Selecione uma decis√£o','warn');
        return;
      }
      mainTab = id;
      renderAll();
    });
  });

  // search
  $('#q').addEventListener('input', ()=> renderLeft());

  // examples
  function loadExamples(){
    // replace decisions with 10 examples + keep current user ones? We'll merge.
    // We'll add as new decisions (not wipe)
    const add = S.library.slice(0,10).map(m=>{
      const d = makeDecision({
        title: m.title,
        domain: m.domain,
        status: m.status,
        reviewDays: m.reviewDays,
        summary: m.summary,
        tags: m.tags,
        options: m.options,
        criteria: m.criteria,
        seed: m.seed || 'B'
      });
      d.notes.assumptions = m.modelNotes?.assumptions || d.notes.assumptions;
      d.notes.evidence = m.modelNotes?.evidence || d.notes.evidence;
      pushTrail(d,'create','Exemplo carregado.');
      return d;
    });
    // avoid duplicates by title
    const titles = new Set(S.decisions.map(d=>d.title));
    for(const d of add){
      if(!titles.has(d.title)){
        S.decisions.unshift(d);
        titles.add(d.title);
      }
    }
    activeId = S.decisions[0].id;
    S.lastOpenId = activeId;
    save(S);
    setSys('Exemplos adicionados','ok');
    setTimeout(()=>setSys('Pronto','ok'), 900);
    renderAll();
  }

  $('#btnExamples').addEventListener('click', loadExamples);

  // top actions
  $('#btnNew').addEventListener('click', ()=>{
    const d = makeDecision({ title: 'Nova decis√£o', domain:'Outro', status:'Em an√°lise', reviewDays:14, seed:'B' });
    S.decisions.unshift(d);
    activeId = d.id; S.lastOpenId = activeId;
    save(S);
    renderAll();
    openEditor(d.id);
  });

  $('#btnExport').addEventListener('click', ()=>{
    const data = JSON.stringify(S, null, 2);
    download('nexus_decisions_export.json', data, 'application/json');
    setSys('Exportado','ok'); setTimeout(()=>setSys('Pronto','ok'), 700);
  });

  $('#btnImport').addEventListener('click', ()=>{
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = 'application/json';
    inp.onchange = async ()=>{
      const file = inp.files?.[0];
      if(!file) return;
      const text = await file.text();
      try{
        const obj = JSON.parse(text);
        // basic validation
        if(!obj.decisions || !Array.isArray(obj.decisions)) throw new Error('Formato inv√°lido');
        S = obj;
        save(S);
        activeId = S.lastOpenId || (S.decisions[0]?.id ?? null);
        setSys('Importado','ok'); setTimeout(()=>setSys('Pronto','ok'), 800);
        renderAll();
      }catch(e){
        setSys('Import falhou','bad');
        alert('Falha ao importar: ' + e.message);
      }
    };
    inp.click();
  });

  $('#btnHelp').addEventListener('click', ()=>{ openGuide(); });

// main buttons
  $('#btnQuickFill').addEventListener('click', ()=>{
    const d = getActive(); if(!d) return;
    autoSeedDecision(d, Math.random()>.5?'A':'B');
    pushTrail(d,'note','Preenchimento autom√°tico aplicado.');
    touch(d); save(S); renderAll();
  });
  $('#btnRecalc').addEventListener('click', ()=>{
    setSys('Recalculado','ok'); setTimeout(()=>setSys('Pronto','ok'), 600);
    renderAll();
  });
  $('#btnStar').addEventListener('click', ()=>{
    const d = getActive(); if(!d) return;
    d.starred = !d.starred;
    touch(d); save(S); renderAll();
  });
  $('#btnEdit').addEventListener('click', ()=>{
    const d = getActive(); if(!d) return;
    openEditor(d.id);
  });
  $('#btnDel').addEventListener('click', ()=>{
    const d = getActive(); if(!d) return;
    if(!confirm('Excluir esta decis√£o?')) return;
    S.decisions = S.decisions.filter(x=>x.id!==d.id);
    activeId = S.decisions[0]?.id ?? null;
    S.lastOpenId = activeId;
    save(S);
    renderAll();
  });

  // modal wiring
  $('#mClose').addEventListener('click', closeEditor);
  $('#ov').addEventListener('click', (e)=>{
    if(e.target.id==='ov') closeEditor();
  });

  $('#mSave').addEventListener('click', ()=>{
    const d = S.decisions.find(x=>x.id===editingId);
    if(!d) return;

    d.title = $('#e_title').value.trim() || 'Decis√£o';
    d.domain = $('#e_domain').value;
    d.status = $('#e_status').value;
    d.reviewDays = clamp(Number($('#e_reviewDays').value||14),1,365);
    d.summary = $('#e_summary').value.trim();
    d.tags = ($('#e_tags').value||'').split(',').map(s=>s.trim()).filter(Boolean);

    // ensure matrix/risk keys exist
    autoSeedDecision(d,'B');

    touch(d);
    pushTrail(d,'note','Decis√£o editada e salva.');
    save(S);
    closeEditor();
    renderAll();
    setSys('Salvo','ok'); setTimeout(()=>setSys('Pronto','ok'), 700);
  });

  $('#eMode').addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-mode]');
    if(!b) return;
    const d = S.decisions.find(x=>x.id===editingId);
    if(!d) return;
    setEditMode(b.dataset.mode, d);
  });

  $('#mNormalize').addEventListener('click', ()=>{
    const d = S.decisions.find(x=>x.id===editingId); if(!d) return;
    normalizeWeights(d);
    renderCritBox(d);
    setEditMode(editingMode, d);
    setSys('Pesos normalizados','ok'); setTimeout(()=>setSys('Editando','warn'), 600);
  });
  $('#mReset').addEventListener('click', ()=>{
    const d = S.decisions.find(x=>x.id===editingId); if(!d) return;
    // set all matrix values to 0
    for(const o of d.options){
      for(const c of d.criteria){
        d.matrix[o.id+'|'+c.id] = 0;
      }
    }
    setEditMode('matrix', d);
    setSys('Matriz zerada','warn');
  });
  $('#mAuto').addEventListener('click', ()=>{
    const d = S.decisions.find(x=>x.id===editingId); if(!d) return;
    autoSeedDecision(d, Math.random()>.5?'A':'B');
    pushTrail(d,'note','Auto: exemplo (A/B) aplicado.');
    setEditMode(editingMode, d);
    setSys('Auto preenchido','ok'); setTimeout(()=>setSys('Editando','warn'), 700);
  });
  $('#mPreMortem').addEventListener('click', ()=>{
    const d = S.decisions.find(x=>x.id===editingId); if(!d) return;
    d.notes.preMortem = d.notes.preMortem || 'Imagine que falhou. Liste 5 raz√µes e mitiga√ß√µes.';
    setEditMode('notes', d);
    setSys('Pr√©‚Äëmortem pronto','ok'); setTimeout(()=>setSys('Editando','warn'), 700);
  });

  /* ----------------------- Keyboard ----------------------- */
  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      if($('#ov').style.display==='flex') closeEditor();
      return;
    }
    const ctrl = e.ctrlKey || e.metaKey;
    if(!ctrl) return;

    if(e.shiftKey && e.key.toLowerCase()==='n'){
      e.preventDefault();
      $('#btnNew').click();
    }else if(e.key.toLowerCase()==='e'){
      e.preventDefault();
      const d = getActive(); if(d) openEditor(d.id);
    }else if(e.key==='Enter'){
      e.preventDefault();
      $('#btnRecalc').click();
    }else if(e.key.toLowerCase()==='k'){
      e.preventDefault();
      $('#q').focus();
    }else if(e.key.toLowerCase()==='l'){
      e.preventDefault();
      loadExamples();
    }
  });

  /* ----------------------- Download helper ----------------------- */
  function download(filename, text, mime='text/plain'){
    const blob = new Blob([text], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  /* ----------------------- Init ----------------------- */
  function init(){
    // set active tab content
    renderAll();
  }

  init();


  // guide / tour
  $('#gClose').addEventListener('click', closeGuide);
  $('#gStartTour').addEventListener('click', ()=>{ closeGuide(); startTour(); });
  $('#gLoadExamples').addEventListener('click', ()=>{ loadExamples(true); toast('Exemplos','10 demos carregados'); renderLeft(); });
  $('#gOpenAcademyTab').addEventListener('click', ()=>{ mainTab='academy'; closeGuide(); renderAll(); });
  $('#gShortcuts').addEventListener('click', ()=>{ toast('Atalhos','Ctrl+Shift+N / Ctrl+E / Ctrl+Enter / Ctrl+K / Ctrl+L','ok'); });

  $('#tourExit').addEventListener('click', endTour);
  $('#tourPrev').addEventListener('click', ()=>{ tourI = Math.max(0, tourI-1); showTour(tourI); });
  $('#tourNext').addEventListener('click', ()=>{ tourI = Math.min(TOUR.length-1, tourI+1); showTour(tourI); });

  window.addEventListener('resize', ()=>{ if($('#tour').classList.contains('show')) showTour(tourI); });

})();
</script>

  <!-- Guia / Tour -->
  <div class="overlay" id="ovGuide" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Guia e demonstra√ß√µes">
      <div class="mHead">
        <div>
          <div class="t">üéì Guia & Demo ‚Ä¢ Decision OS Nexus</div>
          <div class="s">Tour interativo, explica√ß√£o de bot√µes/abas e demonstra√ß√µes prontas.</div>
        </div>
        <div class="flex">
          <button class="btn small ghost" id="gClose">Fechar</button>
          <button class="btn small primary" id="gStartTour">Iniciar tour (5 min)</button>
        </div>
      </div>
      <div class="mBody" id="gBody" style="overflow:auto;-webkit-overflow-scrolling:touch"></div>
      <div class="mFoot">
        <div class="tiny">
          Dica: abra o Guia em qualquer tela. O tour destaca o elemento na interface e explica o ‚Äúporqu√™‚Äù de cada resultado.
        </div>
        <div class="flex safeX" style="gap:8px">
          <button class="btn small" id="gLoadExamples">Carregar 10 exemplos</button>
          <button class="btn small" id="gOpenAcademyTab">Abrir aba Guia & Demo</button>
          <button class="btn small" id="gShortcuts">Ver atalhos</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Spotlight (tour) -->
  <div class="tour" id="tour" aria-hidden="true">
    <div class="tourDim"></div>
    <div class="tourTip" id="tourTip">
      <div class="tourTitle" id="tourTitle">Tour</div>
      <div class="tourText" id="tourText">‚Ä¶</div>
      <div class="tourBtns">
        <button class="btn small ghost" id="tourExit">Sair</button>
        <button class="btn small" id="tourPrev">Voltar</button>
        <button class="btn small primary" id="tourNext">Pr√≥ximo</button>
      </div>
      <div class="tiny" id="tourMeta"></div>
    </div>
    <div class="tourRing" id="tourRing" aria-hidden="true"></div>
  </div>


<div class="ecoLock" id="ecoLock"></div>

<div class="ecoBar" id="ecoBar" style="display:none">
  <div class="ecoPill" id="ecoPill" role="button" aria-label="Status da conta i4">
    <div class="ecoDot" id="ecoDot"></div>
    <div class="ecoTxt">
      <b id="ecoName">Deslogado</b>
      <span id="ecoSub">Conta i4 necess√°ria</span>
    </div>
  </div>
  <button class="btn small" id="ecoOpenI4" type="button">i4</button>
  <button class="btn small" id="ecoAuth" type="button">Entrar</button>
  <button class="btn small danger" id="ecoOut" type="button" style="display:none">Sair</button>
</div>

<div class="ecoOverlay" id="ovEcoAuth" aria-hidden="true">
  <div class="ecoModal" role="dialog" aria-modal="true" aria-label="Conta i4">
    <div class="ecoHead">
      <div>
        <div class="t">Conta i4 (central)</div>
        <div class="s">O NEXUS usa a mesma conta e o mesmo banco do i4. Sem login, voc√™ s√≥ acessa esta tela.</div>
      </div>
      <button class="btn small ghost" id="ecoClose" type="button">Fechar</button>
    </div>
    <div class="ecoBody">
      <div class="ecoGrid">
        <div class="ecoCard">
          <b>Entrar</b>
          <label for="ecoLiUser">Usu√°rio</label>
          <input id="ecoLiUser" autocomplete="username" placeholder="ex: wilso">
          <label for="ecoLiPass">Senha</label>
          <input id="ecoLiPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          <div style="height:10px"></div>
          <div class="ecoRow">
            <button class="btn primary" id="ecoLiBtn" type="button">Entrar</button>
            <button class="btn" id="ecoForgot" type="button" title="N√£o implementado (por enquanto)">Esqueci</button>
          </div>
        </div>
        <div class="ecoCard">
          <b>Criar conta</b>
          <label for="ecoSuUser">Usu√°rio</label>
          <input id="ecoSuUser" autocomplete="username" placeholder="sem espa√ßos">
          <label for="ecoSuName">Nome completo</label>
          <input id="ecoSuName" autocomplete="name" placeholder="Seu nome">
          <label for="ecoSuPass">Senha</label>
          <input id="ecoSuPass" type="password" autocomplete="new-password" placeholder="m√≠n. 4 caracteres">
          <div style="height:10px"></div>
          <button class="btn primary" id="ecoSuBtn" type="button">Criar conta</button>
        </div>
      </div>

      <div class="ecoHr"></div>

      <div class="ecoCard">
        <b>Status do NEXUS</b>
        <div style="height:8px"></div>
        <div id="ecoAccessLine" style="color:var(--muted)">‚Äî</div>
        <div style="height:12px"></div>
        <div class="ecoRow">
          <button class="btn small" id="ecoReq" type="button">Solicitar libera√ß√£o</button>
          <button class="btn small" id="ecoGoI4" type="button">Abrir i4</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="ecoOverlay" id="ovEcoGate" aria-hidden="true">
  <div class="ecoModal" role="dialog" aria-modal="true" aria-label="NEXUS bloqueado">
    <div class="ecoHead">
      <div>
        <div class="t">üîí NEXUS bloqueado</div>
        <div class="s">Voc√™ est√° logado no i4, mas o admin ainda n√£o liberou o app NEXUS para sua conta.</div>
      </div>
      <button class="btn small ghost" id="ecoGateClose" type="button">Fechar</button>
    </div>
    <div class="ecoBody">
      <div class="ecoCard" id="ecoGateMsg">‚Äî</div>
      <div style="height:12px"></div>
      <div class="ecoRow">
        <button class="btn primary" id="ecoGateI4" type="button">Ir para i4</button>
        <button class="btn" id="ecoGateRetry" type="button">Tentar de novo</button>
        <button class="btn danger" id="ecoGateOut" type="button">Sair</button>
      </div>
    </div>
  </div>
</div>


<!-- ===== Firebase (i4 central) ===== -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
(() => {
  'use strict';

  const I4_URL = "https://wilsonf1996.github.io/index.html/i4.html";
  const firebaseConfig = {
  apiKey: "AIzaSyAIp-rFuZZsBCNVJ3pSge4TE-XUuwYygrI",
  authDomain: "agenda-6accc.firebaseapp.com",
  databaseURL: "https://agenda-6accc-default-rtdb.firebaseio.com",
  projectId: "agenda-6accc",
  storageBucket: "agenda-6accc.appspot.com",
  messagingSenderId: "794262176773",
  appId: "1:794262176773:web:c4e3837b29f635d5dc086c",
  measurementId: "G-CVBQ54PERH"
}

  let db = null;
  try {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.database();
  } catch (e) {
    console.warn("Firebase init fail:", e);
  }

  const $ = (id)=>document.getElementById(id);
  const safeJSON = (raw)=>{ try{ return JSON.parse(raw); }catch(e){ return null; } };

  // ===== i4 session format (matches i4 saveSession/loadSession) =====
  function loadSession() {
    try {
      const rawV4 = localStorage.getItem("portal_session_v4");
      if (rawV4) {
        const s4 = JSON.parse(rawV4);
        if (s4 && s4.userKey) return {
          userKey: s4.userKey,
          username: s4.username || "",
          fullName: s4.fullName || "",
          role: s4.role || "user",
          status: s4.status || "active",
          sessionToken: s4.sessionToken || null
        };
      }
    } catch (e) {}
    try {
      const raw = localStorage.getItem("portal_session_v3");
      if (!raw) return null;
      const s = JSON.parse(raw);
      if (s && s.userKey) return {
        userKey: s.userKey,
        username: s.username || "",
        fullName: s.fullName || "",
        role: s.role || "user",
        status: s.status || "active",
        sessionToken: null
      };
    } catch (e) {}
    return null;
  }

  function saveSession(sess) {
    // v3 compat + v4 com token (igual i4)
    localStorage.setItem("portal_session_v3", JSON.stringify(sess));
    const v4 = { ...sess, sessionToken: sess.sessionToken || null, issuedAt: Date.now() };
    localStorage.setItem("portal_session_v4", JSON.stringify(v4));
  }

  async function sha256(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  function normalizeKey(s){
    return String(s||"").trim().toLowerCase().replace(/\s+/g,"").replace(/[^a-z0-9._-]/g,"");
  }

  function qs(name){
    try{ return new URLSearchParams(location.search).get(name); }catch(e){ return null; }
  }

  function getToken() {
    const t = qs("i4_session");
    if (t) return t;
    const s = loadSession();
    return s?.sessionToken || null;
  }

  function clearAllSessions() {
    ["portal_session_v4","portal_session_v3","portal_session","i4_session","nexus_session","portal_last_user"].forEach(k=>{
      try{ localStorage.removeItem(k); }catch(e){}
    });
    try {
      const u=new URL(location.href);
      u.searchParams.delete("i4_session");
      history.replaceState(null,"",u.toString());
    } catch(e) {}
  }

  function show(id,on){
    const el=$(id);
    if(!el) return;
    el.classList.toggle("show",!!on);
    el.setAttribute("aria-hidden", on ? "false":"true");
  }

  function lockApp(on){
    const lk=$("ecoLock");
    if(lk) lk.classList.toggle("on",!!on);
  }

  function toastCompat(title, msg){
    try{ if(typeof window.toast==="function") return window.toast(title,msg); }catch(e){}
    try{ if(typeof window.uiToast==="function") return window.uiToast(title,msg); }catch(e){}
    alert(title+"\n\n"+msg);
  }

  const PATH = {
    users: "portal_users",
    usernames: "portal_usernames",
    access: "portal_access",
    sessions: "portal_sessions"
  };

  async function get(refPath){
    if(!db) throw new Error("DB indispon√≠vel");
    const snap = await db.ref(refPath).get().catch(()=>null);
    if(!snap || !snap.exists()) return null;
    return snap.val();
  }

  async function set(refPath, val){
    if(!db) throw new Error("DB indispon√≠vel");
    await db.ref(refPath).set(val);
  }

  async function upd(refPath, val){
    if(!db) throw new Error("DB indispon√≠vel");
    await db.ref(refPath).update(val);
  }

  async function remove(refPath){
    if(!db) return;
    await db.ref(refPath).remove().catch(()=>null);
  }

  async function validateToken(token){
    if(!token) return null;
    const s = await get(`${PATH.sessions}/${token}`);
    if(!s) return null;
    if(s.exp && Date.now()>s.exp) return null;
    return s;
  }

  async function createPortalSession(userKey, username){
    const token = crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2));
    const now = Date.now();
    await set(`${PATH.sessions}/${token}`, {
      token,
      userKey,
      username,
      app: "i4",
      createdAt: now,
      lastSeenAt: now
    });
    return token;
  }

  async function destroyPortalSession(token){
    if(!token) return;
    await remove(`${PATH.sessions}/${token}`);
  }

  async function login(username, password){
    const key = normalizeKey(username);
    if(!key) throw new Error("Usu√°rio inv√°lido.");
    const map = await get(`${PATH.usernames}/${key}`);
    const userKey = map?.userKey || map; // compat
    if(!userKey) throw new Error("Usu√°rio n√£o encontrado.");
    const user = await get(`${PATH.users}/${userKey}`);
    if(!user) throw new Error("Usu√°rio inv√°lido.");
    if(user.status === "blocked") throw new Error("Conta bloqueada. Contate o administrador.");
    const hash = await sha256(password);
    if(hash !== user.passHash) throw new Error("Senha incorreta.");

    let sessionToken = null;
    try {
      sessionToken = await createPortalSession(user.userKey || userKey, user.username || username);
    } catch(e) {
      sessionToken = null;
    }

    saveSession({
      userKey: user.userKey || userKey,
      username: user.username || username,
      fullName: user.fullName || "",
      role: user.role || "user",
      status: user.status || "active",
      sessionToken
    });
    return loadSession();
  }

  async function createUser(username, fullName, password){
    const usernameKey = normalizeKey(username);
    if(!usernameKey) throw new Error("Usu√°rio inv√°lido.");
    const exists = await get(`${PATH.usernames}/${usernameKey}`);
    if(exists) throw new Error("Esse usu√°rio j√° existe.");

    const passHash = await sha256(password);
    const userKey = db.ref(PATH.users).push().key;
    const now = Date.now();
    const userObj = {
      userKey,
      username: String(username).trim(),
      usernameKey,
      fullName: String(fullName||username).trim(),
      passHash,
      role: "user",
      status: "active",
      createdAt: now,
      updatedAt: now
    };

    const updates = {};
    updates[`${PATH.users}/${userKey}`] = userObj;
    updates[`${PATH.usernames}/${usernameKey}`] = { userKey };

    // 1¬∫ acesso: tudo desligado, acesso pendente (igual i4)
    updates[`${PATH.access}/${userKey}`] = {
      plan: "Pendente",
      accessStatus: "pending",
      paymentStatus: "pending",
      defaultAllow: { nexus: false },
      createdAt: now,
      updatedAt: now
    };

    await db.ref().update(updates);

    let sessionToken = null;
    try {
      sessionToken = await createPortalSession(userKey, username);
    } catch(e) {
      sessionToken = null;
    }

    saveSession({
      userKey,
      username: String(username).trim(),
      fullName: String(fullName||username).trim(),
      role: "user",
      status: "active",
      sessionToken
    });
    return loadSession();
  }

  async function fetchAccess(userKey){
    return await get(`${PATH.access}/${userKey}`);
  }

  function allowedForNexus(access, sess){
    if(!sess) return false;
    if(String(sess.role||"").toLowerCase()==="admin") return true;
    if(!access) return false;
    const okStatus = access.accessStatus === "active";
    const okPay = access.paymentStatus === "approved";
    const allow = !!(access.defaultAllow && access.defaultAllow.nexus === true);
    return okStatus && okPay && allow;
  }

  function openI4(){
    const token = getToken();
    if(!token) { location.href = I4_URL; return; }
    const u = new URL(I4_URL, location.href);
    u.searchParams.set("i4_session", token);
    location.href = u.toString();
  }

  async function hardLogout(){
    try {
      const token = getToken();
      if(token) await destroyPortalSession(token);
    } catch(e) {}
    clearAllSessions();
    location.href = location.pathname;
  }

  function setBarState(sess, access){
    const bar = $("ecoBar");
    if(!bar) return;
    bar.style.display = "flex";
    const dot = $("ecoDot");
    const name = $("ecoName");
    const sub = $("ecoSub");
    const bAuth = $("ecoAuth");
    const bOut = $("ecoOut");

    if(!sess){
      if(dot) dot.classList.remove("on");
      if(name) name.textContent = "Deslogado";
      if(sub) sub.textContent = "Conta i4 necess√°ria";
      if(bAuth) bAuth.style.display = "";
      if(bOut) bOut.style.display = "none";
      return;
    }
    if(dot) dot.classList.add("on");
    if(name) name.textContent = sess.fullName ? sess.fullName : ("@"+(sess.username||""));
    const st = access?.accessStatus || "‚Äî";
    const pay = access?.paymentStatus || "‚Äî";
    const allow = access?.defaultAllow?.nexus ? "SIM" : "N√ÉO";
    if(sub) sub.textContent = `NEXUS: ${st} ‚Ä¢ PIX: ${pay} ‚Ä¢ Liberado: ${allow}`;
    if(bAuth) bAuth.style.display = "none";
    if(bOut) bOut.style.display = "";
  }

  async function syncFromUrlToken(){
    const token = qs("i4_session");
    if(!token) return;
    const s = await validateToken(token);
    if(!s || !s.userKey) return;
    const user = await get(`${PATH.users}/${s.userKey}`);
    if(!user) return;
    saveSession({
      userKey: user.userKey || s.userKey,
      username: user.username || s.username || "",
      fullName: user.fullName || "",
      role: user.role || "user",
      status: user.status || "active",
      sessionToken: token
    });
    // limpa par√¢metro (fica s√≥ no localStorage)
    try {
      const u=new URL(location.href);
      u.searchParams.delete("i4_session");
      history.replaceState(null,"",u.toString());
    } catch(e) {}
  }

  async function applyGate(){
    // regra do usu√°rio: sem login i4 ou login pelo NEXUS => s√≥ tela de auth
    const sess = loadSession();
    if(!sess){
      setBarState(null,null);
      lockApp(true);
      show("ovEcoGate", false);
      show("ovEcoAuth", true);
      return;
    }

    const access = await fetchAccess(sess.userKey).catch(()=>null);
    setBarState(sess, access);

    const line = $("ecoAccessLine");
    if(line){
      const st = access?.accessStatus || "pending";
      const pay = access?.paymentStatus || "pending";
      const allow = access?.defaultAllow?.nexus ? "SIM" : "N√ÉO";
      line.textContent = `Status: ${st} ‚Ä¢ Pagamento: ${pay} ‚Ä¢ NEXUS liberado: ${allow}`;
    }

    if(!allowedForNexus(access, sess)){
      lockApp(true);
      $("ecoGateMsg").textContent = "Voc√™ est√° logado no i4, mas o admin ainda n√£o liberou o NEXUS (ou pagamento n√£o aprovado).";
      show("ovEcoAuth", false);
      show("ovEcoGate", true);
    } else {
      lockApp(false);
      show("ovEcoGate", false);
      show("ovEcoAuth", false);
    }
  }

  function installOverlayOnce(){
    if($("ovEcoAuth")) return;
    const host = document.createElement("div");
    host.innerHTML = "\n<div class=\"ecoLock\" id=\"ecoLock\"></div>\n\n<div class=\"ecoBar\" id=\"ecoBar\" style=\"display:none\">\n  <div class=\"ecoPill\" id=\"ecoPill\" role=\"button\" aria-label=\"Status da conta i4\">\n    <div class=\"ecoDot\" id=\"ecoDot\"></div>\n    <div class=\"ecoTxt\">\n      <b id=\"ecoName\">Deslogado</b>\n      <span id=\"ecoSub\">Conta i4 necess\u00e1ria</span>\n    </div>\n  </div>\n  <button class=\"btn small\" id=\"ecoOpenI4\" type=\"button\">i4</button>\n  <button class=\"btn small\" id=\"ecoAuth\" type=\"button\">Entrar</button>\n  <button class=\"btn small danger\" id=\"ecoOut\" type=\"button\" style=\"display:none\">Sair</button>\n</div>\n\n<div class=\"ecoOverlay\" id=\"ovEcoAuth\" aria-hidden=\"true\">\n  <div class=\"ecoModal\" role=\"dialog\" aria-modal=\"true\" aria-label=\"Conta i4\">\n    <div class=\"ecoHead\">\n      <div>\n        <div class=\"t\">Conta i4 (central)</div>\n        <div class=\"s\">O NEXUS usa a mesma conta e o mesmo banco do i4. Sem login, voc\u00ea s\u00f3 acessa esta tela.</div>\n      </div>\n      <button class=\"btn small ghost\" id=\"ecoClose\" type=\"button\">Fechar</button>\n    </div>\n    <div class=\"ecoBody\">\n      <div class=\"ecoGrid\">\n        <div class=\"ecoCard\">\n          <b>Entrar</b>\n          <label for=\"ecoLiUser\">Usu\u00e1rio</label>\n          <input id=\"ecoLiUser\" autocomplete=\"username\" placeholder=\"ex: wilso\">\n          <label for=\"ecoLiPass\">Senha</label>\n          <input id=\"ecoLiPass\" type=\"password\" autocomplete=\"current-password\" placeholder=\"\u2022\u2022\u2022\u2022\u2022\u2022\">\n          <div style=\"height:10px\"></div>\n          <div class=\"ecoRow\">\n            <button class=\"btn primary\" id=\"ecoLiBtn\" type=\"button\">Entrar</button>\n            <button class=\"btn\" id=\"ecoForgot\" type=\"button\" title=\"N\u00e3o implementado (por enquanto)\">Esqueci</button>\n          </div>\n        </div>\n        <div class=\"ecoCard\">\n          <b>Criar conta</b>\n          <label for=\"ecoSuUser\">Usu\u00e1rio</label>\n          <input id=\"ecoSuUser\" autocomplete=\"username\" placeholder=\"sem espa\u00e7os\">\n          <label for=\"ecoSuName\">Nome completo</label>\n          <input id=\"ecoSuName\" autocomplete=\"name\" placeholder=\"Seu nome\">\n          <label for=\"ecoSuPass\">Senha</label>\n          <input id=\"ecoSuPass\" type=\"password\" autocomplete=\"new-password\" placeholder=\"m\u00edn. 4 caracteres\">\n          <div style=\"height:10px\"></div>\n          <button class=\"btn primary\" id=\"ecoSuBtn\" type=\"button\">Criar conta</button>\n        </div>\n      </div>\n\n      <div class=\"ecoHr\"></div>\n\n      <div class=\"ecoCard\">\n        <b>Status do NEXUS</b>\n        <div style=\"height:8px\"></div>\n        <div id=\"ecoAccessLine\" style=\"color:var(--muted)\">\u2014</div>\n        <div style=\"height:12px\"></div>\n        <div class=\"ecoRow\">\n          <button class=\"btn small\" id=\"ecoReq\" type=\"button\">Solicitar libera\u00e7\u00e3o</button>\n          <button class=\"btn small\" id=\"ecoGoI4\" type=\"button\">Abrir i4</button>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n\n<div class=\"ecoOverlay\" id=\"ovEcoGate\" aria-hidden=\"true\">\n  <div class=\"ecoModal\" role=\"dialog\" aria-modal=\"true\" aria-label=\"NEXUS bloqueado\">\n    <div class=\"ecoHead\">\n      <div>\n        <div class=\"t\">\ud83d\udd12 NEXUS bloqueado</div>\n        <div class=\"s\">Voc\u00ea est\u00e1 logado no i4, mas o admin ainda n\u00e3o liberou o app NEXUS para sua conta.</div>\n      </div>\n      <button class=\"btn small ghost\" id=\"ecoGateClose\" type=\"button\">Fechar</button>\n    </div>\n    <div class=\"ecoBody\">\n      <div class=\"ecoCard\" id=\"ecoGateMsg\">\u2014</div>\n      <div style=\"height:12px\"></div>\n      <div class=\"ecoRow\">\n        <button class=\"btn primary\" id=\"ecoGateI4\" type=\"button\">Ir para i4</button>\n        <button class=\"btn\" id=\"ecoGateRetry\" type=\"button\">Tentar de novo</button>\n        <button class=\"btn danger\" id=\"ecoGateOut\" type=\"button\">Sair</button>\n      </div>\n    </div>\n  </div>\n</div>\n";
    document.body.appendChild(host);
  }

  function bindClicks(){
    document.addEventListener("click", async (ev)=>{
      const el = ev.target?.closest?.("button,[role='button'],a");
      if(!el) return;
      const id = el.id || "";

      if(id==="ecoOpenI4" || id==="ecoGoI4" || id==="ecoGateI4"){ ev.preventDefault(); openI4(); return; }
      if(id==="ecoAuth"){ ev.preventDefault(); show("ovEcoAuth", true); return; }
      if(id==="ecoClose"){ ev.preventDefault(); show("ovEcoAuth", false); return; }
      if(id==="ecoGateClose"){ ev.preventDefault(); show("ovEcoGate", false); return; }
      if(id==="ecoGateRetry"){ ev.preventDefault(); await applyGate(); return; }
      if(id==="ecoOut" || id==="ecoGateOut"){ ev.preventDefault(); await hardLogout(); return; }

      if(id==="ecoLiBtn"){ 
        ev.preventDefault();
        try{
          await login($("ecoLiUser").value, $("ecoLiPass").value);
          toastCompat("Login","Conectado ao i4.");
          await applyGate();
        }catch(e){ toastCompat("Erro", String(e.message||e)); }
        return;
      }
      if(id==="ecoSuBtn"){ 
        ev.preventDefault();
        try{
          const p = $("ecoSuPass").value || "";
          if(String(p).length < 4) throw new Error("Senha muito curta.");
          await createUser($("ecoSuUser").value, $("ecoSuName").value, p);
          toastCompat("Conta criada","Conta criada no i4. Agora solicite libera√ß√£o do NEXUS.");
          await applyGate();
        }catch(e){ toastCompat("Erro", String(e.message||e)); }
        return;
      }
      if(id==="ecoReq"){ 
        ev.preventDefault();
        const sess = loadSession();
        if(!sess){ toastCompat("Conta","Fa√ßa login primeiro."); return; }
        try{
          await upd(`${PATH.access}/${sess.userKey}`, {
            accessStatus: "pending",
            paymentStatus: "pending",
            requestedNexusAt: Date.now(),
            updatedAt: Date.now()
          });
          toastCompat("Solicitado","Pedido enviado ao admin do i4.");
          await applyGate();
        }catch(e){ toastCompat("Erro", String(e.message||e)); }
        return;
      }
    }, {capture:true});
  }

  window.addEventListener("storage", (ev)=>{
    if(ev.key==="portal_session_v4" || ev.key==="portal_session_v3") applyGate();
  });

  document.addEventListener("DOMContentLoaded", async ()=>{
    installOverlayOnce();
    bindClicks();
    await syncFromUrlToken();
    await applyGate();
    setInterval(applyGate, 2500);
  });
})();
</script>

</body>
</html>
