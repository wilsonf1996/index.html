<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WF Hub ‚Ä¢ √önico</title>
  <meta name="theme-color" content="#0b0d12" />

  <style>
    :root{
      --bg0:#07080b; --bg1:#0b0d12;
      --cardA: rgba(255,255,255,.10);
      --cardB: rgba(255,255,255,.03);
      --text:#eaf0ff; --muted:#9aa6c3; --line:rgba(255,255,255,.11);
      --good:#2dd4bf; --bad:#fb7185; --warn:#fbbf24; --brand:#60a5fa;
      --shadow: 0 20px 90px rgba(0,0,0,.58);
      --r:18px; --r2:26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text","Segoe UI", Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% -10%, rgba(96,165,250,.22), transparent 60%),
        radial-gradient(1000px 800px at 95% 10%, rgba(45,212,191,.14), transparent 55%),
        radial-gradient(900px 700px at 80% 115%, rgba(251,113,133,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 45%, #07090f 100%);
      overflow-x:hidden;
    }
    .safe{padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    .wrap{max-width:1280px; margin:0 auto; padding:22px 16px 88px;}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 16px;
      margin:-22px -16px 14px;
      backdrop-filter: blur(18px);
      background: linear-gradient(180deg, rgba(7,8,11,.90), rgba(7,8,11,.35));
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background:
        radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(20px 20px at 70% 30%, rgba(255,255,255,.15), transparent 60%),
        linear-gradient(135deg, rgba(96,165,250,.95), rgba(45,212,191,.75));
      border:1px solid rgba(255,255,255,.15);
      box-shadow: 0 16px 48px rgba(96,165,250,.18);
    }
    .brand h1{margin:0; font-size:14px; letter-spacing:.2px; line-height:1.1}
    .brand p{margin:0; font-size:12px; color:var(--muted); line-height:1.2}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .pill{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      border-radius:999px; padding:8px 10px;
      box-shadow: 0 6px 24px rgba(0,0,0,.25) inset;
    }
    .pill span{font-size:12px; color:var(--muted); max-width:420px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .btn{
      appearance:none; border:none; cursor:pointer;
      border-radius:12px; padding:10px 12px;
      color:var(--text);
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      font-size:13px;
      display:inline-flex; align-items:center; gap:9px;
      user-select:none;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }
    .btn:hover{background:rgba(255,255,255,.09); border-color:rgba(255,255,255,.14)}
    .btn:active{transform:scale(.985)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(45,212,191,.72));
      border-color: rgba(255,255,255,.18);
      color:#071017; font-weight:850;
    }
    .btn.danger{background:rgba(251,113,133,.14); border-color:rgba(251,113,133,.28)}
    .btn.warn{background:rgba(251,191,36,.14); border-color:rgba(251,191,36,.26)}
    .mono{font-family:var(--mono)}
    .hint{font-size:12px; color:var(--muted); line-height:1.45}

    /* Cards / Layout */
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    @media (max-width:980px){ .grid2{grid-template-columns:1fr;} }
    .gridMain{display:grid; grid-template-columns:1.2fr .8fr; gap:12px;}
    @media (max-width:980px){ .gridMain{grid-template-columns:1fr;} }

    .card{
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border:1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .title{display:flex; flex-direction:column; gap:4px;}
    .title h2{margin:0; font-size:14px; letter-spacing:.2px}
    .title p{margin:0; font-size:12px; color:var(--muted)}
    .card .bd{padding:14px 16px 16px;}

    .field{display:flex; flex-direction:column; gap:6px;}
    .field label{font-size:11px; color:var(--muted)}
    input{
      width:100%;
      background: rgba(0,0,0,.22);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding:10px 10px;
      color: var(--text);
      outline:none;
      font-family: var(--sans);
      font-size: 13px;
    }
    input::placeholder{color:rgba(154,166,195,.72)}
    input:focus{border-color: rgba(96,165,250,.55); box-shadow: 0 0 0 4px rgba(96,165,250,.12);}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    /* Apps grid */
    .apps{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width:980px){ .apps{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width:520px){ .apps{grid-template-columns: 1fr;} }
    .app{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      min-height:112px;
    }
    .app:hover{background: rgba(0,0,0,.22); border-color: rgba(255,255,255,.14)}
    .app:active{transform:scale(.993)}
    .appTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
    .appName{font-weight:950; font-size:13px;}
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      white-space:nowrap;
    }
    .appDesc{font-size:12px; color:rgba(233,238,252,.86); line-height:1.35}

    /* Admin list */
    .list{display:flex; flex-direction:column; gap:10px;}
    .urow{
      display:grid;
      grid-template-columns: 1.2fr .8fr .9fr;
      gap:10px;
      align-items:center;
      padding:12px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    @media (max-width:980px){ .urow{grid-template-columns:1fr; gap:8px;} }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      white-space:nowrap;
    }
    .good{color:var(--good)}
    .bad{color:var(--bad)}

    /* Views */
    .view{display:none;}
    .view.active{display:block;}

    /* Toast */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: 16px; z-index:999;
      background: rgba(15,18,26,.88);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding:10px 14px;
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      max-width:min(980px, calc(100% - 22px));
      display:none;
      font-size:13px;
      color: var(--text);
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .toast.show{display:flex}
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>

<body class="safe">
  <div class="wrap">

    <!-- TOPBAR (sempre vis√≠vel) -->
    <header class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>WF Hub ‚Ä¢ √önico</h1>
          <p id="sub">Carregando‚Ä¶</p>
        </div>
      </div>

      <div class="actions">
        <div class="pill"><span id="session">‚Äî</span></div>
        <button class="btn" id="btnGoHome" style="display:none;">üè† Home</button>
        <button class="btn warn" id="btnGoAdmin" style="display:none;">üõ°Ô∏è Controle</button>
        <button class="btn danger" id="btnLogout" style="display:none;">Sair</button>
      </div>
    </header>

    <!-- VIEW: AUTH -->
    <section class="view" id="view-auth">
      <div class="grid2">
        <div class="card">
          <div class="hd">
            <div class="title">
              <h2>Entrar</h2>
              <p>Login por <b>usu√°rio</b> ou <b>email</b></p>
            </div>
          </div>
          <div class="bd">
            <div class="field">
              <label>Usu√°rio ou Email</label>
              <input id="loginUser" placeholder="ex: wilso ou wilso@email.com" autocomplete="username" />
            </div>
            <div class="field" style="margin-top:10px;">
              <label>Senha</label>
              <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn primary" id="btnLogin">Entrar</button>
              <button class="btn" id="btnReset">Esqueci senha</button>
            </div>

            <div class="hint" style="margin-top:10px;">
              Se seu acesso estiver <b>bloqueado</b>, o sistema desloga automaticamente.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div class="title">
              <h2>Criar conta</h2>
              <p>Cadastro com nome, usu√°rio, email e senha</p>
            </div>
          </div>
          <div class="bd">
            <div class="field">
              <label>Nome (obrigat√≥rio)</label>
              <input id="regName" placeholder="ex: Wilson Fernandes Junior" />
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Usu√°rio (√∫nico, sem espa√ßos)</label>
              <input id="regUser" placeholder="ex: wilso" />
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Email</label>
              <input id="regEmail" placeholder="ex: wilso@email.com" autocomplete="email" />
            </div>

            <div class="grid2" style="margin-top:10px;">
              <div class="field">
                <label>Senha</label>
                <input id="regPass" type="password" placeholder="m√≠n. 6 caracteres" autocomplete="new-password" />
              </div>
              <div class="field">
                <label>Confirmar senha</label>
                <input id="regPass2" type="password" placeholder="repita" autocomplete="new-password" />
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn primary" id="btnRegister">Cadastrar</button>
              <span class="hint">Atalho: <span class="mono">Enter</span></span>
            </div>

            <div class="hint" style="margin-top:10px;">
              Controle (Admin) ser√° permitido somente para:
              <span class="badge">Nome: Wilson Fernandes Junior</span>
              <span class="badge">Senha Admin: 92290487</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- VIEW: HOME -->
    <section class="view" id="view-home">
      <div class="gridMain">
        <div class="card">
          <div class="hd">
            <div class="title">
              <h2>Aplicativos</h2>
              <p>Hub com busca instant√¢nea</p>
            </div>
            <div class="field" style="min-width:280px;">
              <label>Buscar</label>
              <input id="qApps" placeholder="ex: financeiro, sa√∫de, documentos, google‚Ä¶" />
            </div>
          </div>

          <div class="bd">
            <div class="apps" id="apps"></div>
            <div class="hint" style="margin-top:12px;">
              Dica: <span class="mono">Enter</span> abre o primeiro resultado.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div class="title">
              <h2>Status</h2>
              <p>Rel√≥gio + sess√£o + base por usu√°rio</p>
            </div>
          </div>
          <div class="bd">
            <div class="hint" id="clock">‚Äî</div>
            <div class="hint" id="date">‚Äî</div>
            <div style="height:12px"></div>

            <div class="hint">
              Base por usu√°rio: <span class="mono">/user_data/&lt;uid&gt;/...</span>
            </div>

            <div style="height:14px"></div>

            <div class="card" style="border-radius:18px;">
              <div class="hd">
                <div class="title">
                  <h2>Port√£o Admin</h2>
                  <p>S√≥ abre para ‚ÄúWilson Fernandes Junior‚Äù</p>
                </div>
              </div>
              <div class="bd">
                <div class="field">
                  <label>Senha Admin</label>
                  <input id="adminGatePass" type="password" placeholder="92290487" />
                </div>
                <div class="row" style="margin-top:12px;">
                  <button class="btn warn" id="btnOpenAdmin">Abrir Controle</button>
                </div>
                <div class="hint" style="margin-top:10px;">
                  Regra: nome do perfil precisa ser <b>exatamente</b> ‚ÄúWilson Fernandes Junior‚Äù.
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- VIEW: ADMIN -->
    <section class="view" id="view-admin">
      <div class="card">
        <div class="hd">
          <div class="title">
            <h2>Controle de Contas</h2>
            <p>Bloquear / liberar usu√°rios em tempo real</p>
          </div>
          <div class="field" style="min-width:300px;">
            <label>Buscar</label>
            <input id="qUsers" placeholder="nome, usu√°rio, email, uid‚Ä¶" />
          </div>
        </div>
        <div class="bd">
          <div class="hint">
            ‚úÖ Esta p√°gina s√≥ abre com:
            <span class="badge">Nome: Wilson Fernandes Junior</span>
            <span class="badge">Senha Admin: 92290487</span>
          </div>

          <div style="height:12px"></div>
          <div class="list" id="usersList"></div>
        </div>
      </div>
    </section>

  </div>

  <!-- TOAST -->
  <div class="toast" id="toast" role="status" aria-live="polite">
    <div id="toastMsg">‚Äî</div>
    <button class="btn" id="toastClose">OK</button>
  </div>

  <script>
    /************************************************************
     * CONFIG (n√£o mexi)
     ************************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyAIp-rFuZZsBCNVJ3pSge4TE-XUuwYygrI",
      authDomain: "agenda-6accc.firebaseapp.com",
      databaseURL: "https://agenda-6accc-default-rtdb.firebaseio.com",
      projectId: "agenda-6accc",
      storageBucket: "agenda-6accc.appspot.com",
      messagingSenderId: "794262176773",
      appId: "1:794262176773:web:c4e3837b29f635d5dc086c",
      measurementId: "G-CVBQ54PERH"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.database();

    const $ = (id)=>document.getElementById(id);

    const PATH = {
      users: "/users",
      usernames: "/usernames"
    };

    // ADMIN gate (como voc√™ pediu)
    const ADMIN_NAME = "Wilson Fernandes Junior";
    const ADMIN_GATE_PASSWORD = "92290487";

    // Apps (edite se quiser)
    const APPS = [
      {name:"WF Engenharia Consultiva", tag:"WF", desc:"Site principal", url:"https://wilsonf1996.github.io/index.html/wf/principal.html"},
      {name:"Agenda Semanal", tag:"Produtividade", desc:"Planejamento semanal", url:"https://wilsonf1996.github.io/index.html/agendasemanal/agendasemanal2.html"},
      {name:"Calculadora", tag:"Ferramentas", desc:"Cient√≠fica / avan√ßada", url:"https://wilsonf1996.github.io/index.html/calculadora/calculadora3.html"},
      {name:"Notas", tag:"Produtividade", desc:"Anota√ß√µes r√°pidas", url:"https://wilsonf1996.github.io/index.html/notas/notas.html"},
      {name:"M√∫sica", tag:"Media", desc:"Player", url:"https://wilsonf1996.github.io/index.html/documentos/videox.html"},
      {name:"Checklist", tag:"Produtividade", desc:"Tarefas", url:"https://wilsonf1996.github.io/index.html/checklist/checklist3.html"},
      {name:"Compras", tag:"Casa", desc:"Lista de compras", url:"https://wilsonf1996.github.io/index.html/compras/compras.html"},
      {name:"Contatos", tag:"Pessoal", desc:"Agenda", url:"https://wilsonf1996.github.io/index.html/contatos/contatos.html"},
      {name:"Di√°rio", tag:"Pessoal", desc:"Registro di√°rio", url:"https://wilsonf1996.github.io/index.html/diario/diario.html"},
      {name:"Financeiro", tag:"Finan√ßas", desc:"Dashboard + metas", url:"https://wilsonf1996.github.io/index.html/financeiro/financeirobotoes.html"},
      {name:"R√°dio", tag:"Media", desc:"R√°dio online", url:"https://wilsonf1996.github.io/index.html/radio/radio.html"},
      {name:"Sa√∫de", tag:"Health", desc:"Controle f√≠sico", url:"https://wilsonf1996.github.io/index.html/sa√∫de/saude.html"},
      {name:"Treino", tag:"Health", desc:"Rotina de treino", url:"https://wilsonf1996.github.io/index.html/treino/treino.html"},
      {name:"TV Online", tag:"Media", desc:"Streaming", url:"https://wilsonf1996.github.io/index.html/tvonline/tvonline.html"},
      {name:"Invent√°rio", tag:"Gest√£o", desc:"Itens e controle", url:"https://wilsonf1996.github.io/index.html/inventarios/inventario.html"},
      {name:"Servi√ßos", tag:"Gest√£o", desc:"Controle de servi√ßos", url:"https://wilsonf1996.github.io/index.html/servi√ßo/servi√ßo.html"},
      {name:"Documentos", tag:"Arquivos", desc:"Gest√£o documental", url:"https://wilsonf1996.github.io/index.html/documentos/documentos3.html"},
      {name:"Alarme", tag:"Util", desc:"Alarmes", url:"https://wilsonf1996.github.io/index.html/documentos/alarme.html"},
      {name:"Jogos", tag:"Divers√£o", desc:"Mini jogos", url:"https://wilsonf1996.github.io/index.html/jogo/jogobot.html"},
      {name:"Curr√≠culos", tag:"Carreira", desc:"Gest√£o de CV", url:"https://wilsonf1996.github.io/index.html/curriculo/gestaocurriculo.html"},
      {name:"ChatGPT", tag:"IA", desc:"Acesso r√°pido", url:"https://chat.openai.com/"},
      {name:"Google", tag:"Web", desc:"Pesquisa", url:"https://www.google.com/"},
      {name:"Google Maps", tag:"Mapa", desc:"Rotas", url:"https://www.google.com/maps"},
      {name:"Gmail", tag:"Email", desc:"Correio", url:"https://mail.google.com/"},
      {name:"LinkedIn", tag:"Carreira", desc:"Networking", url:"https://www.linkedin.com/"},
      {name:"YouTube", tag:"Media", desc:"V√≠deos", url:"https://www.youtube.com/"},
      {name:"Netflix", tag:"Media", desc:"Streaming", url:"https://www.netflix.com/"}
    ];

    /************************************************************
     * Helpers UI
     ************************************************************/
    function toast(msg){
      $("toastMsg").textContent = msg;
      $("toast").classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=> $("toast").classList.remove("show"), 2600);
    }
    $("toastClose").addEventListener("click", ()=> $("toast").classList.remove("show"));

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function showView(name){
      for(const v of document.querySelectorAll(".view")) v.classList.remove("active");
      $(name).classList.add("active");
    }

    function normUsername(u){
      return String(u||"").trim().toLowerCase().replace(/\s+/g,"");
    }
    function validUsername(u){
      return /^[a-z0-9._-]{3,24}$/.test(u);
    }

    async function usernameToEmail(userOrEmail){
      const v = String(userOrEmail||"").trim();
      if(!v) throw new Error("Informe usu√°rio ou email.");
      if(v.includes("@")) return v;

      const uname = normUsername(v);
      const snap = await db.ref(`${PATH.usernames}/${uname}`).get();
      if(!snap.exists()) throw new Error("Usu√°rio n√£o encontrado.");
      const uid = snap.val();

      const eSnap = await db.ref(`${PATH.users}/${uid}/email`).get();
      if(!eSnap.exists()) throw new Error("Email do usu√°rio n√£o encontrado.");
      return eSnap.val();
    }

    async function ensureActive(uid){
      const snap = await db.ref(`${PATH.users}/${uid}/active`).get().catch(()=>null);
      const active = (snap && snap.exists()) ? !!snap.val() : true;
      if(!active){
        await auth.signOut();
        throw new Error("Seu acesso est√° bloqueado.");
      }
      return true;
    }

    async function getProfile(uid){
      const snap = await db.ref(`${PATH.users}/${uid}`).get();
      return snap.exists() ? snap.val() : null;
    }

    function tickClock(){
      const now = new Date();
      $("clock").textContent = `Hora: ${now.toLocaleTimeString("pt-BR",{hour12:false})}`;
      $("date").textContent  = `Data: ${now.toLocaleDateString("pt-BR",{weekday:"long", year:"numeric", month:"long", day:"numeric"})}`;
    }

    /************************************************************
     * AUTH (Cadastro / Login / Reset / Logout)
     ************************************************************/
    async function register(){
      const fullName = String($("regName").value||"").trim();
      const username = normUsername($("regUser").value);
      const email = String($("regEmail").value||"").trim().toLowerCase();
      const pass = $("regPass").value || "";
      const pass2 = $("regPass2").value || "";

      if(fullName.length < 3) throw new Error("Informe seu nome completo.");
      if(!validUsername(username)) throw new Error("Usu√°rio inv√°lido (3‚Äì24, letras/n√∫meros . _ -).");
      if(!email.includes("@")) throw new Error("Informe um email v√°lido.");
      if(pass.length < 6) throw new Error("Senha precisa ter no m√≠nimo 6 caracteres.");
      if(pass !== pass2) throw new Error("As senhas n√£o conferem.");

      const taken = await db.ref(`${PATH.usernames}/${username}`).get();
      if(taken.exists()) throw new Error("Esse usu√°rio j√° existe.");

      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      const uid = cred.user.uid;

      const profile = {
        uid,
        fullName,
        username,
        email,
        active: true,
        createdAt: Date.now()
      };

      await db.ref(`${PATH.users}/${uid}`).set(profile);
      await db.ref(`${PATH.usernames}/${username}`).set(uid);

      toast("Conta criada. Entrando‚Ä¶");
      await ensureActive(uid);
      route("home");
    }

    async function login(){
      const userOrEmail = $("loginUser").value;
      const pass = $("loginPass").value || "";
      if(!pass) throw new Error("Informe a senha.");

      const email = await usernameToEmail(userOrEmail);
      const cred = await auth.signInWithEmailAndPassword(email, pass);
      await ensureActive(cred.user.uid);

      toast("Login ok!");
      route("home");
    }

    async function resetPassword(){
      const userOrEmail = $("loginUser").value.trim();
      if(!userOrEmail) return toast("Digite usu√°rio ou email para reset.");
      const email = await usernameToEmail(userOrEmail);
      await auth.sendPasswordResetEmail(email);
      toast("Email de reset enviado.");
    }

    async function logout(){
      await auth.signOut();
      route("auth");
    }

    $("btnRegister").addEventListener("click", async ()=>{ try{ await register(); }catch(e){ toast(e.message || "Erro no cadastro."); }});
    $("btnLogin").addEventListener("click", async ()=>{ try{ await login(); }catch(e){ toast(e.message || "Erro no login."); }});
    $("btnReset").addEventListener("click", async ()=>{ try{ await resetPassword(); }catch(e){ toast(e.message || "Erro ao enviar reset."); }});
    $("btnLogout").addEventListener("click", logout);

    document.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){
        const ae = document.activeElement?.id || "";
        if(ae.startsWith("reg")) $("btnRegister").click();
        else if(ae.startsWith("login")) $("btnLogin").click();
      }
    });

    /************************************************************
     * HOME: render apps + busca
     ************************************************************/
    function filterApps(q){
      const t = (q||"").trim().toLowerCase();
      if(!t) return APPS;
      return APPS.filter(a=>{
        const bag = `${a.name} ${a.tag} ${a.desc} ${a.url}`.toLowerCase();
        return bag.includes(t);
      });
    }
    function renderApps(list){
      const el = $("apps");
      el.innerHTML = "";
      if(!list.length){
        el.innerHTML = `<div class="hint">Nenhum resultado.</div>`;
        return;
      }
      for(const a of list){
        const div = document.createElement("div");
        div.className = "app";
        div.onclick = ()=> window.location.href = a.url;
        div.innerHTML = `
          <div class="appTop">
            <div class="appName">${esc(a.name)}</div>
            <div class="tag">${esc(a.tag||"App")}</div>
          </div>
          <div class="appDesc">${esc(a.desc||"")}</div>
          <div class="hint mono">${esc(a.url.replace("https://","").slice(0,44))}${a.url.length>44?"‚Ä¶":""}</div>
        `;
        el.appendChild(div);
      }
    }

    $("qApps").addEventListener("input", ()=>{
      renderApps(filterApps($("qApps").value));
    });
    document.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && $("view-home").classList.contains("active")){
        const list = filterApps($("qApps").value);
        if(list[0]) window.location.href = list[0].url;
      }
    });

    /************************************************************
     * ADMIN: controle active
     ************************************************************/
    let allUsers = [];
    let adminListenerOn = false;

    function filterUsers(q){
      const t = (q||"").trim().toLowerCase();
      if(!t) return allUsers;
      return allUsers.filter(u=>{
        const bag = `${u.fullName||""} ${u.username||""} ${u.email||""} ${u.uid||""} ${u.active}`.toLowerCase();
        return bag.includes(t);
      });
    }

    function renderUsers(list){
      const el = $("usersList");
      el.innerHTML = "";
      if(!list.length){
        el.innerHTML = `<div class="hint">Nenhum usu√°rio encontrado.</div>`;
        return;
      }
      for(const u of list){
        const active = u.active !== false;
        const row = document.createElement("div");
        row.className = "urow";
        row.innerHTML = `
          <div>
            <div style="font-weight:950;font-size:13px;">${esc(u.fullName || "(sem nome)")}</div>
            <div class="hint" style="margin-top:4px;">
              <span class="badge">@${esc(u.username || "-")}</span>
              <span class="badge">${esc(u.email || "-")}</span>
              <span class="badge mono">uid: ${esc((u.uid||"").slice(0,10))}‚Ä¶</span>
              <span class="badge ${active ? "good":"bad"}">${active ? "ativo":"bloqueado"}</span>
            </div>
          </div>

          <div class="hint">
            Criado: ${u.createdAt ? new Date(u.createdAt).toLocaleString("pt-BR") : "-"}
          </div>

          <div class="row" style="justify-content:flex-end;">
            <button class="btn ${active ? "danger": "primary"}" data-uid="${esc(u.uid)}">
              ${active ? "üö´ Bloquear" : "‚úÖ Liberar"}
            </button>
          </div>
        `;
        row.querySelector("button").onclick = async ()=>{
          const next = !active;
          await db.ref(`${PATH.users}/${u.uid}/active`).set(next);
          toast(next ? "Usu√°rio liberado." : "Usu√°rio bloqueado.");
        };
        el.appendChild(row);
      }
    }

    $("qUsers").addEventListener("input", ()=>{
      renderUsers(filterUsers($("qUsers").value));
    });

    function startAdminListener(){
      if(adminListenerOn) return;
      adminListenerOn = true;

      db.ref(PATH.users).on("value",(snap)=>{
        const v = snap.val() || {};
        const list = Object.keys(v).map(uid=>{
          const u = v[uid] || {};
          return {
            uid,
            fullName: u.fullName || "",
            username: u.username || "",
            email: u.email || "",
            active: u.active !== false,
            createdAt: u.createdAt || 0
          };
        }).sort((a,b)=> (a.fullName||"").localeCompare(b.fullName||""));

        allUsers = list;
        renderUsers(filterUsers($("qUsers").value));
      });
    }

    /************************************************************
     * ROUTER + Estado de Sess√£o
     ************************************************************/
    function route(where){
      // onde: auth | home | admin
      if(where === "auth"){ location.hash = "#auth"; }
      if(where === "home"){ location.hash = "#home"; }
      if(where === "admin"){ location.hash = "#admin"; }
      renderRoute();
    }

    async function canOpenAdmin(profile){
      // Exatamente como voc√™ pediu:
      // 1) Nome == Wilson Fernandes Junior
      // 2) Senha do port√£o == 92290487
      const gate = String($("adminGatePass").value || "").trim();
      if(profile?.fullName !== ADMIN_NAME) return {ok:false, msg:"Somente Wilson Fernandes Junior pode acessar o controle."};
      if(gate !== ADMIN_GATE_PASSWORD) return {ok:false, msg:"Senha Admin incorreta."};
      return {ok:true};
    }

    $("btnOpenAdmin").addEventListener("click", async ()=>{
      const user = auth.currentUser;
      if(!user) return route("auth");
      const profile = await getProfile(user.uid);
      const ok = await canOpenAdmin(profile);
      if(!ok.ok){ toast(ok.msg); return; }
      route("admin");
    });

    $("btnGoHome").addEventListener("click", ()=> route("home"));
    $("btnGoAdmin").addEventListener("click", ()=> {
      // bot√£o mostra, mas a valida√ß√£o real acontece ao entrar na rota admin
      route("admin");
    });

    async function renderRoute(){
      const user = auth.currentUser;

      // topbar buttons default
      $("btnLogout").style.display = user ? "inline-flex" : "none";
      $("btnGoHome").style.display = user ? "inline-flex" : "none";
      $("btnGoAdmin").style.display = user ? "inline-flex" : "none";

      if(!user){
        $("sub").textContent = "Fa√ßa login para continuar.";
        $("session").textContent = "deslogado";
        showView("view-auth");
        return;
      }

      // valida bloqueio
      try{
        await ensureActive(user.uid);
      }catch(e){
        toast(e.message || "Bloqueado.");
        $("sub").textContent = "Acesso bloqueado.";
        $("session").textContent = "bloqueado";
        showView("view-auth");
        return;
      }

      const profile = await getProfile(user.uid);
      const who = profile?.fullName || profile?.username || user.email || "usu√°rio";
      $("sub").textContent = `Logado como ${who}`;
      $("session").textContent = `uid: ${user.uid.slice(0,8)}‚Ä¶`;

      const hash = (location.hash || "#home").toLowerCase();

      if(hash === "#auth"){
        // se j√° logado, manda pra home
        showView("view-home");
        return;
      }

      if(hash === "#admin"){
        // valida acesso admin EXATAMENTE como pedido
        const ok = await canOpenAdmin(profile);
        if(!ok.ok){
          toast(ok.msg);
          location.hash = "#home";
          showView("view-home");
          return;
        }
        showView("view-admin");
        startAdminListener();
        return;
      }

      // default: home
      showView("view-home");
    }

    /************************************************************
     * Boot
     ************************************************************/
    renderApps(APPS);
    tickClock();
    setInterval(tickClock, 1000);

    auth.onAuthStateChanged(async (user)=>{
      if(user){
        // garante rota padr√£o
        if(!location.hash) location.hash = "#home";
      }else{
        location.hash = "#auth";
      }
      await renderRoute();
    });

    window.addEventListener("hashchange", renderRoute);
  </script>
</body>
</html>
