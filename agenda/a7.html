<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Agenda Pro ‚Ä¢ Planner (Apple/Microsoft-ish) v3.2</title>
  <meta name="theme-color" content="#0b0d12" />
  <meta name="color-scheme" content="dark light" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --bg0:#07080b; --bg1:#0b0d12;
      --cardA: rgba(255,255,255,.09);
      --cardB: rgba(255,255,255,.03);
      --text:#eaf0ff; --muted:#9aa6c3; --line:rgba(255,255,255,.10);
      --good:#2dd4bf; --bad:#fb7185; --warn:#fbbf24; --brand:#60a5fa;
      --shadow: 0 20px 90px rgba(0,0,0,.58);
      --shadow2: 0 12px 38px rgba(0,0,0,.40);
      --r:18px; --r2:26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text","Segoe UI", Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --ring: 0 0 0 4px rgba(96,165,250,.14);
      --ring2: 0 0 0 5px rgba(45,212,191,.12);
      --tap:.985;
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(0,0,0,.18);
      --blur: blur(18px);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg0:#f7f7fb; --bg1:#eef0f6;
        --cardA: rgba(255,255,255,.82);
        --cardB: rgba(255,255,255,.62);
        --text:#0b0d12; --muted:rgba(60,60,67,.70); --line:rgba(60,60,67,.16);
        --shadow: 0 18px 60px rgba(0,0,0,.12);
        --shadow2: 0 10px 30px rgba(0,0,0,.10);
        --glass: rgba(255,255,255,.72);
        --glass2: rgba(255,255,255,.62);
      }
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% -10%, rgba(96,165,250,.22), transparent 60%),
        radial-gradient(1000px 800px at 95% 10%, rgba(45,212,191,.14), transparent 55%),
        radial-gradient(900px 700px at 80% 115%, rgba(251,113,133,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 55%, var(--bg0) 100%);
      overflow-x:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .safe{padding: var(--safeTop) 0 var(--safeBottom) 0;}
    .wrap{max-width:1320px; margin:0 auto; padding:16px 16px 96px;}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px;
      margin:-16px -16px 12px;
      backdrop-filter: var(--blur);
      background: linear-gradient(180deg, rgba(7,8,11,.92), rgba(7,8,11,.30));
      border-bottom:1px solid var(--line);
    }
    @media (prefers-color-scheme: light){
      .topbar{ background: linear-gradient(180deg, rgba(238,240,246,.90), rgba(238,240,246,.35)); }
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:240px;}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background:
        radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(20px 20px at 70% 30%, rgba(255,255,255,.15), transparent 60%),
        linear-gradient(135deg, rgba(96,165,250,.95), rgba(45,212,191,.75));
      border:1px solid rgba(255,255,255,.15);
      box-shadow: 0 16px 48px rgba(96,165,250,.18);
      flex:0 0 auto;
    }
    .brand h1{margin:0; font-size:14px; letter-spacing:.2px; line-height:1.1}
    .brand p{margin:0; font-size:12px; color:var(--muted); line-height:1.2}

    .pill{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      border-radius:999px; padding:8px 10px;
      box-shadow: 0 6px 24px rgba(0,0,0,.25) inset;
      max-width:min(760px, 55vw);
      overflow:hidden;
    }
    .pill .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.22);box-shadow:0 0 0 3px rgba(255,255,255,.06)}
    .dot.good{background:rgba(45,212,191,.95); box-shadow:0 0 0 3px rgba(45,212,191,.12)}
    .dot.warn{background:rgba(251,191,36,.95); box-shadow:0 0 0 3px rgba(251,191,36,.12)}
    .dot.bad{background:rgba(251,113,133,.95); box-shadow:0 0 0 3px rgba(251,113,133,.12)}
    .pill span{font-size:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .btn{
      appearance:none; border:none; cursor:pointer;
      border-radius:12px; padding:10px 12px;
      color:var(--text);
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      transition: transform .08s ease, background .15s ease, border-color .15s ease, filter .15s ease;
      font-size:13px;
      display:inline-flex; align-items:center; gap:9px;
      user-select:none;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      outline:none;
    }
    .btn:hover{background:rgba(255,255,255,.09); border-color:rgba(255,255,255,.14)}
    .btn:active{transform:scale(var(--tap))}
    .btn:focus-visible{box-shadow: var(--shadow), var(--ring)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(45,212,191,.72));
      border-color: rgba(255,255,255,.18);
      color:#071017;
      font-weight:850;
    }
    .btn.danger{background:rgba(251,113,133,.14); border-color:rgba(251,113,133,.28)}
    .btn.ghost{background:transparent; box-shadow:none}
    .btn.key{
      background: rgba(255,255,255,.03);
      border-style: dashed;
    }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      border-radius: 999px;
      padding:6px;
    }
    @media (prefers-color-scheme: light){ .tabs{background: rgba(255,255,255,.65);} }
    .tab{
      cursor:pointer;
      padding:9px 12px;
      border-radius: 999px;
      font-size:12px;
      border:1px solid transparent;
      color: rgba(233,240,255,.92);
      background: transparent;
      transition: background .15s ease, border-color .15s ease, transform .08s ease;
      user-select:none;
      display:flex; align-items:center; gap:8px;
      outline:none;
      white-space:nowrap;
    }
    @media (prefers-color-scheme: light){ .tab{color:rgba(11,13,18,.90);} }
    .tab:active{transform:scale(.99)}
    .tab:focus-visible{box-shadow: var(--ring2); border-color: rgba(45,212,191,.30)}
    .tab.active{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.14); }
    @media (prefers-color-scheme: light){ .tab.active{background: rgba(0,0,0,.06); border-color: rgba(0,0,0,.10);} }

    /* Layout */
    .grid{display:grid; grid-template-columns:1.2fr .8fr; gap:12px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .card{
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border:1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
      will-change: transform;
    }
    .card .hd{
      padding:14px 16px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      flex-wrap:wrap;
    }
    .title{display:flex; flex-direction:column; gap:4px;}
    .title h2{margin:0; font-size:14px; letter-spacing:.2px}
    .title p{margin:0; font-size:12px; color:var(--muted)}
    .card .bd{padding:14px 16px 16px;}

    .hint{font-size:12px; color:var(--muted); line-height:1.45}
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: rgba(233,238,252,.92);
    }

    /* Fields */
    .filters{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;}
    .field{display:flex; flex-direction:column; gap:6px; min-width:160px;}
    .field label{font-size:11px; color:var(--muted)}
    input, select, textarea{
      width:100%;
      background: rgba(0,0,0,.22);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding:10px 10px;
      color: var(--text);
      outline:none;
      font-family: var(--sans);
      font-size: 13px;
    }
    @media (prefers-color-scheme: light){
      input,select,textarea{background: rgba(255,255,255,.70); color: #0b0d12;}
    }
    textarea{min-height:92px; resize: vertical;}
    input::placeholder, textarea::placeholder{color:rgba(154,166,195,.72)}
    input:focus, select:focus, textarea:focus{border-color: rgba(96,165,250,.55); box-shadow: var(--ring);}

    .divider{height:1px; background:var(--line); margin:12px 0;}

    /* Quick Add (Spotlight-ish) */
    .quickbar{
      flex: 1 1 auto;
      min-width: min(720px, 100%);
      display:flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding:8px 10px;
    }
    @media (prefers-color-scheme: light){ .quickbar{background: rgba(255,255,255,.62);} }
    .quickbar .ic{opacity:.9}
    .quickbar input{
      border:none !important;
      background: transparent !important;
      padding: 8px 8px;
      border-radius: 10px;
      box-shadow: none !important;
      font-family: var(--sans);
      font-size: 13px;
      outline:none;
    }
    .quickbar .miniHelp{
      font-size:11px; color:var(--muted);
      white-space:nowrap;
    }
    @media (max-width:820px){ .quickbar .miniHelp{display:none;} }

    /* Lists */
    .list{display:flex; flex-direction:column; gap:10px;}
    .row{
      display:grid;
      grid-template-columns: 1.2fr .7fr .6fr .9fr;
      gap:10px;
      align-items:center;
      padding:12px;
      border-radius: var(--r);
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      cursor:pointer;
      outline:none;
      content-visibility: auto;
      contain-intrinsic-size: 84px;
    }
    @media (prefers-color-scheme: light){ .row{background: rgba(255,255,255,.60);} }
    .row:hover{border-color:rgba(255,255,255,.14); background: rgba(0,0,0,.22)}
    @media (prefers-color-scheme: light){ .row:hover{background: rgba(255,255,255,.76); border-color: rgba(0,0,0,.12);} }
    .row:active{transform:scale(.995)}
    .row:focus-visible{box-shadow: var(--ring2); border-color: rgba(45,212,191,.30)}
    @media (max-width:820px){ .row{grid-template-columns:1fr; gap:8px;} }

    .main{display:flex; flex-direction:column; gap:3px;}
    .name{font-size:13px; font-weight:900}
    .meta{font-size:11px; color:var(--muted); display:flex; flex-wrap:wrap; gap:8px}
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .badge b{color:var(--text); font-weight:950}
    .right{display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap}
    .mono{font-family:var(--mono)}
    .amount{ text-align:right; font-family: var(--mono); font-size: 12px; font-weight:900; white-space:nowrap; }

    /* KPI */
    .kpis{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;}
    @media (max-width:980px){ .kpis{grid-template-columns: repeat(2, 1fr);} }
    .kpi{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius: var(--r);
      padding:12px;
      display:flex; flex-direction:column; gap:6px;
      min-height:78px;
    }
    @media (prefers-color-scheme: light){ .kpi{background: rgba(255,255,255,.60);} }
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-size:18px; font-weight:900; letter-spacing:.2px}
    .kpi .sub{font-size:11px; color:var(--muted)}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}

    /* Kanban */
    .kanban{display:grid; grid-template-columns:repeat(3, 1fr); gap:10px;}
    @media (max-width:980px){ .kanban{grid-template-columns:1fr;} }
    .col{
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(0,0,0,.16);
      padding:10px;
      min-height:200px;
    }
    @media (prefers-color-scheme: light){ .col{background: rgba(255,255,255,.55);} }
    .colhead{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px;}
    .coltitle{font-weight:950; font-size:12px; color:var(--muted); letter-spacing:.2px}
    .dropzone{display:flex; flex-direction:column; gap:8px; min-height:120px;}
    .task{
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.06);
      padding:10px;
      cursor:grab;
      user-select:none;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    @media (prefers-color-scheme: light){ .task{background: rgba(255,255,255,.72);} }
    .task:active{cursor:grabbing; transform:scale(.997)}
    .task b{display:block; font-size:13px; margin-bottom:4px;}
    .task .tmeta{font-size:11px; color:var(--muted); display:flex; flex-wrap:wrap; gap:8px;}
    .drop-hover{outline: 2px dashed rgba(96,165,250,.55); outline-offset: 6px;}

    /* File chips */
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      font-weight:900;
      color: var(--text);
      cursor:pointer;
      user-select:none;
    }
    @media (prefers-color-scheme: light){ .chip{background: rgba(0,0,0,.05);} }
    .chip:active{transform:scale(var(--tap))}
    .chip small{font-weight:700; color:var(--muted)}
    .chip .x{
      width:18px;height:18px;border-radius:999px;
      display:grid; place-items:center;
      background: rgba(251,113,133,.14);
      border:1px solid rgba(251,113,133,.28);
      color: var(--bad);
      font-weight:1000;
      line-height:0;
    }

    /* Month planner */
    .monthWrap{display:grid; grid-template-columns: 1fr; gap:10px;}
    .monthTop{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      padding:10px;
      border-radius: var(--r);
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
    }
    @media (prefers-color-scheme: light){ .monthTop{background: rgba(255,255,255,.60);} }
    .monthTitle{font-weight:950; letter-spacing:.2px}
    .monthGrid{
      border:1px solid var(--line);
      border-radius: var(--r2);
      overflow:hidden;
      background: rgba(0,0,0,.12);
    }
    @media (prefers-color-scheme: light){ .monthGrid{background: rgba(255,255,255,.62);} }
    .monthHead{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:0;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .monthHead div{
      padding:10px 10px;
      font-size:11px;
      color:var(--muted);
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .monthCells{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
    }
    .dayCell{
      min-height:96px;
      border-right:1px solid var(--line);
      border-bottom:1px solid var(--line);
      padding:10px 10px 8px;
      position:relative;
      background: rgba(255,255,255,.02);
      cursor:pointer;
      outline:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }
    @media (prefers-color-scheme: light){ .dayCell{background: rgba(255,255,255,.35);} }
    .dayCell:nth-child(7n){border-right:none;}
    .dayCell:hover{background: rgba(255,255,255,.05)}
    .dayCell:active{transform: scale(.997)}
    .dayNum{
      font-family: var(--mono);
      font-size:12px;
      font-weight:950;
      opacity:.95;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .dayNum.muted{color:var(--muted); opacity:.75}
    .dayCell.today{
      outline: 2px solid rgba(96,165,250,.42);
      outline-offset: -2px;
      box-shadow: 0 0 0 5px rgba(96,165,250,.10) inset;
    }
    .dayCell.selected{
      box-shadow: 0 0 0 5px rgba(45,212,191,.10) inset;
      outline: 2px solid rgba(45,212,191,.32);
      outline-offset: -2px;
    }
    .dots{display:flex; gap:6px; flex-wrap:wrap; margin-top:10px;}
    .dotItem{
      width:8px;height:8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(96,165,250,.85);
    }
    .dotItem.task{background: rgba(45,212,191,.85);}
    .dotItem.note{background: rgba(251,191,36,.85);}
    .dayCell .miniCount{
      position:absolute; right:10px; top:10px;
      font-size:11px; color:var(--muted);
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      padding:3px 8px; border-radius:999px;
    }
    @media (prefers-color-scheme: light){ .dayCell .miniCount{background: rgba(255,255,255,.65);} }
    .dayDrawer{
      border:1px solid var(--line);
      border-radius: var(--r2);
      background: rgba(0,0,0,.12);
      padding:12px;
    }
    @media (prefers-color-scheme: light){ .dayDrawer{background: rgba(255,255,255,.62);} }
    .dayDrawerTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .dayDrawerTop b{font-size:13px}
    .dayDrawerTop span{font-size:12px; color:var(--muted)}
    .miniRow{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px;
      background: rgba(255,255,255,.04);
      cursor:pointer;
      outline:none;
    }
    @media (prefers-color-scheme: light){ .miniRow{background: rgba(255,255,255,.75);} }
    .miniRow b{display:block; font-size:13px; margin-bottom:4px}
    .miniRow .mmeta{font-size:11px; color:var(--muted); display:flex; flex-wrap:wrap; gap:8px}

    /* Toast */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: 16px;
      z-index:999;
      background: rgba(15,18,26,.88);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding:10px 14px;
      backdrop-filter: var(--blur);
      box-shadow: var(--shadow);
      max-width:min(980px, calc(100% - 22px));
      display:none;
      font-size:13px;
      color: var(--text);
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    @media (prefers-color-scheme: light){
      .toast{background: rgba(255,255,255,.86); border-color: rgba(0,0,0,.12);}
    }
    .toast.show{display:flex}
    .toast .msg{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:72vw}

    /* Modal */
    .modal{
      position:fixed; inset:0; display:none; place-items:center; z-index:1000;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      padding: 16px;
    }
    .modal.show{display:grid}
    .panel{
      width:min(980px, 100%);
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateY(4px);
    }
    @media (prefers-color-scheme: light){
      .panel{border-color: rgba(0,0,0,.12); background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70));}
      .modal{background: rgba(0,0,0,.30);}
    }
    .phd{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .phd h3{margin:0; font-size:14px}
    .phd p{margin:0; font-size:12px; color:var(--muted)}
    .pbd{padding:14px 16px 16px;}
    .pft{
      padding:12px 16px;
      border-top:1px solid var(--line);
      display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap;
    }

    /* Command Palette (Ctrl+K) */
    .cmdPanel{ width:min(720px, 100%); }
    .cmdInput{
      width:100%;
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(0,0,0,.18);
      font-size: 13px;
      outline:none;
      box-shadow: none;
    }
    @media (prefers-color-scheme: light){ .cmdInput{background: rgba(255,255,255,.70);} }
    .cmdList{ display:flex; flex-direction:column; gap:8px; margin-top:10px; max-height:min(52vh, 420px); overflow:auto; padding-right:4px; }
    .cmdItem{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 10px 10px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      outline:none;
    }
    @media (prefers-color-scheme: light){ .cmdItem{background: rgba(255,255,255,.78);} }
    .cmdItem:hover{ border-color: rgba(255,255,255,.16); background: rgba(255,255,255,.06); }
    @media (prefers-color-scheme: light){ .cmdItem:hover{ background: rgba(255,255,255,.92); border-color: rgba(0,0,0,.12);} }
    .cmdItem:focus-visible{ box-shadow: var(--ring2); border-color: rgba(45,212,191,.30); }
    .cmdLeft{ display:flex; flex-direction:column; gap:3px; }
    .cmdName{ font-size:13px; font-weight:950; }
    .cmdDesc{ font-size:11px; color:var(--muted); }
    .cmdKey{ font-family: var(--mono); font-size: 11px; color: var(--muted); border:1px solid var(--line); padding: 2px 8px; border-radius: 999px; background: rgba(255,255,255,.05); white-space:nowrap; }
    .cmdEmpty{ font-size:12px; color:var(--muted); padding: 8px 2px; }

    /* Loading overlay */
    .loading{
      position:fixed; inset:0; z-index:1200;
      display:none; place-items:center;
      background: rgba(0,0,0,.35);
      backdrop-filter: var(--blur);
      padding: 16px;
    }
    .loading.show{display:grid}
    .loadingCard{
      width:min(560px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      padding: 14px 14px;
      display:flex;
      gap:12px;
      align-items:center;
    }
    @media (prefers-color-scheme: light){
      .loadingCard{border-color: rgba(0,0,0,.12); background: rgba(255,255,255,.85);}
      .loading{background: rgba(0,0,0,.18);}
    }
    .spinner{
      width:18px;height:18px;border-radius:999px;
      border:2px solid rgba(255,255,255,.18);
      border-top-color: rgba(96,165,250,.9);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to{ transform: rotate(360deg);} }

    /* Mobile bottom nav */
    .bottomNav{
      position:fixed; left:0; right:0; bottom:0; z-index:60;
      padding: 10px 12px calc(10px + var(--safeBottom));
      backdrop-filter: var(--blur);
      background: linear-gradient(180deg, rgba(7,8,11,.10), rgba(7,8,11,.78));
      border-top: 1px solid var(--line);
      display:none;
    }
    @media (prefers-color-scheme: light){
      .bottomNav{ background: linear-gradient(180deg, rgba(238,240,246,.15), rgba(238,240,246,.86)); }
    }
    .bottomNav .tabs{width:100%; justify-content:space-between;}
    @media (max-width:980px){
      .bottomNav{display:block;}
      .desktopTabs{display:none;}
      .wrap{padding-bottom:132px;}
      .pill{max-width: 100%;}
    }

    @media (prefers-reduced-motion: reduce){
      *{scroll-behavior:auto !important; transition:none !important; animation:none !important}
    }
  </style>
</head>

<body class="safe">
  <div class="wrap">
    <header class="topbar" role="banner">
      <div class="brand" aria-label="Identidade do app">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Agenda Pro</h1>
          <p id="subtitle">Planner ‚Ä¢ Agenda ‚Ä¢ Tarefas ‚Ä¢ Notas ‚Ä¢ Arquivos</p>
        </div>
      </div>

      <div class="actions" aria-label="A√ß√µes do topo">
        <div class="pill" title="Usu√°rio, hora, clima e localiza√ß√£o" aria-live="polite">
          <span class="dot" id="statusDot" aria-hidden="true"></span>
          <span id="statusLine">Inicializando‚Ä¶</span>
        </div>

        <div class="desktopTabs" aria-label="Navega√ß√£o">
          <div class="tabs" id="tabsTop" role="tablist">
            <button class="tab active" data-tab="today" role="tab">üìÖ Hoje</button>
            <button class="tab" data-tab="week" role="tab">üóìÔ∏è Semana</button>
            <button class="tab" data-tab="month" role="tab">üß≠ M√™s</button>
            <button class="tab" data-tab="tasks" role="tab">‚úÖ Tarefas</button>
            <button class="tab" data-tab="notes" role="tab">üìù Notas</button>
            <button class="tab" data-tab="files" role="tab">üìé Arquivos</button>
            <button class="tab" data-tab="settings" role="tab">‚öôÔ∏è Ajustes</button>
          </div>
        </div>

        <button class="btn key" id="btnCmd" title="Comandos (Ctrl+K)">‚åò Comandos</button>
        <button class="btn ghost" id="btnBackup" title="Exportar backup JSON (Ctrl+E)">‚§ì Backup</button>
        <button class="btn primary" id="btnNew" title="Novo (N)">Ôºã Novo</button>
      </div>
    </header>

    <main class="grid" role="main">
      <!-- LEFT -->
      <section class="card" aria-label="Conte√∫do">
        <div class="hd">
          <div class="title">
            <h2 id="pageTitle">Hoje</h2>
            <p id="pageSub">Seus compromissos, atividades e quick actions</p>
          </div>

          <div class="right">
            <div class="field" style="min-width:220px;">
              <label for="quickFilter">Filtro r√°pido</label>
              <select id="quickFilter">
                <option value="all">Tudo</option>
                <option value="events">Compromissos</option>
                <option value="tasks">Tarefas</option>
                <option value="notes">Notas</option>
              </select>
            </div>
          </div>
        </div>

        <div class="bd">
          <!-- TODAY -->
          <div id="viewToday">
            <div class="kpis" aria-label="Indicadores do dia">
              <div class="kpi">
                <div class="label">Usu√°rio</div>
                <div class="value" id="kpiUser">‚Äî</div>
                <div class="sub">Perfil local</div>
              </div>
              <div class="kpi">
                <div class="label">Hoje</div>
                <div class="value" id="kpiDate">‚Äî</div>
                <div class="sub" id="kpiClock">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="label">Compromissos</div>
                <div class="value" id="kpiEvents">‚Äî</div>
                <div class="sub">No dia</div>
              </div>
              <div class="kpi">
                <div class="label">Tarefas</div>
                <div class="value" id="kpiTasks">‚Äî</div>
                <div class="sub">A fazer / em andamento</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="filters" aria-label="Busca do dia">
              <div class="field" style="min-width:240px;">
                <label for="todaySearch">Buscar</label>
                <input id="todaySearch" placeholder="Ex: reuni√£o, m√©dico, obra, academia‚Ä¶" />
              </div>
              <div class="field" style="min-width:220px;">
                <label for="todayScope">Escopo</label>
                <select id="todayScope">
                  <option value="all">Tudo</option>
                  <option value="event">Compromissos</option>
                  <option value="task">Tarefas</option>
                  <option value="note">Notas</option>
                </select>
              </div>

              <!-- NEW: Quick Add inteligente -->
              <div class="field" style="min-width:360px; flex:1 1 auto;">
                <label for="quickAddInput">Quick Add (inteligente)</label>
                <div class="quickbar">
                  <span class="ic">‚ú®</span>
                  <input id="quickAddInput" placeholder='Ex: "Reuni√£o amanh√£ 14:30 1h #cliente @Escrit√≥rio"  ou  "Tarefa: pagar conta sexta 09:00 !alta"' />
                  <span class="miniHelp"><span class="kbd">Enter</span> cria</span>
                </div>
              </div>

              <div class="field" style="min-width:220px;">
                <label>&nbsp;</label>
                <button class="btn" id="btnQuickAdd">Criar r√°pido</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="title" style="margin-bottom:10px;">
              <h2 style="margin:0; font-size:13px;">Linha do dia</h2>
              <p style="margin:0; font-size:12px; color:var(--muted)">Compromissos + tarefas + notas (ordenado por hor√°rio)</p>
            </div>
            <div class="list" id="todayList"></div>
          </div>

          <!-- WEEK -->
          <div id="viewWeek" style="display:none;">
            <div class="filters">
              <div class="field" style="min-width:220px;">
                <label for="weekStart">Semana (in√≠cio)</label>
                <input id="weekStart" type="date" />
              </div>
              <div class="field" style="min-width:220px;">
                <label for="weekSearch">Buscar</label>
                <input id="weekSearch" placeholder="Ex: cliente, projeto, compromisso‚Ä¶" />
              </div>
              <div class="field" style="min-width:220px;">
                <label for="weekType">Tipo</label>
                <select id="weekType">
                  <option value="all">Tudo</option>
                  <option value="event">Compromissos</option>
                  <option value="task">Tarefas</option>
                  <option value="note">Notas</option>
                </select>
              </div>
            </div>

            <div class="divider"></div>

            <div class="hint">
              Dica: <span class="kbd">N</span> cria r√°pido ‚Ä¢ arraste tarefas no Kanban ‚Ä¢ anexos ficam no navegador (IndexedDB).
            </div>

            <div class="divider"></div>

            <div class="list" id="weekList"></div>
          </div>

          <!-- MONTH -->
          <div id="viewMonth" style="display:none;">
            <div class="monthWrap">
              <div class="monthTop">
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                  <div class="monthTitle" id="monthTitle">‚Äî</div>
                  <span class="badge" id="monthMeta">‚Äî</span>
                </div>
                <div class="right">
                  <button class="btn" id="btnMonthPrev" title="M√™s anterior">‚Üê</button>
                  <button class="btn" id="btnMonthToday" title="Ir para hoje">Hoje</button>
                  <button class="btn" id="btnMonthNext" title="Pr√≥ximo m√™s">‚Üí</button>
                  <button class="btn primary" id="btnMonthCreate" title="Criar item no dia selecionado">Ôºã Criar</button>
                </div>
              </div>

              <div class="monthGrid" aria-label="Calend√°rio do m√™s">
                <div class="monthHead">
                  <div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>S√°b</div><div>Dom</div>
                </div>
                <div class="monthCells" id="monthCells"></div>
              </div>

              <div class="dayDrawer" aria-label="Detalhes do dia">
                <div class="dayDrawerTop">
                  <div>
                    <b id="dayDrawerTitle">Selecione um dia</b><br/>
                    <span id="dayDrawerSub">Mostra compromissos, tarefas e notas desse dia.</span>
                  </div>
                  <div class="right">
                    <button class="btn" id="btnDayNewEvent">üìÖ</button>
                    <button class="btn" id="btnDayNewTask">‚úÖ</button>
                    <button class="btn" id="btnDayNewNote">üìù</button>
                  </div>
                </div>
                <div class="divider"></div>
                <div class="list" id="dayDrawerList"></div>
                <div class="divider"></div>
                <div class="hint">Dica: arraste uma tarefa do Kanban e solte num dia para mudar o vencimento ‚úÖ</div>
              </div>

              <div class="hint">
                Clique em um dia para abrir os detalhes. Pontinhos = itens (üìÖ/‚úÖ/üìù).
              </div>
            </div>
          </div>

          <!-- TASKS -->
          <div id="viewTasks" style="display:none;">
            <div class="filters">
              <div class="field" style="min-width:260px;">
                <label for="taskSearch">Buscar</label>
                <input id="taskSearch" placeholder="Ex: enviar relat√≥rio, mercado, academia‚Ä¶" />
              </div>
              <div class="field" style="min-width:220px;">
                <label for="taskSort">Ordenar</label>
                <select id="taskSort">
                  <option value="priority">Prioridade</option>
                  <option value="due">Vencimento</option>
                  <option value="created">Cria√ß√£o</option>
                </select>
              </div>
              <div class="field" style="min-width:220px;">
                <label>&nbsp;</label>
                <button class="btn" id="btnNewTask">Ôºã Nova tarefa</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="kanban" id="kanban">
              <div class="col" data-col="todo">
                <div class="colhead">
                  <div class="coltitle">A FAZER</div>
                  <span class="badge" id="countTodo">0</span>
                </div>
                <div class="dropzone" id="zoneTodo"></div>
              </div>

              <div class="col" data-col="doing">
                <div class="colhead">
                  <div class="coltitle">EM ANDAMENTO</div>
                  <span class="badge" id="countDoing">0</span>
                </div>
                <div class="dropzone" id="zoneDoing"></div>
              </div>

              <div class="col" data-col="done">
                <div class="colhead">
                  <div class="coltitle">FEITO</div>
                  <span class="badge" id="countDone">0</span>
                </div>
                <div class="dropzone" id="zoneDone"></div>
              </div>
            </div>
          </div>

          <!-- NOTES -->
          <div id="viewNotes" style="display:none;">
            <div class="filters">
              <div class="field" style="min-width:260px;">
                <label for="noteSearch">Buscar</label>
                <input id="noteSearch" placeholder="Ex: ideias, reuni√µes, checklist‚Ä¶" />
              </div>
              <div class="field" style="min-width:220px;">
                <label for="noteTag">Tag</label>
                <input id="noteTag" placeholder="Ex: obra, pessoal‚Ä¶" />
              </div>
              <div class="field" style="min-width:220px;">
                <label>&nbsp;</label>
                <button class="btn" id="btnNewNote">Ôºã Nova nota</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="list" id="notesList"></div>
          </div>

          <!-- FILES -->
          <div id="viewFiles" style="display:none;">
            <div class="filters">
              <div class="field" style="min-width:280px;">
                <label for="fileSearch">Buscar arquivo</label>
                <input id="fileSearch" placeholder="Ex: pdf, contrato, foto‚Ä¶" />
              </div>
              <div class="field" style="min-width:240px;">
                <label>&nbsp;</label>
                <button class="btn" id="btnAddFiles">üìé Importar arquivos</button>
                <input id="filesInput" type="file" multiple style="display:none" />
              </div>
            </div>

            <div class="divider"></div>

            <div class="hint">
              Arquivos s√£o guardados <b>no seu navegador</b> (IndexedDB). Voc√™ pode anexar arquivos em compromissos/tarefas/notas.
            </div>

            <div class="divider"></div>

            <div class="list" id="filesList"></div>
          </div>

          <!-- SETTINGS -->
          <div id="viewSettings" style="display:none;">
            <div class="hint">
              Ajustes do app (salvo localmente). Para GPS e clima, use <b>HTTPS</b>. (GitHub Pages j√° √© HTTPS.)
            </div>

            <div class="divider"></div>

            <div class="filters">
              <div class="field" style="min-width:260px;">
                <label for="setUserName">Nome do usu√°rio</label>
                <input id="setUserName" placeholder="Ex: Wilson" />
              </div>
              <div class="field" style="min-width:260px;">
                <label for="setGeo">Localiza√ß√£o</label>
                <select id="setGeo">
                  <option value="ask">Perguntar / solicitar permiss√£o</option>
                  <option value="off">Desligado</option>
                </select>
              </div>
              <div class="field" style="min-width:260px;">
                <label for="setUnits">Unidades</label>
                <select id="setUnits">
                  <option value="metric">M√©trico (¬∞C, km)</option>
                  <option value="imperial">Imperial (¬∞F, mi)</option>
                </select>
              </div>
            </div>

            <div class="divider"></div>

            <div class="filters">
              <div class="field" style="min-width:260px;">
                <label>&nbsp;</label>
                <button class="btn primary" id="btnSaveSettings">‚úî Salvar ajustes</button>
              </div>
              <div class="field" style="min-width:260px;">
                <label>&nbsp;</label>
                <button class="btn" id="btnDemo">‚ú® Criar dados demo</button>
              </div>
              <div class="field" style="min-width:260px;">
                <label>&nbsp;</label>
                <button class="btn danger" id="btnWipe">üóëÔ∏è Limpar itens</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="filters">
              <div class="field" style="min-width:260px;">
                <label>&nbsp;</label>
                <button class="btn" id="btnRestore">‚§í Importar backup</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="hint">
              Atalhos: <span class="kbd">N</span> novo ‚Ä¢ <span class="kbd">Ctrl+E</span> backup ‚Ä¢ <span class="kbd">Esc</span> fechar ‚Ä¢ <span class="kbd">Ctrl+K</span> comandos ‚Ä¢ <span class="kbd">Alt+M</span> M√™s
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card" aria-label="Painel r√°pido">
        <div class="hd">
          <div class="title">
            <h2>Centro</h2>
            <p id="rightSub">Resumo + a√ß√µes r√°pidas</p>
          </div>
          <button class="btn ghost" id="btnNow">‚ü≥ Atualizar</button>
        </div>

        <div class="bd">
          <div class="kpi" style="margin-bottom:10px;">
            <div class="label">Agora</div>
            <div class="value" id="nowTime">‚Äî</div>
            <div class="sub" id="nowMeta">‚Äî</div>
          </div>

          <div class="divider"></div>

          <div class="title" style="margin-bottom:10px;">
            <h2 style="margin:0; font-size:13px;">Pr√≥ximos 3</h2>
            <p style="margin:0; font-size:12px; color:var(--muted)">Compromissos e tarefas com vencimento</p>
          </div>
          <div class="list" id="nextList"></div>

          <div class="divider"></div>

          <div class="title">
            <h2 style="margin:0; font-size:13px;">Privacidade (r√°pido)</h2>
            <p style="margin:0; font-size:12px; color:var(--muted)">Localiza√ß√£o s√≥ se voc√™ permitir</p>
          </div>
          <div class="divider"></div>

          <div class="hint">
            ‚úÖ Sem login por enquanto<br/>
            ‚úÖ Salva no navegador (localStorage + IndexedDB)<br/>
            ‚úÖ Cada registro pode ter <b>hor√°rio</b>, <b>local</b>, <b>GPS</b> e <b>anexos</b><br/>
            ‚úÖ Vis√µes: Hoje / Semana / M√™s / Kanban / Notas / Arquivos<br/>
            ‚ú® Novo: <b>Quick Add inteligente</b> + <b>Comandos (Ctrl+K)</b>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Mobile bottom nav -->
  <nav class="bottomNav" aria-label="Navega√ß√£o inferior">
    <div class="tabs" id="tabsBottom" role="tablist">
      <button class="tab active" data-tab="today" title="Hoje">üìÖ</button>
      <button class="tab" data-tab="week" title="Semana">üóìÔ∏è</button>
      <button class="tab" data-tab="month" title="M√™s">üß≠</button>
      <button class="tab" data-tab="tasks" title="Tarefas">‚úÖ</button>
      <button class="tab" data-tab="notes" title="Notas">üìù</button>
      <button class="tab" data-tab="files" title="Arquivos">üìé</button>
      <button class="tab" data-tab="settings" title="Ajustes">‚öôÔ∏è</button>
    </div>
  </nav>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite" aria-hidden="true">
    <div class="msg" id="toastMsg">‚Äî</div>
    <button class="btn ghost" id="toastClose" style="padding:8px 10px;">OK</button>
  </div>

  <!-- Loading -->
  <div class="loading" id="loading" aria-hidden="true">
    <div class="loadingCard">
      <div class="spinner" aria-hidden="true"></div>
      <div>
        <div style="font-weight:950; font-size:13px;">Processando</div>
        <div class="hint" id="loadingMsg">Carregando‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- Command Palette Modal -->
  <div class="modal" id="cmdModal" aria-hidden="true">
    <div class="panel cmdPanel" role="dialog" aria-modal="true" aria-labelledby="cmdTitle">
      <div class="phd">
        <div class="title">
          <h3 id="cmdTitle">Comandos</h3>
          <p>Digite para buscar a√ß√µes, p√°ginas e itens ‚Ä¢ <span class="kbd">Enter</span> executa</p>
        </div>
        <div class="right">
          <button class="btn ghost" id="btnCloseCmd">Fechar</button>
        </div>
      </div>
      <div class="pbd">
        <input class="cmdInput" id="cmdInput" placeholder="Ex: novo evento ‚Ä¢ m√™s ‚Ä¢ backup ‚Ä¢ abrir 'reuni√£o'‚Ä¶" autocomplete="off" />
        <div class="cmdList" id="cmdList"></div>
        <div class="divider"></div>
        <div class="hint">Dicas: <span class="kbd">Ctrl+K</span> abre ‚Ä¢ <span class="kbd">‚Üë</span>/<span class="kbd">‚Üì</span> navega ‚Ä¢ <span class="kbd">Esc</span> fecha</div>
      </div>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal" id="itemModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="phd">
        <div class="title">
          <h3 id="modalTitle">Novo</h3>
          <p id="modalSub">Compromisso, tarefa ou nota</p>
        </div>
        <div class="right">
          <button class="btn ghost" id="btnCloseModal">Fechar</button>
        </div>
      </div>

      <div class="pbd">
        <div class="filters">
          <div class="field" style="min-width:220px;">
            <label for="mType">Tipo</label>
            <select id="mType">
              <option value="event">Compromisso</option>
              <option value="task">Tarefa</option>
              <option value="note">Nota</option>
            </select>
          </div>

          <div class="field" style="min-width:280px; flex:1 1 auto;">
            <label for="mTitle">T√≠tulo</label>
            <input id="mTitle" placeholder="Ex: Reuni√£o com cliente / Academia / Ideia de projeto‚Ä¶" />
          </div>

          <div class="field" style="min-width:220px;">
            <label for="mPriority">Prioridade</label>
            <select id="mPriority">
              <option value="2">Normal</option>
              <option value="3">Alta</option>
              <option value="1">Baixa</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="filters">
          <div class="field" style="min-width:240px;">
            <label for="mStart">In√≠cio</label>
            <input id="mStart" type="datetime-local" />
          </div>
          <div class="field" style="min-width:240px;">
            <label for="mEnd">Fim</label>
            <input id="mEnd" type="datetime-local" />
          </div>
          <div class="field" style="min-width:240px;">
            <label for="mDue">Vencimento (tarefa)</label>
            <input id="mDue" type="datetime-local" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="filters">
          <div class="field" style="min-width:240px;">
            <label for="mLocationName">Local (texto)</label>
            <input id="mLocationName" placeholder="Ex: Escrit√≥rio, Casa, Rua X‚Ä¶" />
          </div>
          <div class="field" style="min-width:240px;">
            <label for="mTags">Tags (v√≠rgula)</label>
            <input id="mTags" placeholder="Ex: obra, pessoal, cliente" />
          </div>
          <div class="field" style="min-width:240px;">
            <label for="mStatus">Status</label>
            <select id="mStatus">
              <option value="planned">Planejado</option>
              <option value="doing">Em andamento</option>
              <option value="done">Conclu√≠do</option>
              <option value="canceled">Cancelado</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="filters">
          <div class="field" style="min-width:280px; flex:1 1 auto;">
            <label for="mBody">Anota√ß√µes</label>
            <textarea id="mBody" placeholder="Detalhes, pauta, checklist, links‚Ä¶"></textarea>
          </div>
          <div class="field" style="min-width:320px;">
            <label for="mFiles">Anexos</label>
            <input id="mFiles" type="file" multiple />
            <div class="hint" style="margin-top:6px;">
              Dica: PDFs/fotos ficam no navegador. Voc√™ consegue baixar depois.
            </div>
            <div class="chips" id="mFileChips"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="filters">
          <div class="field" style="min-width:260px;">
            <label>Localiza√ß√£o (GPS)</label>
            <button class="btn" id="btnAttachGPS">üìç Anexar GPS agora</button>
            <div class="hint" id="gpsHint" style="margin-top:6px;">Sem GPS anexado.</div>
          </div>
          <div class="field" style="min-width:260px;">
            <label>Coluna Kanban</label>
            <select id="mKanban">
              <option value="todo">A fazer</option>
              <option value="doing">Em andamento</option>
              <option value="done">Feito</option>
            </select>
            <div class="hint" style="margin-top:6px;">S√≥ aplica para Tarefa.</div>
          </div>
        </div>
      </div>

      <div class="pft">
        <div class="hint" id="modalFootHint">Criado em: ‚Äî</div>
        <div class="right">
          <button class="btn danger" id="btnDelete" style="display:none;">üóëÔ∏è Excluir</button>
          <button class="btn" id="btnDuplicate">‚éò Duplicar</button>
          <button class="btn primary" id="btnSave">‚úî Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Restore Modal -->
  <div class="modal" id="restoreModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="restoreTitle">
      <div class="phd">
        <div class="title">
          <h3 id="restoreTitle">Importar backup</h3>
          <p>Restaura itens (sem anexos). Anexos ficam no seu navegador.</p>
        </div>
        <div class="right">
          <button class="btn ghost" id="btnCloseRestore">Fechar</button>
        </div>
      </div>
      <div class="pbd">
        <div class="filters">
          <div class="field" style="min-width:320px;">
            <label for="restoreFile">Arquivo JSON</label>
            <input id="restoreFile" type="file" accept="application/json" />
          </div>
          <div class="field" style="min-width:240px;">
            <label>&nbsp;</label>
            <button class="btn primary" id="btnDoRestore">‚¨Ü Importar</button>
          </div>
        </div>
        <div class="divider"></div>
        <div class="hint">
          Seguran√ßa: importe apenas backup do seu app. N√£o importa anexos (eles ficam na sua IndexedDB local).
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   Agenda Pro ‚Äî single-file app (v3.2)
   NOVO (v3.2):
   - Quick Add inteligente (parser: amanh√£, 14:30, 1h, #tags, @local, !alta)
   - Command Palette (Ctrl+K) com a√ß√µes + busca de itens
   - Perf: content-visibility nas listas + render com fragment (menos layout thrash)
   - UX: bot√£o ‚Äú‚åò Comandos‚Äù + Quick Add Spotlight-like
   ========================================================= */

const $ = (id)=>document.getElementById(id);
const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

const LS_KEY = "agenda_pro_v3_items";
const LS_SETTINGS = "agenda_pro_v3_settings";
const LS_ACTIVE_TAB = "agenda_pro_v3_active_tab";
const LS_MONTH_CURSOR = "agenda_pro_v3_month_cursor";
const DB_NAME = "AgendaProDB";
const DB_VER = 1;
const FILE_STORE = "files";

const state = {
  activeTab: "today",
  items: [],
  settings: { userName: "Wilson", geo: "ask", units: "metric" },

  geo: { ok:false, lat:null, lon:null, accuracy:null, lastFixAt:0 },
  weather: { ok:false, temp:null, desc:"", code:null, lastAt:0 },

  renderQueued: false,
  editingId: null,
  tempFiles: [],
  tempGeo: null,
  month: { cursor: new Date(), selected: null },

  db: null,
  toastTimer: null,

  // NEW: command palette state
  cmd: { open:false, items:[], idx:0, q:"" }
};

/* ===================== UX ===================== */
function showLoading(msg="Carregando‚Ä¶"){
  $("loadingMsg").textContent = msg;
  $("loading").classList.add("show");
  $("loading").setAttribute("aria-hidden","false");
}
function hideLoading(){
  $("loading").classList.remove("show");
  $("loading").setAttribute("aria-hidden","true");
}
function toast(msg){
  $("toastMsg").textContent = msg;
  $("toast").classList.add("show");
  $("toast").setAttribute("aria-hidden","false");
  clearTimeout(state.toastTimer);
  state.toastTimer = setTimeout(()=> {
    $("toast").classList.remove("show");
    $("toast").setAttribute("aria-hidden","true");
  }, 2600);
}
$("toastClose").addEventListener("click", ()=> {
  $("toast").classList.remove("show");
  $("toast").setAttribute("aria-hidden","true");
});
function rafRender(){
  if(state.renderQueued) return;
  state.renderQueued = true;
  requestAnimationFrame(async ()=>{
    state.renderQueued = false;
    await renderAll();
  });
}
function debounce(fn, ms){
  let t=null;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

/* ===================== Modal A11y ===================== */
function getFocusable(container){
  return Array.from(container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))
    .filter(el=>!el.disabled && el.offsetParent!==null);
}
let modalTrapHandler = null;
let lastFocus = null;

function openModal(id){
  const m = $(id);
  lastFocus = document.activeElement;
  m.classList.add("show");
  m.setAttribute("aria-hidden","false");
  document.body.style.overflow = "hidden";

  const panel = m.querySelector(".panel");
  const f = getFocusable(panel);
  if(f[0]) f[0].focus({preventScroll:true});

  modalTrapHandler = (e)=>{
    if(e.key !== "Tab") return;
    const items = getFocusable(panel);
    if(items.length===0) return;
    const first = items[0];
    const last = items[items.length-1];
    if(e.shiftKey && document.activeElement === first){
      e.preventDefault(); last.focus();
    }else if(!e.shiftKey && document.activeElement === last){
      e.preventDefault(); first.focus();
    }
  };
  document.addEventListener("keydown", modalTrapHandler);

  m.addEventListener("mousedown", (e)=>{
    const panel = m.querySelector(".panel");
    if(panel && !panel.contains(e.target)){
      if(id==="itemModal") closeItemModal();
      if(id==="restoreModal") closeRestore();
      if(id==="cmdModal") closeCmd();
    }
  }, {once:true});
}
function closeModal(id){
  const m = $(id);
  m.classList.remove("show");
  m.setAttribute("aria-hidden","true");
  document.body.style.overflow = "";

  if(modalTrapHandler){
    document.removeEventListener("keydown", modalTrapHandler);
    modalTrapHandler = null;
  }
  if(lastFocus) lastFocus.focus({preventScroll:true});
}

/* ===================== Date helpers ===================== */
function pad(n){return String(n).padStart(2,"0");}
function toISODate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function toLocalDTInputValue(d){ return `${toISODate(d)}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function parseDT(v){
  if(!v) return null;
  const d = new Date(v);
  return isNaN(d.getTime()) ? null : d;
}
function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
function startOfWeekMon(d){
  const x = startOfDay(d);
  const day = x.getDay(); // 0 dom
  const diff = (day===0 ? -6 : 1-day);
  x.setDate(x.getDate()+diff);
  return x;
}
function fmtNiceDT(dt){
  if(!dt) return "‚Äî";
  const d = (dt instanceof Date) ? dt : new Date(dt);
  if(isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleString("pt-BR", {weekday:"short", day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit"});
}
function fmtNiceDate(dt){
  const d = (dt instanceof Date) ? dt : new Date(dt);
  return d.toLocaleDateString("pt-BR", {weekday:"long", day:"2-digit", month:"long", year:"numeric"});
}
function safeText(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }
function uid(){ return (crypto?.randomUUID?.() || `id_${Date.now()}_${Math.random().toString(16).slice(2)}`); }

/* ===================== Domain helpers ===================== */
function normalizeTags(v){
  return String(v||"")
    .split(",")
    .map(x=>x.trim())
    .filter(Boolean)
    .slice(0,12);
}
function prioLabel(p){ return p==3?"Alta":p==1?"Baixa":"Normal"; }
function typeEmoji(t){ return t==="event"?"üìÖ":t==="task"?"‚úÖ":"üìù"; }
function statusBadge(it){
  const s = it.status || "planned";
  if(it.type==="task"){
    if(it.kanban==="done" || s==="done") return "done";
    if(it.kanban==="doing" || s==="doing") return "doing";
    return "planned";
  }
  return s;
}

function idbOpen(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(FILE_STORE)){
        db.createObjectStore(FILE_STORE, { keyPath:"id" });
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}
function idbTx(mode="readonly"){
  const tx = state.db.transaction(FILE_STORE, mode);
  return tx.objectStore(FILE_STORE);
}
function idbPutFile(fileObj){
  return new Promise((resolve, reject)=>{
    const store = idbTx("readwrite");
    const req = store.put(fileObj);
    req.onsuccess = ()=> resolve(true);
    req.onerror = ()=> reject(req.error);
  });
}
function idbGetFile(id){
  return new Promise((resolve, reject)=>{
    const store = idbTx("readonly");
    const req = store.get(id);
    req.onsuccess = ()=> resolve(req.result || null);
    req.onerror = ()=> reject(req.error);
  });
}
function idbDelFile(id){
  return new Promise((resolve, reject)=>{
    const store = idbTx("readwrite");
    const req = store.delete(id);
    req.onsuccess = ()=> resolve(true);
    req.onerror = ()=> reject(req.error);
  });
}
function idbListFiles(){
  return new Promise((resolve, reject)=>{
    const store = idbTx("readonly");
    const req = store.getAll();
    req.onsuccess = ()=> resolve(req.result || []);
    req.onerror = ()=> reject(req.error);
  });
}

/* ===================== Storage estimate (v3.2) ===================== */
async function refreshStorageInfo(){
  // nem todo browser suporta navigator.storage.estimate()
  if(!navigator.storage?.estimate){
    state.storage = { ok:false, usage:null, quota:null, lastAt:Date.now() };
    $("storageHint").textContent = "Armazenamento: (estimativa indispon√≠vel neste navegador)";
    return;
  }
  try{
    const est = await navigator.storage.estimate();
    state.storage = { ok:true, usage: est.usage || null, quota: est.quota || null, lastAt:Date.now() };
    const usage = est.usage ?? 0;
    const quota = est.quota ?? 0;
    const pct = quota ? Math.min(100, Math.round(usage/quota*100)) : null;
    const fmt = (b)=> {
      const u = ["B","KB","MB","GB"]; let i=0; let n=b;
      while(n>=1024 && i<u.length-1){ n/=1024; i++; }
      return `${n.toFixed(i===0?0:1)} ${u[i]}`;
    };
    $("storageHint").textContent = quota
      ? `Armazenamento: usando ${fmt(usage)} de ${fmt(quota)} (${pct}%)`
      : `Armazenamento: usando ${fmt(usage)}`;
  }catch(e){
    state.storage = { ok:false, usage:null, quota:null, lastAt:Date.now() };
    $("storageHint").textContent = "Armazenamento: (erro ao estimar)";
  }
}

/* ===================== Geo + Weather (sem API paga) ===================== */
async function getGeoFix(){
  if(state.settings.geo==="off"){
    state.geo.ok=false;
    return null;
  }
  if(!("geolocation" in navigator)){
    state.geo.ok=false;
    return null;
  }
  return new Promise((resolve)=>{
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        state.geo.ok = true;
        state.geo.lat = pos.coords.latitude;
        state.geo.lon = pos.coords.longitude;
        state.geo.accuracy = pos.coords.accuracy;
        state.geo.lastFixAt = Date.now();
        resolve(state.geo);
      },
      ()=>{
        state.geo.ok=false;
        resolve(null);
      },
      {
        enableHighAccuracy:true,
        timeout: 9000,
        maximumAge: 60_000
      }
    );
  });
}

/* Clima: usa Open-Meteo (gr√°tis, sem chave) */
async function refreshWeather(){
  // s√≥ tenta se temos geo ok
  if(!state.geo.ok || state.geo.lat==null || state.geo.lon==null) return;

  // evita spam: 10 min cache
  if(state.weather.ok && (Date.now()-state.weather.lastAt) < 10*60*1000) return;

  const lat = state.geo.lat.toFixed(4);
  const lon = state.geo.lon.toFixed(4);
  try{
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`;
    const r = await fetch(url, {cache:"no-store"});
    if(!r.ok) throw new Error("weather");
    const j = await r.json();
    const t = j?.current?.temperature_2m;
    const code = j?.current?.weather_code;
    const desc = weatherCodeToText(code);
    state.weather = { ok:true, temp:t, desc, code, lastAt:Date.now() };
  }catch(e){
    state.weather.ok=false;
  }
}
function weatherCodeToText(code){
  // mapa simples (Open-Meteo WMO)
  const m = {
    0:"C√©u limpo", 1:"Predom. limpo", 2:"Parcialmente nublado", 3:"Nublado",
    45:"Neblina", 48:"Neblina", 51:"Garoa fraca", 53:"Garoa", 55:"Garoa forte",
    61:"Chuva fraca", 63:"Chuva", 65:"Chuva forte",
    71:"Neve fraca", 73:"Neve", 75:"Neve forte",
    80:"Pancadas fracas", 81:"Pancadas", 82:"Pancadas fortes",
    95:"Tempestade", 96:"Tempestade c/ granizo", 99:"Granizo"
  };
  return m[code] || "Tempo";
}

/* ===================== Items CRUD ===================== */
function newItem(type="event", seed={}){
  const now = new Date();
  const base = {
    id: uid(),
    type,
    title: "",
    body: "",
    tags: [],
    priority: 2,
    status: "planned",
    kanban: "todo",
    locationName: "",
    geo: null,
    files: [], // [{id,name,type,size,addedAt}]
    createdAt: now.toISOString(),
    updatedAt: now.toISOString(),
    start: null,
    end: null,
    due: null
  };
  return {...base, ...seed};
}
function upsertItem(item){
  item.updatedAt = new Date().toISOString();
  const idx = state.items.findIndex(x=>x.id===item.id);
  if(idx>=0) state.items[idx] = item;
  else state.items.unshift(item);
  saveAll();
  rafRender();
}
function deleteItem(id){
  const idx = state.items.findIndex(x=>x.id===id);
  if(idx>=0){
    state.items.splice(idx,1);
    saveAll();
    rafRender();
  }
}

/* ===================== Modal Create/Edit ===================== */
function resetModalTemp(){
  state.editingId = null;
  state.tempFiles = [];
  state.tempGeo = null;
  $("mFiles").value = "";
  $("mFileChips").innerHTML = "";
  $("gpsHint").textContent = "Sem GPS anexado.";
}
function openNewModal(defaultType="event", prefill={}){
  resetModalTemp();
  $("modalTitle").textContent = "Novo";
  $("modalSub").textContent = "Compromisso, tarefa ou nota";
  $("btnDelete").style.display = "none";

  $("mType").value = defaultType;
  $("mTitle").value = prefill.title || "";
  $("mPriority").value = String(prefill.priority ?? 2);
  $("mStatus").value = prefill.status || "planned";
  $("mKanban").value = prefill.kanban || "todo";
  $("mBody").value = prefill.body || "";
  $("mTags").value = (prefill.tags||[]).join(", ");
  $("mLocationName").value = prefill.locationName || "";

  // times
  const now = new Date();
  const start = prefill.start ? new Date(prefill.start) : now;
  $("mStart").value = toLocalDTInputValue(start);
  $("mEnd").value = prefill.end ? toLocalDTInputValue(new Date(prefill.end)) : "";
  $("mDue").value = prefill.due ? toLocalDTInputValue(new Date(prefill.due)) : "";

  $("modalFootHint").textContent = "Criado em: ‚Äî";
  applyModalTypeUI();
  openModal("itemModal");
}
function openEditModal(id){
  const it = state.items.find(x=>x.id===id);
  if(!it){ toast("Item n√£o encontrado."); return; }

  resetModalTemp();
  state.editingId = id;

  $("modalTitle").textContent = "Editar";
  $("modalSub").textContent = `${typeEmoji(it.type)} ${it.type==="event"?"Compromisso":it.type==="task"?"Tarefa":"Nota"}`;
  $("btnDelete").style.display = "inline-flex";

  $("mType").value = it.type;
  $("mTitle").value = it.title || "";
  $("mPriority").value = String(it.priority ?? 2);
  $("mStatus").value = it.status || "planned";
  $("mKanban").value = it.kanban || "todo";
  $("mBody").value = it.body || "";
  $("mTags").value = (it.tags||[]).join(", ");
  $("mLocationName").value = it.locationName || "";

  $("mStart").value = it.start ? toLocalDTInputValue(new Date(it.start)) : "";
  $("mEnd").value = it.end ? toLocalDTInputValue(new Date(it.end)) : "";
  $("mDue").value = it.due ? toLocalDTInputValue(new Date(it.due)) : "";

  // files chips
  state.tempFiles = Array.isArray(it.files) ? [...it.files] : [];
  renderModalFileChips();

  // geo
  state.tempGeo = it.geo || null;
  $("gpsHint").textContent = it.geo
    ? `GPS anexado: ${it.geo.lat.toFixed(5)}, ${it.geo.lon.toFixed(5)} (¬±${Math.round(it.geo.accuracy||0)}m)`
    : "Sem GPS anexado.";

  $("modalFootHint").textContent = `Criado em: ${fmtNiceDT(it.createdAt)} ‚Ä¢ Atualizado: ${fmtNiceDT(it.updatedAt)}`;

  applyModalTypeUI();
  openModal("itemModal");
}
function closeItemModal(){
  closeModal("itemModal");
  resetModalTemp();
}
$("btnCloseModal").addEventListener("click", closeItemModal);

function applyModalTypeUI(){
  const t = $("mType").value;
  const due = $("mDue").closest(".field");
  const kan = $("mKanban").closest(".field");
  const end = $("mEnd").closest(".field");
  if(t==="task"){
    due.style.display = "flex";
    kan.style.display = "flex";
    end.style.display = "none";
    $("mStatus").value = $("mStatus").value || "planned";
  }else if(t==="event"){
    due.style.display = "none";
    kan.style.display = "none";
    end.style.display = "flex";
  }else{
    due.style.display = "none";
    kan.style.display = "none";
    end.style.display = "none";
  }
}
$("mType").addEventListener("change", applyModalTypeUI);

/* ===== Anexos no modal ===== */
function renderModalFileChips(){
  const wrap = $("mFileChips");
  wrap.innerHTML = "";
  if(!state.tempFiles.length){
    wrap.innerHTML = `<span class="hint">Nenhum anexo neste item.</span>`;
    return;
  }
  for(const f of state.tempFiles){
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.innerHTML = `${safeText(f.name)} <small>${formatBytes(f.size||0)}</small> <span class="x" title="Remover">√ó</span>`;
    chip.addEventListener("click", async (e)=>{
      // se clicou no X: remover
      if(e.target && e.target.classList.contains("x")){
        state.tempFiles = state.tempFiles.filter(x=>x.id!==f.id);
        renderModalFileChips();
        return;
      }
      // abrir download
      const obj = await idbGetFile(f.id);
      if(!obj){ toast("Arquivo n√£o encontrado no armazenamento local."); return; }
      downloadBlob(obj.blob, obj.name);
    });
    wrap.appendChild(chip);
  }
}
function formatBytes(b){
  const u=["B","KB","MB","GB"]; let i=0; let n=b||0;
  while(n>=1024 && i<u.length-1){ n/=1024; i++; }
  return `${n.toFixed(i===0?0:1)} ${u[i]}`;
}
function downloadBlob(blob, name){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = name || "arquivo";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}

$("mFiles").addEventListener("change", async ()=>{
  const files = Array.from($("mFiles").files || []);
  if(!files.length) return;
  showLoading("Salvando anexos‚Ä¶");
  try{
    for(const f of files){
      const id = uid();
      const obj = {
        id,
        name: f.name,
        type: f.type || "application/octet-stream",
        size: f.size || 0,
        addedAt: new Date().toISOString(),
        blob: f
      };
      await idbPutFile(obj);
      state.tempFiles.push({ id, name: obj.name, type: obj.type, size: obj.size, addedAt: obj.addedAt });
    }
    renderModalFileChips();
    await refreshStorageInfo();
    toast("Anexos adicionados.");
  }catch(e){
    toast("Falha ao salvar anexos (IndexedDB).");
  }finally{
    hideLoading();
    $("mFiles").value = "";
  }
});

/* ===== GPS no modal ===== */
$("btnAttachGPS").addEventListener("click", async ()=>{
  showLoading("Capturando GPS‚Ä¶");
  const fix = await getGeoFix();
  hideLoading();
  if(!fix){
    toast("GPS indispon√≠vel / permiss√£o negada.");
    return;
  }
  state.tempGeo = { lat: fix.lat, lon: fix.lon, accuracy: fix.accuracy, at: new Date().toISOString() };
  $("gpsHint").textContent = `GPS anexado: ${fix.lat.toFixed(5)}, ${fix.lon.toFixed(5)} (¬±${Math.round(fix.accuracy||0)}m)`;
  toast("GPS anexado ao item (ao salvar).");
});

/* ===== Save/Delete/Duplicate ===== */
$("btnSave").addEventListener("click", ()=>{
  const type = $("mType").value;
  const title = $("mTitle").value.trim();
  if(!title){
    toast("T√≠tulo √© obrigat√≥rio.");
    $("mTitle").focus();
    return;
  }

  const tags = normalizeTags($("mTags").value);
  const prio = Number($("mPriority").value)||2;
  const status = $("mStatus").value || "planned";
  const kanban = $("mKanban").value || "todo";
  const body = $("mBody").value || "";
  const locationName = $("mLocationName").value || "";

  const start = parseDT($("mStart").value);
  const end   = parseDT($("mEnd").value);
  const due   = parseDT($("mDue").value);

  let it = null;
  if(state.editingId){
    it = state.items.find(x=>x.id===state.editingId);
    if(!it){ toast("Item n√£o encontrado."); return; }
  }else{
    it = newItem(type);
  }

  it.type = type;
  it.title = title;
  it.body = body;
  it.tags = tags;
  it.priority = prio;
  it.status = status;
  it.kanban = type==="task" ? kanban : it.kanban;
  it.locationName = locationName;
  it.geo = state.tempGeo ? {...state.tempGeo} : null;
  it.files = [...state.tempFiles];

  it.start = (type==="note") ? null : (start ? start.toISOString() : null);
  it.end   = (type==="event") ? (end ? end.toISOString() : null) : null;
  it.due   = (type==="task") ? (due ? due.toISOString() : null) : null;

  // sanity: event end before start
  if(it.type==="event" && it.start && it.end){
    const a=new Date(it.start), b=new Date(it.end);
    if(b < a){
      toast("Fim n√£o pode ser antes do in√≠cio.");
      return;
    }
  }

  upsertItem(it);
  toast("Salvo.");
  closeItemModal();
});

$("btnDelete").addEventListener("click", ()=>{
  if(!state.editingId) return;
  const it = state.items.find(x=>x.id===state.editingId);
  if(!it) return;
  const ok = confirm(`Excluir "${it.title}"?`);
  if(!ok) return;
  deleteItem(it.id);
  toast("Exclu√≠do.");
  closeItemModal();
});

$("btnDuplicate").addEventListener("click", ()=>{
  // duplica o que est√° no modal (sem depender de salvar antes)
  const type = $("mType").value;
  const title = $("mTitle").value.trim() || "C√≥pia";
  const tags = normalizeTags($("mTags").value);
  const prio = Number($("mPriority").value)||2;
  const status = $("mStatus").value || "planned";
  const kanban = $("mKanban").value || "todo";
  const body = $("mBody").value || "";
  const locationName = $("mLocationName").value || "";
  const start = parseDT($("mStart").value);
  const end   = parseDT($("mEnd").value);
  const due   = parseDT($("mDue").value);

  const it = newItem(type, {
    title: `${title} (c√≥pia)`,
    body,
    tags,
    priority: prio,
    status,
    kanban,
    locationName,
    geo: state.tempGeo ? {...state.tempGeo} : null,
    files: [...state.tempFiles],
    start: (type==="note") ? null : (start ? start.toISOString() : null),
    end:   (type==="event") ? (end ? end.toISOString() : null) : null,
    due:   (type==="task") ? (due ? due.toISOString() : null) : null
  });
  upsertItem(it);
  toast("Duplicado.");
});

/* ===================== Quick Add (Hoje) ===================== */
$("btnQuickAdd").addEventListener("click", ()=>{
  // cria um "check-in" tipo nota r√°pida no hor√°rio atual
  const now = new Date();
  openNewModal("note", {
    title: `Check-in ${pad(now.getHours())}:${pad(now.getMinutes())}`,
    body: "",
    tags: ["check-in"]
  });
});

/* ===================== Files view (biblioteca) ===================== */
$("btnAddFiles").addEventListener("click", ()=> $("filesInput").click());
$("filesInput").addEventListener("change", async ()=>{
  const files = Array.from($("filesInput").files || []);
  if(!files.length) return;
  showLoading("Importando arquivos‚Ä¶");
  try{
    for(const f of files){
      const id = uid();
      const obj = {
        id,
        name: f.name,
        type: f.type || "application/octet-stream",
        size: f.size || 0,
        addedAt: new Date().toISOString(),
        blob: f
      };
      await idbPutFile(obj);
    }
    toast("Arquivos importados.");
    await refreshStorageInfo();
    rafRender();
  }catch(e){
    toast("Falha ao importar arquivos.");
  }finally{
    hideLoading();
    $("filesInput").value = "";
  }
});

/* ===================== Lists rendering helpers ===================== */
function makeRow(it){
  const d = itemKeyDate(it);
  const when = itemWhen(it);
  const tags = (it.tags||[]).slice(0,3);
  const more = (it.tags||[]).length>3 ? `+${(it.tags||[]).length-3}` : "";

  const badgeType = it.type==="event" ? "üìÖ Compromisso" : it.type==="task" ? "‚úÖ Tarefa" : "üìù Nota";
  const pr = prioLabel(it.priority);
  const st = statusBadge(it);
  const stLabel = st==="done" ? "Conclu√≠do" : st==="doing" ? "Em andamento" : st==="canceled" ? "Cancelado" : "Planejado";
  const hasFiles = (it.files||[]).length;
  const hasGeo = it.geo ? "GPS" : "";

  const el = document.createElement("div");
  el.className = "row";
  el.tabIndex = 0;
  el.innerHTML = `
    <div class="main">
      <div class="name">${safeText(it.title)}</div>
      <div class="meta">
        <span class="badge"><b>${badgeType}</b></span>
        <span class="badge"><b>${safeText(stLabel)}</b></span>
        <span class="badge"><b>${safeText(pr)}</b></span>
        ${it.locationName ? `<span class="badge">üìç <b>${safeText(it.locationName)}</b></span>` : ""}
        ${hasGeo ? `<span class="badge">üß≠ <b>${hasGeo}</b></span>` : ""}
        ${hasFiles ? `<span class="badge">üìé <b>${hasFiles}</b></span>` : ""}
        ${tags.map(t=>`<span class="badge">#<b>${safeText(t)}</b></span>`).join("")}
        ${more ? `<span class="badge"><b>${safeText(more)}</b></span>` : ""}
      </div>
    </div>
    <div class="amount">${safeText(when)}</div>
    <div class="amount mono">${safeText(fmtNiceDT(d))}</div>
    <div class="right">
      <button class="btn" data-open="${it.id}">Abrir</button>
      <button class="btn danger" data-del="${it.id}">Excluir</button>
    </div>
  `;
  el.addEventListener("click", (e)=>{
    const t = e.target;
    if(t?.dataset?.open){
      openEditModal(t.dataset.open);
      return;
    }
    if(t?.dataset?.del){
      const ok = confirm("Excluir este item?");
      if(!ok) return;
      deleteItem(t.dataset.del);
      toast("Exclu√≠do.");
      return;
    }
    openEditModal(it.id);
  });
  el.addEventListener("keydown", (e)=>{
    if(e.key==="Enter" || e.key===" "){
      e.preventDefault();
      openEditModal(it.id);
    }
  });
  return el;
}

/* ===================== Kanban Drag & Drop ===================== */
function makeTaskCard(it){
  const el = document.createElement("div");
  el.className = "task";
  el.draggable = true;
  el.dataset.id = it.id;
  const due = it.due ? `Vence: ${fmtNiceDT(it.due)}` : "Sem vencimento";
  const pr = prioLabel(it.priority);
  el.innerHTML = `
    <b>${safeText(it.title)}</b>
    <div class="tmeta">
      <span>Prioridade: ${safeText(pr)}</span>
      <span>${safeText(due)}</span>
      ${(it.tags||[]).slice(0,2).map(t=>`<span>#${safeText(t)}</span>`).join("")}
    </div>
  `;
  el.addEventListener("dblclick", ()=> openEditModal(it.id));
  el.addEventListener("dragstart", (e)=>{
    e.dataTransfer.setData("text/plain", it.id);
    e.dataTransfer.effectAllowed = "move";
  });
  return el;
}
function setupDrop(zone, colName){
  zone.addEventListener("dragover", (e)=>{ e.preventDefault(); zone.classList.add("drop-hover"); });
  zone.addEventListener("dragleave", ()=> zone.classList.remove("drop-hover"));
  zone.addEventListener("drop", (e)=>{
    e.preventDefault();
    zone.classList.remove("drop-hover");
    const id = e.dataTransfer.getData("text/plain");
    if(!id) return;
    const it = state.items.find(x=>x.id===id);
    if(!it) return;

    // Se arrastou no Kanban, muda kanban e status
    if(it.type==="task"){
      it.kanban = colName;
      it.status = (colName==="done") ? "done" : (colName==="doing") ? "doing" : "planned";
      upsertItem(it);
      toast("Tarefa movida.");
      return;
    }

    // Se arrastou item n√£o-task para o calend√°rio do m√™s (handled elsewhere)
  });
}

/* ===== Drop tarefa em um dia do m√™s -> ajusta vencimento ===== */
function attachDropOnDayCell(cell, dayDate){
  cell.addEventListener("dragover", (e)=>{ e.preventDefault(); cell.classList.add("drop-hover"); });
  cell.addEventListener("dragleave", ()=> cell.classList.remove("drop-hover"));
  cell.addEventListener("drop", (e)=>{
    e.preventDefault();
    cell.classList.remove("drop-hover");
    const id = e.dataTransfer.getData("text/plain");
    if(!id) return;
    const it = state.items.find(x=>x.id===id);
    if(!it) return;
    if(it.type!=="task"){ toast("Somente tarefas podem ser soltas em dias (vencimento)."); return; }
    const due = new Date(dayDate);
    // mant√©m hora atual se j√° tinha due
    if(it.due){
      const old = new Date(it.due);
      due.setHours(old.getHours(), old.getMinutes(), 0, 0);
    }else{
      due.setHours(18, 0, 0, 0);
    }
    it.due = due.toISOString();
    upsertItem(it);
    toast("Vencimento atualizado.");
    // se estiver no m√™s, atualiza drawer
    if(state.activeTab==="month") renderDayDrawer(dayDate);
  });
}

/* ===================== Filters / Search ===================== */
function textMatch(it, q){
  if(!q) return true;
  const s = q.toLowerCase();
  const hay = [
    it.title||"",
    it.body||"",
    it.locationName||"",
    ...(it.tags||[])
  ].join(" ").toLowerCase();
  return hay.includes(s);
}

/* ===================== v3.2 Command Palette ===================== */
function openPalette(){
  state.paletteOpen = true;
  state.paletteQuery = "";
  state.paletteIndex = 0;
  $("paletteInput").value = "";
  renderPalette();
  openModal("paletteModal");
  setTimeout(()=> $("paletteInput").focus({preventScroll:true}), 20);
}
function closePalette(){
  state.paletteOpen = false;
  closeModal("paletteModal");
}
$("btnPalette").addEventListener("click", openPalette);
$("btnClosePalette").addEventListener("click", closePalette);

function paletteItems(){
  // comandos
  const cmds = [
    {title:"Novo compromisso", sub:"Criar um compromisso (evento)", kbd:"N E", run:()=>{ closePalette(); openNewModal("event"); }},
    {title:"Nova tarefa", sub:"Criar tarefa no Kanban", kbd:"N T", run:()=>{ closePalette(); openNewModal("task"); }},
    {title:"Nova nota", sub:"Criar anota√ß√£o r√°pida", kbd:"N N", run:()=>{ closePalette(); openNewModal("note"); }},
    {title:"Ir para Hoje", sub:"Abrir vis√£o Hoje", kbd:"Alt H", run:()=>{ closePalette(); setTab("today"); }},
    {title:"Ir para Semana", sub:"Abrir vis√£o Semana", kbd:"Alt W", run:()=>{ closePalette(); setTab("week"); }},
    {title:"Ir para M√™s", sub:"Abrir vis√£o M√™s", kbd:"Alt M", run:()=>{ closePalette(); setTab("month"); }},
    {title:"Ir para Tarefas", sub:"Abrir Kanban", kbd:"Alt T", run:()=>{ closePalette(); setTab("tasks"); }},
    {title:"Ir para Notas", sub:"Abrir Notas", kbd:"Alt N", run:()=>{ closePalette(); setTab("notes"); }},
    {title:"Ir para Arquivos", sub:"Abrir Arquivos", kbd:"Alt F", run:()=>{ closePalette(); setTab("files"); }},
    {title:"Ir para Ajustes", sub:"Abrir Ajustes", kbd:"Alt S", run:()=>{ closePalette(); setTab("settings"); }},
    {title:"Exportar backup JSON", sub:"Baixar backup", kbd:"Ctrl E", run:()=>{ closePalette(); doBackup(); }},
    {title:"Exportar calend√°rio (.ICS)", sub:"Baixar .ics com eventos e tarefas", kbd:"‚Äî", run:()=>{ closePalette(); exportICS(); }},
    {title:"Atualizar painel", sub:"Atualiza KPIs / clima / listas", kbd:"R", run:()=>{ closePalette(); manualRefresh(); }},
  ];

  // busca de itens (top 8)
  const q = state.paletteQuery.trim().toLowerCase();
  const items = state.items
    .filter(it=> q ? textMatch(it,q) : false)
    .slice(0, 8)
    .map(it=>({
      title:`${typeEmoji(it.type)} ${it.title}`,
      sub: itemWhen(it),
      kbd:"Abrir",
      run:()=>{ closePalette(); openEditModal(it.id); }
    }));

  const merged = q ? [...cmds, ...items] : cmds;
  return merged;
}
function renderPalette(){
  const q = $("paletteInput").value || "";
  state.paletteQuery = q;
  const list = $("paletteList");
  const items = paletteItems();
  if(state.paletteIndex >= items.length) state.paletteIndex = Math.max(0, items.length-1);

  list.innerHTML = "";
  items.forEach((it, idx)=>{
    const el = document.createElement("div");
    el.className = "pItem";
    el.tabIndex = 0;
    el.dataset.idx = String(idx);
    el.innerHTML = `
      <div class="pLeft">
        <div class="pTitle">${safeText(it.title)}</div>
        <div class="pSub">${safeText(it.sub||"")}</div>
      </div>
      <div class="pKbd">${safeText(it.kbd||"")}</div>
    `;
    if(idx===state.paletteIndex){
      el.style.boxShadow = "var(--ring2)";
      el.style.borderColor = "rgba(45,212,191,.30)";
    }
    el.addEventListener("click", ()=> it.run());
    el.addEventListener("mouseenter", ()=> { state.paletteIndex = idx; renderPalette(); });
    el.addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){ e.preventDefault(); it.run(); }
    });
    list.appendChild(el);
  });

  if(!items.length){
    list.innerHTML = `<div class="hint" style="padding:10px;">Sem resultados.</div>`;
  }
}
$("paletteInput").addEventListener("input", debounce(renderPalette, 30));

/* ===================== Backup / Restore / Wipe ===================== */
function doBackup(){
  const data = {
    version: "3.2",
    exportedAt: new Date().toISOString(),
    settings: state.settings,
    items: state.items
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  downloadBlob(blob, `agenda_pro_backup_${toISODate(new Date())}.json`);
  toast("Backup exportado.");
}
$("btnBackup").addEventListener("click", doBackup);

function openRestore(){
  $("restoreFile").value = "";
  openModal("restoreModal");
}
function closeRestore(){ closeModal("restoreModal"); }
$("btnRestore").addEventListener("click", openRestore);
$("btnCloseRestore").addEventListener("click", closeRestore);

$("btnDoRestore").addEventListener("click", async ()=>{
  const f = $("restoreFile").files?.[0];
  if(!f){ toast("Selecione um arquivo JSON."); return; }
  showLoading("Importando‚Ä¶");
  try{
    const txt = await f.text();
    const j = JSON.parse(txt);
    if(!j || !Array.isArray(j.items)) throw new Error("invalid");
    // merge: substitui tudo por padr√£o
    state.items = j.items;
    if(j.settings) state.settings = {...state.settings, ...j.settings};
    saveAll();
    toast("Importado. (Anexos n√£o v√™m no backup)");
    closeRestore();
    rafRender();
  }catch(e){
    toast("Falha ao importar. Arquivo inv√°lido.");
  }finally{
    hideLoading();
  }
});

$("btnWipe").addEventListener("click", async ()=>{
  const ok = confirm("Limpar TODOS os itens? (n√£o apaga anexos da biblioteca)");
  if(!ok) return;
  state.items = [];
  saveAll();
  rafRender();
  toast("Itens limpos.");
});

/* ===================== Settings ===================== */
$("btnSaveSettings").addEventListener("click", ()=>{
  state.settings.userName = $("setUserName").value.trim() || "Wilson";
  state.settings.geo = $("setGeo").value;
  state.settings.units = $("setUnits").value;
  saveAll();
  toast("Ajustes salvos.");
  rafRender();
});
$("btnDemo").addEventListener("click", ()=>{
  const now = new Date();
  const s1 = newItem("event", {
    title:"Reuni√£o ‚Ä¢ Projeto",
    start: addDays(now,0).toISOString(),
    end: addDays(new Date(now.getTime()+60*60*1000),0).toISOString(),
    locationName:"Escrit√≥rio",
    tags:["cliente","obra"],
    priority:3
  });
  const t1 = newItem("task", {
    title:"Enviar relat√≥rio",
    due: addDays(new Date(),1).toISOString(),
    kanban:"todo",
    tags:["trabalho"],
    priority:3
  });
  const n1 = newItem("note", {
    title:"Ideias",
    body:"Checklist: \n- ligar para fornecedor\n- revisar cronograma\n- separar docs",
    tags:["pessoal","checklist"]
  });
  upsertItem(s1); upsertItem(t1); upsertItem(n1);
  toast("Demo criado.");
});

/* ===================== Export ICS (v3.2) ===================== */
function escICS(s){
  return String(s||"")
    .replaceAll("\\","\\\\")
    .replaceAll(";","\\;")
    .replaceAll(",","\\,")
    .replaceAll("\n","\\n");
}
function dtToICS(dt){
  const d = new Date(dt);
  const y=d.getUTCFullYear(), m=pad(d.getUTCMonth()+1), da=pad(d.getUTCDate());
  const h=pad(d.getUTCHours()), mi=pad(d.getUTCMinutes()), se=pad(d.getUTCSeconds());
  return `${y}${m}${da}T${h}${mi}${se}Z`;
}
function exportICS(){
  const lines = [];
  lines.push("BEGIN:VCALENDAR");
  lines.push("VERSION:2.0");
  lines.push("PRODID:-//Agenda Pro//PT-BR//");
  lines.push("CALSCALE:GREGORIAN");

  const all = state.items.filter(it=>{
    if(it.type==="event" && it.start) return true;
    if(it.type==="task" && it.due) return true;
    return false;
  });

  for(const it of all){
    lines.push("BEGIN:VEVENT");
    lines.push(`UID:${escICS(it.id)}@agendapro`);
    lines.push(`DTSTAMP:${dtToICS(new Date())}`);
    const title = it.type==="task" ? `‚úÖ ${it.title}` : `üìÖ ${it.title}`;
    lines.push(`SUMMARY:${escICS(title)}`);
    const desc = [it.body||"", (it.locationName?`Local: ${it.locationName}`:""), (it.tags?.length?`Tags: ${it.tags.join(", ")}`:"")].filter(Boolean).join("\n");
    if(desc) lines.push(`DESCRIPTION:${escICS(desc)}`);
    if(it.locationName) lines.push(`LOCATION:${escICS(it.locationName)}`);

    if(it.type==="event"){
      const st = new Date(it.start);
      const en = it.end ? new Date(it.end) : new Date(st.getTime()+60*60*1000);
      lines.push(`DTSTART:${dtToICS(st)}`);
      lines.push(`DTEND:${dtToICS(en)}`);
    }else{
      // tarefa com vencimento -> cria evento no hor√°rio do due com dura√ß√£o 15 min
      const st = new Date(it.due);
      const en = new Date(st.getTime()+15*60*1000);
      lines.push(`DTSTART:${dtToICS(st)}`);
      lines.push(`DTEND:${dtToICS(en)}`);
    }
    lines.push("END:VEVENT");
  }

  lines.push("END:VCALENDAR");
  const blob = new Blob([lines.join("\r\n")], {type:"text/calendar"});
  downloadBlob(blob, `agenda_pro_${toISODate(new Date())}.ics`);
  toast("ICS exportado.");
}
$("btnICS").addEventListener("click", exportICS);

function statusBadge(it){
  if(it.status==="done") return "done";
  if(it.status==="doing") return "doing";
  if(it.status==="canceled") return "canceled";
  return "planned";
}
function prioLabel(p){
  const n = Number(p)||2;
  if(n<=1) return "Baixa";
  if(n===2) return "Normal";
  if(n===3) return "Alta";
  return "Cr√≠tica";
}
function typeEmoji(t){
  return t==="event" ? "üìÖ" : t==="task" ? "‚úÖ" : "üìù";
}
function itemKeyDate(it){
  // data ‚Äúprincipal‚Äù p/ ordenar/mostrar
  if(it.type==="event" && it.start) return it.start;
  if(it.type==="task" && it.due) return it.due;
  return it.updatedAt || it.createdAt || new Date().toISOString();
}
function itemWhen(it){
  if(it.type==="event"){
    const s = it.start ? fmtTime(it.start) : "‚Äî";
    const e = it.end ? fmtTime(it.end) : "";
    return e ? `${s}‚Äì${e}` : s;
  }
  if(it.type==="task"){
    if(it.due) return `Vence ${fmtNiceDT(it.due)}`;
    return it.kanban==="done" ? "Conclu√≠da" : "Sem vencimento";
  }
  return `Atualizado ${fmtNiceDT(it.updatedAt||it.createdAt)}`;
}

/* ===================== Tabs / Nav ===================== */
function setTab(tab){
  state.activeTab = tab;
  // update tabs
  document.querySelectorAll(".tab").forEach(x=>{
    x.classList.toggle("active", x.dataset.tab===tab);
  });
  // update views
  document.querySelectorAll(".view").forEach(v=>{
    v.classList.toggle("active", v.id===`view-${tab}`);
  });
  // close drawer on tab change
  closeDrawer();

  rafRender();
  // focus search
  if(tab==="today" || tab==="week" || tab==="month" || tab==="tasks" || tab==="notes"){
    setTimeout(()=> $("globalSearch").focus({preventScroll:true}), 20);
  }
}

document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=> setTab(btn.dataset.tab));
});

/* ===================== Drawer (Day details) ===================== */
function openDrawer(){
  $("drawer").classList.add("open");
}
function closeDrawer(){
  $("drawer").classList.remove("open");
  $("drawerTitle").textContent = "Dia";
  $("drawerSub").textContent = "‚Äî";
  $("drawerList").innerHTML = "";
}
$("btnCloseDrawer").addEventListener("click", closeDrawer);

function renderDayDrawer(date){
  // date: Date
  const key = toISODate(date);
  const items = itemsForDay(date);

  $("drawerTitle").textContent = `Dia ${key}`;
  $("drawerSub").textContent = `${items.length} item(ns)`;
  const list = $("drawerList");
  list.innerHTML = "";

  if(!items.length){
    list.innerHTML = `<div class="hint">Nada por aqui. Crie algo para este dia.</div>`;
  }else{
    for(const it of items){
      list.appendChild(makeRow(it));
    }
  }

  // bot√µes do drawer
  $("btnDayNewEvent").onclick = ()=>{
    openNewModal("event", {
      title:"",
      start: new Date(date).toISOString()
    });
  };
  $("btnDayNewTask").onclick = ()=>{
    const d = new Date(date); d.setHours(18,0,0,0);
    openNewModal("task", { title:"", due: d.toISOString() });
  };
  $("btnDayNewNote").onclick = ()=>{
    openNewModal("note", { title:`Nota ${key}`, body:"" });
  };

  openDrawer();
}

/* ===================== Queries (Hoje / Semana / M√™s) ===================== */
function itemsForDay(date){
  const start = startOfDay(date).getTime();
  const end = endOfDay(date).getTime();
  const q = state.search.trim().toLowerCase();
  const fType = state.filterType;
  const fStatus = state.filterStatus;

  return state.items
    .filter(it=>{
      if(fType!=="all" && it.type!==fType) return false;
      if(fStatus!=="all"){
        if((it.status||"planned")!==fStatus) return false;
      }
      if(!textMatch(it, q)) return false;

      const k = itemKeyDate(it);
      const t = new Date(k).getTime();
      return t>=start && t<=end;
    })
    .sort((a,b)=> new Date(itemKeyDate(a)) - new Date(itemKeyDate(b)));
}

function itemsForRange(from, to){
  const a = startOfDay(from).getTime();
  const b = endOfDay(to).getTime();
  const q = state.search.trim().toLowerCase();
  const fType = state.filterType;
  const fStatus = state.filterStatus;

  return state.items
    .filter(it=>{
      if(fType!=="all" && it.type!==fType) return false;
      if(fStatus!=="all"){
        if((it.status||"planned")!==fStatus) return false;
      }
      if(!textMatch(it, q)) return false;
      const t = new Date(itemKeyDate(it)).getTime();
      return t>=a && t<=b;
    })
    .sort((x,y)=> new Date(itemKeyDate(x)) - new Date(itemKeyDate(y)));
}

/* ===================== Today view ===================== */
function renderToday(){
  const now = new Date();
  $("todayDate").textContent = fmtNiceDate(now);
  const list = $("todayList");
  list.innerHTML = "";
  const items = itemsForDay(now);

  if(!items.length){
    list.innerHTML = `<div class="hint">Nada para hoje. Use ‚Äú+‚Äù para criar.</div>`;
  }else{
    for(const it of items) list.appendChild(makeRow(it));
  }

  // CTA create
  $("btnNewToday").onclick = ()=> openNewModal("event", { start: now.toISOString() });
}

/* ===================== Week view ===================== */
function renderWeek(){
  const now = new Date();
  const start = startOfWeek(now);
  const end = endOfWeek(now);

  $("weekRange").textContent = `${fmtNiceDate(start)} ‚Üí ${fmtNiceDate(end)}`;

  // grid
  const grid = $("weekGrid");
  grid.innerHTML = "";

  for(let i=0;i<7;i++){
    const d = addDays(start, i);
    const items = itemsForDay(d);

    const card = document.createElement("div");
    card.className = "dayCard";
    card.innerHTML = `
      <div class="dayHead">
        <div class="dayTitle">${weekDayShort(d)} ‚Ä¢ ${pad(d.getDate())}/${pad(d.getMonth()+1)}</div>
        <button class="btn" data-open="1">Abrir</button>
      </div>
      <div class="dayMini">
        ${items.slice(0,4).map(it=>`<div class="mini">${safeText(typeEmoji(it.type)+" "+it.title)}</div>`).join("")}
        ${items.length>4 ? `<div class="mini muted">+${items.length-4} mais‚Ä¶</div>` : (items.length? "" : `<div class="mini muted">vazio</div>`)}
      </div>
    `;
    card.querySelector("[data-open]").addEventListener("click", ()=> renderDayDrawer(d));
    grid.appendChild(card);
  }

  // list
  const list = $("weekList");
  list.innerHTML = "";
  const items = itemsForRange(start, end);

  if(!items.length){
    list.innerHTML = `<div class="hint">Sem itens nesta semana.</div>`;
  }else{
    for(const it of items) list.appendChild(makeRow(it));
  }
}

/* ===================== Month view ===================== */
function renderMonth(){
  const base = new Date(state.monthCursor || new Date());
  const year = base.getFullYear();
  const month = base.getMonth(); // 0-11

  $("monthLabel").textContent = `${monthName(month)} ${year}`;

  const first = new Date(year, month, 1);
  const last = new Date(year, month+1, 0);

  const startGrid = startOfWeek(first);
  const endGrid = endOfWeek(last);

  const grid = $("monthGrid");
  grid.innerHTML = "";

  const todayKey = toISODate(new Date());

  let d = new Date(startGrid);
  while(d <= endGrid){
    const cell = document.createElement("div");
    cell.className = "mCell";
    const key = toISODate(d);
    const inMonth = d.getMonth()===month;

    const items = itemsForDay(d);
    const mini = items.slice(0,3).map(it=>`<div class="mMini">${safeText(typeEmoji(it.type)+" "+it.title)}</div>`).join("");
    const more = items.length>3 ? `<div class="mMini muted">+${items.length-3} mais‚Ä¶</div>` : "";

    cell.innerHTML = `
      <div class="mTop">
        <div class="mDay ${key===todayKey?'today':''} ${inMonth?'':'muted'}">${d.getDate()}</div>
        <div class="mDots">${items.length?`<span class="dot"></span><span class="dot"></span>`:""}</div>
      </div>
      <div class="mBody">
        ${mini || `<div class="mMini muted">‚Äî</div>`}
        ${more}
      </div>
    `;
    cell.addEventListener("click", ()=> renderDayDrawer(new Date(d)));

    // drop tasks here => adjust due
    attachDropOnDayCell(cell, new Date(d));

    grid.appendChild(cell);
    d = addDays(d, 1);
  }

  // list (month)
  const list = $("monthList");
  list.innerHTML = "";
  const items = itemsForRange(first, last);
  if(!items.length) list.innerHTML = `<div class="hint">Sem itens neste m√™s.</div>`;
  else for(const it of items) list.appendChild(makeRow(it));
}

$("btnMonthPrev").addEventListener("click", ()=>{
  const d = new Date(state.monthCursor || new Date());
  d.setMonth(d.getMonth()-1);
  state.monthCursor = d.toISOString();
  rafRender();
});
$("btnMonthNext").addEventListener("click", ()=>{
  const d = new Date(state.monthCursor || new Date());
  d.setMonth(d.getMonth()+1);
  state.monthCursor = d.toISOString();
  rafRender();
});
$("btnMonthToday").addEventListener("click", ()=>{
  state.monthCursor = new Date().toISOString();
  rafRender();
});

/* ===================== Tasks view (Kanban) ===================== */
function renderTasks(){
  const q = state.search.trim().toLowerCase();
  const fStatus = state.filterStatus;
  // tasks only
  const tasks = state.items.filter(it=>{
    if(it.type!=="task") return false;
    if(fStatus!=="all" && (it.status||"planned")!==fStatus) return false;
    if(!textMatch(it,q)) return false;
    return true;
  });

  const todo = $("kTodo"); const doing = $("kDoing"); const done = $("kDone");
  todo.innerHTML = ""; doing.innerHTML=""; done.innerHTML="";

  for(const it of tasks.sort((a,b)=> (Number(b.priority||2)-Number(a.priority||2)) || (new Date(itemKeyDate(a))-new Date(itemKeyDate(b))))){
    const col = (it.kanban||"todo");
    const card = makeTaskCard(it);
    if(col==="doing") doing.appendChild(card);
    else if(col==="done") done.appendChild(card);
    else todo.appendChild(card);
  }

  setupDrop($("colTodo"), "todo");
  setupDrop($("colDoing"), "doing");
  setupDrop($("colDone"), "done");

  $("btnNewTask").onclick = ()=> openNewModal("task");
}

/* ===================== Notes view ===================== */
function renderNotes(){
  const q = state.search.trim().toLowerCase();
  const list = $("notesList");
  list.innerHTML = "";
  const notes = state.items
    .filter(it=> it.type==="note")
    .filter(it=> textMatch(it, q))
    .sort((a,b)=> new Date(itemKeyDate(b)) - new Date(itemKeyDate(a)));

  if(!notes.length){
    list.innerHTML = `<div class="hint">Sem notas. Crie uma em ‚Äú+‚Äù.</div>`;
  }else{
    for(const it of notes) list.appendChild(makeRow(it));
  }

  $("btnNewNote").onclick = ()=> openNewModal("note");
}

/* ===================== Files view ===================== */
async function renderFiles(){
  const list = $("filesList");
  list.innerHTML = "";
  let files = [];
  try{
    files = await idbListFiles();
  }catch(e){
    list.innerHTML = `<div class="hint">Erro ao ler biblioteca (IndexedDB).</div>`;
    return;
  }

  const q = state.search.trim().toLowerCase();
  if(q){
    files = files.filter(f=> (f.name||"").toLowerCase().includes(q));
  }

  files.sort((a,b)=> new Date(b.addedAt||0) - new Date(a.addedAt||0));

  if(!files.length){
    list.innerHTML = `<div class="hint">Sem arquivos na biblioteca. Use ‚ÄúImportar‚Äù.</div>`;
    return;
  }

  for(const f of files){
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="main">
        <div class="name">${safeText(f.name||"arquivo")}</div>
        <div class="meta">
          <span class="badge"><b>${safeText(f.type||"")}</b></span>
          <span class="badge"><b>${safeText(formatBytes(f.size||0))}</b></span>
          <span class="badge">Adicionado: <b>${safeText(fmtNiceDT(f.addedAt))}</b></span>
        </div>
      </div>
      <div class="right">
        <button class="btn" data-dl="${f.id}">Baixar</button>
        <button class="btn danger" data-rm="${f.id}">Apagar</button>
      </div>
    `;
    row.addEventListener("click", async (e)=>{
      const t = e.target;
      if(t?.dataset?.dl){
        const obj = await idbGetFile(t.dataset.dl);
        if(!obj){ toast("Arquivo n√£o encontrado."); return; }
        downloadBlob(obj.blob, obj.name);
        return;
      }
      if(t?.dataset?.rm){
        const ok = confirm("Apagar este arquivo da biblioteca? (n√£o d√° para desfazer)");
        if(!ok) return;
        await idbDelFile(t.dataset.rm);
        toast("Arquivo apagado.");
        await refreshStorageInfo();
        rafRender();
        return;
      }
    });

    list.appendChild(row);
  }
}

/* ===================== Global search / filters ===================== */
function bindTopControls(){
  $("globalSearch").addEventListener("input", debounce(()=>{
    state.search = $("globalSearch").value;
    rafRender();
  }, 40));

  $("filterType").addEventListener("change", ()=>{
    state.filterType = $("filterType").value;
    rafRender();
  });
  $("filterStatus").addEventListener("change", ()=>{
    state.filterStatus = $("filterStatus").value;
    rafRender();
  });
}
bindTopControls();

/* ===================== Header stats ===================== */
function renderStats(){
  const now = new Date();
  const today = itemsForDay(now);
  const week = itemsForRange(startOfWeek(now), endOfWeek(now));

  const tasks = state.items.filter(x=>x.type==="task");
  const done = tasks.filter(x=>x.status==="done").length;
  const open = tasks.length - done;

  $("kpiToday").textContent = String(today.length);
  $("kpiWeek").textContent = String(week.length);
  $("kpiTasks").textContent = `${open}/${tasks.length}`;

  // header info: hora / clima / local
  $("hdrUser").textContent = state.settings.userName || "Wilson";
  $("hdrTime").textContent = new Date().toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit"});

  if(state.weather.ok && state.weather.temp!=null){
    $("hdrWeather").textContent = `${Math.round(state.weather.temp)}¬∞ ‚Ä¢ ${state.weather.desc||"Tempo"}`;
  }else{
    $("hdrWeather").textContent = "‚Äî";
  }

  if(state.geo.ok && state.geo.accuracy!=null){
    $("hdrLoc").textContent = `GPS ¬±${Math.round(state.geo.accuracy)}m`;
  }else{
    $("hdrLoc").textContent = "Local: ‚Äî";
  }
}

/* ===================== Manual refresh ===================== */
async function manualRefresh(){
  showLoading("Atualizando‚Ä¶");
  try{
    await getGeoFix();
    await refreshWeather();
    await refreshStorageInfo();
    toast("Atualizado.");
  }finally{
    hideLoading();
    rafRender();
  }
}
$("btnRefresh").addEventListener("click", manualRefresh);

/* ===================== Keyboard shortcuts ===================== */
document.addEventListener("keydown", (e)=>{
  const k = e.key.toLowerCase();

  // ESC closes modals
  if(e.key==="Escape"){
    // fecha modais abertos
    if($("paletteModal").classList.contains("open")) return closePalette();
    if($("itemModal").classList.contains("open")) return closeItemModal();
    if($("restoreModal").classList.contains("open")) return closeRestore();
    if($("drawer").classList.contains("open")) return closeDrawer();
  }

  // Ctrl+K or Cmd+K -> palette
  if((e.ctrlKey || e.metaKey) && k==="k"){
    e.preventDefault();
    return openPalette();
  }

  // Ctrl+E export backup
  if((e.ctrlKey || e.metaKey) && k==="e"){
    e.preventDefault();
    return doBackup();
  }

  // R refresh (quando n√£o est√° digitando)
  const ae = document.activeElement;
  const typing = ae && (ae.tagName==="INPUT" || ae.tagName==="TEXTAREA");
  if(!typing && !e.ctrlKey && !e.metaKey && k==="r"){
    e.preventDefault();
    return manualRefresh();
  }

  // quick new
  if(!typing && k==="n"){
    // N abre modal com op√ß√µes via palette (mais elegante)
    e.preventDefault();
    return openPalette();
  }

  // Alt nav
  if(e.altKey && k==="h"){ e.preventDefault(); return setTab("today"); }
  if(e.altKey && k==="w"){ e.preventDefault(); return setTab("week"); }
  if(e.altKey && k==="m"){ e.preventDefault(); return setTab("month"); }
  if(e.altKey && k==="t"){ e.preventDefault(); return setTab("tasks"); }
  if(e.altKey && k==="n"){ e.preventDefault(); return setTab("notes"); }
  if(e.altKey && k==="f"){ e.preventDefault(); return setTab("files"); }
  if(e.altKey && k==="s"){ e.preventDefault(); return setTab("settings"); }

  // palette navigation
  if($("paletteModal").classList.contains("open")){
    const items = paletteItems();
    if(e.key==="ArrowDown"){
      e.preventDefault();
      state.paletteIndex = Math.min(items.length-1, state.paletteIndex+1);
      renderPalette();
    }
    if(e.key==="ArrowUp"){
      e.preventDefault();
      state.paletteIndex = Math.max(0, state.paletteIndex-1);
      renderPalette();
    }
    if(e.key==="Enter"){
      e.preventDefault();
      const it = items[state.paletteIndex];
      if(it) it.run();
    }
  }
});

$("paletteInput").addEventListener("keydown", (e)=>{
  if(e.key==="Escape"){ e.preventDefault(); closePalette(); }
});

/* ===================== Palette input render on open ===================== */
$("paletteModal").addEventListener("click", (e)=>{
  if(e.target && e.target.id==="paletteModal") closePalette();
});
$("restoreModal").addEventListener("click", (e)=>{
  if(e.target && e.target.id==="restoreModal") closeRestore();
});
$("itemModal").addEventListener("click", (e)=>{
  if(e.target && e.target.id==="itemModal") closeItemModal();
});

/* ===================== Render pipeline ===================== */
let _raf = 0;
function rafRender(){
  if(_raf) cancelAnimationFrame(_raf);
  _raf = requestAnimationFrame(renderAll);
}

async function renderAll(){
  _raf = 0;

  // header
  renderStats();

  // tab renders
  if(state.activeTab==="today") renderToday();
  if(state.activeTab==="week") renderWeek();
  if(state.activeTab==="month") renderMonth();
  if(state.activeTab==="tasks") renderTasks();
  if(state.activeTab==="notes") renderNotes();
  if(state.activeTab==="files") await renderFiles();

  // settings fill
  $("setUserName").value = state.settings.userName || "Wilson";
  $("setGeo").value = state.settings.geo || "ask";
  $("setUnits").value = state.settings.units || "metric";
}

/* ===================== App init ===================== */
async function init(){
  // load persisted
  const settings = loadSettings();
  state.settings = {...state.settings, ...settings};
  state.items = loadItems();

  // set controls initial
  $("globalSearch").value = state.search;
  $("filterType").value = state.filterType;
  $("filterStatus").value = state.filterStatus;

  // open indexeddb
  try{
    state.db = await idbOpen();
  }catch(e){
    toast("Aviso: IndexedDB indispon√≠vel. Anexos podem n√£o funcionar.");
  }

  await refreshStorageInfo();

  // time ticker
  setInterval(()=>{
    // s√≥ re-rendera header
    $("hdrTime").textContent = new Date().toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit"});
  }, 20_000);

  // geo + weather (best effort)
  await getGeoFix();
  await refreshWeather();

  // periodic weather refresh
  setInterval(async ()=>{
    await refreshWeather();
    renderStats();
  }, 6*60*1000);

  // open default tab
  setTab("today");

  // initial render
  rafRender();
}
init();

/* ===================== END SCRIPT ===================== */
</script>
</body>
</html>
