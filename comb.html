<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestão Veicular Profissional</title>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* ===== Geral ===== */
body, html{margin:0;padding:0;font-family:'Roboto',sans-serif;background:#f4f6f8;color:#333;}
header{background:#1976d2;color:#fff;padding:15px;text-align:center;font-size:1.5em;position:sticky;top:0;z-index:10;}
main{padding:15px;max-width:1200px;margin:auto;}
.hidden{display:none;}
input, select, button{padding:10px;margin:5px 0;width:100%;max-width:300px;border-radius:6px;border:1px solid #ccc;font-size:1em;}
button{background:#1976d2;color:#fff;border:none;cursor:pointer;transition:0.3s;}
button:hover{background:#115293;}
.card{background:#fff;padding:15px;margin:10px 0;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.15);}
table{width:100%;border-collapse: collapse;margin-top:10px;}
th, td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#eee;}
.dashboard-cards{display:flex;flex-wrap:wrap;justify-content:space-around;margin-bottom:10px;}
.card-small{flex:1 1 150px;margin:5px;padding:10px;text-align:center;background:#fff;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1);transition:0.3s;}
.card-small:hover{transform: translateY(-3px); box-shadow:0 4px 12px rgba(0,0,0,0.2);}
canvas{background:#fff;border-radius:10px;margin-top:10px;}
.dark-mode{background:#121212;color:#fff;}
.dark-mode .card{background:#1e1e1e;color:#fff;}
@media(max-width:600px){.dashboard-cards{flex-direction:column;}table{font-size:12px;}input,select,button{max-width:100%;}}
</style>
</head>
<body>
<header>Gestão Veicular Profissional</header>
<main>

<!-- AUTENTICAÇÃO -->
<div id="auth-section">
  <div class="card">
    <h2>Login</h2>
    <input type="email" id="login-email" placeholder="Email">
    <input type="password" id="login-password" placeholder="Senha">
    <button onclick="login()">Entrar</button>
    <p><a href="#" onclick="showRegister()">Registrar</a> | <a href="#" onclick="recoverPassword()">Esqueci a senha</a></p>
  </div>
  <div class="card hidden" id="register-card">
    <h2>Registrar</h2>
    <input type="text" id="register-name" placeholder="Nome">
    <input type="email" id="register-email" placeholder="Email">
    <input type="password" id="register-password" placeholder="Senha">
    <button onclick="register()">Registrar</button>
    <p><a href="#" onclick="showLogin()">Voltar ao Login</a></p>
  </div>
</div>

<!-- APP -->
<div id="app-section" class="hidden">

<button onclick="logout()" style="margin-bottom:10px;">Sair</button>
<button onclick="toggleDarkMode()">Dark Mode</button>

<h2>Veículos</h2>
<select id="vehicle-selector" onchange="loadVehicleData()"></select>
<button onclick="showAddVehicle()">Adicionar Veículo</button>

<div id="add-vehicle-card" class="card hidden">
  <h3>Adicionar Veículo</h3>
  <input type="text" id="new-vehicle-name" placeholder="Modelo (ex: Ford Ka 2010)">
  <input type="number" id="new-vehicle-odometer" placeholder="Quilometragem atual">
  <button onclick="addVehicle()">Salvar Veículo</button>
</div>

<div class="dashboard-cards">
  <div class="card-small"><h4>Kilometragem Atual</h4><p id="dash-odometer">0 km</p></div>
  <div class="card-small"><h4>Consumo Médio</h4><p id="dash-consumption">0 km/l</p></div>
  <div class="card-small"><h4>Gastos Totais</h4><p id="dash-expense">R$ 0</p></div>
  <div class="card-small"><h4>Próxima Manutenção</h4><p id="dash-maintenance">---</p></div>
</div>

<!-- Abastecimentos -->
<div class="card">
<h3>Abastecimentos</h3>
<input type="date" id="fuel-date">
<input type="number" id="fuel-odometer" placeholder="Quilometragem">
<input type="number" step="0.01" id="fuel-liters" placeholder="Litros abastecidos">
<input type="number" step="0.01" id="fuel-price" placeholder="Valor total R$">
<button onclick="addFuel()">Registrar Abastecimento</button>
<table id="fuel-table">
<thead><tr><th>Data</th><th>KM</th><th>Litros</th><th>Valor</th></tr></thead>
<tbody></tbody>
</table>
</div>

<!-- Manutenções -->
<div class="card">
<h3>Manutenções</h3>
<select id="maint-type-selector">
  <option value="Óleo">Óleo</option>
  <option value="Filtro de Ar">Filtro de Ar</option>
  <option value="Filtro de Combustível">Filtro de Combustível</option>
  <option value="Água Radiador">Água Radiador</option>
  <option value="Pneus">Pneus</option>
  <option value="Freios">Freios</option>
  <option value="Pastilhas">Pastilhas</option>
  <option value="Outros">Outros</option>
</select>
<input type="date" id="maint-date">
<input type="number" step="0.01" id="maint-cost" placeholder="Custo R$">
<button onclick="addMaintenance()">Registrar Manutenção</button>
<table id="maint-table">
<thead><tr><th>Data</th><th>Tipo</th><th>Custo</th></tr></thead>
<tbody></tbody>
</table>
</div>

<!-- Gráficos -->
<div class="card">
<h3>Dashboards de Consumo e Manutenção</h3>
<canvas id="consumption-chart" width="800" height="300"></canvas>
<canvas id="maintenance-chart" width="800" height="300"></canvas>
</div>

<!-- Export/Import -->
<button onclick="exportData()">Exportar Dados (JSON)</button>
<button onclick="importData()">Importar Dados (JSON)</button>

</div>

<script>
// Firebase Config
const firebaseConfig = {
apiKey: "AIzaSyAIp-rFuZZsBCNVJ3pSge4TE-XUuwYygrI",
authDomain: "agenda-6accc.firebaseapp.com",
databaseURL: "https://agenda-6accc-default-rtdb.firebaseio.com",
projectId: "agenda-6accc",
storageBucket: "agenda-6accc.appspot.com",
messagingSenderId: "794262176773",
appId: "1:794262176773:web:c4e3837b29f635d5dc086c",
measurementId: "G-CVBQ54PERH"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUser=null;
let currentVehicleId=null;
let consumptionChart=null;
let maintenanceChart=null;
let darkMode=false;

// AUTH
function showRegister(){ document.getElementById('register-card').classList.remove('hidden'); }
function showLogin(){ document.getElementById('register-card').classList.add('hidden'); }
function register(){
  const email=document.getElementById('register-email').value;
  const pass=document.getElementById('register-password').value;
  const name=document.getElementById('register-name').value;
  if(!email||!pass||!name) return alert("Preencha todos os campos");
  auth.createUserWithEmailAndPassword(email,pass).then(cred=>{
    db.ref('users/'+cred.user.uid).set({name,email});
    cred.user.sendEmailVerification();
    showLogin(); alert("Usuário registrado! Verifique seu email para ativação.");
  }).catch(err=>alert(err.message));
}
function login(){
  const email=document.getElementById('login-email').value;
  const pass=document.getElementById('login-password').value;
  auth.signInWithEmailAndPassword(email,pass).then(cred=>{
    if(!cred.user.emailVerified){ alert("Confirme seu email antes de entrar."); auth.signOut(); return; }
    currentUser=cred.user; showApp(); loadVehicles();
  }).catch(err=>alert(err.message));
}
function recoverPassword(){
  const email=prompt("Digite seu email para recuperação:");
  if(email) auth.sendPasswordResetEmail(email).then(()=>alert("Email enviado!")).catch(err=>alert(err.message));
}
function logout(){ auth.signOut().then(()=>location.reload()); }
function showApp(){ document.getElementById('auth-section').classList.add('hidden'); document.getElementById('app-section').classList.remove('hidden'); }

// DARK MODE
function toggleDarkMode(){
  darkMode=!darkMode;
  if(darkMode) document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode');
}

// VEHICLES
function loadVehicles(){
  db.ref('vehicles/'+currentUser.uid).once('value',snap=>{
    const data=snap.val()||{};
    const selector=document.getElementById('vehicle-selector'); selector.innerHTML="";
    Object.entries(data).forEach(([id,v])=>{
      const option=document.createElement('option'); option.value=id; option.textContent=v.name; selector.appendChild(option);
    });
    if(Object.keys(data).length>0){currentVehicleId=Object.keys(data)[0]; loadVehicleData();}
  });
}
function showAddVehicle(){ document.getElementById('add-vehicle-card').classList.toggle('hidden'); }
function addVehicle(){
  const name=document.getElementById('new-vehicle-name').value;
  const km=parseFloat(document.getElementById('new-vehicle-odometer').value)||0;
  if(!name) return alert("Digite o modelo");
  const newId=db.ref('vehicles/'+currentUser.uid).push().key;
  db.ref('vehicles/'+currentUser.uid+'/'+newId).set({name,odometer:km});
  document.getElementById('new-vehicle-name').value=""; document.getElementById('new-vehicle-odometer').value="";
  loadVehicles();
}

// FUEL
function addFuel(){
  if(!currentVehicleId) return alert("Selecione um veículo");
  const date=document.getElementById('fuel-date').value;
  const km=parseFloat(document.getElementById('fuel-odometer').value)||0;
  const liters=parseFloat(document.getElementById('fuel-liters').value)||0;
  const price=parseFloat(document.getElementById('fuel-price').value)||0;
  if(!date||km<=0||liters<=0||price<0) return alert("Preencha corretamente");
  const newId=db.ref('fuels/'+currentUser.uid+'/'+currentVehicleId).push().key;
  db.ref('fuels/'+currentUser.uid+'/'+currentVehicleId+'/'+newId).set({date,km,liters,price});
  document.getElementById('fuel-date').value=""; document.getElementById('fuel-odometer').value=""; document.getElementById('fuel-liters').value=""; document.getElementById('fuel-price').value="";
  loadVehicleData();
}

// MAINTENANCE
function addMaintenance(){
  if(!currentVehicleId) return alert("Selecione um veículo");
  const type=document.getElementById('maint-type-selector').value;
  const date=document.getElementById('maint-date').value;
  const cost=parseFloat(document.getElementById('maint-cost').value)||0;
  if(!date||cost<0) return alert("Preencha corretamente");
  const newId=db.ref('maintenance/'+currentUser.uid+'/'+currentVehicleId).push().key;
  db.ref('maintenance/'+currentUser.uid+'/'+currentVehicleId+'/'+newId).set({type,date,cost});
  document.getElementById('maint-date').value=""; document.getElementById('maint-cost').value="";
  loadVehicleData();
}

// LOAD DATA & DASHBOARD
function loadVehicleData(){
  if(!currentVehicleId) return;
  db.ref('vehicles/'+currentUser.uid+'/'+currentVehicleId).once('value',snap=>{
    const v=snap.val(); if(!v) return;
    document.getElementById('dash-odometer').textContent=v.odometer+" km";
  });

  // Fuel
  db.ref('fuels/'+currentUser.uid+'/'+currentVehicleId).once('value',snap=>{
    const data=snap.val()||{}; const tbody=document.querySelector('#fuel-table tbody'); tbody.innerHTML="";
    const labels=[]; const consumption=[]; let lastKm=null;
    Object.values(data).sort((a,b)=>a.date.localeCompare(b.date)).forEach(f=>{
      const row=tbody.insertRow(); row.insertCell(0).textContent=f.date; row.insertCell(1).textContent=f.km; row.insertCell(2).textContent=f.liters; row.insertCell(3).textContent=f.price;
      labels.push(f.date); if(lastKm!==null) consumption.push((f.km-lastKm)/f.liters); else consumption.push(0); lastKm=f.km;
    });
    document.getElementById('dash-consumption').textContent=(consumption.reduce((a,b)=>a+b,0)/consumption.length||0).toFixed(2)+" km/l";
    if(consumptionChart) consumptionChart.destroy();
    const ctx=document.getElementById('consumption-chart').getContext('2d');
    consumptionChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Consumo (km/l)',data:consumption,borderColor:'#1976d2',fill:false}]},options:{responsive:true}});
  });

  // Maintenance
  db.ref('maintenance/'+currentUser.uid+'/'+currentVehicleId).once('value',snap=>{
    const data=snap.val()||{}; const tbody=document.querySelector('#maint-table tbody'); tbody.innerHTML="";
    const costData={}; Object.values(data).sort((a,b)=>a.date.localeCompare(b.date)).forEach(m=>{
      const row=tbody.insertRow(); row.insertCell(0).textContent=m.date; row.insertCell(1).textContent=m.type; row.insertCell(2).textContent=m.cost;
      if(!costData[m.type]) costData[m.type]=0; costData[m.type]+=m.cost;
    });
    document.getElementById('dash-expense').textContent="R$ "+Object.values(costData).reduce((a,b)=>a+b,0).toFixed(2);
    let next='---';
    Object.values(data).sort((a,b)=>a.date.localeCompare(b.date)).forEach(m=>{
      if(new Date(m.date)>new Date() && next==='---') next=m.date;
    });
    document.getElementById('dash-maintenance').textContent=next;
    if(maintenanceChart) maintenanceChart.destroy();
    const ctx2=document.getElementById('maintenance-chart').getContext('2d');
    maintenanceChart=new Chart(ctx2,{type:'bar',data:{labels:Object.keys(costData),datasets:[{label:'Gastos por tipo',data:Object.values(costData),backgroundColor:'#1976d2'}]},options:{responsive:true}});
  });
}

// EXPORT / IMPORT
function exportData(){
  db.ref('vehicles/'+currentUser.uid).once('value',snap=>{
    const vehicles=snap.val(); db.ref('fuels/'+currentUser.uid).once(fSnap=>{
      const fuels=fSnap.val(); db.ref('maintenance/'+currentUser.uid).once(mSnap=>{
        const maint=mSnap.val(); const data={vehicles,fuels,maintenance:maint};
        const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='veiculos.json'; a.click();
      });
    });
  });
}
function importData(){
  const file=document.createElement('input'); file.type='file'; file.accept='.json';
  file.onchange=e=>{
    const f=e.target.files[0]; const reader=new FileReader();
    reader.onload=ev=>{ const data=JSON.parse(ev.target.result);
      if(data.vehicles) db.ref('vehicles/'+currentUser.uid).set(data.vehicles);
      if(data.fuels) db.ref('fuels/'+currentUser.uid).set(data.fuels);
      if(data.maintenance) db.ref('maintenance/'+currentUser.uid).set(data.maintenance);
      loadVehicles(); alert("Dados importados!");
    };
    reader.readAsText(f);
  };
  file.click();
}

// MONITOR AUTH STATE
auth.onAuthStateChanged(user=>{
  if(user){currentUser=user; showApp(); loadVehicles();}
});
</script>
</body>
</html>
