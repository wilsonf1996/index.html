<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GaragePro — Controle Veicular (Ford Ka 2010 Flex)</title>
  <meta name="description" content="App profissional de controle de veículo: abastecimentos, manutenção, gastos e alertas. 100% local, pronto para GitHub Pages." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0b0b0c; --card:#141416; --text:#f2f2f3; --muted:#a1a1aa; --brand:#4f46e5; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --stroke:#222227;
    }
    [data-theme="light"] { --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#475569; --stroke:#e5e7eb; }
    *{ box-sizing: border-box }
    html,body{ height:100% }
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); color: var(--text);
    }
    .container{ max-width:1200px; margin:0 auto; padding:24px }
    header{ display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px }
    .title{ font-weight:700; font-size:20px }
    .muted{ color:var(--muted); font-size:12px }
    .row{ display:grid; gap:16px }
    @media (min-width: 900px){ .row.cols-4{ grid-template-columns: repeat(4, 1fr) } .row.cols-3{ grid-template-columns: repeat(3, 1fr) } .row.cols-2{ grid-template-columns: repeat(2, 1fr) } }
    .card{ background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:16px }
    .card h3{ margin:0 0 8px 0; font-size:14px; font-weight:600 }
    .value{ font-size:24px; font-weight:700 }
    .controls{ display:flex; gap:8px; align-items:center }
    button, input, select, textarea{ background:#0d0d10; color:var(--text); border:1px solid var(--stroke); border-radius:10px; padding:10px 12px; font: inherit }
    [data-theme="light"] button, [data-theme="light"] input, [data-theme="light"] select, [data-theme="light"] textarea{ background:#fff }
    button{ background:linear-gradient(180deg, #5b54ff, #4338ca); border:none; cursor:pointer; font-weight:600 }
    button.ghost{ background:transparent; border:1px solid var(--stroke) }
    button.warn{ background:linear-gradient(180deg, #f59e0b, #b45309) }
    button.danger{ background:linear-gradient(180deg, #ef4444, #b91c1c) }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin:16px 0 }
    .tab{ padding:10px 12px; border:1px solid var(--stroke); border-radius:12px; cursor:pointer; background:transparent }
    .tab.active{ background:var(--brand); border-color:transparent }
    table{ width:100%; border-collapse: collapse }
    th, td{ padding:10px; border-bottom:1px solid var(--stroke); font-size:13px; text-align:left }
    th{ color:var(--muted); font-weight:600 }
    .right{ text-align:right }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--stroke) }
    .badge.ok{ color:var(--ok); border-color:rgba(16,185,129,.35) }
    .badge.warn{ color:var(--warn); border-color:rgba(245,158,11,.35) }
    .badge.danger{ color:var(--danger); border-color:rgba(239,68,68,.35) }
    .grid-2{ display:grid; gap:12px }
    @media(min-width:800px){ .grid-2{ grid-template-columns: 1fr 1fr } }
    .section-title{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:8px }
    .pill{ padding:6px 10px; border:1px solid var(--stroke); border-radius:999px; font-size:12px }
    .help{ font-size:12px; color:var(--muted) }
    .footer{ text-align:center; color:var(--muted); font-size:12px; padding:32px 0 }
    .split{ display:flex; gap:8px }
    .split > *{ flex:1 }
    .hidden{ display:none }
  </style>
</head>
<body>
  <div class="container" id="app">
    <header>
      <div>
        <div class="title">GaragePro — Controle Veicular</div>
        <div class="muted">Stand-alone • 100% local (localStorage) • Pronto para GitHub Pages</div>
      </div>
      <div class="controls">
        <select id="vehicleSelect"></select>
        <button id="addVehicle">+ Veículo</button>
        <button class="ghost" id="themeToggle">Tema</button>
        <button class="ghost" id="exportBtn">Exportar</button>
        <label class="pill" for="importFile" style="cursor:pointer">Importar <input id="importFile" class="hidden" type="file" accept="application/json" /></label>
      </div>
    </header>

    <nav class="tabs" id="tabs">
      <button class="tab active" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="abastecimentos">Abastecimentos</button>
      <button class="tab" data-tab="manutencao">Manutenção</button>
      <button class="tab" data-tab="gastos">Gastos</button>
      <button class="tab" data-tab="veiculo">Veículo</button>
      <button class="tab" data-tab="config">Config</button>
    </nav>

    <!-- DASHBOARD -->
    <section id="dashboard" class="tabpane">
      <div class="row cols-4">
        <div class="card"><h3>Odômetro Atual</h3><div class="value" id="odoAtual">—</div><div class="help">Atualize na aba Veículo</div></div>
        <div class="card"><h3>Consumo Médio (Gasolina)</h3><div class="value" id="avgGas">—</div><div class="help">Método tanque cheio</div></div>
        <div class="card"><h3>Consumo Médio (Etanol)</h3><div class="value" id="avgEta">—</div><div class="help">Método tanque cheio</div></div>
        <div class="card"><h3>Sugestão Flex</h3><div class="value" id="flexTip">—</div><div class="help">Regra dos 70%</div></div>
      </div>
      <div class="row cols-2" style="margin-top:16px">
        <div class="card">
          <h3>Evolução do Consumo (km/L)</h3>
          <canvas id="chartConsumo" height="140"></canvas>
        </div>
        <div class="card">
          <h3>Gastos Mensais (Combustível + Manutenção)</h3>
          <canvas id="chartGastos" height="140"></canvas>
        </div>
      </div>
      <div class="card" style="margin-top:16px">
        <div class="section-title"><h3>Alertas Próximos</h3><span class="help">Baseados em km e/ou tempo</span></div>
        <div id="alertList" class="grid-2" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- ABASTECIMENTOS -->
    <section id="abastecimentos" class="tabpane hidden">
      <div class="card">
        <h3>Novo Abastecimento</h3>
        <div class="grid-2">
          <div class="split"><input id="fuelDate" type="date"><input id="fuelOdo" type="number" placeholder="Odômetro (km)"></div>
          <div class="split"><input id="fuelLitros" type="number" step="0.01" placeholder="Litros"><input id="fuelValor" type="number" step="0.01" placeholder="Valor total (R$)"></div>
          <div class="split"><select id="fuelTipo"><option value="gasolina">Gasolina</option><option value="etanol">Etanol</option></select><input id="fuelPosto" placeholder="Posto (opcional)"></div>
          <div class="split"><label><input type="checkbox" id="fuelCheio"> Tanque cheio</label><input id="fuelObs" placeholder="Observação (opcional)"></div>
        </div>
        <div class="controls" style="margin-top:8px"><button id="addFuelBtn">Adicionar</button></div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>Histórico</h3>
        <div style="overflow:auto">
          <table id="fuelTable"><thead><tr>
            <th>Data</th><th>Odo</th><th>Litros</th><th>Valor</th><th>R$/L</th><th>Tipo</th><th>Cheio</th><th>km desde o último</th><th>km/L</th><th></th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- MANUTENÇÃO -->
    <section id="manutencao" class="tabpane hidden">
      <div class="card">
        <div class="section-title"><h3>Plano — Ford Ka 2010 Flex</h3><span class="pill">Editar itens e intervalos</span></div>
        <div class="help">Valores iniciais predefinidos. Ajuste conforme uso/condições.</div>
        <div class="controls" style="margin-top:8px"><button id="addMaintPreset">+ Item</button></div>
        <div style="overflow:auto; margin-top:8px">
          <table id="maintTable"><thead><tr>
            <th>Item</th><th>Intervalo km</th><th>Intervalo meses</th><th>Última data</th><th>Último km</th><th>Próx. data</th><th>Próx. km</th><th>Status</th><th></th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>Registrar Manutenção Executada</h3>
        <div class="grid-2">
          <div class="split"><input id="doneDate" type="date"><input id="doneKm" type="number" placeholder="Odômetro"></div>
          <div class="split"><select id="doneItem"></select><input id="doneCusto" type="number" step="0.01" placeholder="Custo (R$)"></div>
          <div class="split"><input id="doneOficina" placeholder="Oficina (opcional)"><input id="doneNotas" placeholder="Notas (opcional)"></div>
        </div>
        <div class="controls" style="margin-top:8px"><button id="addDoneBtn">Registrar</button></div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>Histórico de Manutenções</h3>
        <div style="overflow:auto">
          <table id="doneTable"><thead><tr>
            <th>Data</th><th>Odômetro</th><th>Item</th><th>Custo</th><th>Oficina</th><th>Notas</th><th></th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- GASTOS -->
    <section id="gastos" class="tabpane hidden">
      <div class="card">
        <h3>Novo Gasto (IPVA/Seguro/Multa/Outros)</h3>
        <div class="grid-2">
          <div class="split"><input id="costDate" type="date"><input id="costTipo" placeholder="Tipo (ex.: IPVA)"></div>
          <div class="split"><input id="costValor" type="number" step="0.01" placeholder="Valor (R$)"><input id="costObs" placeholder="Observação"></div>
        </div>
        <div class="controls" style="margin-top:8px"><button id="addCostBtn">Adicionar</button></div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>Histórico de Gastos</h3>
        <div style="overflow:auto">
          <table id="costTable"><thead><tr>
            <th>Data</th><th>Tipo</th><th>Valor</th><th>Obs.</th><th></th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- VEÍCULO -->
    <section id="veiculo" class="tabpane hidden">
      <div class="card">
        <h3>Dados do Veículo</h3>
        <div class="grid-2">
          <div class="split"><input id="vNome" placeholder="Nome (ex.: Ford Ka 2010 Flex)"><input id="vPlaca" placeholder="Placa"></div>
          <div class="split"><input id="vOdo" type="number" placeholder="Odômetro atual (km)"><select id="vCombPref"><option value="auto">Flex (auto)</option><option value="gasolina">Gasolina</option><option value="etanol">Etanol</option></select></div>
        </div>
        <div class="controls" style="margin-top:8px">
          <button id="saveVehicle">Salvar</button>
          <button class="danger" id="delVehicle">Excluir veículo</button>
        </div>
      </div>
    </section>

    <!-- CONFIG -->
    <section id="config" class="tabpane hidden">
      <div class="card">
        <h3>Preferências</h3>
        <div class="grid-2">
          <div class="split"><label class="pill">Moeda: BRL</label><label class="pill">Unidades: km/L</label></div>
          <div class="split"><label class="pill">Tema: <span id="themeLbl">Escuro</span></label><label class="pill">Backup: Export/Import JSON</label></div>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>Ferramentas</h3>
        <div class="controls">
          <button class="warn" id="resetBtn">Limpar todos os dados locais</button>
        </div>
      </div>
    </section>

    <div class="footer">GaragePro • Nenhum dado sai do seu navegador • Coloque este arquivo como <strong>index.html</strong> no GitHub Pages</div>
  </div>

  <script>
  // ===== Util =====
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const fmtBRL = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(Number(v||0));
  const todayISO = () => new Date().toISOString().slice(0,10);
  const ym = d => (d||'').slice(0,7);

  // ===== Storage Schema =====
  const LS_KEY = 'garagepro.v1';
  const DEFAULT_PRESET = [
    { id: cid(), item:'Troca de óleo do motor', ivKm:10000, ivMes:6, lastDate:'', lastKm:null },
    { id: cid(), item:'Filtro de óleo',        ivKm:10000, ivMes:6, lastDate:'', lastKm:null },
    { id: cid(), item:'Filtro de ar',          ivKm:20000, ivMes:12, lastDate:'', lastKm:null },
    { id: cid(), item:'Filtro de combustível', ivKm:30000, ivMes:24, lastDate:'', lastKm:null },
    { id: cid(), item:'Velas de ignição',      ivKm:40000, ivMes:24, lastDate:'', lastKm:null },
    { id: cid(), item:'Correia dentada',       ivKm:60000, ivMes:48, lastDate:'', lastKm:null },
    { id: cid(), item:'Fluido de freio',       ivKm:40000, ivMes:24, lastDate:'', lastKm:null },
    { id: cid(), item:'Líquido de arrefecimento',ivKm:40000, ivMes:24, lastDate:'', lastKm:null },
    { id: cid(), item:'Alinhamento/Balanceamento',ivKm:10000, ivMes:12, lastDate:'', lastKm:null },
  ];
  const DEFAULT_DATA = {
    theme:'dark',
    vehicles:[{
      id: cid(), name:'Ford Ka 2010 Flex', plate:'', odo:0, prefFuel:'auto',
      fuels:[],
      maintPlan: JSON.parse(JSON.stringify(DEFAULT_PRESET)),
      maintHistory:[],
      costs:[]
    }],
    activeVehicle: 0
  };

  function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || DEFAULT_DATA }catch{ return DEFAULT_DATA } }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(DB)); }
  function cid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }

  let DB = load();

  // ===== Tabs & Theme =====
  const panes = $$('.tabpane');
  $$('#tabs .tab').forEach(btn=> btn.addEventListener('click', ()=>{
    $$('#tabs .tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    panes.forEach(p=>p.classList.add('hidden')); $('#'+btn.dataset.tab).classList.remove('hidden');
    if(btn.dataset.tab==='dashboard'){ drawCharts(); renderAlerts(); }
  }));
  function applyTheme(){ document.documentElement.setAttribute('data-theme', DB.theme==='light'?'light':'dark'); $('#themeLbl').textContent = DB.theme==='light'?'Claro':'Escuro' }
  $('#themeToggle').onclick = ()=>{ DB.theme = DB.theme==='light'?'dark':'light'; applyTheme(); save(); };
  applyTheme();

  // ===== Vehicles =====
  function active(){ return DB.vehicles[DB.activeVehicle] }
  function refreshVehicleSelect(){ const s=$('#vehicleSelect'); s.innerHTML=''; DB.vehicles.forEach((v,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=v.name || ('Veículo '+(i+1)); s.appendChild(o); }); s.value=DB.activeVehicle; }
  $('#vehicleSelect').onchange = e=>{ DB.activeVehicle = Number(e.target.value); save(); renderAll(); };
  $('#addVehicle').onclick = ()=>{ DB.vehicles.push({ id:cid(), name:'Novo Veículo', plate:'', odo:0, prefFuel:'auto', fuels:[], maintPlan: JSON.parse(JSON.stringify(DEFAULT_PRESET)), maintHistory:[], costs:[] }); DB.activeVehicle = DB.vehicles.length-1; save(); renderAll(); };
  $('#saveVehicle').onclick = ()=>{ const v=active(); v.name=$('#vNome').value.trim(); v.plate=$('#vPlaca').value.trim(); v.odo=Number($('#vOdo').value||0); v.prefFuel=$('#vCombPref').value; save(); renderAll(); };
  $('#delVehicle').onclick = ()=>{ if(DB.vehicles.length<=1) return alert('Mantenha pelo menos 1 veículo.'); if(confirm('Excluir veículo atual?')){ DB.vehicles.splice(DB.activeVehicle,1); DB.activeVehicle=0; save(); renderAll(); } };

  // ===== Abastecimentos =====
  $('#addFuelBtn').onclick = ()=>{
    const v=active();
    const rec = { id:cid(), date: $('#fuelDate').value||todayISO(), odo: Number($('#fuelOdo').value||0), litros:Number($('#fuelLitros').value||0), valor:Number($('#fuelValor').value||0), tipo:$('#fuelTipo').value, posto:$('#fuelPosto').value.trim(), cheio: $('#fuelCheio').checked, obs:$('#fuelObs').value.trim() };
    if(!rec.odo || !rec.litros || !rec.valor) return alert('Preencha odômetro, litros e valor.');
    v.fuels.push(rec); if(rec.odo>v.odo) v.odo=rec.odo; save(); renderAll();
    // clear
    $('#fuelLitros').value=''; $('#fuelValor').value=''; $('#fuelPosto').value=''; $('#fuelObs').value='';
  };
  function removeFuel(id){ const v=active(); v.fuels = v.fuels.filter(x=>x.id!==id); save(); renderAll(); }

  // Consumo (tanque cheio) e dicas flex
  function computeFuelStats(){
    const v=active();
    const sorted = [...v.fuels].sort((a,b)=> a.odo-b.odo || a.date.localeCompare(b.date));
    const series = [];
    for(let i=1;i<sorted.length;i++){
      const cur=sorted[i], prev=sorted[i-1];
      const km = cur.odo - prev.odo; const liters = cur.litros; if(km>0 && liters>0){ series.push({ date:cur.date, kmL: km/liters, tipo:cur.tipo }) }
    }
    const avg = t=>{ const arr=series.filter(s=>s.tipo===t); const km=arr.reduce((a,b)=>a+b.km,0); const l=arr.reduce((a,b)=>a+b.liters||0,0); /*not available*/ return (arr.length? (arr.reduce((a,b)=>a+b.kmL,0)/arr.length):0) };
    const lastG = [...sorted].reverse().find(a=>a.tipo==='gasolina');
    const lastE = [...sorted].reverse().find(a=>a.tipo==='etanol');
    const priceG = lastG ? lastG.valor/lastG.litros : null;
    const priceE = lastE ? lastE.valor/lastE.litros : null;
    let tip='Cadastre gasolina e etanol para sugerirmos.';
    if(priceG && priceE){ tip = (priceE <= 0.7*priceG) ? 'No momento, ETANOL é mais vantajoso (≤ 70% do preço da gasolina).' : 'No momento, GASOLINA é mais vantajosa (> 70%).'; }
    return { series, priceG, priceE, tip };
  }

  // ===== Manutenção =====
  $('#addMaintPreset').onclick = ()=>{ const v=active(); v.maintPlan.push({ id:cid(), item:'Novo item', ivKm:10000, ivMes:12, lastDate:'', lastKm:null }); save(); renderMaint(); };
  function removeMaintItem(id){ const v=active(); v.maintPlan = v.maintPlan.filter(x=>x.id!==id); save(); renderMaint(); }

  $('#addDoneBtn').onclick = ()=>{
    const v=active(); const itemId = $('#doneItem').value; const plan = v.maintPlan.find(x=>x.id===itemId); if(!plan) return;
    const rec = { id:cid(), date: $('#doneDate').value||todayISO(), odo: Number($('#doneKm').value||0), item: plan.item, itemId, custo:Number($('#doneCusto').value||0), oficina:$('#doneOficina').value.trim(), notas:$('#doneNotas').value.trim() };
    if(!rec.odo) return alert('Informe o odômetro.');
    v.maintHistory.push(rec);
    // atualizar plano
    plan.lastDate = rec.date; plan.lastKm = rec.odo;
    if(rec.odo>v.odo) v.odo = rec.odo;
    save(); renderAll();
    $('#doneCusto').value=''; $('#doneOficina').value=''; $('#doneNotas').value='';
  };
  function removeDone(id){ const v=active(); v.maintHistory = v.maintHistory.filter(x=>x.id!==id); save(); renderMaint(); }

  // ===== Gastos =====
  $('#addCostBtn').onclick = ()=>{ const v=active(); const rec = { id:cid(), date: $('#costDate').value||todayISO(), tipo: $('#costTipo').value.trim()||'Outro', valor:Number($('#costValor').value||0), obs:$('#costObs').value.trim() }; if(!rec.valor) return alert('Informe o valor.'); v.costs.push(rec); save(); renderCosts(); };
  function removeCost(id){ const v=active(); v.costs = v.costs.filter(x=>x.id!==id); save(); renderCosts(); }

  // ===== Export/Import/Reset =====
  $('#exportBtn').onclick = ()=>{
    const blob = new Blob([JSON.stringify(DB,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='garagepro_backup.json'; a.click(); URL.revokeObjectURL(url);
  };
  $('#importFile').addEventListener('change', e=>{
    const file = e.target.files[0]; if(!file) return;
    const fr = new FileReader(); fr.onload = (ev)=>{ try{ const data = JSON.parse(ev.target.result); if(confirm('Substituir todos os dados atuais?')){ DB=data; save(); renderAll(); } }catch(err){ alert('Arquivo inválido.'); } }; fr.readAsText(file);
  });
  $('#resetBtn').onclick = ()=>{ if(confirm('Apagar todos os dados locais?')){ localStorage.removeItem(LS_KEY); DB = load(); renderAll(); } };

  // ===== Rendering =====
  let chConsumo, chGastos;
  function drawCharts(){ const v=active();
    const sorted = [...v.fuels].sort((a,b)=> a.date.localeCompare(b.date));
    const labels = []; const dataKmL = [];
    for(let i=1;i<sorted.length;i++){ const cur=sorted[i], prev=sorted[i-1]; const km = cur.odo - prev.odo; const liters=cur.litros; if(km>0 && liters>0){ labels.push(cur.date); dataKmL.push((km/liters).toFixed(2)); } }
    const byMonth = new Map();
    v.fuels.forEach(a=>{ const key=ym(a.date); const o=byMonth.get(key)||{gasto:0}; o.gasto += Number(a.valor||0); byMonth.set(key,o); });
    v.maintHistory.forEach(m=>{ const key=ym(m.date); const o=byMonth.get(key)||{gasto:0}; o.gasto += Number(m.custo||0); byMonth.set(key,o); });
    const labels2 = [...byMonth.keys()].sort(); const dataGasto = labels2.map(k=> byMonth.get(k).gasto.toFixed(2));
    // consumo
    const ctx1 = $('#chartConsumo').getContext('2d'); if(chConsumo) chConsumo.destroy(); chConsumo = new Chart(ctx1,{ type:'line', data:{ labels, datasets:[{ label:'km/L', data:dataKmL }] }, options:{ responsive:true, plugins:{ legend:{display:true} } } });
    // gastos
    const ctx2 = $('#chartGastos').getContext('2d'); if(chGastos) chGastos.destroy(); chGastos = new Chart(ctx2,{ type:'bar', data:{ labels:labels2, datasets:[{ label:'Gasto (R$)', data:dataGasto }] }, options:{ responsive:true, plugins:{ legend:{display:true} } } });
  }

  function renderDashboard(){ const v=active(); $('#odoAtual').textContent = (v.odo||0).toLocaleString('pt-BR')+' km';
    // médias
    const stats = computeFuelStats();
    // simples: média aritmética por tipo
    const sorted = [...v.fuels].sort((a,b)=> a.odo-b.odo || a.date.localeCompare(b.date));
    const arrG=[], arrE=[]; for(let i=1;i<sorted.length;i++){ const cur=sorted[i], prev=sorted[i-1]; const km=cur.odo-prev.odo; if(km>0 && cur.litros>0){ const v=km/cur.litros; (cur.tipo==='gasolina'?arrG:arrE).push(v); } }
    const avg = a=> a.length? (a.reduce((x,y)=>x+y,0)/a.length).toFixed(2):'—';
    $('#avgGas').textContent = avg(arrG);
    $('#avgEta').textContent = avg(arrE);
    $('#flexTip').textContent = stats.tip;
    drawCharts();
  }

  function renderAlerts(){ const v=active(); const now = new Date(); const list = $('#alertList'); list.innerHTML='';
    v.maintPlan.forEach(it=>{
      const nextDate = it.lastDate ? addMonths(it.lastDate, it.ivMes) : null;
      const nextKm = it.lastKm!=null ? (it.lastKm + (it.ivKm||0)) : null;
      const dueDate = nextDate && (new Date(nextDate) <= addMonths(todayISO(), 1));
      const dueKm = nextKm!=null && (v.odo >= (nextKm - 1000));
      const status = (dueDate||dueKm)? (v.odo>=nextKm || (nextDate && new Date(nextDate)<=now) ? 'danger' : 'warn') : 'ok';
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div><div style="font-weight:600">${it.item}</div>
        <div class="help">Próx. km: ${nextKm?nextKm.toLocaleString('pt-BR'): '—'} • Próx. data: ${nextDate?fmtDate(nextDate):'—'}</div></div>
        <span class="badge ${status}">${status==='ok'?'OK':status==='warn'?'Em breve':'Vencido'}</span>
      </div>`;
      list.appendChild(card);
    });
  }

  function renderFuel(){ const v=active(); const tbody = $('#fuelTable tbody'); tbody.innerHTML='';
    const arr=[...v.fuels].sort((a,b)=> a.odo-b.odo || a.date.localeCompare(b.date));
    arr.forEach((a,i)=>{
      const prev = arr[i-1]; const km = prev? (a.odo - prev.odo):0; const kmL = prev && a.litros? (km/a.litros):0; const pL = a.litros? (a.valor/a.litros):0;
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${a.date}</td><td>${a.odo.toLocaleString('pt-BR')}</td><td>${a.litros.toFixed(2)}</td><td class='right'>${fmtBRL(a.valor)}</td><td class='right'>${fmtBRL(pL)}</td><td>${a.tipo}</td><td>${a.cheio?'Sim':'Não'}</td><td>${km?km.toLocaleString('pt-BR'):'—'}</td><td>${kmL?kmL.toFixed(2):'—'}</td><td><button class='danger' data-id='${a.id}'>Excluir</button></td>`;
      tbody.appendChild(tr);
    });
    $$('#fuelTable button.danger').forEach(b=> b.onclick = ()=> removeFuel(b.dataset.id));
  }

  function renderMaint(){ const v=active(); const tbody=$('#maintTable tbody'); tbody.innerHTML=''; const sel=$('#doneItem'); sel.innerHTML='';
    v.maintPlan.forEach(it=>{
      const nextDate = it.lastDate ? addMonths(it.lastDate, it.ivMes) : '';
      const nextKm = it.lastKm!=null ? (it.lastKm + (it.ivKm||0)) : '';
      const tr=document.createElement('tr'); tr.innerHTML = `
        <td><input value="${it.item}" data-k="item" data-id="${it.id}"></td>
        <td><input type="number" value="${it.ivKm}" data-k="ivKm" data-id="${it.id}"></td>
        <td><input type="number" value="${it.ivMes}" data-k="ivMes" data-id="${it.id}"></td>
        <td><input type="date" value="${it.lastDate||''}" data-k="lastDate" data-id="${it.id}"></td>
        <td><input type="number" value="${it.lastKm??''}" data-k="lastKm" data-id="${it.id}"></td>
        <td>${nextDate?fmtDate(nextDate):'—'}</td>
        <td>${nextKm?Number(nextKm).toLocaleString('pt-BR'):'—'}</td>
        <td></td>
        <td><button class='danger' data-id='${it.id}'>Excluir</button></td>`;
      tbody.appendChild(tr);
      const opt=document.createElement('option'); opt.value=it.id; opt.textContent=it.item; sel.appendChild(opt);
    });
    // bind inputs
    $$('#maintTable [data-id]').forEach(inp=> inp.addEventListener('input', (e)=>{
      const id=e.target.dataset.id; const k=e.target.dataset.k; const v=active(); const it=v.maintPlan.find(x=>x.id===id); if(!it) return; let val=e.target.value; if(k==='ivKm'||k==='ivMes'||k==='lastKm') val = Number(val||0); it[k]= val; save(); renderMaint(); }));
    $$('#maintTable button.danger').forEach(b=> b.onclick = ()=> removeMaintItem(b.dataset.id));

    // histórico
    const tbody2 = $('#doneTable tbody'); tbody2.innerHTML='';
    [...active().maintHistory].sort((a,b)=> b.date.localeCompare(a.date)).forEach(m=>{
      const tr=document.createElement('tr'); tr.innerHTML = `<td>${m.date}</td><td>${m.odo.toLocaleString('pt-BR')}</td><td>${m.item}</td><td class='right'>${fmtBRL(m.custo)}</td><td>${m.oficina||''}</td><td>${m.notas||''}</td><td><button class='danger' data-id='${m.id}'>Excluir</button></td>`; tbody2.appendChild(tr);
    });
    $$('#doneTable button.danger').forEach(b=> b.onclick = ()=> removeDone(b.dataset.id));
  }

  function renderCosts(){ const v=active(); const tbody=$('#costTable tbody'); tbody.innerHTML='';
    [...v.costs].sort((a,b)=> b.date.localeCompare(a.date)).forEach(c=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.date}</td><td>${c.tipo}</td><td class='right'>${fmtBRL(c.valor)}</td><td>${c.obs||''}</td><td><button class='danger' data-id='${c.id}'>Excluir</button></td>`; tbody.appendChild(tr); });
    $$('#costTable button.danger').forEach(b=> b.onclick = ()=> removeCost(b.dataset.id));
  }

  function renderVehicle(){ const v=active(); $('#vNome').value=v.name||''; $('#vPlaca').value=v.plate||''; $('#vOdo').value=v.odo||0; $('#vCombPref').value=v.prefFuel||'auto'; }

  function renderAll(){ refreshVehicleSelect(); renderDashboard(); renderFuel(); renderMaint(); renderCosts(); renderVehicle(); renderAlerts(); save(); }

  // ===== Helpers =====
  function addMonths(dateISO, m){ if(!dateISO || !m) return ''; const d=new Date(dateISO); d.setMonth(d.getMonth()+Number(m||0)); return d.toISOString().slice(0,10); }
  function fmtDate(dateISO){ const d=new Date(dateISO); return d.toLocaleDateString('pt-BR'); }

  // ===== Init =====
  // default set a data de hoje nos forms
  $('#fuelDate').value = todayISO(); $('#doneDate').value = todayISO(); $('#costDate').value = todayISO();
  renderAll();
  </script>
</body>
</html>
